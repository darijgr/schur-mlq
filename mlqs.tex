\documentclass[reqno]{amsart}
\usepackage{setspace,tikz,xcolor,mathrsfs,listings,multicol}
\usepackage{amssymb}
\usepackage{rotating}
\usepackage[vcentermath]{youngtab}
\usepackage{enumerate}
\usepackage[all,cmtip]{xy}
\usetikzlibrary{arrows,matrix}
\usepackage{comment}
\usepackage{color}
\usepackage[sc]{mathpazo}
\usepackage[T1]{fontenc}
\usepackage{needspace}
\usepackage{tabls}
\usepackage{ytableau}
%\usepackage{amsmath}
%\usepackage{amsthm}
%\usepackage{subcaption}
%\usepackage{fullpage}
%\usepackage[margin=1.25in]{geometry}
%\onehalfspacing

\usepackage[colorlinks=true, pdfstartview=FitV, linkcolor=blue, citecolor=blue, urlcolor=blue]{hyperref}

% use these commands for typesetting doi and arXiv references in the bibliography
\newcommand{\doi}[1]{\href{https://doi.org/#1}{\texttt{doi:#1}}}
\newcommand{\arxiv}[1]{\href{http://arxiv.org/abs/#1}{\texttt{arXiv:#1}}}

\newcommand{\iso}{\cong}
%\newcommand{\qedbox}{\rule{2mm}{2mm}}
%\renewcommand{\qedsymbol}{\qedbox}
\newcommand{\qbinom}[3]{\genfrac{[}{]}{0pt}{}{#1}{#2}_{#3}}
\newcommand{\absval}[1]{\left\lvert #1 \right\rvert}
\newcommand{\case}[1]{\vspace{12pt}\noindent\underline{#1}:}
\newcommand{\fs}{\mathcal{S}} % flagged Schur function
\newcommand{\mbf}{\mathbf}
\newcommand{\0}{\phantom{c}}
\newcommand{\swt}[1]{\left\langle #1 \right\rangle} % Spectral weight or amplitude
\newcommand{\merge}[1]{\vee_{#1}} % merge
\newcommand{\SymGp}[1]{\mathfrak{S}_{#1}} % symmetric group
\newcommand{\std}[1]{\widetilde{#1}} % standardization
\newcommand{\MLQ}{\mathbf{S}} % (old symbol for) MLQs
\newcommand{\diag}[1]{\left[#1\right]} % diagram

\DeclareMathOperator{\supp}{supp} % Support
\DeclareMathOperator{\inter}{int} % queuing interval
\DeclareMathOperator{\wt}{wt} % weight
\DeclareMathOperator{\SP}{SP} % parenthesis sequence
\DeclareMathOperator{\col}{col} % column
\DeclareMathOperator{\colw}{colw} % column word
\DeclareMathOperator{\word}{word} % word
\DeclareMathOperator{\xcoord}{x} % the x-coordinate
\DeclareMathOperator{\ycoord}{y} % the y-coordinate
\DeclareMathOperator{\id}{id} % identity
\DeclareMathOperator{\SST}{SST} % Semistandard tableaux
\DeclareMathOperator{\KM}{KM}
\DeclareMathOperator{\ch}{ch} % character
\DeclareMathOperator{\gr}{gr} % grading
\DeclareMathOperator{\rev}{rev}
\DeclareMathOperator{\conncomp}{conncomp}
\DeclareMathOperator{\core}{core}

\newcommand{\ff}{\mathbf{f}}
\newcommand{\mm}{\mathbf{m}}
\newcommand{\nn}{\mathbf{n}}
\newcommand{\pp}{\mathbf{p}}
\newcommand{\qq}{\mathbf{q}}
\newcommand{\uu}{\mathbf{u}}
\newcommand{\vv}{\mathbf{v}}
\newcommand{\xx}{\mathbf{x}}

\newcommand{\mcA}{\mathcal{A}}
\newcommand{\mcF}{\mathcal{F}}
\newcommand{\mcM}{\mathcal{M}}
\newcommand{\mcW}{\mathcal{W}}
\newcommand{\mcI}{\mathcal{I}}

\newcommand{\NN}{\mathbb{N}}
\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\CC}{\mathbb{C}}

\newcommand{\bze}{\overline{0}}
\newcommand{\bon}{\overline{1}}
\newcommand{\btw}{\overline{2}}
\newcommand{\bth}{\overline{3}}
\newcommand{\bfo}{\overline{4}}
\newcommand{\bfive}{\overline{5}}
\newcommand{\bsix}{\overline{6}}
\newcommand{\bseven}{\overline{7}}
\newcommand{\beight}{\overline{8}}
\newcommand{\bi}{\overline\imath}
\newcommand{\bk}{\overline{k}}
\newcommand{\brr}{\overline{r}}
\newcommand{\bn}{\overline{n}}
\newcommand{\ellbar}{\overline{\ell}}

\newcommand{\fraks}{\mathfrak{s}}

\let\sumnonlimits\sum
\let\prodnonlimits\prod
\let\cupnonlimits\bigcup
\let\capnonlimits\bigcap
\renewcommand{\sum}{\sumnonlimits\limits}
\renewcommand{\prod}{\prodnonlimits\limits}
\renewcommand{\bigcup}{\cupnonlimits\limits}
\renewcommand{\bigcap}{\capnonlimits\limits}

\newenvironment{subproof}{\textit{Proof.} }{\hfill$\blacksquare$ \medskip}
% Darij's alternative:
% \newenvironment{subproof}{$\lceil$ \textit{Proof.} }{\hfill$\blacksquare \rfloor$ \medskip}

\newenvironment{verlong}{}{}
\newenvironment{vershort}{}{}
\newenvironment{noncompile}{}{}
\excludecomment{verlong}
\includecomment{vershort}
\excludecomment{noncompile}

\newenvironment{statement}{\begin{quote}}{\end{quote}}

\newcommand{\powset}[2][]{\ifthenelse{\equal{#2}{}}{\mathcal{P}\left(#1\right)}{\mathcal{P}_{#1}\left(#2\right)}}
% $\powset[k]{S}$ stands for the set of all $k$-element subsets of
% $S$. The argument $k$ is optional, and if not provided, the result
% is the whole powerset of $S$.
\newcommand{\set}[1]{\left\{ #1 \right\}}
% $\set{...}$ yields $\left\{ ... \right\}$.
\newcommand{\abs}[1]{\left| #1 \right|}
% $\abs{...}$ yields $\left| ... \right|$.
\newcommand{\tup}[1]{\left( #1 \right)}
% $\tup{...}$ yields $\left( ... \right)$.
\newcommand{\ive}[1]{\left[ #1 \right]}
% $\ive{...}$ yields $\left[ ... \right]$.
\newcommand{\verts}[1]{\operatorname{V}\left( #1 \right)}
% $\verts{...}$ yields $\operatorname{V}\left( ... \right)$.
\newcommand{\edges}[1]{\operatorname{E}\left( #1 \right)}
% $\edges{...}$ yields $\operatorname{E}\left( ... \right)$.
\newcommand{\arcs}[1]{\operatorname{A}\left( #1 \right)}
% $\arcs{...}$ yields $\operatorname{A}\left( ... \right)$.
\newcommand{\underbrack}[2]{\underbrace{#1}_{\substack{#2}}}
% $\underbrack{...1}{...2}$ yields
% $\underbrace{...1}_{\substack{...2}}$. This is useful for doing
% local rewriting transformations on mathematical expressions with
% justifications.
\newcommand{\mlnode}[1]{\node[circle, draw=black] at (#1){\phantom{c}};}

% Dark red emphasis
\definecolor{darkred}{rgb}{0.7,0,0} % darkred color
\newcommand{\defn}[1]{{\color{darkred}\emph{#1}}} % emphasis of a definition

%% For typesetting code listings                                                
\usepackage{listings}
\lstdefinelanguage{Sage}[]{Python}
{morekeywords={False,sage,True},sensitive=true}
\lstset{
  frame=single,
  showtabs=False,
  showspaces=False,
  showstringspaces=False,
  commentstyle={\ttfamily\color{dgreencolor}},
  keywordstyle={\ttfamily\color{dbluecolor}\bfseries},
  stringstyle={\ttfamily\color{dgraycolor}\bfseries},
  language=Sage,
  basicstyle={\footnotesize\ttfamily},
  aboveskip=0.75em,
  belowskip=0.75em,
  xleftmargin=.15in,
}
\definecolor{dblackcolor}{rgb}{0.0,0.0,0.0}
\definecolor{dbluecolor}{rgb}{0.01,0.02,0.7}
\definecolor{dgreencolor}{rgb}{0.2,0.4,0.0}
\definecolor{dgraycolor}{rgb}{0.30,0.3,0.30}
\newcommand{\dblue}{\color{dbluecolor}\bf}
\newcommand{\dred}{\color{dredcolor}\bf}
\newcommand{\dblack}{\color{dblackcolor}\bf}

\usepackage{xparse}

\makeatletter
% \specialmergetwolists{<coupler>}{<list1>}{<list2>}{<return macro>}
% \specialmergetwolists*{<coupler>}{<listcmd1>}{<listcmd2>}{<return macro>}
\protected\def\specialmergetwolists{%
  \begingroup
  \@ifstar{\def\cnta{1}\@specialmergetwolists}
    {\def\cnta{0}\@specialmergetwolists}%
}
\def\@specialmergetwolists#1#2#3#4{%
  \def\tempa##1##2{%
    \edef##2{%
      \ifnum\cnta=\@ne\else\expandafter\@firstoftwo\fi
      \unexpanded\expandafter{##1}%
    }%
  }%
  \tempa{#2}\tempb\tempa{#3}\tempa
  \def\cnta{0}\def#4{}%
  \foreach \x in \tempb{%
    \xdef\cnta{\the\numexpr\cnta+1}%
    \gdef\cntb{0}%
    \foreach \y in \tempa{%
      \xdef\cntb{\the\numexpr\cntb+1}%
      \ifnum\cntb=\cnta\relax
        \xdef#4{#4\ifx#4\empty\else,\fi\x#1\y}%
        \breakforeach
      \fi
    }%
  }%
  \endgroup
}
\makeatother

\theoremstyle{plain}
\newtheorem{thm}{Theorem}[section]
\newtheorem{lemma}[thm]{Lemma}
\newtheorem{conj}[thm]{Conjecture}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}
\newtheorem{claim}[thm]{Claim}
\theoremstyle{definition}
\newtheorem{dfn}[thm]{Definition}
\newtheorem{example}[thm]{Example}
\newtheorem{remark}[thm]{Remark}
\numberwithin{equation}{section}
%\numberwithin{figure}{section}
%\numberwithin{table}{section}
%\setcounter{section}{-1}

% For breaking equations across multiple pages
% \allowdisplaybreaks[1]

\usepackage[colorinlistoftodos]{todonotes}
\newcommand{\erik}[1]{\todo[size=\tiny,color=green!30]{#1 \\ \hfill --- Erik}}
\newcommand{\Erik}[1]{\todo[size=\tiny,inline,color=green!30]{#1
      \\ \hfill --- Erik}}
\newcommand{\darij}[1]{\todo[size=\tiny,color=red!30]{#1 \\ \hfill --- Darij}}
\newcommand{\Darij}[1]{\todo[size=\tiny,inline,color=red!30]{#1
      \\ \hfill --- Darij}}
\newcommand{\travis}[1]{\todo[size=\tiny,color=blue!30]{#1 \\ \hfill --- Travis}}
\newcommand{\Travis}[1]{\todo[size=\tiny,inline,color=blue!30]{#1
      \\ \hfill --- Travis}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
\title[MLQs]{Multiline queues with spectral parameters}

\author[E.~Aas]{Erik Aas}
\address[E. Aas]{Department of Mathematics, Pennsylvania State University, McAllister Building, State College, PA 116802, USA}
\email{eaas@kth.se}

\author[D.~Grinberg]{Darij Grinberg}
\address[D. Grinberg]{School of Mathematics, University of Minnesota, 206 Church St. SE, Minneapolis, MN 55455}
\email{darijgrinberg@gmail.com}
\urladdr{http://www.cip.ifi.lmu.de/~grinberg/}

\author[T.~Scrimshaw]{Travis Scrimshaw}
\address[T. Scrimshaw]{School of Mathematics and Physics, The University of Queensland, St. Lucia, QLD 4072, Australia}
\email{tcscrims@gmail.com}
\urladdr{https://sites.google.com/view/tscrim/home}

\date{\today}

\keywords{multiline queue, TASEP, R-matrix, symmetric function}
\subjclass[2010]{
60C05,  % Combinatorial probability
05A19,  % Combinatorial identities, bijective combinatorics
16T25,  % Yang--Baxter equations
05E05}  % Symmetric functions

\thanks{TS was partially supported by the Australian Research Council DP170102648 and the National Science Foundation RTG grant DMS-1148634.}

\begin{abstract}
Using the description of multiline queues as functions on words, we introduce the notion of a spectral weight of a word by defining a new weighting on multiline queues.
We show that the spectral weight of a word is invariant under a natural action of the symmetric group, giving a proof of the commutativity conjecture of Arita, Ayyer, Mallick, and Prolhac.
We give a determinant formula for the spectral weight of a word, which gives a proof of a conjecture of the first author and Linusson.
\end{abstract}

\maketitle

%=====================================================================
\section{Introduction}
\label{sec:introduction}

One of the fundamental models of particles moving in a 1-dimensional lattice is the asymmetric simple exclusion process (ASEP), and it has received broad attention in many different variations.
The earliest known publication of the ASEP was done to model the dynamics of ribosomes along RNA~\cite{MGP68}.
For statistical mechanics, it is a model for gas particles in a lattice with an induced current, where the exclusion mimics the short-range interactions among the particles.
Despite admitting very simple descriptions of the particle dynamics, the ASEP has very rich macroscopic behaviors, such as
\begin{itemize}
\item boundary-induced phase transitions~\cite{Krug91},
\item spontaneous symmetry breaking with possibly multiple broken symmetry phases~\cite{AHR98,AHR99,CEM01,EFGM95,EPSZ05,GLEMSS95,PK07},
\item describing the formations of shocks~\cite{DJLS93,Ferrari92,FF94,FF94II,Liggett76}, and
\item phase separation and condensation~\cite{EKKM98,JNHWW09,KLMST02,RSS00}.
\end{itemize}
We also refer the reader to~\cite{PEM09,Schutz01,SZ95,TJHJ16} and references therein.

The term exclusion process was coined by Spitzer~\cite{Spitzer70}, where he was focused on an application with Brownian motion with hard-core interactions.
Moreover, it was~\cite{Spitzer70} that initiated the investigation of exclusion processes using probability theory.
However, the applications of the ASEP (and its variations) has since spread to other areas, such as
\begin{itemize}
\item transportation processes in capillary vessels~\cite{Levitt73} or proteins within the cells along actin filaments~\cite{KNL05},
\item anistropic conductors known as solid electrolytes~\cite{CL99},
\item discrete models of traffic flow~\cite{Schad01},
\item partition growth processes~\cite{Lam15},
\item (non)symmetric Macdonald polynomials, Koornwinder polynomials, and (deformed) Knizhnik--Zamolodchikov (KZ) equations~\cite{CdGW15,KT07},
\item random matrix theory~\cite{Johansson00,TW09}, and
\item moments of Askey--Wilson polynomials~\cite{CW11,USW04}.
\end{itemize}

If we prohibit the particles from moving backwards, we obtain the totally asymmetric exclusion process (TASEP), a non-equilibrium stochastic process that has its own vast literature.
For example, we refer the reader to~\cite{AasLin17,AAMP,BE07,BP14,DEHP93,KMO15,KMO16,Liggett99} and references therein.
In this paper, we consider the TASEP on a ring with $n$ sites and $\ell$ species of particles.
Thus, we will consider the states to be words $u$ in the alphabet $\{1, \dotsc, \ell\}$ of length $n$, where we take the indices to be $\ZZ / n \ZZ$.
We will also consider our process to be discrete in time, where our transition map interchanges a pair $u_i u_{i+1}$ with $u_i > u_{i+1}$ to $u_{i+1} u_i$ and is done at a uniform rate.

The steady state of the TASEP on a ring is known in terms of another process using ordinary multiline queues (MLQs) and applying the Ferrari--Martin (FM) algorithm~\cite{FM06,FM07}.
This is a generalization of 2-line queues used by Angel~\cite{Angel06} and the work of Ferrari, Fontes, and Kohayakawa~\cite{FFK94}.
In~\cite{KMO15,KMO16}, the FM algorithm was reformulated in terms of the combinatorial $R$-matrix~\cite{NY97,Shimozono02} and using type $A_{n-1}^{(1)}$ Kirillov--Reshetikhin crystals~\cite{KKMMNN92}.
This interpretation gives a connection with five-vertex models, corner transfer matrices~\cite{Baxter89}, 3D integrable lattice models, and the tetrahedron equation~\cite{Zam80}, yielding a matrix product formula for the steady state distribution different than~\cite{CdGW15,EFM09,PEM09}.

In this paper, we introduce a new weighting of MLQs, which is the weight of the MLQ considered as a tensor product of Kirillov--Reshetikhin crystals.
We also interpret MLQs as functions on words of a fixed length $n$ following~\cite{AAMP}, where it was referred to as the generalized FM algorithm.
This allows us to define the spectral weight or amplitude of a word $u$ to be the sum over all the weight of all ordinary MLQs $\qq$ such that $u = \qq(1^n)$, where $1^n$ is the word $1 \dotsm 1$.
Furthermore, we introduce the notion of a $\sigma$-twisted MLQ, where $\sigma$ is a permutation, although this is implicitly considered in~\cite{AAMP}.
Our main result (Theorem~\ref{thm:permutation}) is that for a fixed permutation $\sigma$, the sum of the weights of all $\sigma$-twisted MLQs $\qq_{\sigma}$ such that $u = \qq_{\sigma}(1^n)$ equals the spectral weight of $u$.
To this end, we construct an action of the symmetric group on MLQs that corresponds, under the usual FM algorithm, to the natural action by letters on words.
We show that does not change the MLQ as a function on words.
This action has previously appeared in a number of different guises, such as in Danilov and Koshevoy~\cite{DanilovKoshevoy} (see also~\cite[Ch.~4]{Gorodentsev2}), van Leeuwen~\cite[Lemma~2.3]{vanLeeuwen-dc}, and Lothaire~\cite[Ch.~5, (5.6.3)]{Loth}.
In the context of Kirillov--Reshetikhin crystals, it can be described as applying a combinatorial $R$-matrix to an MLQ, where the weight remaining invariant is a condition of being a crystal isomorphism.

As a consequence of this action and specializing our weight parameters to $1$, we obtain a proof of the commutativity conjecture of~\cite{AAMP}.
However, we note that the interlacing property of~\cite{AAMP} does not generalize to our weighting of MLQs.
Furthermore, we give a determinant expression for the spectral weight of decreasing words by using the Lindstr\"om--Gessel--Viennot Lemma~\cite{GV85,Lindstrom73}.
By combining these results, we obtain a proof of~\cite[Conj.~3.10]{AasLin17}, which in turn proves a number of other conjectures in~\cite{AasLin17}.

We note that our weighting scheme can be extended to multiline process used to determine the steady state distribution of the totally asymmetric zero range process (TARZP) on a ring, where multiple particles can occupy the same site.
This comes from the fact that the TARZP steady state distribution can also be computed using a tensor product of Kirillov--Reshetikhin crystals (under rank-level duality) using combinatorial $R$-matrices with analogous connections to corner transfer matrices and the tetrahedron equation~\cite{KMO16TARZP,KMO16TARZPII}.
Thus, we expect that a similar description of $\sigma$-twisted multiline process can be defined such that the weighting is invariant under the action of the combinatorial $R$-matrix.
Yet it seems unlikely that our weighting is related to the steady state distribution for the inhomogeneous TASEP~\cite{AM13,AL14} or TARZP~\cite{KMO16II}.

This paper is organized as follows.
In Section~\ref{sec:background}, we give the necessary background and definitions of MLQs and spectral weight.
In Section~\ref{sec:result}, we give our main results, and use them to prove some of the conjectures in~\cite{AasLin17}.
In Section~\ref{sec:tasep}, we describe the connection between MLQs and the TASEP.
In Section~\ref{sec:JT-proofs}, we give a proof of our Jacobi-Trudi-type formula (Theorem~\ref{thm:determinant_form}).
In Section~\ref{sec:thm_proof}, we give a proof of our main theorem (Theorem~\ref{thm:permutation}).
In Section~\ref{sec:remarks}, we give some additional remarks about our results.


\subsection{Acknowledgements}

We thank Atsuo Kuniba for explaining the results in his papers~\cite{KMO15,KMO16II,KMO16,KMO16TARZP,KMO16TARZPII}.
We thank Olya Mandelshtam for useful discussions on the inhomogeneous TASEP.
We thank Jae-Hoon Kwon for pointing out that the $\SymGp{n}$-action on MLQs comes from an $(\mathfrak{sl}_m \oplus \mathfrak{sl}_n)$-action.
This work benefited from computations using \textsc{SageMath}~\cite{sage,combinat}.









%=====================================================================
\section{Background and definitions}
\label{sec:background}

Fix a positive integer $n$.
For a nonnegative integer $k$, let $\ive{k}$ denote the set $\set{1, 2, \ldots, k}$, and so $[0] = \emptyset$.
Let $\SymGp{k}$ denote the symmetric group on $\ive{k}$, and let $s_i \in \SymGp{k}$ be the simple transposition of $i$ and $i+1$.
Let $w_0 \in \SymGp{k}$ be the longest element: the permutation $k (k-1) \dotsm 321$ (written in one line notation) that reverses the order of all elements.

We shall refer to the elements $1, 2, \ldots, n \in \ZZ / n \ZZ$ as \defn{sites}.
We visualize them as points on a line that ``wraps around'' cyclically; thus, for example, the sites weakly to the right of a site $i$ are $i, i+1, \ldots, n-1, n, 1, 2, 3, \ldots$ (in this order).

%%%%%%%%%%
\subsection{Words and queues}

Let $\mcW_n$ be the set of words $u = u_1 \dotsm u_n$ in the ordered alphabet $\mcA := \{1 < 2 < 3 < \cdots \}$.
We consider the indices of letters in a word to be taken modulo $n$ (that is, $u_{k+n} = u_k$ for all $k$).
Thus, if $u$ is a word and $i \in \ZZ / n \ZZ$ is a site, then the $i$-th letter $u_i$ of $u$ is well-defined.
We sometimes refer to a letter $u_i = t$ as a \defn{particle at site $i$ of class $t$}.

The \defn{type} of a word $u$ is the vector $\mm = (m_1, m_2, \ldots)$, where $m_i$ is the number of occurrences of $i$ in $u$.
Let $\ell = \max\{i \mid m_i \neq 0 \}$, which we say is the number of \defn{classes} in $u$ or $\mm$.
A word $u$ or type $\mm$ with $\ell$ classes is \defn{packed} if $m_i \neq 0$ for all $1 \leq i \leq \ell$.
A word $w$ of type $\mm$ is \defn{standard} if $m_i \leq 1$ for all $i$.
We will write $1^n = 1 \dotsm 1$ for the (unique) word of type $(n, 0, \dotsc)$.

We \defn{merge} two adjacent classes $i,i+1$ in a word $u$ to obtain a new word by replacing all occurrences of $j$ by $j-1$ in $u$ for each $j = i+1, i+2, \ldots$ in that order.
We denote the merging of $i$ and $i+1$ in $u$ by $\merge{i} u$.
Note that $\merge{i} u$ is packed whenever $u$ is packed.
For $T = \set{t_1 < \cdots < t_k} \subseteq \ive{\ell-1}$, we set $\bigvee_T u := \merge{t_1} \cdots \merge{t_k} u$.
Similarly, the merging of $i,i+1$ in a type $\mm = (m_1, m_2, \ldots)$ is $\merge{i}(\mm) = (m_1, \dotsc, m_{i-1}, m_i + m_{i+1}, m_{i+2}, \ldots)$.
These operations interact as one would hope:
If the type of a word $u$ is $\mm$, then the type of $\merge{i} u$ is $\merge{i}(\mm)$.

Fix a word $u \in \mcW_n$, and let $\mm = (m_1, m_2, \ldots)$ be the type of $u$.
For each $i \geq 0$, set
\begin{equation}
\label{eq:type_partial_sums}
p_i(\mm) := m_1 + m_2 + \cdots + m_i.
\end{equation}
When $\mm$ is clear, we simply write $p_i$ for this.
(Thus, $p_0 = 0$ and $p_i = n$ for sufficiently large $i$.)

\begin{vershort}
We define an \defn{$r$-queue} $q$ to be any subset of $\ive{n}$ of size $r$. When $r$ is clear, we will simply call $q$ a \defn{queue}.
We equate $q$ with a function from $\mcW_n$ to itself defined as follows.
For any $u \in \mcW_n$, the following algorithm computes $v = q(u)$.
\end{vershort}
\begin{verlong}
We define a \defn{queue} to be any set of sites.
%\travis{As I said on Skype, I do not like this extra level of indirection for the reader. You also loose some of the explicitness of the $n$ dependence.}
A queue of size $r$ will be called an \defn{$r$-queue}.
%\travis{I think it is much better to have the general definition as an $r$-queue. This otherwise is a useless definition as everywhere we should be saying ``Let $q$ be a queue of size $r$'' or ``Let $q$ be a queue such that $|q| = r$''.}

We shall now define an action of queues on words.
Namely, if $q$ is any queue and $u \in \mcW_n$ is a word,
then a new word $v = q(u) \in \mcW_n$ is defined by the following algorithm:
\end{verlong}
In the beginning, no letter of $v \in \mcW_n$ is set.
Choose a permutation $\tup{i_1, i_2, \ldots, i_n}$ of $\tup{1, 2, \ldots, n}$
such that $u_{i_1} \leq u_{i_2} \leq \cdots \leq u_{i_n}$.

\begin{description}
\item[Phase~I]
  For $i = i_n, i_{n-1}, \ldots, i_{\abs{q}+1}$, do the following.
    Find the first site $j$ weakly to the left (cyclically) of $i$ such that $j \notin q$ and $v_j$ is not set.
    Then set $v_j = u_i + 1$.

\item[Phase~II]
  For $i = i_1, i_2, \ldots, i_{\abs{q}}$, do the following.
    Find the first site $j$ weakly to the right (cyclically) of $i$ such that $j \in q$ and $v_j$ is not set.
    Then set $v_j = u_i$.
\end{description}

\begin{remark}
\label{rmk:order-agnostic}
Consider the above algorithm.
Notice that Phase~I sets $v_j$ for all $j \notin q$ (because it contains
$n - \abs{q}$ steps, and sets one such $v_j$ per step),
whereas Phase~II sets $v_j$ for all $j \in q$ (for similar reasons).
Hence, at the end of the algorithm, all letters of $v$ are set, and we never
run out of $j$'s in either phase.

Since Phase~I only deals with $j \notin q$, and Phase~II only with $j\in q$,
the two phases can be arbitrarily interleaved
(\textit{i.e.}, we can perform the steps of the algorithm in any order as long as
the steps of Phase~I (resp.\ Phase~II) are processed in the order $i = i_n, i_{n-1}, \ldots, i_{\abs{q}+1}$
(resp.\ $i = i_1, i_2, \ldots, i_{\abs{q}}$).
\end{remark}

\begin{lemma}
\label{lemma:order_indep}
The resulting word $v = q(u)$ does not depend on the choice of permutation $(i_1, i_2, \dotsc, i_n)$
(as long as $u_{i_1} \leq u_{i_2} \leq \cdots \leq u_{i_n}$ holds).
\end{lemma}

\begin{proof}
Consider some $k \in \ive{n-1}$ such that $u_{i_k} = u_{i_{k+1}}$.
If we switch the two adjacent entries $i_k$ and $i_{k+1}$ of the
permutation $\tup{i_1, i_2, \ldots, i_n}$,
then the resulting word $v$ is unchanged.
Indeed, if we set $h = u_{i_k} = u_{i_{k+1}}$, then:
\begin{itemize}
 \item If $k < \abs{q}$, then this switch interchanges two consecutive
       steps in Phase~II, causing the corresponding letters $v_j$ to
       get set in a possibly different order; but this does not change $v$
       because these two letters are set to the same value
       (namely, to $h+1$).
 \item If $k > \abs{q}$, then a similar argument works (using Phase~I instead).
 \item If $k = \abs{q}$, then recall from Remark~\ref{rmk:order-agnostic} that
       the two phases can be arbitrarily interleaved.
       In particular, we can first perform all but the last step of Phase~I,
       then perform all but the last step of Phase~II,
       and finally perform the remaining two steps.
       The switch only affects these final two steps.
       However, the effect of these two steps is simply that the unique
       remaining unset $v_j$ with $j \in q$ gets set to $h$,
       and the unique remaining unset $v_j$ with $j \notin q$ gets set to $h+1$.
       The switch clearly does not change this behavior,
       since it does not depend on $i_k$ and $i_{k+1}$.
\end{itemize}
\end{proof}

Lemma~\ref{lemma:order_indep} states that the order between sites $i$ with equal $u_i$ does not matter.

\begin{remark}
\label{rmk:t-splitting}
Let $u$ and $q$ be as before. Let $r = \abs{q}$.
There exists a $t \in \ive{\ell}$ such that
$
p_{t-1} \leq r \leq p_t.
$
The word $v = q(u)$ then has type
\begin{equation}
\label{eq:queue_type_change}
(m_1, \dots, m_{t-1}, r-p_{t-1}, p_{t}-r, m_{t+1}, m_{t+2}, \ldots).
\end{equation}
Note that $p_{t} - r = m_{t} + (p_{t-1} - r)$.
We think of this as splitting the class $t$ into two new classes $t$ and $t+1$. % and so we call $t$ the \defn{splitting class} of $q(u)$.

For all $i$ processed in Phase~I (resp.\ Phase~II) of the algorithm, we have $u_i \geq t$ (resp.~$u_i \leq t$).
The queue $q$ can be reconstructed from $v$ and $t$ as the set of all $j \in \ive{n}$ satisfying $v_j \leq t$.
\end{remark}

\begin{example}
\label{ex:first_queue}
We consider the $4$-queue $q = \{1, 4, 8, 9\}$, and let $u = 346613321$.
Thus, the type of $u$ is $\mm = (2, 1, 3, 1, 0, 2, 0, \ldots)$ with $p_2 = 3$ and $p_3 = 6$.
Thus, the $t$ in Remark~\ref{rmk:t-splitting} equals $3$.
To compute $q(u)$, draw the following diagram
(whose upper row shows $u$, whose lower row shows $q(u)$,
and whose middle row represents the set $q$ by balls in the positions of its elements):
\[
\begin{tikzpicture}[>=latex,rounded corners,yscale=1.5,xscale=1.2,baseline=0]
\def\passwidth{3pt};
\node (i1) at (1,1) {$3$};
\node (i2) at (2,1) {$4$};
\node (i3) at (3,1) {$6$};
\node (i4) at (4,1) {$6$};
\node (i5) at (5,1) {$1$};
\node (i6) at (6,1) {$3$};
\node (i7) at (7,1) {$3$};
\node (i8) at (8,1) {$2$};
\node (i9) at (9,1) {$1$};
\node (t1) at (1,-1) {$2$};
\node (t2) at (2,-1) {$7$};
\node (t3) at (3,-1) {$7$};
\node (t4) at (4,-1) {$3$};
\node (t5) at (5,-1) {$4$};
\node (t6) at (6,-1) {$4$};
\node (t7) at (7,-1) {$5$};
\node (t8) at (8,-1) {$1$};
\node (t9) at (9,-1) {$1$};
\node[circle,draw=black] (q1) at (1,0) {};
\node[circle,draw=black] (q2) at (4,0) {};
\node[circle,draw=black] (q3) at (8,0) {};
\node[circle,draw=black] (q4) at (9,0) {};
\draw[->,red] (i4) -- (4,0.5) .. controls (3.8,0.2) and (3.5,0) .. (3.1,0) -- (2,0) -- (t2);
\draw[->,red] (i3) -- (t3);
\draw[->,red] (i2) -- (2,0.15) .. controls (1.8,-0.2) and (1.6,-0.25) .. (1.3,-0.25) -- (0,-0.25);
\draw[>->,red] (10,-0.25) -- (8,-0.25) -- (7,-0.25) -- (t7);
\draw[->,red] (i6) -- (t6);
\draw[->,red] (i7) -- (7,0) -- (5,0) -- (t5);
\draw[white,line width=\passwidth] (5,0.28) -- (7.3,0.28) .. controls (7.7,0.28) and (7.85,0.12) .. (q3);  % To simulate underpass
\draw[->,blue] (i5) -- (5,0.28) -- (7.3,0.28) .. controls (7.7,0.28) and (7.85,0.12) .. (q3);
\draw[white,line width=\passwidth] (q3) -- (t8);  % To simulate underpass
\draw[->,blue] (q3) -- (t8);
\draw[->,blue] (i9) -- (q4);
\draw[white,line width=\passwidth] (q4) -- (t9);  % To simulate underpass
\draw[->,blue] (q4) -- (t9);
\draw[white,line width=\passwidth] (1,0.28) -- (3.3,0.28) .. controls (3.7,0.28) and (3.85,0.12) .. (q2);  % To simulate underpass
\draw[->,blue] (i1) -- (1,0.28) -- (3.3,0.28) .. controls (3.7,0.28) and (3.85,0.12) .. (q2);
\draw[->,blue] (q2) -- (t4);
\draw[white,line width=\passwidth] (i8) -- (8,0.28) -- (10,0.28);  % To simulate underpass
\draw[->,blue] (i8) -- (8,0.28) -- (10,0.28);
\draw[>->,blue] (0,0.28) -- (0.3,0.28) .. controls (0.7,0.28) and (0.85,0.12) .. (q1);
\draw[white,line width=\passwidth] (q1) -- (t1);  % To simulate underpass
\draw[->,blue] (q1) -- (t1);
\end{tikzpicture}
\]
\begin{vershort}
where the paths in red correspond to Phase~I and those in blue are from Phase~II.
\end{vershort}
\begin{verlong}
where the paths in red correspond to Phase~I and those in blue are from Phase~II
(and where we have picked the permutation $\tup{i_1, i_2, \ldots, i_n}
= \tup{5, 9, 8, 1, 7, 6, 2, 4, 3}$ out of a total of $2! \cdot 3! \cdot 2! = 24$ permutations
satisfying $u_{i_1} \leq u_{i_2} \leq \cdots \leq u_{i_n}$;
but any other among them would lead to the same result).
\end{verlong}
Hence, we have $q(346613321) = 277344511$, which has type $(2,1,1,2,1,0,2,\ldots)$.
\end{example}

We illustrate the situation $v = q(u)$ with a $2 \times n$ array, where the first row is the word $u$
and the second row has a circle labeled $v_j$ for $j \in q$ or a square labeled $v_j$ for $j \notin q$ in position $j$.
Using this convention, we can write Example~\ref{ex:first_queue} as
\begin{equation}
\begin{tikzpicture}[baseline=10]
  \def\ll{0.65}   % level 2
  \foreach \i in {5,9} { \node at (\i,\ll) {$1$}; }
  \foreach \i in {8} { \node at (\i,\ll) {$2$}; }
  \foreach \i in {1,6,7} { \node at (\i,\ll) {$3$}; }
  \foreach \i in {2} { \node at (\i,\ll) {$4$}; }
  \foreach \i in {3,4} { \node at (\i,\ll) {$6$}; }
  \foreach \i in {1,4,8,9} { \draw (\i,0) circle (0.3); }
  \foreach \i in {2,3,5,6,7} { \draw (\i-.3,0-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {8,9} { \node at (\i,0) {$1$}; }
  \foreach \i in {1} { \node at (\i,0) {$2$}; }
  \foreach \i in {4} { \node at (\i,0) {$3$}; }
  \foreach \i in {5,6} { \node at (\i,0) {$4$}; }
  \foreach \i in {7} { \node at (\i,0) {$5$}; }
  \foreach \i in {2,3} { \node at (\i,0) {$7$}; }
\end{tikzpicture}
\label{eq:boxes-and-balls-1}
\end{equation}

\begin{comment}  % s-flow only seems to be used in this paragraph
Consider a pair $k, k+1 \pmod{n}$ of consecutive columns.
For $s > t$ the \defn{$s$-flow} from $k+1$ to $k$ is the number of $i$ such that $u_i=s$, and whose queueing interval $\inter[j,i]$ contains both $k$ and $k+1$.
Similarly, for $s < t$, the \defn{$s$-flow} from $k$ to $k+1$ is the number of $i$ such that $u_i = s$, and whose queueing interval $\inter[i,j]$ contains both $k$ and $k+1$.
\end{comment}

There is a natural duality in the algorithm above.
For each queue $q$, let $q^*$ be the \defn{contragredient dual queue}, defined by $\tup{i \in q^*} \Longleftrightarrow \tup{n+1-i \notin q}$.
Similarly, for each word $u$ with $\ell$ classes, let $u^*$ be the \defn{contragredient dual word} defined by $u^*_i = \ell + 1 - u_{n+1-i}$.
For a fixed $k \in \ive{\ell}$, we call $\ell + 1 - k$ the \defn{contragredient dual letter} of $k$.
Note that if $q$ is an $r$-queue, then $q^*$ is the $(n-r)$-queue obtained by reflecting $[n] \setminus q$ through the middle of $[n]$.
Similarly, $u^*$ is obtained by reversing the word $u$ and taking the contragredient dual letters.

\begin{lemma}[Contragredient duality]
  \label{le:dual}
  Let $q$ be a queue and $u$ be a word with $\ell$ classes.
  Then we have $\bigl(q(u) \bigr)^* = q^*(u^*)$, \textit{i.e.}, we have $q(u)_i = \ell + 2 - q^*(u^*)_{n+1-i}$ for all $i$.
\end{lemma}

Here, we treat $q(u)$ as a word with $\ell+1$ classes, even if it may have only $\ell$ classes (in the degenerate case when $q = \ive{n}$).

\begin{proof}
Phase~I (resp.~II) in the construction of $q(u)$ corresponds to Phase~II (resp.~I) in the construction of $q^*(u^*)$ when the word is reversed and the letters are replaced by their contragredient duals.
Hence the claim follows.
\end{proof}

%\begin{remark} (Excision)
%  Fix a queue $q$ and a word $u$, and let $i,j$ be columns. Suppose that the $s$-flow from $j+1$ to $j$ equals the $s$-flow from $i+1$ to $i$ for each $s > t$, and that the $s$-flow from $i$ to $i+1$ equals the $s$-flow from $j$ to $j+1$ for each $s < t$. Then we have $q_{|\inter[i,j]^c}(u_{|\inter[i,j]^c}) = \bigl( q(u) \bigr)_{|\inter[i,j]^c}$. Here, for a (cyclic) word $u$, we let $u_{|\inter[i,j]^c}$ denote the (cyclic) word gotten from simply removing the closed (cyclic) interval $\inter[i,j]$, and similarly for $q_{|\inter[i,j]^c}$.
%\end{remark}

We note that our construction is a minor variation of the construction given by~\cite[\S 3.1]{AAMP}, which is a reformulation of that of~\cite{FM07}.
We more precisely describe the relationship with~\cite{FM07} in Appendix~\ref{app:queue-relations}, where we also discuss a small variant that has appeared in~\cite{AssSea18}.


%%%%%%%%%%
\subsection{Multiline queues}

We now give our main definition of a multiline queue and spectral weight.

\begin{dfn}
For $\sigma \in \SymGp{\ell-1}$, a \defn{$\sigma$-twisted multiline queue (MLQ) of type $\mm = \tup{m_1, m_2, \ldots, m_\ell, 0, 0, \ldots}$}, with $\ell$ classes, is a sequence of queues $\qq = (q_1, \dotsc, q_{\ell-1})$ such that $q_i$ is a $p_{\sigma(i)}(\mm)$-queue and $m_{\ell} = n - p_{\ell-1}(\mm)$ (that is, $p_\ell(\mm) = n$).
When $\sigma$ is the identity permutation, we simply call $\qq$ an \defn{(ordinary) MLQ of type $\mm$}.
We also consider $\qq$ as a function on words by
\[
\qq(u) := q_{\ell-1}\bigl( \cdots q_2\bigl( q_1(u) \bigr) \cdots \bigr).
\]
\end{dfn}

\begin{remark}
Our notion of an (ordinary) MLQ is equivalent to what is called a ``discrete MLQ'' in~\cite[\S 2.2]{AasLin17}, where we can recover the labeling of level $k$ from the word $q_k( \cdots q_1(1^n) \cdots )$.
See Appendix~\ref{app:queue-relations} for more details.
We omit the word ``discrete'' as these are the only MLQs in this note.
\end{remark}

We shall now introduce generating functions for queues.

\begin{dfn}
Let $\xx := \{x_1, x_2, \ldots, x_n\}$ be commuting indeterminates indexed by elements of $\ZZ / n \ZZ$.
(Thus, $x_{n+k} = x_k$ for all $k \in \ZZ$.)
The \defn{weight} of a queue $q$ is
\[
  \wt(q) := \prod_{i \in q} x_i.
\]
The \defn{weight} of a $\sigma$-twisted MLQ $\qq = (q_1, \dotsc, q_{\ell-1})$ is
\[
  \wt(\qq) := \prod_{i=1}^{\ell-1} \wt(q_i).
\]
\end{dfn}

\begin{dfn}
For $\sigma \in \SymGp{\ell-1}$ and a packed word $u$ of type $\mm$ with $\ell$ classes, we define the \defn{$\sigma$-spectral weight} or \defn{$\sigma$-amplitude} as
\[
%\begin{equation}
%\label{eq:amplitude}
  \swt{u}_{\sigma} := \sum_{\qq} \wt(\qq),
%\end{equation}
\]
where the sum is over all $\sigma$-twisted MLQs $\qq$ of type $\mm$ satisfying $u = \qq(1^n)$.
(Recall that $1^n$ denotes the word in $\mcW_n$ whose all letters are $1$.)
When $\sigma = \id$ is the identity permutation, we simply call this the \defn{spectral weight} or \defn{amplitude} and denote it by $\swt{u} := \swt{u}_{\id}$.
\end{dfn}

\begin{lemma}
\label{rmk:mlq-type}
Let $\ell \geq 1$ and $\sigma \in \SymGp{\ell-1}$.
Let $\qq$ be a $\sigma$-twisted MLQ.
Then the type of the word $\qq(1^n)$ is the type of $\qq$.
\end{lemma}

\begin{vershort}
\begin{proof}
Repeatedly apply~\eqref{eq:queue_type_change}.
\end{proof}
\end{vershort}

\begin{verlong}
\begin{proof}
Write the $\sigma$-twisted MLQ $\qq$ as $\tup{q_1, \ldots, q_{\ell-1}}$.
Let $\mm = \tup{m_1, m_2, \ldots, m_\ell, 0, 0, \ldots}$ be the type of $\qq$.
Thus, $m_1 + m_2 + \cdots + m_\ell = p_{\ell}(\mm) = n$.
Now, the word $1^n$ has type $\tup{n, 0, 0, \ldots} = \tup{m_1 + m_2 + \cdots + m_\ell, 0, 0, \ldots}$
(since $n = m_1 + m_2 + \cdots + m_\ell$).
Every time we apply one of the queues $q_i$ to this word, the type changes in a simple way (because of~\eqref{eq:queue_type_change}): Namely, the plus sign between $m_{\sigma(i)}$ and $m_{\sigma(i)+1}$ turns into a comma (so, for example, the application of $q_1$ transforms it into $\tup{m_1 + m_2 + \cdots + m_{\sigma(1)}, m_{\sigma(1)+1} + m_{\sigma(1)+2} + \cdots + m_\ell, 0, 0, \ldots}$).
Hence, the action of $\qq$ transforms $1^n$ into a word whose type has all the plus signs replaced by commas -- \textit{i.e.}, whose type is $\tup{m_1, m_2, \ldots, m_\ell, 0, 0, \ldots} = \mm$.
In other words, the type of the word $\qq(1^n)$ is $\mm$.
This proves Lemma~\ref{rmk:mlq-type}.

[The above proof is a bit informal.
To make it more rigorous, we can proceed as follows: Since $\tup{q_1, \ldots, q_{\ell-1}} = \qq$ is a $\sigma$-twisted MLQ of type $\mm$, we know that the sizes $\abs{q_1}, \abs{q_2}, \ldots, \abs{q_{\ell-1}}$ of its queues are a permutation of $p_1(\mm), p_2(\mm), \ldots, p_{\ell-1}(\mm)$.
Thus, $p_1(\mm), p_2(\mm), \ldots, p_{\ell-1}(\mm)$ is the weakly increasing permutation of the sequence $\abs{q_1}, \abs{q_2}, \ldots, \abs{q_{\ell-1}}$.
Now, define the \defn{p-sequence} of a type $\nn$ to be the weakly increasing infinite sequence $\tup{p_0(\nn), p_1(\nn), p_2(\nn), \ldots}$ of integers (which uniquely determines $\nn$).
Furthermore, if $u$ is a word of type $\nn$, then we define the p-sequence of $u$ to be the p-sequence of $\nn$.
Then,~\eqref{eq:queue_type_change} shows the following: If $q$ is a queue and $u$ is a word, then the p-sequence of $q(u)$ is obtained from the p-sequence of $u$ by inserting $\abs{q}$ into the p-sequence at the appropriate position (appropriate in the sense that the resulting sequence is still weakly increasing).
Hence, the p-sequence of the word $\qq (1^n)$ is obtained from the p-sequence $\tup{0, n, n, n, \ldots}$ of the word $1^n$ by inserting $\abs{q_1}, \abs{q_2}, \ldots, \abs{q_{\ell-1}}$ at the appropriate positions.
In other words, the p-sequence of the word $\qq (1^n)$ is $\tup{0, p_1(\mm), p_2(\mm), \ldots, p_{\ell-1}(\mm), n, n, \ldots, n}$ (since $p_1(\mm), p_2(\mm), \ldots, p_{\ell-1}(\mm)$ is the weakly increasing permutation of the sequence $\abs{q_1}, \abs{q_2}, \ldots, \abs{q_{\ell-1}}$).
In other words, this p-sequence is $\tup{p_0(\mm), p_1(\mm), p_2(\mm), \ldots}$.
Hence, the type of the word $\qq (1^n)$ is $\mm$.]
\end{proof}
\end{verlong}

\begin{example}
Let $\ell \geq 1$.
Let $u$ be a packed word with $\ell$ classes and type $\mm$.
For each $k \in \ive{\ell-1}$, let $q_k$ be the set of all sites $i$ such that $u_i \leq k$.
It is then easy to check that $\qq := \tup{q_1, q_2, \ldots, q_{\ell-1}}$ is an
MLQ of type $\mm$ satisfying $\qq(1^n) = u$ and has weight
$\wt(\qq) = \prod_{j \in \ZZ / n \ZZ} x_j^{\ell - u_j}$.
Hence, $\swt{u} \neq 0$ (as a polynomial over $\ZZ$).
\end{example}




%%%%%%%%%%
\subsection{Symmetric polynomials}

We also need the \defn{elementary symmetric polynomials} and \defn{complete homogeneous symmetric polynomials}.
Recall that they are defined for each $N \in \NN$ and $k \geq 0$ and any $N$ indeterminates $y_1, y_2, \ldots, y_N$ by
\begin{align*}
e_k(y_1, y_2, \dotsc, y_N) & = \sum_{1 \leq i_1 < \cdots < i_k \leq N} y_{i_1} \dotsm y_{i_k},
\\ h_k(y_1, y_2, \dotsc, y_N) & = \sum_{1 \leq i_1 \leq \cdots \leq i_k \leq N} y_{i_1} \dotsm y_{i_k},
\end{align*}
respectively.
We define $e_k(y_1, \dotsc, y_N) = 0$ and $h_k(y_1, \dotsc, y_N) = 0$ for $k < 0$.
For more details on symmetric polynomials, we refer the reader to~\cite[Ch.~7]{Stanley-EC2}.








%=====================================================================
\section{Main results}
\label{sec:result}


In this section, we state our main results and use them to prove the commutativity conjecture of~\cite{AAMP} and~\cite[Conj.~3.10]{AasLin17}.

\subsection{$\sigma$-independence of the spectral weight}

\begin{thm}
\label{thm:permutation}
  Let $u$ be a packed word of type $\mm$ with $\ell$ classes.
  For any $\sigma \in \SymGp{\ell-1}$, we have 
  \[
  \swt{u} = \swt{u}_{\sigma}.
  \]
\end{thm}

We will give the proof of Theorem~\ref{thm:permutation} in Section~\ref{sec:thm_proof}.
%In order to prove our next result, we need the following.

\subsection{Queue action and merges}
We shall next study the interplay between the action of queues on words and the merging of adjacent classes.

If $w$ is a word of type $\mm$, and if $j \geq 0$, then $p_j(\mm)$ is the number of letters of $w$ that are at most $j$.

For a word $w$ and a nonnegative integer $k$, we let \defn{$\vee^{(k)} w$} be the word obtained from $w$ by decrementing (by $1$) all but the $k$ smallest letters of $w$.
This is only well-defined if these $k$ smallest letters are determined uniquely and the remaining $n-k$ letters are $> 1$.
In other words, this is only well-defined if $k \in \set{ p_j(\mm) \mid j \geq 1 }$, where $\mm$ is the type of $w$.
Note that $\vee^{(k)} w = \merge{j} w$, where $j$ is such that $k = p_j(\mm)$.
% Note that $j$ is not necessarily unique, in which case $w$ is not a packed word, but the result is independent of the choice of $j$.

% \Travis{I am becoming less convinced of this notation as it makes things less explicit.
% Well-definedness is equivalent to the existence of a $j$ such that $p_j(\mm) = k$, and we really want to do the $j$-merge.
% It might be a little extra verbage, but I feel like it means more details and concepts are on the surface.}

\begin{lemma}
\label{lemma:queue_merge_commute}
Let $u \in \mcW_n$ be a word of type $\mm$.
Let $k \in \set{ p_j(\mm) \mid j \geq 1 }$.
If $q$ is a queue, then
\[
\vee^{(k)} q(u) = q(\vee^{(k)} u).
\]
In particular, both $\vee^{(k)} q(u)$ and $\vee^{(k)} u$ are well-defined.
\end{lemma}

\begin{proof}
The word $\vee^{(k)} u$ is well-defined since $k = p_j(\mm)$ for some $j \geq 1$;
furthermore, $\vee^{(k)} q(u)$ is well-defined since the type $\nn$ of $q(u)$
satisfies
\[
k \in \set{ p_j(\mm) \mid j \geq 1 } \subseteq \set{ p_j(\mm) \mid j \geq 1 } \cup \set{\abs{q}} = \set{ p_j(\nn) \mid j \geq 1 }.
\]
Thus, it remains to prove $\vee^{(k)} q(u) = q(\vee^{(k)} u)$.
The permutation $\tup{i_1, i_2, \dotsc, i_n}$ in the construction of $q(u)$
also works for the construction of $q(\vee^{(k)} u)$,
since $(\vee^{(k)} u)_a \leq (\vee^{(k)} u)_b$ whenever $u_a \leq u_b$.
Consequently, the construction of $q(\vee^{(k)} u)$ proceeds exactly like
the construction of $q(u)$ (with the same entries being set in the same
order), except that all but the $k$ smallest letters are now smaller by $1$.
Hence, $q(\vee^{(k)} u)$ is obtained from $q(u)$ by decrementing (by $1$)
all but the $k$ smallest letters of $q(u)$.
% (since $\vee^{(k)} u$ is obtained in this way from $u$).
However, the word $\vee^{(k)} q(u)$ is obtained from $q(u)$ in exactly the same way.
Therefore, we have $\vee^{(k)} q(u) = q(\vee^{(k)} u)$ as claimed.
\end{proof}

\begin{example}
Consider $q = \set{1,4,5,9,10}$ and $v = 3455313321$:
\[
\begin{tikzpicture}[baseline=-7]
  \def\ll{0.65}   % level 2
  \foreach \i in {6,10} { \node at (\i,\ll) {$1$}; }
  \foreach \i in {9} { \node at (\i,\ll) {$2$}; }
  \foreach \i in {1,5,7,8} { \node at (\i,\ll) {$3$}; }
  \foreach \i in {2} { \node at (\i,\ll) {$4$}; }
  \foreach \i in {3,4} { \node at (\i,\ll) {$5$}; }
  \foreach \i in {1,4,5,9,10} { \draw (\i,0) circle (0.3); }
  \foreach \i in {2,3,6,7,8} { \draw (\i-.3,0-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {9,10} { \node at (\i,0) {$1$}; }
  \foreach \i in {1} { \node at (\i,0) {$2$}; }
  \foreach \i in {4,5} { \node at (\i,0) {$3$}; }
  \foreach \i in {6,7} { \node at (\i,0) {$4$}; }
  \foreach \i in {8} { \node at (\i,0) {$5$}; }
  \foreach \i in {2,3} { \node at (\i,0) {$6$}; }
\end{tikzpicture}\ .
\]
Let $u = 3566413321$, and note that $v = \merge{3} u = \vee^{(6)} u$ and
\[
\begin{tikzpicture}[baseline=-7]
  \def\ll{0.65}   % level 2
  \foreach \i in {6,10} { \node at (\i,\ll) {$1$}; }
  \foreach \i in {9} { \node at (\i,\ll) {$2$}; }
  \foreach \i in {1,7,8} { \node at (\i,\ll) {$3$}; }
  \foreach \i in {5} { \node at (\i,\ll) {$4$}; }
  \foreach \i in {2} { \node at (\i,\ll) {$5$}; }
  \foreach \i in {3,4} { \node at (\i,\ll) {$6$}; }
  \foreach \i in {1,4,5,9,10} { \draw (\i,0) circle (0.3); }
  \foreach \i in {2,3,6,7,8} { \draw (\i-.3,0-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {9,10} { \node at (\i,0) {$1$}; }
  \foreach \i in {1} { \node at (\i,0) {$2$}; }
  \foreach \i in {4,5} { \node at (\i,0) {$3$}; }
  \foreach \i in {6} { \node at (\i,0) {$4$}; }
  \foreach \i in {7} { \node[red] at (\i,0) {$5$}; }
  \foreach \i in {8} { \node[dgreencolor] at (\i,0) {$6$}; }
  \foreach \i in {2,3} { \node[dgreencolor] at (\i,0) {$7$}; }
\end{tikzpicture}\ ,
\]
where we have $2663344511 = \merge{4} 2773345611 = \vee^{(6)} 2773345611$.
Similarly, let $u' = 4566413421$, and note that $v = \merge{3} u'$ and
\[
\begin{tikzpicture}[baseline=-7]
  \def\ll{0.65}   % level 2
  \foreach \i in {6,10} { \node at (\i,\ll) {$1$}; }
  \foreach \i in {9} { \node at (\i,\ll) {$2$}; }
  \foreach \i in {7} { \node at (\i,\ll) {$3$}; }
  \foreach \i in {1,5,8} { \node at (\i,\ll) {$4$}; }
  \foreach \i in {2} { \node at (\i,\ll) {$5$}; }
  \foreach \i in {3,4} { \node at (\i,\ll) {$6$}; }
  \foreach \i in {1,4,5,9,10} { \draw (\i,0) circle (0.3); }
  \foreach \i in {2,3,6,7,8} { \draw (\i-.3,0-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {9,10} { \node at (\i,0) {$1$}; }
  \foreach \i in {1} { \node at (\i,0) {$2$}; }
  \foreach \i in {4} { \node[blue] at (\i,0) {$3$}; }
  \foreach \i in {5} { \node[dgreencolor] at (\i,0) {$4$}; }
  \foreach \i in {6,7} { \node[dgreencolor] at (\i,0) {$5$}; }
  \foreach \i in {8} { \node[dgreencolor] at (\i,0) {$6$}; }
  \foreach \i in {2,3} { \node[dgreencolor] at (\i,0) {$7$}; }
\end{tikzpicture}\ ,
\]
where we have $2663344511 = \merge{4} 2773455611$.
\end{example}

\begin{lemma}
\label{lemma:queue_merge}
  Let $q'$ be a $p_i(\mm)$-queue for some type $\mm$ and some $i \geq 1$.
  Let the type $\mm$ have $\ell$ classes, and let $\sigma \in \SymGp{\ell-1}$.
  Let $\qq$ be a $\sigma$-twisted MLQ of type $\merge{i}\mm$.
  % Darij: Yes, we need $\sigma$-twisted here, due to how we apply this
  % lemma repeatedly in the proof of Theorem~\ref{thm:determinant_form}.
  % (To apply it repeatedly, we need $\sigma$-twisted MLQs, since an
  % MLQ might become $\sigma$-twisted after the first application.)
  For the word
  $
  u = \qq\bigl( q'(1^n) \bigr),
  $
  we have
  \[
  \qq(1^n) = \merge{i} u.
  \]
\end{lemma}

\begin{proof}
\begin{comment}
Let us first show an auxiliary observation.
Let $q$, $u$ and $t$ be as in Remark~\ref{rmk:t-splitting},
and let $h \in \set{1, 2, \ldots}$.
The permutation $\tup{i_1, i_2, \ldots, i_n}$ in the construction of $q(u)$
also works for the construction of $q(\merge{h} u)$,
since $(\merge{h} u)_a \leq (\merge{h} u)_b$ whenever $u_a \leq u_b$.
Thus, the construction of $q(\merge{h} u)$ proceeds exactly as the
construction of $q(u)$, except that the letters used to build
the former word are those of $\merge{h} u$ instead of those of $u$.
This yields an expression for each letter $(q(\merge{h} u))_i$ of
$q(\merge{h} u)$ depending on whether ...
\begin{equation}
 q(\merge{h} u) = \begin{cases}
                   \merge{h} q(u) , & \text{ if } h < t ; \\
                   \merge{h+1} q(u) , & \text{ if } h \geq t
                  \end{cases} .
\label{pf.lemma:queue_merge.1}
\end{equation}
\end{comment}
Write the $\sigma$-twisted MLQ $\qq$ as $\tup{q_1, \ldots, q_{\ell-1}}$.
It has type $\merge{i} \mm$.

Set $\qq' := \tup{q', q_1, \ldots, q_{\ell-1}}$; this is easily
seen to be a $\zeta$-twisted MLQ of type $\mm$, for some
$\zeta \in \SymGp{\ell}$
(since the multiset of the $p_k(\merge{i}\mm)$ for $k \geq 1$
is precisely the multiset of the $p_k(\mm)$ for $k \geq 1$
with one copy of $p_i(\mm) = \abs{q'}$ removed).
Furthermore, the definition of $u$ becomes $u = \qq' (1^n)$.
Hence, the type of $u$ is $\mm$ (by Lemma~\ref{rmk:mlq-type}).

Set $k = p_i(\mm)$. Then, $q'$ is a $k$-queue, so that the type
$\nn$ of the word $q'(1^n)$ satisfies $p_1(\nn) = k$.
Hence, any word obtained by actions of queues on $q'(1^n)$
will have its type $\nn$ satisfy
$k \in \set{ p_j(\nn) \mid j \geq 1 } $.

Since the type of $u$ is $\mm$, and since $k = p_i(\mm)$, we have
\begin{equation}
\label{pf.lemma:queue_merge.4}
 \merge{i} u = \vee^{(k)} (u) = \vee^{(k)} \qq\bigl( q' (1^n) \bigr) = \qq\bigl( \vee^{(k)} q' (1^n) \bigr)
\end{equation}
by repeated use of Lemma~\ref{lemma:queue_merge_commute}
(since any word obtained by actions of queues on $q'(1^n)$
will have its type $\nn$ satisfy
$k \in \set{ p_j(\nn) \mid j \geq 1 } $).
It is clear that $\vee^{(k)} q'(1^n) = 1^n$,
and so~\eqref{pf.lemma:queue_merge.4} becomes $\qq(1^n) = \merge{i} u$.
\end{proof}

\subsection{Spectral weights of merged words}

The preceding lemmas will help us establish a rule for products of spectral weights with elementary symmetric polynomials (somewhat similar to the dual Pieri rule, \textit{e.g.}, \cite[Section 7.15]{Stanley-EC2}):

\begin{thm}
\label{thm:merge}
  Let $\mm$ be a type with $m_i \neq 0$ and $m_{i+1} \neq 0$.
  Let $v$ be a packed word of type $\merge{i}\mm$.
  Then,
  \[
  \swt{v} e_{p_i(\mm)}(x_1, \dotsc, x_n) = \sum_u \swt{u},
  \]
where we sum over all $u$ of type $\mm$ such that $v = \merge{i} u$.
\end{thm}

\begin{proof}
  The type $\mm$ is packed (since $m_i \neq 0$ and $m_{i+1} \neq 0$,
  and since $\merge{i}\mm$ is packed).
  Let $\merge{i}\mm$ have $\ell$ classes; then, $\mm$ has $\ell+1$
  classes.
  First note that
  \[
  \swt{v} e_{p_i(\mm)}(x_1, \dotsc, x_n) = \sum_{(\qq,q')} \wt(\qq) \wt(q'),
  \]
  where we sum over all pairs $(\qq, q')$ such that
  \begin{itemize}
  \item $\qq = (q_1, \dotsc, q_{\ell-1})$ is an MLQ of type $\merge{i}\mm$ such that $v = \qq(1^n)$ and
  \item $q'$ is a $p_i(\mm)$-queue.
  \end{itemize}
  Given any such pair $\tup{\qq, q'}$, we set
  \[
  \theta(\qq, q') := (q', q_1, \dotsc, q_{\ell-1});
  \]
  the result is a $(s_{i-1} \dotsm s_2 s_1)$-twisted MLQ of type $\mm$ with weight
  $\wt\bigl( \theta(\qq, q') \bigr) = \wt(\qq) \wt(q')$.
  But recall that $v = \qq(1^n$); thus, by Lemma~\ref{lemma:queue_merge}, we have
  \[
  v = \qq(1^n) = \merge{i} \qq\bigl( q'(1^n) \bigr) = \merge{i} \bigl( \theta(\qq, q')(1^n) \bigr).
  \]
  Thus, we have defined a weight preserving bijection $\theta$ from the set of all pairs $(\qq, q')$ as above
  to the set of all $(s_{i-1} \dotsm s_1)$-twisted MLQs $\widetilde{\qq}$ of type $\mm$ satisfying $v = \merge{i} \widetilde{\qq} (1^n)$.
  Hence, we have
  \[
  \sum_{(\qq,q')} \wt(\qq) \wt(q')
  = \sum_{\widetilde{\qq}} \wt(\widetilde{\qq})
  = \sum_u \swt{u}_{s_{i-1} \dotsm s_1} ,
  \]
  where the last sum is over all words $u$ of type $\mm$ satisfying $v = \merge{i} u$.
  Finally, we have $\swt{u}_{s_{i-1} \dotsm s_1} = \swt{u}$ for all such $u$ by Theorem~\ref{thm:permutation}.
  Combining all the above equalities, we find $\swt{v} e_{p_i(\mm)}(x_1, \dotsc, x_n) = \sum_u \swt{u}$.
\end{proof}

\begin{remark}
\label{rmk:bijective_proof}
Our proof of Theorem~\ref{thm:permutation} is by constructing a bijection $\omega$, and hence, we can give a bijective proof of Theorem~\ref{thm:merge} by the composition $\omega \circ \theta$.
\end{remark}


\begin{example}
Suppose $n = 5$.
Let $v = 13234$, and we have that $v = \merge{3} u$ if and only if $u \in \set{13245, 14235}$.
By examining all possible MLQs for these words, we obtain
\begin{align*}
\swt{13234} & = x_1 x_2 x_3^2 x_4 (x_1^2 + x_1 x_4 + x_1 x_5 + x_4 x_5 + x_5^2),
\\ \swt{13245} & = x_1 x_2 x_3^2 x_4 (x_1^2 + x_1x_4 + x_1x_5 + x_4^2 + x_4x_5 + x_5^2)
\\ & \hspace{20pt} \times (x_1x_2x_3 + x_1x_2x_5+x_1x_3x_5+x_2x_3x_5),
\\ \swt{14235} & = x_1x_2x_3^2x_4^2 (x_1^3x_2 + x_1^3x_3 + x_1^3x_5 + x_1^2x_2x_3 + x_1^2x_2x_4 + 2x_1^2x_2x_5
\\ & \hspace{60pt} + x_1^2x_3x_4 + 2x_1^2x_3x_5 + x_1^2x_4x_5 + x_1^2x_5^2 + x_1x_2x_3x_5
\\ & \hspace{60pt} + x_1x_2x_4x_5 + 2x_1x_2x_5^2 + x_1x_3x_4x_5 + 2x_1x_3x_5^2 + x_1x_4x_5^2
\\ & \hspace{60pt} + x_1x_5^3 + x_2x_3x_5^2 + x_2x_4x_5^2 + x_2x_5^3 + x_3x_4x_5^2 + x_3x_5^3).
\end{align*}
(We have factored the expressions for readability only.)
We verify Theorem~\ref{thm:merge} in this case by computing $\swt{13234} e_3(x_1, x_2, x_3, x_4, x_5) = \swt{13245} + \swt{14235}$.
\end{example}

\subsection{A Jacobi-Trudi-like formula for special $u$}
\label{subsec:JT_formula}

\begin{comment}
% Old version of this section, using too much handwaving. The graphics are probably worth reusing.

We shall now prove a determinantal formula for $\swt{u}$ when $u$ is a packed word with either $\ell-1$ or $\ell$ classes and weakly decreasing if we disregard all letters $\ell$.

\begin{dfn}
\label{def:near_std}
Define the \defn{$k$-near standardization} of a word $u \in \mcW_n$ of type $\mm$ to be the word $\std{u} := \std{u}_1 \cdots \std{u}_n$ obtained as follows.
Define
\[
W := \{ w_1 > w_2 > \cdots > w_r \mid u_{w_i} < k \}
\]
such that $u_j \geq k$ for all $j \in \ive{n} \setminus W$.
Let $r = \abs{W}$ and set
\[
\std{u}_i = \begin{cases}
j & \text{if } u_i < k \text{ and } i = w_j \\
r + 1 & \text{otherwise.}
\end{cases}
\]
That is to say, the $k$-near standardization $\std{u}$ is obtained by replacing the $j$-th letter that is not $k$ read right-to-left with $j$ and all letters $k$ with $r + 1$.
We say the \defn{near standardization} of a word with $\ell$ classes to be the $\ell$-near standardization.
\end{dfn}

Note that the $k$-near standardization is order preserving in the sense that $1 \leq i < j \leq n$ satisfy $u_i \geq u_j$ if and only if either $\std{u}_i > \std{u}_j$ or $\std{u}_i = \std{u}_j = r+1$.
Additionally, note that the type of the near standardization of a word $u$ with $\ell$ classes is $\widetilde{\mm} = (\widetilde{m}_1, \widetilde{m}_2, \ldots, \widetilde{m}_{r+1}, 0, 0, \ldots)$ with $\widetilde{m}_i = 1$ for $i \leq r$ and $\widetilde{m}_{r+1} = m_k$.

\begin{example}
For $k = 4$, we have
\begin{align*}
u & = {\color{gray} 4}3{\color{gray} 44}33{\color{gray} 4}22{\color{gray} 4}211{\color{gray} 4},
\\ \std{u} & = {\color{gray} 9}8{\color{gray} 99}76{\color{gray} 9}54{\color{gray} 9}321{\color{gray} 9}.
\end{align*}
\end{example}

\begin{thm}
\label{thm:determinant_form}
  Let $B = \set{b_1 < b_2 < \cdots < b_r} \subseteq \ive{n}$.
  Let $v_1v_2 \dotsm v_r$ be a weakly decreasing (non-cyclic) packed word of length $r$ with $\ell-1$ classes.
  Define a word $u$ of length $n$ by $u_i = v_j$ if $i = b_j$ for some $j$, otherwise $u_i = \ell$.
  Then
  \[
  \swt{u} = \left( \prod_{i\in B} x_i \right) \det\bigl( h_{i-j-1+\gamma_j}(x_1, \dotsc, x_{b_j}) \bigr)_{i, j \in \ive{r}}\,,
  \]
  where $\gamma_j$ is the number of distinct letters in $v_1 \dotsm v_j$.
\end{thm}

\begin{proof}[Proof of Theorem~\ref{thm:determinant_form}.]
Let $\qq = \tup{q_1, \ldots, q_{\ell-1}}$ be any MLQ appearing in the sum $\swt{u}$.
Thus, $\qq (1^n) = u$, and the type of $\qq$ is the type $\mm = (m_1, m_2, \ldots, m_\ell, 0, 0, \ldots)$ of $u$.
In particular,
$\abs{q_{\ell-1}} = p_{\ell-1}(\mm) = r = \abs{B}$.
Since the positions of the smallest $\abs{B}$ entries of $u$
are exactly the sites in $B$, this entails that
$q_{\ell-1} = B$.
Hence, $\wt(q_{\ell-1}) = \prod_{i\in B} x_i$.
Thus, the factor $\prod_{i\in B} x_i$ appears in each addend of $\swt{u}$;
we shall disregard this factor in the following.

Let $\std{u}$ be the near standardization of $u$, and note that $W = B$ from Definition~\ref{def:near_std} (but in the reverse order).
There exists $T$ such that $\bigvee_T \std{u} = u$.
Thus, from Lemma~\ref{lemma:queue_merge}, there exists some $\sigma$-twisted MLQ $\widetilde{\qq}'$ such that $\widetilde{\qq}'(1^n) = \std{u}$, and from Theorem~\ref{thm:permutation}, there exists a corresponding MLQ $\widetilde{\qq}$ such that $\widetilde{\qq}(1^n) = \std{u}$.\footnote{This is essentially the same as the proof of Theorem~\ref{thm:merge}. Moreover, this is done bijectively; see also Remark~\ref{rmk:bijective_proof}.}
As shown in the proof of~\cite[Prop.~3.7]{AasLin17}, the MLQ $\widetilde{\qq}$ corresponds to disjoint $r$-paths with initial points $\iota_i := (0,i)$ and terminal points $(b_i,0)$.
Note that these are precisely the bully paths of~\cite{AasLin17}.
We claim it is sufficient to show that for every MLQ $\qq$, there exists unique disjoint $r$-paths $\{\rho_i\}_{i=1}^r$ such that $\rho_i$ passes through the point $\tau_i := (b_i, i - \gamma_i)$.
This follows by applying the \defn{Lindstr\"om--Gessel--Viennot (LGV) Lemma}~\cite{Lindstrom73,GV85} and considering the initial points $\{ \iota_i \}_{i=1}^r$ and terminal points $\{ \tau_i \}_{i=1}^r$.
We refer the reader to~\cite[\S2]{GesVie89} for details on the LGV Lemma.\footnote{The version we shall use is~\cite[Cor.~2]{GesVie89}.}

Therefore, given disjoint $r$-paths $\rho = \{ \rho_i \}_{i=1}^r$ with corresponding MLQ $\widetilde{\qq} = (\widetilde{q}_1, \dotsc, \widetilde{q}_r)$, we construct $\qq_{\rho} = (q_1, \dotsc, q_{\ell-1})$ by
\[
j \in q_i \text{ if and only if } j \in \widetilde{q}_{i+t-\gamma_t},
\]
where $t \in \ive{r}$ such that $b_t \leq j < b_{t+1}$ (with $b_{r+1} = \infty$).
Moreover, this map is invertible, where to construct the inverse, we first construct sets
\[
A_i := \left\{ a_{i,j} = \text{$i$-th largest entry in $q_j$} %= \max\bigl\{ q_j \setminus \{ a_{k,j} \mid K(j) \leq k < j \} \bigr\}
\mid K(i) \leq j <\ell \right\},
\]
where $K(i) := \min\{\kappa \mid i \leq \lvert q_{\kappa} \rvert \}$. We will use the convention that $a_{i,j} = a_{i,\ell-1}$ for all $j \geq \ell$.
This then forms the disjoint $r$-paths $\rho' = \{\rho'_i\}_{i=1}^r$ by
\begin{align*}
\rho'_i \colon (0,i) \to (a_{i,K(i)},i) & \to (a_{i,K(i)},i+1) \to (a_{i,K(i)+1},i+1) \to
\\ \cdots & \to (a_{i,\ell-1}, i + \ell - K(i)) = (b_i, i - \gamma_i).
\end{align*}
The fact that $\qq = \qq_{\rho'}$ follows from Lemma~\ref{lemma:queue_merge_commute}.
\end{proof}

\begin{figure}[t]
\[
\begin{tikzpicture}[xscale=1.3,yscale=0.9]
  \begin{scope}[yshift=7cm]
    \foreach \i in {1,...,9}{
      \foreach \j in {0,1,2}{
        \node at (\i,\j){$\cdot$};
      }
    }
    \node[circle,fill=white,draw=black] at  (1, 0){$3$};
    \node[circle,fill=white,draw=black,text=blue] at  (2, 0){$3$};
    \node[circle,fill=white,draw=black] at  (4, 0){$2$};
    \node[circle,fill=white,draw=black,text=blue] at  (6, 0){$2$};
    \node[circle,fill=white,draw=black,text=darkred] at  (7, 0){$2$};
    \node[circle,fill=white,draw=black] at  (9, 0){$1$};
    \node[circle,fill=white,draw=black] at  (3, 1){$2$};
    \node[circle,fill=white,draw=black,text=blue] at  (4, 1){$2$};
    \node[circle,fill=white,draw=black,text=darkred] at  (6, 1){$2$};
    \node[circle,fill=white,draw=black] at  (8, 1){$1$};
    \node[circle,fill=white,draw=black] at  (7, 2){$1$};
  \end{scope}

  \fill[black!10] (1,1) -- (1,2) -- (4,2) -- (4,3) -- (6,3) -- (6,4) -- (9,4) -- (9,1) -- cycle;
  \draw[densely dotted] (1,1) grid (9,6);

  \draw[thick,draw=red] (1,2)--(2,2);
  \draw[thick,draw=red] (1,3)--(3,3)--(3,2)--(4,2);
  \draw[thick,draw=red] (1,4)--(4,4)--(4,3)--(6,3);
  \draw[thick,draw=red] (1,5)--(6,5)--(6,4)--(7,4);
  \draw[thick,draw=red] (1,6)--(7,6)--(7,5)--(8,5)--(8,4)--(9,4);
  %\draw[thick,blue,dashed] (2,2) -- (2,1);
  %\draw[thick,blue,dashed] (4,2) -- (4,1);
  %\draw[thick,blue,dashed] (6,3) -- (6,1);
  %\draw[thick,blue,dashed] (7,4) -- (7,1);
  %\draw[thick,blue,dashed] (9,4) -- (9,1);
  
  \node[circle,fill=white,draw=black,inner sep=1pt] at (1,1) {$3$};
  \node[circle,fill=white,draw=black,text=blue,inner sep=1pt] at (2,2) {$3$};
  \node[circle,fill=white,draw=black,inner sep=1pt] at (4,2) {$2$};
  \node[circle,fill=white,draw=black,inner sep=1pt] at (3,3) {$2$};
  \node[circle,fill=white,draw=black,text=blue,inner sep=1pt] at (4,4) {$2$};
  \node[circle,fill=white,draw=black,text=blue,inner sep=1pt] at (6,3) {$2$};
  \node[circle,fill=white,draw=black,text=darkred,inner sep=1pt] at (6,5) {$2$};
  \node[circle,fill=white,draw=black,text=darkred,inner sep=1pt] at (7,4) {$2$};
  \node[circle,fill=white,draw=black,inner sep=1pt] at (7,6) {$1$};
  \node[circle,fill=white,draw=black,inner sep=1pt] at (8,5) {$1$};
  \node[circle,fill=white,draw=black,inner sep=1pt] at (9,4) {$1$};

  \foreach \i in {2,...,6} {
    \node at (1,\i) {\textbullet};
  }
  \foreach \i in {1,...,6} {
    \node[anchor=east,inner sep=7pt] at (1,7-\i) {$\iota_{\i}$};
  }
\end{tikzpicture}
\]
\caption{The bijection with  between MLQs and disjoint $r$-paths for Example~\ref{ex:NILP_bijection} as described in the proof of Theorem~\ref{thm:determinant_form}.}
\label{fig:lattice_path_bijection}
\end{figure}

\begin{example}
\label{ex:NILP_bijection}
Consider $n = 9$, $r = 6$, $\ell = 4$, $v = 332221$, and $B = \set{1,2,4,6,7,9}$.
Therefore, we have the word $u$ in Theorem~\ref{thm:determinant_form} and its near standardization
\begin{align*}
u & = 33{\color{gray} 4}2{\color{gray} 4}22{\color{gray} 4}1,
\\ \std{u} & = 65{\color{gray} 7}4{\color{gray} 7}32{\color{gray} 7}1.
\end{align*}
See Figure~\ref{fig:lattice_path_bijection} for an example of the resulting bijection between an MLQ and disjoint $r$-paths.
\end{example}
\end{comment}

Throughout this subsection, we shall regard the sites $1, 2, \ldots, n$ as elements of $\set{1, 2, \ldots, n}$ rather than of $\ZZ/n\ZZ$.
In particular, they are totally ordered by $1 < 2 < \cdots < n$.

We shall now state a determinantal formula for $\swt{u}$ in the special case when $u$ is a packed word with either $\ell-1$ or $\ell$ classes and becomes weakly decreasing if we disregard all letters $\ell$.
%For example, $u = {\color{gray}4}3{\color{gray}44}33{\color{gray}4}22{\color{gray}4}211{\color{gray}4}$ is such a word, with $\ell=4$.

\begin{thm}
\label{thm:determinant_form}
Let $\ell$ be a positive integer.
Let $B = \set{ b_1 < b_2 < \cdots < b_r} \subseteq \ive{n}$.
Let $\tup{v_1 \geq v_2 \geq \cdots \geq v_r}$ be a weakly decreasing $r$-tuple of integers such that $\set{v_1, v_2, \ldots, v_r} = \ive{\ell-1}$.
%\travis{We probably want to introduce the notation of a weakly decreasing word, then we can just say ``Let $v = v_1 v_2 \dotsm v_r$ be a weakly decreasing packed word.''}
%\darij{I don't. Our words are cyclic with $n$ letters. Since we don't do wordy things with $v$, why call it a word?}\ 
Define a word $u \in \mcW_n$ by $u_i=v_j$ if $i = b_j$ for some $j$, otherwise $u_i = \ell$.
For each $j \in \ive{r}$, set $\gamma_j = \ell - v_j$.
(The value $\gamma_j$ can also be described as the number of distinct letters among $v_1, v_2, \dotsc, v_j$.)
Then
\[
\swt{u} = \left(  \prod_{b \in B} x_b \right)  \det \left(  h_{\gamma_j+i-j-1}(x_1,\dotsc,x_{b_j}) \right)_{i, j \in \ive{r}}.
\]
\end{thm}

The proof of this theorem is given in Section~\ref{sec:JT-proofs}.




%%%%%%%%%%
\subsection{Conclusions for Aas--Linusson MLQs}

We can use Theorem~\ref{thm:determinant_form} to settle two conjectures from~\cite{AasLin17}. Here is an outline:

Fix a sequence $b_1 < b_2 < \cdots < b_r$ of sites.
For a permutation $v \in \SymGp{r}$, let $u(v)$ be the corresponding word as defined in Theorem~\ref{thm:determinant_form}.
\darij{What does this mean?}
We say that a set $S$ of integers is \defn{lacunar} if $i\in S$ implies $i+1 \notin S$.
Let $S \subseteq \ive{r-1}$ be lacunar, and define the permutation $\sigma_S := \left( \prod_{i \in S} s_i \right) w_0$, where $s_i, w_0 \in \SymGp{r}$.
Note that the elements $\{s_i \mid i \in S\}$ all commute, so their product, and hence $\sigma_S$, is well-defined.
In~\cite[Conj.~3.10]{AasLin17}, a formula for the spectral weight $\swt{u \sigma_S}$ at $x_1 = \cdots = x_n = 1$ is conjectured, where $u \sigma_S = u_{\sigma_S(1)} \cdots u_{\sigma_S(r)}$.

Let $T \subseteq \ive{r-1}$ be lacunar, and let $\psi(T) = \sum_{S \subseteq T} \swt{u \sigma_S}$.
By Theorem~\ref{thm:permutation}, we have
\darij{Do you perhaps mean Theorem~\ref{thm:merge} instead? And if so, why exactly?}
\begin{align*}
  \psi(T) & = \left(\prod_{i\in S} e_{p_i(\mm)}(x_1, \dotsc, x_n) \right) \swt{ \bigvee_T w_0}
  \\ & = \left( \prod_{i\in B} x_i \right) \left(\prod_{i\in S} e_{p_i(\mm)}(x_1, \dotsc, x_n) \right) \det\bigl(h_{i-j+1+\gamma_j}(x_1, \dotsc, x_{b_j})\bigr)_{i, j \in \ive{r}},
\end{align*}
where $\gamma_i = i - \lvert \{j\in T \mid j < i \} \rvert$ and the second equality is by Theorem~\ref{thm:determinant_form}.
By M\"obius inversion we have $\swt{u \sigma_S} = \sum_{T\subseteq S} (-1)^{|S|-|T|} \psi(T)$.
Taken together with $x_1 = \cdots = x_n = 1$, this proves~\cite[Conj.~3.10]{AasLin17} (which is a generalization of~\cite[Conj.~3.9]{AasLin17}).
Additionally, this proves~\cite[Conj.~3.6]{AasLin17} (which is a generalization of~\cite[Conj.~3.4]{AasLin17}).










%=====================================================================
\section{The TASEP connection}
\label{sec:tasep}

We now explain how our proof of Theorem~\ref{thm:permutation} gives a proof of the commutativity conjecture of~\cite{AAMP}.

There are $2^{n-1}$ packed types for words of length $n$, as they are the compositions of $n$ (see \cite[Section 1.2]{Stanley-EC1}).
We let the subset $S \subseteq [n-1]$ correspond to the type of the word obtained by merging $i$ and $i+1$ in $12 \dotsm n$ for each $i \in S$.
Denote this type by $\mm_S$.
Note that $\set{p_1(\mm_S), \dotsc, p_{\ell-1}(\mm_S)} = [n-1] \setminus S$, where $\mm_S$ has $\ell$ classes; this is the complement of the usual bijection between subsets of $\ive{n-1}$ and compositions of $n$.
Let $\mcW_S$ denote the set of words of type $\mm_S$.
Let $V_S$ be the vector space over $\RR$ with basis $\set{\epsilon_w \mid w \in \mcW_S}$.

\begin{example}
  For $n = 4$, we have
  \[
  \begin{tikzpicture}[xscale=4.5,yscale=2,thick,>=latex]
  \node (E) at (1,0) {$\mbf{m}_{\emptyset} = (1,1,1,1)$};
  \node (1) at (2,1) {$\mbf{m}_{\{1\}} = (2,1,1)$};
  \node (2) at (1,1) {$\mbf{m}_{\{2\}} = (1,2,1)$};
  \node (3) at (0,1) {$\mbf{m}_{\{3\}} = (1,1,2)$};
  \node (12) at (2,2) {$\mbf{m}_{\{1,2\}} = (3,1)$};
  \node (13) at (1,2) {$\mbf{m}_{\{1,3\}} = (2,2)$};
  \node (23) at (0,2) {$\mbf{m}_{\{2,3\}} = (1,3)$};
  \node (123) at (1,3) {$\mbf{m}_{\{1,2,3\}} = (4)$};
  \draw[->,red] (E) -- (1);
  \draw[->,blue] (E) -- (2);
  \draw[->,dgreencolor] (E) -- (3);
  \draw[->,red] (2) -- (12);
  \draw[->,red] (3) -- (13);
  \draw[->,blue] (3) -- (23);
  \draw[->,blue] (1) -- (12);
  \draw[->,dgreencolor] (1) -- (13);
  \draw[->,dgreencolor] (2) -- (23);
  \draw[->,red] (23) -- (123);
  \draw[->,blue] (13) -- (123);
  \draw[->,dgreencolor] (12) -- (123);
  \end{tikzpicture}
  \]
  where we have drawn an arrow $\mm_S \to \mm_{S \cup \set{i}}$ for each $S \subseteq [n-1]$ and each $i \in [n-1] \setminus S$ (this is the Hasse diagram of the Boolean lattice of subsets of $[n-1]$).
\end{example}

The \defn{totally asymmetric simple exclusion process} (TASEP) is a Markov chain on $\mcW_S$, where $S \subseteq[n-1]$, as follows.
For a state $u \in \mcW_S$, we move to a new state by picking a random $i \in [n]$ and either
\begin{itemize}
\item if $u_i > u_{i+1}$, swap the positions $u_i$ and $u_{i+1}$, or
\item do nothing (\textit{i.e.} stay at $u$).
\end{itemize}
Let $M_S \colon V_S \to V_S$ be the transition matrix of this Markov chain.
Note that these moves preserve the type of the words; thus we could consider this as a Markov chain on $\mcW_n$, where $\mcW_S$ becomes an irreducible component.
For $i \notin S$, we have the merging map $\Phi_i \colon \mcW_S \to \mcW_{S\cup\{i\}}$ given by
$\Phi_i(\epsilon_u) = \epsilon_{\vee^{(i)} u}$.
%$\Phi_i(\epsilon_u) = \epsilon_{\merge{t}u}$, where $t = \min\set{k \mid p_k(\mm_S) \geq i}$.
It is easy to see that $\Phi_i M_S = M_{S\cup \{i\}} \Phi_i$. 

\begin{figure}
\[
\begin{tikzpicture}[>=stealth,thick,scale=0.8]
\node (321) at (3,8) {$321$};
\node (231) at (0,6) {$231$};
\node (312) at (6,6) {$312$};
\node (213) at (0,2) {$213$};
\node (132) at (6,2) {$132$};
\node (123) at (3,0) {$123$};
\draw[->,blue] (123) -- (321); % node[right,pos=0.8] {$1/3$};
\draw[->,dgreencolor] (132) -- (123); % node[above=3pt,pos=0.5] {$1/3$};
\draw[->,red] (132) -- (231); % node[below=4pt,pos=0.8] {$1/3$};
\draw[->,red] (213) -- (123); % node[above=3pt,pos=0.5] {$1/3$};
\draw[->,dgreencolor] (213) -- (312); % node[below=4pt,pos=0.8] {$1/3$};
\draw[->,blue] (231) -- (213); % node[left,pos=0.5] {$1/3$};
\draw[->,blue] (312) -- (132); % node[right,pos=0.5] {$1/3$};
\draw[->,dgreencolor] (321) -- (231); % node[above=3pt,pos=0.5] {$1/3$};
\draw[->,red] (321) -- (312); % node[above=3pt,pos=0.5] {$1/3$};
\end{tikzpicture}
\hspace{35pt}
\begin{tikzpicture}[>=stealth,thick,scale=0.8]
\node (1223) at (0,-2) {$1223$};
\node (3221) at (0,8) {$3221$};
\node (2321) at (2,6) {$2321$};
\node (3212) at (-2,6) {$3212$};
\node (2231) at (3,4) {$2231$};
\node (2312) at (0,4) {$2312$};
\node (3122) at (-3,4) {$3122$};
\node (2213) at (3,2) {$2213$};
\node (2132) at (0,2) {$2132$};
\node (1322) at (-3,2) {$1322$};
\node (1232) at (-2,0) {$1232$};
\node (2123) at (2,0) {$2123$};
\draw[->,blue] (1223) .. controls (2,3) and (1,6) .. (3221);
\draw[->,red] (3221) -- (3212);
\draw[->,dgreencolor] (3221) -- (2321);
\draw[->,dgreencolor] (2321) -- (2231);
\draw[->,red] (2321) -- (2312);
\draw[->,red] (3212) -- (3122);
\draw[->,dgreencolor] (3212) -- (2312);
\draw[->,blue] (3122) -- (1322);
\draw[->,blue] (2312) -- (2132);
\draw[->,blue] (2231) -- (2213);
\draw[->,dgreencolor] (1322) -- (1232);
\draw[->,red] (1322)  .. controls (-1,3) and (-1,6) .. (2321);
\draw[->,dgreencolor] (2132) -- (2123);
\draw[->,red] (2132) -- (1232);
\draw[->,dgreencolor] (2213) .. controls (1,3) and (1,6) .. (3212);
\draw[->,red] (2213) -- (2123);
\draw[->,dgreencolor] (1232) -- (1223);
\draw[->,red] (1232) .. controls (1,0) and (1,3) .. (2231);
\draw[->,red] (2123) -- (1223);
\draw[->,dgreencolor] (2123) .. controls (-1,0) and (-1,3) .. (3122);
\end{tikzpicture}
\]
\caption{The states and transitions for $\mcW_{\emptyset}$ for $n = 3$ (left) and $\mcW_{\set{2}}$ for $n = 4$ (right).
All probabilities of the drawn transitions are $1/n$.}
\end{figure}

Building on work by Ferrari and Martin~\cite{FM06,FM07}, the paper~\cite{AAMP} introduced opposite operators $\Psi_i \colon \mcW_S \to \mcW_{S \setminus \{i\}}$ given by $\Psi_i(\epsilon_u) = \sum_{q} \epsilon_{q(u)}$, where the sum is taken over all $i$-queues $q$, and showed that $\Psi_i M_S = M_{S \setminus \{i\}} \Psi_i$.
Furthermore they proposed the \defn{commutativity conjecture}: that $\Psi_i \Psi_j = \Psi_j \Psi_i$.
By looking at the $(u,v)$ entry of both sides of this equation, the commutativity conjecture is asking whether the number of $(i,j)$-configurations $C$ such that $v = C(u)$ equals the number of $(j,i)$-configurations $C'$ such that $v = C'(u)$. 
Thus, our proof of Theorem~\ref{thm:permutation} shows that $\widetilde{\Psi}_i \widetilde{\Psi}_j = \widetilde{\Psi}_j \widetilde{\Psi}_i$ for the weighted operators $\widetilde{\Psi}_i$ given by
\[
\widetilde{\Psi}_i(\epsilon_u) = \sum_q \wt(q) \epsilon_{q(u)},
\]
where we also sum over all $i$-queues $q$.
Note that $\widetilde{\Psi}_i = \Psi_i$ when we specialize $x_1 = \cdots = x_n = 1$, giving the connection between our MLQs and the multi-species TASEP.
We note that the proof of interlacing given in~\cite{AAMP} is significantly different from our approach.

We have not managed to find a process similar to the TASEP whose transition matrix $\widetilde{M}_S$ would satisfy $\widetilde{M}_S \widetilde{\Psi}_i = \widetilde{\Psi}_i \widetilde{M}_{S \setminus \set{i}}$ for our $\widetilde{\Psi}_i$ operators.
Note however that queues give us \emph{a} random process with this property: for a word $u \in \mcW_S$, a move in the chain is given by
\begin{enumerate}
\item picking a random $i$-queue $q$
\item going to the state $\merge{t} q(u) \in \mcW_S$, where $t = \min\set{k \mid p_k(\mm_S) \geq i}$.
\end{enumerate}










%=====================================================================

\section{Proof of Theorem~\ref{thm:determinant_form}}
\label{sec:JT-proofs}

%In this section, we gather some technical proofs that have been omitted from Section~\ref{sec:JT_formula}.
% [Use the above line if we end up moving further unrelated proofs into this appendix.]

The goal of this section is to prove Theorem~\ref{thm:determinant_form}.
Along the way, we shall derive a number of intermediate results, some of which may be of independent interest.

As in Subsection~\ref{subsec:JT_formula}, we shall consider the sites as elements of the totally ordered set $\set{1, 2, \ldots, n}$ (ordered by $1 < 2 < \cdots < n$) throughout this section.
Moreover, we shall use infinitely many distinct commuting indeterminates $\ldots, x_{-2}, x_{-1}, x_0, x_1, x_2, \ldots$ instead of those indexed by $\ZZ/n\ZZ$; thus we do not have $x_{n+k} = x_k$ in this section.

%%%%%%%%%%
\subsection{Lattice paths and the Lindstr\"{o}m--Gessel--Viennot theorem}

Our arguments will rely on the \defn{Lindstr\"om--Gessel--Viennot (LGV) Lemma}~\cite{GV85,Lindstrom73} and on a re-interpretation of MLQs as a certain kind of semistandard tableaux (of non-partition shape).
This takes inspiration from the ``bully paths'' of~\cite{AasLin17} as well as from the standard proof of the Jacobi--Trudi identities for Schur functions~\cite[First proof of Theorem 7.16.1]{Stanley-EC2}.
We begin with basic definitions.

The \defn{lattice} shall mean the (infinite) directed graph whose vertices are
all pairs of integers (that is, its vertex set is $\ZZ^2$), and whose arcs are
\begin{align*}
(i,j) & \to (i,j+1) & & \text{for all } (i,j) \in \ZZ^2, \qquad \text{and} \\
(i,j) & \to (i+1,j) & & \text{for all } (i,j) \in \ZZ^2.
\end{align*}
The arcs of the first kind are called \defn{north-steps}, whereas the arcs of
the second kind are called \defn{east-steps}.
\begin{verlong}
The vertices of the lattice will just be called \defn{vertices}.
\end{verlong}
We consider the lattice as the usual integer lattice in the Cartesian plane.

For each vertex $v = (i,j) \in \ZZ^2$, we set $\xcoord(v) = i$ and $\ycoord(v) = j$.
We refer to $\xcoord(v)$ (resp.~$\ycoord(v)$) as the \defn{$x$-coordinate} (resp.~\defn{$y$-coordinate}) of $v$.
The \defn{$y$-coordinate} of an east-step $(i,j) \to (i+1, j)$ is defined to be $j$.

For each arc $a$ of the lattice, we define the \defn{weight} of $a$ as the monomial
\[
\wt(a) :=
\begin{cases}
x_j & \text{if $a$ is an east-step } (i,j) \to (i+1,j), \\
1 & \text{if $a$ is a north-step } (i,j) \to (i,j+1).
\end{cases}
\]
Thus, all north-steps have weight $1$, while east-steps with $y$-coordinate $j$ have weight $x_j$.

Fix $k \in \NN$.
A $k$-tuple of vertices of the lattice will be called a \defn{$k$-vertex}.
\begin{verlong}
If $\vv = \tup{A_1, A_2, \dotsc, A_k}$ is a $k$-vertex, and if $\sigma \in \SymGp{k}$ is a permutation, then $\sigma(\vv)$ denotes the $k$-vertex $\tup{A_{\sigma(1)}, A_{\sigma(2)}, \dotsc, A_{\sigma(k)}}$.
\end{verlong}
A \defn{path} simply means a (directed) path in the lattice.
The \defn{weight} of a path $p$, denoted $\wt(p)$, is defined as the product of the weights of all arcs of this path; this weight is a monomial.
If $A$ and $B$ are two vertices, then \defn{$N(A,B)$} shall denote the set of all paths from $A$ to $B$.

It is easy to see (see, \textit{e.g.}, \cite[(2.36)]{Stanley-EC1}) that any two vertices $A = (a,b)$ and $B = (c,d)$ satisfy
\begin{equation}
\label{eq.LGV.single-paths}
\sum_{p \in N(A,B)} \wt(p) = h_{c-a}(x_{b}, x_{b+1}, \dotsc, x_{d}).
\end{equation}
% This really is just a substitution and we can assume the readers are not completely incompetent
%(Here, $h_{\ell}(x_{b}, x_{b+1}, \ldots, x_{d})$ is defined as $\sum_{\substack{(k_1,k_2,\ldots,k_{\ell}) \in \set{b,b+1,\ldots,d}^{\ell}; \\ k_1 \leq k_2 \leq \cdots \leq k_{\ell}}} x_{k_1} x_{k_2} \dotsm x_{k_{\ell}}$ for all $\ell \in\NN$, and is $0$ otherwise.)

\begin{comment}
We begin with a proof of~\eqref{eq.LGV.single-paths}, which is a simple and classical fact that appears implicitly in various texts on enumerative combinatorics (\textit{e.g.}, \cite[(2.36)]{Stanley-EC1}).

\begin{proof}[Proof of~\eqref{eq.LGV.single-paths}.]
Let $A = (a,b)$ and $B = (c,d)$ be two vertices.
If $p$ is a path from $A$ to $B$, then $p$ must have exactly $c-a$ east-steps, and the $y$-coordinates of these
east-steps must belong to the interval $\set{b,b+1,\dotsc,d}$.
Let $\bigl( y_1(p), y_2(p), \dotsc, y_{c-a}(p) \bigr) \in \set{b,b+1, \dotsc, d}^{c-a}$ be the weakly increasing $(c-a)$-tuple consisting of the $y$-coordinates of the $c-a$ east-steps of $p$ (from left to right).
Moreover, $p$ can be uniquely reconstructed from this $(c-a)$-tuple (since this $(c-a)$-tuple determines the east-steps of $p$).
Conversely, any weakly increasing $(c-a)$-tuple of elements of $\set{b, b+1, \dotsc,d}$ has the form $\bigl( y_1(p), y_2(p), \dotsc, y_{c-a}(p) \bigr)$ for a unique path $p$ from $A$ to $B$.
Thus, there is a bijection between the paths $p$ from $A$ to $B$ and the weakly increasing $(c-a)$-tuples of elements of $\set{b, b+1, \dotsc, d}$.
This yields
\begin{align*}
\sum_{p \in N(A,B)} \wt(p) & = \sum_{\substack{ \tup{k_1,k_2,\ldots,k_{c-a}} \text{ is a weakly increasing} \\ (c-a)\text{-tuple of elements of }\set{b,b+1,\dotsc,d} }} x_{k_1} x_{k_2} \cdots x_{k_{c-a}}
\\ & = h_{c-a}(x_{b}, x_{b+1}, \dotsc, x_{d}).
\end{align*}
\end{proof}
\end{comment}

If $\tup{A_1, A_2, \dotsc, A_k}$ and $\tup{B_1, B_2, \dotsc, B_k}$ are two $k$-vertices, then a \defn{non-intersecting lattice path tuple (NILP)} from $\tup{A_1, A_2, \dotsc, A_k}$ to $\tup{B_1, B_2, \dotsc, B_k}$ shall mean a $k$-tuple $\tup{p_1, p_2, \dotsc, p_k}$ of paths such that
\begin{itemize}
\item each $p_i$ is a path from $A_i$ to $B_i$;
\item no two of the paths $p_1, p_2, \dotsc, p_k$ have a vertex in common.
\end{itemize}
(Visually speaking, the paths must neither cross nor touch.)

The \defn{weight} of a NILP $\pp = \tup{p_1, p_2, \dotsc, p_k}$ is the monomial $\wt(\pp)$ defined by
\[
\wt(\pp) := \prod_{i=1}^{k} \wt(p_i).
\]

See Figure~\ref{fig:NILP_example} for an illustration.

\begin{figure}[t]
\[
\begin{tikzpicture}
  \draw[densely dotted] (0,0) grid (7.2,7.2);
  % axes:
  \draw[->] (0,0) -- (0,7.2);
  \draw[->] (0,0) -- (7.2,0);
  \foreach \x/\xtext in {0, 1, 2, 3, 4, 5, 6, 7}
     \draw (\x cm,1pt) -- (\x cm,-1pt) node[anchor=north] {$\xtext$};
  \foreach \y/\ytext in {0, 1, 2, 3, 4, 5, 6, 7}
     \draw (1pt,\y cm) -- (-1pt,\y cm) node[anchor=east] {$\ytext$};

  \node[circle,fill=white,draw=black,text=darkred,inner sep=1pt] (A3) at (2,3) {$A_3$};
  \node[circle,fill=white,draw=black,text=darkred,inner sep=1pt] (A2) at (3,1) {$A_2$};
  \node[circle,fill=white,draw=black,text=darkred,inner sep=1pt] (A1) at (5,1) {$A_1$};

  \node[circle,fill=white,draw=black,text=black,inner sep=1pt] (B3) at (4,6) {$B_3$};
  \node[circle,fill=white,draw=black,text=black,inner sep=1pt] (B2) at (5,6) {$B_2$};
  \node[circle,fill=white,draw=black,text=black,inner sep=1pt] (B1) at (6,4) {$B_1$};

  \begin{scope}[thick,>=stealth,red]
      % $p_3$:
      \draw (A3) edge[->] (2,4);
      \draw (2,3.6) node[anchor=east] {$1$};
      \draw (2,4) edge[->] (3,4);
      \draw (2.5,4) node[anchor=north] {$x_4$};
      \draw (3,4) edge[->] (3,5);
      \draw (3,4.5) node[anchor=east] {$1$};
      \draw (3,5) edge[->] (4,5);
      \draw (3.5,5) node[anchor=north] {$x_5$};
      \draw (4,5) edge[->] (B3);
      \draw (4,5.4) node[anchor=east] {$1$};
  \end{scope}
  \begin{scope}[thick,>=stealth,blue]
      % $p_2$:
      \draw (A2) edge[->] (4,1);
      \draw (3.6,1) node[anchor=north] {$x_1$};
      \draw (4,1) edge[->] (4,2);
      \draw (4,1.5) node[anchor=east] {$1$};
      \draw (4,2) edge[->] (4,3);
      \draw (4,2.5) node[anchor=east] {$1$};
      \draw (4,3) edge[->] (4,4);
      \draw (4,3.5) node[anchor=west] {$1$};
      \draw (4,4) edge[->] (5,4);
      \draw (4.5,4) node[anchor=south] {$x_4$};
      \draw (5,4) edge[->] (5,5);
      \draw (5,4.5) node[anchor=west] {$1$};
      \draw (5,5) edge[->] (B2);
      \draw (5,5.4) node[anchor=west] {$1$};
  \end{scope}
  \begin{scope}[thick,>=stealth,dgreencolor]
      % $p_1$:
      \draw (A1) edge[->] (5,2);
      \draw (5,1.6) node[anchor=east] {$1$};
      \draw (5,2) edge[->] (6,2);
      \draw (5.5,2) node[anchor=south] {$x_2$};
      \draw (6,2) edge[->] (6,3);
      \draw (6,2.5) node[anchor=west] {$1$};
      \draw (6,3) edge[->] (B1);
      \draw (6,3.4) node[anchor=west] {$1$};
  \end{scope}
\end{tikzpicture}
\]
\caption{A NILP from the $3$-vertex $\tup{A_1, A_2, A_3}$ to the $3$-vertex $\tup{B_1, B_2, B_3}$ of weight $x_1 x_2 x_4^2 x_5$.
  The weights of the edges of the paths are written next to the edges.}
\label{fig:NILP_example}
\end{figure}

If $\uu$ and $\vv$ are two $k$-vertices, then \defn{$N(\uu,\vv)$} denotes the set of all NILPs from $\uu$ to $\vv$.

\begin{verlong}
A pair $(\uu, \vv)$ of two $k$-vertices $\uu$ and $\vv$ is said to be \defn{nonpermutable} if and only
if every permutation $\sigma \neq \id$ in $\SymGp{k}$ satisfies $N\bigl( \uu,\sigma(\vv) \bigr) = \emptyset$.
Note that we are not requiring that $N(\uu, \vv) \neq \emptyset$ here.

The following fact (a particular case of~\cite[Corollary 2]{GesVie89}) is crucial:

\begin{prop}
\label{prop.LGV.nonper}
Let $k \in \NN$.
Let $(\uu, \vv)$ be a nonpermutable pair of two $k$-vertices $\uu = \tup{A_1, A_2, \dotsc, A_k}$ and $\vv = \tup{B_1, B_2, \dotsc, B_k}$.
Then,
\[
\sum_{\pp \in N(\uu,\vv)} \wt(\pp) = \det\left( \sum_{p \in N(A_i,B_j)} \wt(p) \right)_{i, j \in \ive{k}}.
\]
\end{prop}

Next, we state a simple lemma that will help us show that certain pairs of $k$-vertices are nonpermutable:

\begin{lemma}
\label{lem.LGV.hex}
Let $A$, $B$, $A'$ and $B'$ be four vertices of the lattice such that
\[
\xcoord(A') \leq \xcoord(A), \qquad \ycoord(A') \geq \ycoord(A), \qquad
\xcoord(B') \leq \xcoord(B), \qquad \ycoord(B') \geq \ycoord(B).
\]
Let $p$ be a path from $A$ to $B'$. Let $p'$ be a path from $A'$ to $B$.
Then, $p$ and $p'$ have a vertex in common.
\end{lemma}

TODO: Example picture.

\begin{proof}[First proof of Lemma~\ref{lem.LGV.hex}.]
If $q$ is any path, then the \defn{length $\ell\left(q\right)$} of $q$ is defined to be the number of arcs
of $q$.

We shall now prove Lemma~\ref{lem.LGV.hex} by strong induction on $\ell(p) + \ell(p')$:

\textit{Induction step:}
Fix $N \in \NN$. Assume (as the induction hypothesis) that Lemma~\ref{lem.LGV.hex} holds whenever $\ell(p) + \ell(p') < N$.
We must now prove that Lemma~\ref{lem.LGV.hex} holds when $\ell(p) + \ell(p') = N$.

So let $A$, $B$, $A'$, $B'$, $p$ and $p'$ be as in Lemma~\ref{lem.LGV.hex}, and let us assume that $\ell(p) + \ell(p') = N$.
We must prove that $p$ and $p'$ have a vertex in common.

Assume the contrary. Thus, $p$ and $p'$ have no vertex in common.

The vertex $A$ belongs to the path $p$, and thus does not belong to the path
$p'$ (since $p$ and $p'$ have no vertex in common). Similarly,
the vertex $A'$ does not belong to the path $p$.

Recall that each arc of the lattice is either an east-step or a north-step.
Thus, the $x$-coordinates of the vertices of a path are always weakly
increasing, and so are the $y$-coordinates. Hence, the existence of a path $p$
from $A$ to $B'$ shows that $\xcoord(A) \leq \xcoord(B')$ and $\ycoord(A) \leq \ycoord(B')$.
Similarly, the existence of a path $p'$ from $A'$ to $B$ yields $\xcoord(A') \leq \xcoord(B)$ and $\ycoord(A') \leq \ycoord(B)$.

Next, we claim that $\ell(p) \neq 0$.

[\textit{Proof:}
Assume the contrary. Thus, $\ell(p) = 0$.
Hence, the path $p$ has no steps.
Therefore, $A=B'$ (since $p$ is a path from $A$ to $B'$).
Hence, $\ycoord(A) = \ycoord(B') \geq \ycoord(B)$, so that $\ycoord(A') \geq \ycoord(A) \geq \ycoord(B)$.
Combining this with $\ycoord(A') \leq \ycoord(B)$, we obtain $\ycoord(A') = \ycoord(B)$.
Combining $\ycoord(A') \geq \ycoord(A)$ with $\ycoord(A') = \ycoord(B) \leq \ycoord(A)$, we obtain $\ycoord(A')  = \ycoord(A)$.
Thus, $\ycoord(A') = \ycoord(A) = \ycoord(B)$.
Therefore, the vertex $A$ lies on the horizontal line that contains $A'$ and $B$.
Furthermore, this vertex $A$ must lie on the line segment between $A'$ and $B$ (since $\xcoord(A') \leq \xcoord( \underbrace{A}_{=B'} ) = \xcoord(B') \leq \xcoord(B)$).

Recall again that the $y$-coordinates of the vertices a path are always weakly increasing.
Moreover, they increase strictly whenever the path makes a north-step.
Hence, if the path $p'$ would have any north-step, then we would have $\ycoord(A') < \ycoord(B)$ (since $p'$ is a path from $A'$ to $B$).
But this would contradict $\ycoord(A') \geq \ycoord(B)$.
Hence, the path $p'$ has no north-step.
Thus, $p'$ consists entirely of east-steps.
Hence, $p'$ contains every vertex on the line segment between $A'$ and $B$.
Therefore, $p'$ contains the vertex $A$ (since the vertex $A$ lies on the line segment between $A'$ and $B$).
This contradicts the fact that $A$ does not belong to the path $p'$.
This contradiction shows that our assumption was false; hence, $\ell(p) \neq0$ is proven.]

Furthermore, we claim that $\ell(p') \neq 0$. \travis{Isn't this basically the same as the above proof but with $\xcoord$ instead of $\ycoord$?}

[\textit{Proof:}
Assume the contrary. Thus, $\ell(p') = 0$.
Hence, the path $p'$ has no steps.
Therefore, $A'=B$ (since $p'$ is a path from $A'$ to $B$).
Hence, $\xcoord(A') = \xcoord(B) \geq \xcoord(B')$, so that $\xcoord(A) \geq \xcoord(A') \geq \xcoord (B')$.
Combining this with $\xcoord(A) \leq \xcoord(B')$, we obtain $\xcoord(A) = \xcoord(B')$.
Combining $\xcoord(A) \geq \xcoord(A')$ with $\xcoord(A') \geq \xcoord(B') = \xcoord(A)$, we obtain $\xcoord(A)  = \xcoord(A')$.
Thus, $\xcoord(A') = \xcoord(A) = \xcoord(B')$.
Therefore, the vertex $A'$ lies on the vertical line that contains $A$ and $B'$.
Furthermore, this vertex $A'$ must lie on the line segment between $A$ and $B'$ (since $\ycoord(A') \geq \ycoord(A)$ and $\ycoord(\underbrace{A'}_{=B}) = \ycoord(B) \leq \ycoord(B')$).

Recall again that the $x$-coordinates of the vertices a path are always weakly increasing.
Moreover, they increase strictly whenever the path makes an east-step.
Hence, if the path $p$ would have any east-step, then we would have $\xcoord(A) < \xcoord(B')$ (since $p$ is a path from $A$ to $B'$).
But this would contradict $\xcoord(A) = \xcoord(B')$.
Hence, the path $p$ has no east-step.
Thus, $p$ consists entirely of north-steps.
Hence, $p$ contains every vertex on the line segment between $A$ and $B'$.
Therefore, $p$ contains the vertex $A'$ (since the vertex $A'$ lies on the line segment between $A$ and $B'$).
This contradicts the fact that $A'$ does not belong to the path $p$.
This contradiction shows that our assumption was false; hence, $\ell(p') \neq 0$ is proven.]

Let $P$ be the second vertex of the path $p$.
(This is well-defined, since $\ell(p) \neq 0$.)
Hence, $P$ lies on a path from $A$ to $B'$ (namely, on the path $p$).
Therefore, $\xcoord(A) \leq \xcoord(P) \leq \xcoord(B')$ (since the $x$-coordinates of the vertices a path are
always weakly increasing) and $\ycoord(A) \leq \ycoord(P) \leq \ycoord(B')$ (since the $y$-coordinates of the vertices a path are always weakly increasing).
Let $r$ be the path from $P$ to $B'$ obtained by removing the first arc from $p$.
Thus, $r$ is a subpath of $p$.
Hence, the paths $r$ and $p'$ have no vertex in common (since $p$ and $p'$ have no vertex in common).
Also, $\ell(r) = \ell(p) - 1 < \ell(p)$ and thus $\underbrace{\ell(r)}_{<\ell(p)} + \ell(p') < \ell(p) + \ell(p') = N$.

Moreover, $\xcoord(A') \leq \xcoord(A) \leq \xcoord(P)$.
If we had $\ycoord(A') \geq \ycoord(P)$, then we could apply Lemma~\ref{lem.LGV.hex} to $P$ and $r$ instead of $A$ and $p$ (by the induction hypothesis, since $\ell(r) + \ell(p') < N$).
We thus would conclude that the paths $r$ and $p'$ have a vertex in common; this would contradict the fact that the paths $r$ and $p'$ have no vertex in common.
Hence, we cannot have $\ycoord(A') \geq \ycoord(P)$.
Thus, $\ycoord(A') < \ycoord(P)$.
Hence, $\ycoord(A') \leq \ycoord(P)  -1$ (since $\ycoord(A')$ and $\ycoord(P)$ are integers).

But $P$ is the next vertex after $A$ on the path $p$.
Hence, there is an arc from $A$ to $P$. If this arc was an east-step, then we would have $\ycoord(P) = \ycoord(A)$, which would contradict $\ycoord(A) \leq \ycoord(A') < \ycoord(P)$.
Hence, this arc cannot be an east-step.
Thus, this arc must be a north-step.
Therefore, $\ycoord(P) = \ycoord(A) + 1$ and $\xcoord(P) = \xcoord(A)$.
Combining $\ycoord(A') \leq \ycoord(P) - 1 = \ycoord(A)$ (since $\ycoord(P) = \ycoord(A) + 1$) with $\ycoord(A') \geq \ycoord(A)$, we obtain $\ycoord(A') = \ycoord(A)$.

\travis{Isn't this just the same as the above, but with primes and $\xcoord \leftrightarrow \ycoord$?}
Let $P'$ be the second vertex on the path $p'$.
(This is well-defined, since $\ell(p') \neq0 $.)
Hence, $P'$ lies on a path from $A'$ to $B$ (namely, on the path $p'$).
Therefore, $\xcoord(A') \leq \xcoord(P') \leq \xcoord(B)$ (since the $x$-coordinates of the vertices a path are always weakly increasing) and $\ycoord(A') \leq \ycoord(P') \leq \ycoord(B)$ (since the $y$-coordinates of the vertices a path are always weakly increasing).
Let $r'$ be the path from $P'$ to $B$ obtained by removing the first arc from $p'$.
Thus, $r'$ is a subpath of $p'$.
Hence, the paths $p$ and $r'$ have no vertex in common (since $p$ and $p'$ have no vertex in common).
Also, $\ell(r') = \ell(p') - 1 < \ell(p')$, and thus $\ell(p) + \underbrace{\ell(r')}_{<\ell(p')} < \ell(p) + \ell(p') = N$.

Moreover, $\ycoord(P') \geq \ycoord(A') \geq \ycoord(A)$.
If we had $\xcoord(P') \leq \xcoord(A)$, then we could apply Lemma~\ref{lem.LGV.hex} to $P'$ and $r'$ instead of $A'$ and $p'$ (by the induction hypothesis, since $\ell(p) + \ell(r') < N$).
We thus would conclude that the paths $p$ and $r'$ have a vertex in common; this would contradict the fact that the paths $p$ and $r'$ have no vertex in common.
Hence, we cannot have $\xcoord(P') \leq \xcoord(A)$.
Thus, $\xcoord(P') > \xcoord(A)$.
Hence, $\xcoord(P') \geq \xcoord(A) + 1$ (since $\xcoord(P')$ and $\xcoord(A)$ are integers).

But $P'$ is the next vertex after $A'$ on the path $p'$.
Hence, there is an arc from $A'$ to $P'$.
If this arc was a north-step, then we would have $\xcoord(P') = \xcoord(A')$, which would contradict $\xcoord(A') \leq \xcoord(A) < \xcoord(P')$.
Hence, this arc cannot be a north-step.
Thus, this arc must be an east-step.
Therefore, $\ycoord(P') = \ycoord(A')$ and $\xcoord(P') = \xcoord(A') + 1$.
Hence, $\xcoord(A') + 1 = \xcoord(P') \geq \xcoord(A) + 1$, so that $\xcoord(A') \geq \xcoord(A)$.
Combining this with $\xcoord(A') \leq \xcoord(A)$, we obtain $\xcoord(A') = \xcoord(A)$.

Now, the vertices $A$ and $A'$ have the same $x$-coordinate (since $\xcoord(A') = \xcoord(A)$) and the same $y$-coordinate (since $\ycoord(A') = \ycoord(A)$).
Hence, these two vertices are equal.
In other words, $A = A'$.
Hence, the vertex $A$ belongs to the path $p'$ (since the vertex $A'$ belongs to the path $p'$).
This contradicts the fact that the vertex $A$ does not belong to the path $p'$.
This contradiction shows that our assumption was false.
Hence, we have shown that $p$ and $p'$ have a vertex in common.

Now, forget that we fixed $A$, $B$, $A'$, $B'$, $p$ and $p'$.
We thus have proven that if $A$, $B$, $A'$, $B'$, $p$ and $p'$ are as in Lemma~\ref{lem.LGV.hex}, and if $\ell(p) + \ell(p') = N$, then $p$ and $p'$ have a vertex in common.
In other words, Lemma~\ref{lem.LGV.hex} holds when $\ell(p) + \ell(p') = N$.
This completes the induction step.
Hence, Lemma~\ref{lem.LGV.hex} is proven.
\end{proof}

\begin{proof}[Second proof of Lemma~\ref{lem.LGV.hex} (sketched).]
Recall that each arc of the lattice is either an east-step or a north-step.
Thus, the $x$-coordinates of the vertices of a path are always weakly increasing, and so are the $y$-coordinates.
Hence, the existence of a path $p$ from $A$ to $B'$ shows that $\xcoord(A) \leq \xcoord(B')$ and $\ycoord(A) \leq \ycoord(B')$.
Similarly, the existence of $p'$ yields $\xcoord(A') \leq \xcoord(B')$ and $\ycoord(A') \leq\ycoord(B)$.

Thus,
\begin{align}
\xcoord(A')  & \leq \xcoord(A)  \leq \xcoord(B') \leq \xcoord(B) \qquad \text{and} \label{pf.lem.LGV.hex.1} \\
\ycoord(A)  & \leq \ycoord(A') \leq \ycoord(B) \leq \ycoord(B'). \label{pf.lem.LGV.hex.2}
\end{align}
Now, consider the rectangle whose four sides are given by the equations
\[
x = \xcoord(A'), \qquad
y = \ycoord(A), \qquad
x = \xcoord(B), \qquad
y = \ycoord(B'),
\]
respectively (all in Cartesian coordinates).
Then, the path $p$ joins two opposite sides of this rectangle (namely, the second and the fourth), whereas
the path $p'$ joins the other two sides of this rectangle; moreover, both paths stay fully within the rectangle (due to~\eqref{pf.lem.LGV.hex.1} and~\eqref{pf.lem.LGV.hex.2}).
Hence, it is geometrically obvious that $p$ and $p'$ must meet; in other words, $p$ and $p'$ have a vertex in common.

[This last geometric argument can also be substituted by a purely combinatorial one.
Namely: Assume the contrary. Hence, the paths $p$ and $p'$ have no vertex in common.

We extend the path $p$ to a bidirectionally infinite path $\widetilde{p}$ by vertical steps (\textit{i.e.}, arcs of the form $(i,j) \to (i,j+1)$) in both directions (so the path $\widetilde{p}$ first reaches $A$ through infinitely many north-steps, then proceeds to $B'$ along $p$, and then leaves $B'$ along infinitely many north-steps).
We extend the path $p'$ to a bidirectionally infinite path $\widetilde{p'}$ by horizontal steps (\textit{i.e.}, arcs of the form $(i,j) \to (i+1,j)$) in both directions.
The resulting infinite paths $\widetilde{p}$ and $\widetilde{p'}$ have no vertex in common (indeed, the paths $p$ and $p'$ stay within the rectangle discussed above, and have no vertex in common; meanwhile, the new
steps we have added to them to obtain $\widetilde{p}$ and $\widetilde{p'}$ escape this rectangle normally in four different directions, whence they intersect neither each other nor $p$ or $p'$).
Recall that each arc of the lattice is either an east-step or a north-step.
Thus, if a vertex $C$ runs through a path, the value $\xcoord(C) + \ycoord(C)$ is incremented by $1$ with each step.
Hence, if $q$ is a bidirectionally infinite path, then, for each $N \in \ZZ$, there is a unique vertex $C$ of $q$ satisfying $\xcoord(C) + \ycoord(C) = N$.
Denote this vertex $C$ by $h_N(q)$.
Thus, the vertices of $q$ are $\ldots, h_{-1}(q), h_{0}(q), h_1(q), \ldots$ in this order.

All sufficiently low $N \in \ZZ$ satisfy $\xcoord\bigl( h_N(\widetilde{p'}) \bigr) < \xcoord\bigl( h_N(\widetilde{p}) \bigr)$, whereas all sufficiently high $N \in \ZZ$ satisfy $\xcoord\bigl( h_N(\widetilde{p'}) \bigr) > \xcoord\bigl( h_N(\widetilde{p}) \bigr)$.
Hence, the set of all $N \in \ZZ$ that satisfy $\xcoord\bigl( h_N(\widetilde{p'}) \bigr) < \xcoord\bigl( h_N(\widetilde{p}) \bigr)$ is a nonempty set of integers that is bounded from above.
Therefore, this set has a maximum.
Let $M$ be this maximum.
Thus, $M \in \ZZ$ satisfies $\xcoord\bigl( h_{M}(\widetilde{p'}) \bigr) < \xcoord\bigl( h_{M}(\widetilde{p}) \bigr)$ but $\xcoord\bigl( h_{M+1}(\widetilde{p'}) \bigr) \geq \xcoord\bigl( h_{M+1}(\widetilde{p}) \bigr)$.

But the point $h_{M+1}(\widetilde{p'})$ is either the eastern or the northern neighbor of $h_{M}(\widetilde{p'})$; hence, $\xcoord\bigl( h_{M+1}(\widetilde{p'}) \bigr) \leq \xcoord\bigl( h_{M}(\widetilde{p'}) \bigr) + 1$.
Also, the point $h_{M+1}(\widetilde{p})$ is either the eastern or the northern neighbor of $h_{M}(\widetilde{p})$; thus, $\xcoord\bigl( h_{M+1}(\widetilde{p}) \bigr) \geq \xcoord\bigl( h_{M}(\widetilde{p}) \bigr)$.
Hence,
\[
\xcoord\bigl( h_{M+1}(\widetilde{p'}) \bigr) \leq \underbrace{\xcoord\bigl( h_{M}(\widetilde{p'}) \bigr)}_{<\xcoord\bigl( h_{M}(\widetilde{p}) \bigr)} + 1 < \underbrace{\xcoord\bigl( h_{M}(\widetilde{p}) \bigr)}_{\leq\xcoord\bigl( h_{M+1}(\widetilde{p}) \bigr)} + 1 \leq \xcoord\bigl( h_{M+1}(\widetilde{p}) \bigr) + 1.
\]
Therefore, $\xcoord\bigl( h_{M+1}(\widetilde{p'}) \bigr) \leq \xcoord\bigl( h_{M+1}(\widetilde{p}) \bigr)$ (since both sides are integers).
Combining this with $\xcoord\bigl( h_{M+1}(\widetilde{p'}) \bigr) \geq \xcoord\bigl( h_{M+1}(\widetilde{p}) \bigr)$, we obtain $\xcoord\bigl( h_{M+1}(\widetilde{p'}) \bigr) = \xcoord\bigl( h_{M+1}(\widetilde{p}) \bigr)$.
Hence, $h_{M+1}(\widetilde{p'}) = h_{M+1}(\widetilde{p})$ (since $\xcoord\bigl( h_{M+1}(\widetilde{p'}) \bigr) -\ycoord\bigl( h_{M+1}(\widetilde{p'}) \bigr) = M + 1 = \xcoord\bigl( h_{M+1}(\widetilde{p}) \bigr) - \ycoord( h_{M+1}(\widetilde{p}) \bigr)$ as well).
Thus, the paths $\widetilde{p}$ and $\widetilde{p'}$ have a vertex in common (namely, $h_{M+1}(\widetilde{p'}) = h_{M+1}(\widetilde{p})$).
This contradicts the fact that they don't.
This contradiction shows that our assumption was false.
Hence, the paths $p$ and $p'$ have a vertex in common.]
\end{proof}

We can now specialize Proposition~\ref{prop.LGV.nonper} to a form that is most
suited for our applications:
\end{verlong}

We now shall state a folklore result, which follows from the Lindstr\"om--Gessel--Viennot lemma:\footnote{%
See the proof of Corollary~4 in \url{https://math.stackexchange.com/questions/2870640} (applied to $\omega_{a} = \wt(a)$) for a detailed derivation of Proposition~\ref{prop.LGV.concrete}.}

\begin{prop}
\label{prop.LGV.concrete}
Let $k \in \NN$.
Let $\uu = \tup{A_1, A_2, \dotsc, A_k}$ and $\vv = \tup{B_1,B_2, \dotsc, B_k}$ be two $k$-vertices such that
\begin{align*}
\xcoord(A_1) & \geq \xcoord(A_2) \geq \cdots \geq \xcoord(A_k), \\
\ycoord(A_1) & \leq \ycoord(A_2) \leq \cdots \leq \ycoord(A_k), \\
\xcoord(B_1) & \geq \xcoord(B_2) \geq \cdots \geq \xcoord(B_k), \\
\ycoord(B_1) & \leq \ycoord(B_2) \leq \cdots \leq \ycoord(B_k).
\end{align*}
Then,
\[
\sum_{\pp \in N(\uu,\vv)} \wt(\pp) = \det\left( \sum_{p\in N(A_i,B_j) } \wt(p) \right)_{i, j \in \ive{k}} .
\]
\end{prop}

The situation of this proposition is illustrated in Figure~\ref{fig:NILP_example}.

\begin{verlong}
\begin{proof}[Proof of Proposition~\ref{prop.LGV.concrete}.]
This will follow immediately from Proposition~\ref{prop.LGV.nonper}
once we have shown that $\left( \uu,\vv\right)  $ is nonpermutable.
Thus, it remains to show the latter fact.

Let $\sigma\neq\id$ be a permutation in $\SymGp{k}$.
We must show that $N\bigl(\uu, \sigma(\vv) \bigr) = \emptyset$.
Indeed, let $\pp\in N\bigl( \uu,\sigma(\vv) \bigr)$.

The permutation $\sigma$ has an inversion (since $\sigma \neq \id$).
In other words, there exist some $i<j$ in $\ive{k}$ such that $\sigma(i) > \sigma(j)$.
Consider such $i$ and $j$.

Write $\pp$ in the form $\pp = \tup{p_1, p_2, \dotsc, p_k}$.
Thus, $\tup{p_1, p_2, \dotsc, p_k}$ is a NILP from $\uu$ to $\sigma(\vv)$ (since $\tup{p_1, p_2, \dotsc, p_k} = \pp\in N\bigl( \uu, \sigma(\vv) \bigr)$).

By the definition of a NILP, this implies that
\begin{itemize}
\item $p_i$ is a path from $A_i$ to $B_{\sigma(i)}$;

\item $p_j$ is a path from $A_j$ to $B_{\sigma(j)}$;

\item the paths $p_i$ and $p_j$ have no vertex in common.
\end{itemize}

However, the assumptions of Proposition~\ref{prop.LGV.concrete} yield
$\xcoord(A_j) \leq \xcoord(A_i)$,
$\ycoord(A_j) \geq \ycoord(A_i)$,
$\xcoord(B_{\sigma(i)}) \leq \xcoord(B_{\sigma(j)})$, and
$\ycoord(B_{\sigma(i)}) \geq \ycoord(B_{\sigma(j)})$.
Hence, Lemma~\ref{lem.LGV.hex} (applied to $A = A_i$, $B = B_{\sigma(j)}$, $A' = A_j$, $B' = B_{\sigma(i)}$, $p = p_i$ and $p' = p_j$) shows that $p_i$ and $p_j$ have a vertex in common.
This contradicts the fact that the paths $p_i$ and $p_j$ have no vertex in common.

Thus we have found a contradiction for each $\pp\in N\bigl( \uu,\sigma(\vv) \bigr)$.
Hence, $N\bigl(\uu, \sigma(\vv) \bigr) = \emptyset$, as we desired.
\end{proof}
\end{verlong}

%%%%%%%%%%
\subsection{Pseudo-partitions and tableaux}

We shall next introduce the concepts of pseudo-partitions and their corresponding semistandard tableaux;
we will then express a generating function for these tableaux by a determinantal formula (Theorem~\ref{thm.tableau.jt}) akin to the Jacobi--Trudi formula for Schur functions (and, like the latter, the proof will rely on Proposition~\ref{prop.LGV.concrete}).
A pseudo-partition is similar to the concept of a partition, except it allows entries to increase by $1$.
The semistandard tableaux of a pseudo-partition shape are defined just like for partitions.
The generating function in our determinantal formula is going to be a sum over the semistandard tableaux of a fixed pseudo-partition shape with given rightmost entries in each row.
Later we will translate these tableaux into MLQs that yield a specific word when applied to $1^n$.

Let us formalize these definitions.
A \defn{pseudo-partition} shall mean a $k$-tuple $\lambda = \tup{\lambda_1, \lambda_2, \dotsc, \lambda_k}$ of positive integers (for some $k \in \NN$) such that
\[
\text{each } i \in \ive{k-1} \text{ satisfies } \lambda_i + 1 \geq \lambda_{i+1}.
\]
For example, both $\tup{5,3,4,2,2}$ and $\tup{6,2,3,4,1}$ are pseudo-partitions.

The \defn{diagram $\diag{\lambda}$} of a pseudo-partition $\lambda = \tup{\lambda_1, \lambda_2, \dotsc,\lambda_k}$ is defined as the set
$\set{  \left(  i,j\right)  \in \ive{k} \times \set{ 1,2,3,\ldots }  \mid  j \leq \lambda_i }$.
This diagram is drawn in the plane like usual Young diagrams, in English notation.
\begin{verlong}
For example, the diagram of the pseudo-partition $\tup{3,2,3,1}$ is drawn as
\[
\ydiagram{3,2,3,1}.
\]
\end{verlong}

If $\lambda = \tup{\lambda_1, \lambda_2, \dotsc, \lambda_k}$ is a pseudo-partition, then a \defn{tableau of shape $\lambda$} is a map $T \colon \diag{\lambda} \to \set{1,2,3,\ldots}$.
For each such tableau $T$ and each $(i,j) \in \diag{\lambda}$, we refer to the value $T(i,j)$ as the \defn{entry of $T$ in cell $\left(i,j\right)$}.
As usual, we represent a tableau $T$ of shape $\lambda$ by placing the entry $T(i,j)$ into the box corresponding to $(i,j) \in \diag{\lambda}$.
\begin{verlong}
For example, the following are two tableaux of shape $\tup{3,2,3,1}$:
\begin{equation}
\label{eq.tableau.exas-long}
\begin{ytableau} 2 & 5 & 3 \\ 1 & 1 \\ 2 & 4 & 1 \\ 7 \end{ytableau}\qquad
\text{and}\qquad
\begin{ytableau} 1 & 1 & 3 \\ 2 & 3 \\ 4 & 5 & 5 \\ 5 \end{ytableau}.
\end{equation}
\end{verlong}

A tableau $T$ of shape $\lambda$ is said to be \defn{semistandard} if and only if
\begin{itemize}
\item the entries of $T$ are weakly increasing along each row (\textit{i.e.}, we have $T(i,j_1) \leq T(i,j_2)$ whenever $(i,j_1) \in \diag{\lambda}$ and $(i,j_2) \in \diag{\lambda}$ satisfy $j_1 < j_2$);

\item the entries of $T$ are strictly increasing down each column (\textit{i.e.}, we have $T(i_1,j) < T(i_2,j)$ whenever $(i_1,j) \in \diag{\lambda}$ and $(i_2,j) \in \diag{\lambda}$ satisfy $i_1 < i_2$).
\end{itemize}

\begin{verlong}
For example, the second tableau in~\eqref{eq.tableau.exas-long} is semistandard, while the first is not.
\end{verlong}

If $\lambda = \tup{\lambda_1, \lambda_2, \dotsc, \lambda_k}$ is a pseudo-partition, and if $T$ is a tableau of shape $\lambda = \tup{\lambda_1, \lambda_2, \dotsc, \lambda_k}$,
then the \defn{surface} of $T$ is defined to be the $k$-tuple $(s_1, s_2, \dotsc, s_k)$, where $s_i$ is the rightmost entry of the $i$-th row of $T$ (that is, $s_i = T(i,\lambda_i)$).

If $T$ is a tableau of shape $\lambda$ whose entries belong to $\ive{n}$, then the \defn{weight} of $T$ is defined as the monomial
\[
\wt(T) := \prod_{(i,j) \in \diag{\lambda}} x_{T(i,j)}
\]
(that is, the product of $x_{d}$ for $d$ ranging over all entries of $T$).
\begin{verlong}
For example, the two tableaux in~\eqref{eq.tableau.exas-long} have weights $x_1^{3}x_2^{2}x_{3}x_{4}x_{5}x_{7}$ and $x_1^{2}x_2x_{3}^{2}x_{4}x_{5}^{3}$, respectively (assuming that $n \geq 7$).
\end{verlong}
Let $\SST(\lambda, s)$ denote the set of all semistandard tableaux of shape $\lambda$ and surface $s$.

\begin{example}
The diagram of the pseudo-partition $\tup{3,2,3,1}$ is drawn as
\[
\ydiagram{3,2,3,1}\,.
\]
The following are two tableaux of shape $\tup{3,2,3,1}$:
% $n$ doesn't appear in our definitions; we fix the surface in our formula, which ensures no too-high entries.
\[
\label{eq.tableau.exas}
\begin{ytableau} 1 & 2 & 5 \\ 2 & 3 \\ 3 & 4 & 5 \\ 7 \end{ytableau}\qquad
\text{and}\qquad
\begin{ytableau} 1 & 1 & 4 \\ 2 & 3 \\ 4 & 5 & 5 \\ 5 \end{ytableau}\,.
\]
The right tableau is semistandard, while the left one is not (the two $5$'s in the rightmost column).
These tableaux have surfaces $(5,3,5,7)$ and $(4,3,5,5)$, respectively, and weights $x_1 x_2^2 x_3^2 x_4 x_5^2 x_7$ and $x_1^2 x_2 x_3 x_4^2 x_5^3$, respectively.
\end{example}

We now state the main result of this subsection:

\begin{thm}
\label{thm.tableau.jt}
Let $\lambda = \tup{\lambda_1, \lambda_2, \dotsc, \lambda_k}$ be a pseudo-partition.
Let $s = \tup{s_1, s_2, \dotsc, s_k}$ be a strictly increasing sequence of elements of $\ive{n}$.
Then,
\[
\sum_{T \in \SST(\lambda, s)} \wt(T) = \left(  \prod_{i=1}^{k} x_{s_i} \right)  \det\left(  h_{\lambda_j-j+i-1}(  x_1,x_2,\ldots,x_{s_j})  \right)_{i, j \in \ive{k}} .
\]
\end{thm}

We remark that the determinant in Theorem~\ref{thm.tableau.jt} is an instance of a \defn{multi-Schur function} as defined in~\cite[(SCHUR.2.2)]{LLPT18}.


\begin{figure}[t]
\[
\begin{ytableau} 1 & 1 & 2 \\ 2 & 3 \\ 4 & 5 & 5 \\ 6 \end{ytableau}
\quad \longleftrightarrow \quad
\begin{tikzpicture}[baseline=3.5cm]
  \draw[densely dotted] (-1,0) grid (6.2,6.2);
  % axes:
  \draw[->] (-1,0) -- (-1,6.2);
  \draw[->] (-1,0) -- (6.2,0);
  \foreach \x/\xtext in {-1, 0, 1, 2, 3, 4, 5, 6}
     \draw (\x cm,1pt) -- (\x cm,-1pt) node[anchor=north] {$\xtext$};
  \foreach \y/\ytext in {0, 1, 2, 3, 4, 5, 6}
     \draw (-1cm+1pt,\y cm) -- (-1cm-1pt,\y cm) node[anchor=east] {$\ytext$};
  \foreach \x in {1, 2, 3, 4}
    \node[circle,fill=white,draw=black,text=darkred,inner sep=1pt] (A\x) at (4-\x,1) {$A_{\x}$};

  \node[circle,fill=white,draw=black,text=black,inner sep=1pt] (B4p) at (1+4-4-1,6) {$B_4$};
  \node[circle,fill=black,inner sep=1.5pt] (B4) at (1+4-4,6) {};
  \node[circle,fill=white,draw=black,text=black,inner sep=1pt] (B3p) at (3+4-3-1,5) {$B_3$};
  \node[circle,fill=black,inner sep=1.5pt] (B3) at (3+4-3,5) {};
  \node[circle,fill=white,draw=black,text=black,inner sep=1pt] (B2p) at (2+4-2-1,3) {$B_2$};
  \node[circle,fill=black,inner sep=1.5pt] (B2) at (2+4-2,3) {};
  \node[circle,fill=white,draw=black,text=black,inner sep=1pt] (B1p) at (3+4-1-1,2) {$B_1$};
  \node[circle,fill=black,inner sep=1.5pt] (B1) at (3+4-1,2) {};

  \begin{scope}[thick,>=stealth,brown]
      % $p_4$:
      \draw (A4) edge[->] (0,2);
      \draw (0,1.6) node[anchor=east] {$1$};
      \draw (0,2) edge[->] (0,3);
      \draw (0,2.5) node[anchor=east] {$1$};
      \draw (0,3) edge[->] (0,4);
      \draw (0,3.5) node[anchor=east] {$1$};
      \draw (0,4) edge[->] (0,5);
      \draw (0,4.5) node[anchor=east] {$1$};
      \draw (0,5) edge[->] (B4p);
      \draw (0,5.4) node[anchor=east] {$1$};
      \draw (B4p) edge[->,color=black] (B4);
      \draw[color=black] (0.6,6) node[anchor=south] {$x_6$};
  \end{scope}
  \begin{scope}[thick,>=stealth,red]
      % $p_3$:
      \draw (A3) edge[->] (1,2);
      \draw (1,1.6) node[anchor=east] {$1$};
      \draw (1,2) edge[->] (1,3);
      \draw (1,2.5) node[anchor=east] {$1$};
      \draw (1,3) edge[->] (1,4);
      \draw (1,3.5) node[anchor=east] {$1$};
      \draw (1,4) edge[->] (2,4);
      \draw (1.5,4) node[anchor=north] {$x_4$};
      \draw (2,4) edge[->] (2,5);
      \draw (2,4.5) node[anchor=east] {$1$};
      \draw (2,5) edge[->] (B3p);
      \draw (2.4,5) node[anchor=north] {$x_5$};
      \draw (B3p) edge[->,color=black] (B3);
      \draw[color=black] (3.6,5) node[anchor=south] {$x_5$};
  \end{scope}
  \begin{scope}[thick,>=stealth,blue]
      % $p_2$:
      \draw (A2) edge[->] (2,2);
      \draw (2,1.6) node[anchor=east] {$1$};
      \draw (2,2) edge[->] (3,2);
      \draw (2.5,2) node[anchor=north] {$x_2$};
      \draw (3,2) edge[->] (B2p);
      \draw (3,2.4) node[anchor=east] {$1$};
      \draw (B2p) edge[->,color=black] (B2);
      \draw[color=black] (3.6,3) node[anchor=south] {$x_3$};
  \end{scope}
  \begin{scope}[thick,>=stealth,dgreencolor]
      % $p_1$:
      \draw (A1) edge[->] (4,1);
      \draw (3.6,1) node[anchor=north] {$x_1$};
      \draw (4,1) edge[->] (5,1);
      \draw (4.6,1) node[anchor=north] {$x_1$};
      \draw (5,1) edge[->] (B1p);
      \draw (5,1.4) node[anchor=east] {$1$};
      \draw (B1p) edge[->,color=black] (B1);
      \draw[color=black] (5.6,2) node[anchor=south] {$x_2$};
  \end{scope}
  
\end{tikzpicture}
\]
\caption{A semistandard tableau of surface $(2,3,5,6)$ (left) and the corresponding NILP (right).
  Note that the final horizontal steps are fixed.}
\label{fig:tableau_to_NILP}
\end{figure}

\begin{vershort}
\begin{proof}[Proof of Theorem~\ref{thm.tableau.jt}.]
The proof is similar to the usual Jacobi--Trudi bijection relating semistandard tableaux and NILPs.
For example, see~\cite[First proof of Thm. 7.16.1]{Stanley-EC2}.\footnote{Note that in this proof, those paths go west instead of east, but this is just a reflection across the $y$-axis.}
We note on the differences.
\begin{itemize}
\item The fixed surface $s = (s_1, \dotsc, s_k)$ condition on the semistandard tableaux of shape $\lambda = (\lambda_1, \dotsc, \lambda_k)$ translates into requiring each path $p_i$ having the final arc be an east-step.
However, the corresponding NILP coming from the LGV Lemma is without this final arc, and more precisely, it would start and end $k$-vertices are $\uu = (A_1, \dotsc, A_k)$ and $\vv = (B_1, \dotsc, B_k)$, respectively, with
\[
A_i = (k-i,1)  \qquad \text{and} \qquad B_i = (\lambda_i+k-i-1, s_i).
\]
This fixed surface $s$ (or fixed final east steps) yields the $\prod_{i=1}^k x_{s_i}$ factor.
Removing these final steps yields the NILP coming from the LGV Lemma.
\item We can have the bottom row be longer than the row above it, but then these final steps are free (except for being larger than things to their left).
\item We can have gaps between entries in a column, but the semistandard and strictly increasing surface conditions hold when removing intermediate rows from consideration.
Indeed, removing these rows and their corresponding paths gives a natural injection on both the tableaux their corresponding NILPs.
\end{itemize}
\end{proof}
\end{vershort}

\begin{verlong}
\begin{proof}[Proof of Theorem~\ref{thm.tableau.jt}.]
Let us define two $k$-vertices $\uu = \tup{A_1, A_2, \dotsc, A_k}$ and $\vv = \tup{B_1, B_2, \dotsc, B_k}$ by
\[
A_i = (k-i,1)  \qquad \text{and} \qquad B_i = (\lambda_i+k-i-1, s_i).
\]
The conditions of Proposition~\ref{prop.LGV.concrete} are satisfied (since $\lambda$ is a pseudo-partition and $s$ is weakly increasing).
Thus, Proposition~\ref{prop.LGV.concrete} yields
\begin{align}
\sum_{\pp \in N(\uu,\vv)} \wt(\pp) & = \det\left(  \sum_{p \in  N(A_i,B_j)}\wt(p) \right)_{i, j \in \ive{k}} \nonumber \\
 & = \det\left( h_{\lambda_j-j+i-1}(x_1, x_2, \dotsc, x_{s_j}) \right)_{i, j \in \ive{k}},
\label{pf.thm.tableau.jt.1}
\end{align}
where the second equality follows from the fact each $i,j \in \ive{k}$ satisfy
\[
\sum_{p \in N(A_i,B_j)} \wt(p) = h_{\lambda_j-j+i-1}(x_1, x_2, \dotsc, x_{s_j})
\]
(by~\eqref{eq.LGV.single-paths}, applied to $A = A_i$ and $B = B_j$).

Next, let us define a bijection
\[
\Phi \colon N(\uu, \vv) \to \SST(\lambda, s).
\]

Indeed, let $\tup{p_1, p_2, \dotsc, p_k} \in N(\uu,\vv)$ be arbitrary.
Thus, each $p_i$ is a path from $A_i$ to $B_i$, and no two of the paths $p_1, p_2, \dotsc, p_k$ have a vertex in common.

For each $i \in \ive{k}$, the path $p_i$ is a path from $A_i = (k-i, 1)$ to $B_i = (\lambda_i+k-i-1,s_i)$; thus, it must contain exactly $(\lambda_i+k-i-1) - (k-i) = \lambda_i - 1$ east-steps.

Let $p_{i,1},p_{i,2}, \dotsc, p_{i,\lambda_i-1}$ be the $y$-coordinates of these east-steps (from first to last).
Also, set $p_{i,\lambda_i} = s_i$.
Thus,
\begin{equation}
\label{pf.thm.tableau.jt.row-weak}
1 \leq p_{i,1} \leq p_{i,2} \leq \cdots \leq p_{i,\lambda_i-1} \leq p_{i,\lambda_i} = s_i
\end{equation}
for each $i \in \ive{k}$.
Note that for each $i \in \ive{k}$,
\begin{subequations}
\begin{gather}
\label{pf.thm.tableau.jt.pi-vert-1}
\text{the path }p_i\text{ contains the vertices } (k-i+j-1, p_{i,j})  \text{ for all } j \in \ive{\lambda_i}
\\
\label{pf.thm.tableau.jt.pi-vert-2}
\text{and the vertices } (k-i+j, p_{i,j}) \text{ for all } j \in \ive{\lambda_i-1}.
\end{gather}
\end{subequations}

Now, let $T$ be the tableau of shape $\lambda$ that sends each $(i,j) \in \diag{\lambda}$  to $p_{i,j}$.
Then, the entries of $T$ are weakly increasing along each row by~\eqref{pf.thm.tableau.jt.row-weak}.
We shall next show that the entries of $T$ are strictly increasing down each column.

First, we claim that if $i \in \ive{k-1}$, then, for all $j \in \ive{\lambda_i} \cap \ive{\lambda_{i+1}}$, we have
\begin{equation}
\label{pf.thm.tableau.jt.col-strict-no-gap}
p_{i,j} < p_{i+1,j}.
\end{equation}

\begin{subproof}
We will show~\eqref{pf.thm.tableau.jt.col-strict-no-gap} holds.
Let $i \in \ive{k-1}$.
We must prove~\eqref{pf.thm.tableau.jt.col-strict-no-gap} for each $j \in \ive{\lambda_i}  \cap \ive{\lambda_{i+1}}  $.
To do so, we assume the contrary, and pick the \emph{smallest} $j$ for which~\eqref{pf.thm.tableau.jt.col-strict-no-gap} fails.
Thus, $p_{i,j} \geq p_{i+1,j}$.
Assume that $j > 1$ (the argument for the case $j=1$ is similar).
Thus, the minimality of $j$ forces $p_{i,j-1} < p_{i+1,j-1}$.
Finally,~\eqref{pf.thm.tableau.jt.row-weak} yields $p_{i+1,j-1} \leq p_{i+1,j}$.
Hence, $p_{i,j-1} < p_{i+1,j-1} \leq p_{i+1,j} \leq p_{i,j}$.
No two of the paths $p_1, p_2, \dotsc, p_k$ have a vertex in common.
Hence, $p_i$ and $p_{i+1}$ have no vertex in common.
Note that~\eqref{pf.thm.tableau.jt.pi-vert-1} yields that $p_i$ contains the vertex $\tup{k-i+j-1, p_{i,j}}$.
Also,~\eqref{pf.thm.tableau.jt.pi-vert-2} (applied to $j-1$ instead of $j$) yields that $p_i$ contains the vertex $\tup{k-i+j-1, p_{i,j-1}}$.
However, the vertex $\tup{k-i+j-1, p_{i+1,j}}$ lies on the vertical line segment connecting the two vertices $\tup{k-i+j-1, p_{i,j}}$ and $\tup{k-i+j-1,p_{i,j-1}}$ (since $p_{i,j-1} \leq p_{i+1,j} \leq p_{i,j}$).
Hence, $p_i$ must contain the former vertex (since $p_i$ contains the latter two vertices).

From~\eqref{pf.thm.tableau.jt.row-weak}, we obtain $p_{i,j} \leq s_i < s_{i+1}$ (since $s$ is strictly increasing).
If we had $j = \lambda_{i+1}$, then we would have $p_{i+1,j} = p_{i+1,\lambda_{i+1}} = s_{i+1}$ (by the definition of
$p_{i+1,\lambda_{i+1}}$), which would contradict $p_{i+1,j} \leq p_{i,j} < s_{i+1}$.
Hence, $j \neq \lambda_{i+1}$. Thus, $j \in \ive{\lambda_{i+1}-1}$ (since $j \in \ive{\lambda_{i+1}}$).
Therefore,~\eqref{pf.thm.tableau.jt.pi-vert-2} (applied to $i+1$ instead of $i$) shows that $p_{i+1}$ contains the vertex $\tup{k-(i+1)+j, p_{i+1,j}} = \tup{k-i+j-1, p_{i+1,j}}$.
So we have shown that both $p_i$ and $p_{i+1}$ contain the vertex $\tup{k-i+j-1, p_{i+1,j}}$.
This contradicts the fact that $p_i$ and $p_{i+1}$ have no vertex in common.

We have assumed that $j > 1$; but the same argument works for $j = 1$ with minor 
changes
(we now need to use $\tup{k-i+j-1, 1}$ instead of $\tup{k-i+j-1, p_{i,j-1}}$).
Thus, we always obtain a contradiction.
This contradiction shows that our assumption was false; hence,~\eqref{pf.thm.tableau.jt.col-strict-no-gap} is proven.
\end{subproof}

Next, we claim that the entries of $T$ are strictly increasing down each column.

\begin{subproof}
Let $i_1,i_2\in\ive{k}$ be such that $i_1 < i_2$.
Let $j \in \ive{\lambda_{i_1}} \cap \ive{\lambda_{i_2}}$.
We must show that $T( i_1,j) < T(i_2, j)$.
In other words, we must prove that $p_{i_1,j} < p_{i_2,j}$ (since $T(i,j) = p_{i,j}$ for all $i$).

If the column $j$ of $\diag{\lambda}$ has no gaps between row $i_1$ and row $i_2$ (that is, if we have $(i,j) \in \diag{\lambda}$ for each $i \in \set{i_1, i_1+1, \dotsc, i_2}$), then this follows from~\eqref{pf.thm.tableau.jt.col-strict-no-gap}.
Hence, without loss of generality, we assume that column $j$ of $\diag{\lambda}$ has at least one gap between row $i_1$ and row $i_2$.
In other words, there exists some $q \in \set{i_1, i_1+1, \dotsc, i_2}$ such that $(q,j) \notin \diag{\lambda}$.
Consider the \emph{largest} such $q$.
Clearly, $i_1 < q < i_2$.
Also, $\lambda_{q} < j$ (since $(q,j) \notin \diag{\lambda}$).

The maximality of $q$ shows that column $j$ of $[\lambda]$ has no gaps between row $q$ and row $i_2$.
Hence,~\eqref{pf.thm.tableau.jt.col-strict-no-gap} shows that $p_{q,j}<p_{i_2,j}$ (since $q<i_2$).

From~\eqref{pf.thm.tableau.jt.row-weak}, we obtain $p_{i_1,j} \leq s_{i_1} \leq s_{q}$ (since $i_1 < q$, but the sequence $s$ is weakly increasing).
Also, $p_{q,\lambda_{q}} = s_{q}$ (by the definition of $p_{q,\lambda_{q}}$), whence $s_{q} = p_{q,\lambda_{q}} \leq p_{q,j}$ (by~\eqref{pf.thm.tableau.jt.row-weak}, since $\lambda_{q} < j$).
Hence, $p_{i_1,j} \leq s_{q} \leq p_{q,j} < p_{i_2,j}$. This proves our claim.
\end{subproof}

Altogether, we thus know that $T$ is a semistandard tableau of shape $\lambda$ and surface $s$ (since $T(i, \lambda_i) = p_{i,\lambda_i} = s_i$ for all $i \in \ive{k}$).
That is, $T \in \SST(\lambda, s)$.
So let us set
\[
\Phi(p_1, p_2, \dotsc, p_k) = T.
\]
Thus, the map $\Phi$ is defined.

It is easy to see that this map $\Phi$ is injective (indeed, $\tup{p_1,p_2,\dotsc,p_k}$ can be reconstructed from $T$, since the $i$-th row of $T$ encodes the $y$-coordinates of all the east-steps of $p_i$) and surjective (indeed, the reverse of the above construction turns every $T \in \SST(\lambda, s)$ into a $k$-tuple $\tup{p_1, p_2, \dotsc, p_k}$ of paths $p_i$ from $A_i$ to $B_i$; furthermore, the strict increase of the entries of $T$ down columns forces these paths $p_1,p_2,\ldots,p_k$ to have no vertices in common).
Thus, $\Phi$ is a bijection.
Moreover, it is easy to see that
\[
\wt\bigl(  \Phi(\pp) \bigr) = \left( \prod_{i=1}^k x_{s_i} \right) \wt(\pp)
\]
for each $\pp \in N(\uu,\vv)$.
Hence,
\begin{align*}
\sum_{T \in \SST(\lambda, s)} \wt(T)  &  = \sum_{\pp\in N(\uu,\vv)  }\left( \prod_{i=1}^k x_{s_i} \right)  \wt(\pp)
= \left( \prod_{i=1}^k x_{s_i} \right) \sum_{\pp\in N(\uu,\vv)  } \wt(\pp) \\
&  \overset{\eqref{pf.thm.tableau.jt.1}}{=} \left(  \prod_{i=1}^k x_{s_i} \right)  \det\left( h_{\lambda_j-j+i-1}(x_1, x_2, \dotsc, x_{s_j}) \right)_{i, j \in \ive{k}}.
\end{align*}
\end{proof}

We note that during the construction of the bijection $\Phi$, the fixed surface $s$ condition on the semistandard tableaux translates into requiring each path $p_i$ to having a final arc $B_i \to (\lambda_i + k - i, s_i)$.
Otherwise the rest of the proof is similar to the usual Jacobi--Trudi bijection relating semistandard tableaux and NILPs.
\end{verlong}

See Figure~\ref{fig:tableau_to_NILP} for an example of the bijection between semistandard tableaux with a fixed (strictly increasing) surface and NILPs used in the proof of Theorem~\ref{thm.tableau.jt}.


%%%%%%%%%%
\subsection{Interlacing MLQs}

Let us introduce some further notations now.

First, we define two binary relations $\succeq$ and $\gg$ on the powerset of $\ive{n}$:

\begin{itemize}
\item Given two subsets $A = \set{a_1 < \cdots < a_{\alpha}} $ and $B = \set{b_1 < \cdots < b_{\beta}}$ of $\ive{n}$, we say that \defn{$A\succeq B$} if and only if $\alpha =\beta$ and every $a_k \geq b_k$ for all $1 \leq k \leq \alpha$.

\item Given two subsets $A$ and $B$ of $\ive{n}$, we say that \defn{$A \gg B$} if and only if every $a \in A$ and $b \in B$ satisfy $a > b$.
\end{itemize}

For example, $\set{10,8} \gg \set{4,6,7} \succeq \set{4,5,7} \succeq \set{2,5,6}  \gg \set{1}$.
Note that $A \gg \emptyset$ and $\emptyset \gg A$ for any subset $A$ of $\ive{n}$ (for vacuous reasons), so that $\gg$ is not a partial order (but it becomes a partial order if we forbid $\emptyset$).
%\travis{Does the $\emptyset$ come up at all? Can we say for $\gg$ that $A$ and $B$ are nonempty sets and make it a partial order?}
%\darij{Yeah, tried that, it made Lemma \ref{lem:determinant_form.interl-A} even more complicated.}

The following criterion (proof left to the reader) will be useful:

\begin{lemma}
\label{lem:determinant_form.gale1}
Let $A, B \subseteq \ive{n}$.
We have $A \succeq B$ if and only if there exists a bijection $\phi \colon B \to A$ satisfying $\phi(b) \geq b$ for each $b \in B$.
\end{lemma}

Fix some $\ell \in \NN$ and a type $\mm = \tup{m_1,m_2, \dotsc, m_{\ell}, 0, 0, \ldots}$ with $\ell$ classes.
Assume that $m_i > 0$ for all $i \in \ive{\ell-1}$ (but $m_{\ell}$ may be $0$).

Our next few definitions concern MLQs.
Consider an (ordinary) MLQ $\qq = \tup{q_1,\ldots,q_{\ell-1}}$ of type $\mm$.
Thus, for each $i \in \ive{\ell-1}$, we have $\abs{q_i} = p_i(\mm) = m_1 + m_2 + \cdots + m_i$.
Hence, for each $i \in \ive{\ell-1}$, we can subdivide the set $q_i$ into $i$ blocks: the block containing the largest $m_1$ elements; the block containing the next-largest $m_2$ elements; and so on, until the block containing the smallest $m_i$ elements.
Denote these $i$ blocks by $q_i^{(1)}, q_i^{(2)}, \dotsc, q_i^{(i)}$, respectively.
Thus, $q_i^{(1)}, q_i^{(2)}, \dotsc, q_i^{(i)}$ are pairwise disjoint nonempty subsets of $\ive{n}$ satisfying
\begin{subequations}
\begin{align}
\label{eq.determinant_form.qij.1}
  q_i  & = q_i^{(1)} \cup q_i^{(2)} \cup \cdots \cup q_i^{(i)}
\qquad \text{and}
\\ \label{eq.determinant_form.qij.2}
  q_i^{(1)} & \gg q_i^{(2)} \gg \cdots \gg q_i^{(i)}
\qquad \text{and}
\\ \label{eq.determinant_form.qij.3}
  \abs{q_i^{(j)}} & = m_j \text{ for all } j \in \ive{i}.
\end{align}
\end{subequations}
Thus, we have defined nonempty queues $q_i^{(j)} \subseteq \ive{n}$ for all $i \in \ive{\ell-1}$ and $j \in \ive{i}$ whenever $\qq = \tup{q_1, \dotsc, q_{\ell-1}}$ is an MLQ of type $\mm$.

\Darij{TODO: Example.}

We say that the MLQ $\qq = \tup{q_1, \dotsc, q_{\ell-1}}$ is \defn{interlacing} if each $i \in \set{2,3,\dotsc,\ell-1}$ satisfies
\begin{equation}
\label{eq.determinant_form.interlacing.def}
q_i^{(1)} \succeq q_{i-1}^{(1)} \gg
q_i^{(2)} \succeq q_{i-1}^{(2)} \gg
q_i^{(3)} \succeq q_{i-1}^{(3)} \gg \cdots \gg
q_i^{(i)}
\end{equation}
(that is, $q_i^{(j)} \succeq q_{i-1}^{(j)} \gg q_i^{(j+1)}$ for all $j \in \ive{i-1}$).

\Darij{TODO: Example.}

Forget that we fixed $\qq$.
% I don't understand what purpose this sentence serves -- Travis
% It serves to clarify that $\qq$ is no longer fixed. --Darij

%Let $k = p_{\ell-1}(\mm) = m_1 + m_2 + \cdots + m_{\ell-1} = n - m_{\ell} \in \NN$.
Define a pseudo-partition
\begin{equation}
\label{eq.determinant_form.interlacing.lam}
\lambda^{\mm} := (
  \underbrace{1,1,\ldots,1}_{m_{\ell-1}\text{ times}},
  \underbrace{2,2,\ldots,2}_{m_{\ell-2}\text{ times}},
  \ldots,
  \underbrace{\ell-1,\ell-1,\ldots,\ell-1}_{m_1\text{ times}}
).
\end{equation}
Thus, the columns of the diagram $\diag{\lambda^{\mm}}$ are aligned to the bottom, and have lengths $p_{\ell-1}(\mm), p_{\ell-2}(\mm), \dotsc, p_1(\mm)$ (from left to right).

\begin{lemma}
\label{lem:determinant_form.bij1}
Let $\ell$, $\mm$, and $m_i$ be as above.
Then, there is an injection
\[
P \colon \set{ \text{MLQs of type } \mm } \to \set{ \text{tableaux of shape } \lambda^{\mm} }
\]
with the following properties:
\begin{enumerate}
\item[(a)] We have $\wt\bigl(  P(\qq) \bigr) = \wt(\qq)$ for each MLQ $\qq$ of type $\mm$.

\item[(b)] If $\qq = \tup{q_1, q_2, \dotsc, q_{\ell-1}}$ is an MLQ of type $\mm$, then the surface of $P(\qq)$ is the list of all elements of $q_{\ell-1}$ in increasing order.

\item[(c)] If $\qq$ is an interlacing MLQ of type $\mm$, then $P(\qq)$ is a semistandard tableau of shape $\lambda^{\mm}$.

\item[(d)] Any semistandard tableau $T$ of shape $\lambda^{\mm}$ has the form $P(\qq)$ for some interlacing MLQ $\qq$ of type $\mm$.
\end{enumerate}
\end{lemma}

(To make sense of this in the border case $\ell = 1$, we agree to interpret $q_0$ as the empty set whenever $\qq = \tup{q_1, q_2, \dotsc, q_{\ell-1}}$ is an MLQ.)

\begin{proof}[Proof of Lemma~\ref{lem:determinant_form.bij1}.]
If $r \subseteq \ive{n}$ is any queue, then $\widetilde{r}$ shall denote the entries of $r$ written vertically in a column, strictly increasing from top to bottom.
For example, if $r = \set{2,5,6}$, then $\widetilde{r}$ is the column $\begin{ytableau} 2 \\ 5 \\ 6 \end{ytableau}$.

Now, we define the map $P$ as follows: If $\qq = \tup{q_1, q_2, \dotsc, q_{\ell-1}}$ is any MLQ of type $\mm$, then we let $P(\qq)$ be the following tableau of shape $\lambda^{\mm}$:
\begin{equation}
\label{pf.lem:determinant_form.bij1.visual}
\begin{array}[c]{r|c|ccc@{\hspace{30pt}}c@{\hspace{35pt}}c@{\hspace{35pt}}}
\cline{2-2}%
m_{\ell-1} \text{ rows } \left\{ \vphantom{\dfrac{2^2}{2^2}}\right.
    & \widetilde{q_{\ell-1}^{(\ell-1)}} &  &  &  &  & \\\cline{2-3}
m_{\ell-2} \text{ rows } \left\{ \vphantom{\dfrac{2^2}{2^2}}\right.
    & \widetilde{q_{\ell-2}^{(\ell-2)}} & \widetilde{q_{\ell-1}^{(\ell-2)}} & \multicolumn{1}{|c}{} &  &  & \\\cline{2-4}
m_{\ell-3} \text{ rows } \left\{  \vphantom{\dfrac{2^2}{2^2}}\right.
    & \widetilde{q_{\ell-3}^{(\ell-3)}} & \widetilde{q_{\ell-2}^{(\ell-3)}} & \multicolumn{1}{|c}{\widetilde{q_{\ell-1}^{(  \ell-3)}}} & \multicolumn{1}{|c}{} &  & \\\cline{2-4}%
\vdots & \mathbf{\vdots} & \mathbf{\vdots} & \multicolumn{1}{|c}{\vdots} & \multicolumn{1}{|c}{\ddots} &  & \\\cline{2-4}\cline{6-6}
m_2 \text{ rows } \left\{  \vphantom{\dfrac{2^2}{2^2}}\right.
    & \widetilde{q_2^{(2)}} & \widetilde{q_{3}^{(2)}} & \multicolumn{1}{|c}{\widetilde{q_{4}^{(2)}}} & \multicolumn{1}{|c}{\cdots} & \multicolumn{1}{|c}{\widetilde{q_{\ell-1}^{(2)}}} & \multicolumn{1}{|c}{}\\\cline{2-4}\cline{6-7}
m_1 \text{ rows } \left\{ \vphantom{\dfrac{2^2}{2^2}}\right.
    & \widetilde{q_1^{(1)}} & \widetilde{q_2^{(1)}} & \multicolumn{1}{|c}{\widetilde{q_{3}^{(1)}}} & \multicolumn{1}{|c}{\cdots} & \multicolumn{1}{|c}{\widetilde{q_{\ell-2}^{(1)}}} & \multicolumn{1}{|c|}{\widetilde{q_{\ell-1}^{(1)}}}\\\cline{2-4}\cline{6-7}
\end{array}
\end{equation}
Formally speaking, this is the tableau of shape $\lambda^{\mm}$ whose $\ell-1$ columns are given as follows:
For each $j \in \ive{\ell-1}$, the $j$-th column consists of the columns $\widetilde{q_{\ell-1}^{(\ell-j)}}, \widetilde{q_{\ell-2}^{(\ell-j-1)}}, \dotsc, \widetilde{q_j^{(1)}}$ stacked atop each other (with $\widetilde{q_{\ell-1}^{\left(  \ell-j\right)  }}$ at the very top, $\widetilde{q_{\ell-2}^{(\ell-j-1)}}$ coming next under it, and so on).
Note that for each $i \in \ive{\ell-1}$, the parts $\widetilde{q_i^{(i)}}, \widetilde{q_{i+1}^{(i)}}, \dotsc, \widetilde{q_{\ell-1}^{(i)}}$ of columns $1,2,\ldots,\ell-i$ align with each other horizontally (and together form the topmost $m_i$ among the bottommost $m_1+m_2+\cdots+m_i$ rows of $P(\qq)$).

Thus, the map $P \colon \set{ \text{MLQs of type } \mm } \to \set{\text{tableaux of shape } \lambda^{\mm}}$ is defined.
This map $P$ is an injection, because the MLQ $\qq$ can be recovered
from the tableau $P(\qq)$ (indeed, each of the elements
of each of the queues of $\qq$ lands in some predictable cell of
$P(\qq)$).

We shall now prove the four properties we claimed about this injection $P$.

Property (a) is clear, since the entries of $q_1, q_2, \dotsc, q_{\ell-1}$ are in 1-to-1 correspondence with the entries of the tableau $P(\qq)$.

Furthermore, the surface of $P(\qq)$ is the concatenation of the sequences $\widetilde{q_{\ell-1}^{(\ell-1)}},\widetilde{q_{\ell-1}^{(\ell-2)}}, \dotsc, \widetilde{q_{\ell-1}^{(1)}}$ (regarded as lists); but this concatenation is simply the sequence $\widetilde{q_{\ell-1}}$ (regarded as a list) (because of~\eqref{eq.determinant_form.qij.1} and~\eqref{eq.determinant_form.qij.2}).
In other words, the surface of $P(\qq)$ is the list of all elements of $q_{\ell-1}$ in increasing order.
This proves property~(b).

Let $\qq$ be an MLQ of type $\mm$.
Then, the columns $\widetilde{q_i^{(j)}}$ are strictly increasing. Hence, from~\eqref{pf.lem:determinant_form.bij1.visual}, we see the following:
\begin{itemize}
\item The entries of the tableau $P(\qq)$ are weakly increasing along each row
if and only if all $i \in \ive{\ell-1}$ and $j \in \ive{i-1}$ satisfy
$q_i^{\left(j\right)} \succeq q_{i-1}^{\left(j\right)}$.
\item The entries of the tableau $P(\qq)$ are strictly increasing down each
column if and only if all $i \in \ive{\ell-1}$ and $j \in \ive{i-1}$ satisfy
$q_{i-1}^{\left(j\right)} \gg q_i^{\left(j+1\right)}$.
(Here, we are also tacitly using the fact that the sets
$q_i^{\left(  j\right)  }$ are nonempty. This ensures that the southern
neighbor of a cell in $\widetilde{q_i^{\left(  j\right)  }}$ belongs either
to $\widetilde{q_i^{\left(  j\right)  }}$ again or to
$\widetilde{q_{i-1}^{\left(  j-1\right)  }}$, rather than (say) to
$\widetilde{q_{i-2}^{\left(  j-2\right)  }}$.)
\end{itemize}
Combining these two observations, we conclude that the tableau $P(\qq)$ is semistandard if and only if the sets $q_i^{(j)}$ satisfy~\eqref{eq.determinant_form.interlacing.def}.
In other words, the tableau $P(\qq)$ is semistandard if and only if $\qq$ is interlacing.
This proves property (c).

Finally, if $T$ is a semistandard tableau of shape $\lambda^{\mm}$, then $T$ has the form $P(\qq)$ for some interlacing MLQ $\qq$ of type $\mm$.
(Namely, we can construct this $\qq$ by recovering the sets $q_i^{(j)}$ from the appropriate cells of $T$ in~\eqref{pf.lem:determinant_form.bij1.visual}, and combining them to obtain queues $q_i$ and an MLQ $\qq$.
This latter MLQ $\qq$ then satisfies $T = P(\qq)$ because the interlacing conditions~\eqref{eq.determinant_form.interlacing.def} imply $q_i^{(1)} \gg q_i^{(2)} \gg \cdots \gg q_i^{(i)}$.)
This proves property~(d).
Hence, we have proven all four properties (a--d).
\end{proof}

\begin{cor}
\label{cor:determinant_form.bij1c}
Let $\ell$, $\mm$, and $m_i$ be as above.
Let $k \in \NN$ and $\lambda_1, \lambda_2, \ldots, \lambda_k$ be such that $\lambda^{\mm} = \tup{\lambda_1, \lambda_2, \dotsc, \lambda_k}$.
% This awkward wording should repel the misunderstanding that we are *defining* $\lambda^{\mm}$ here.
Let $S = \set{s_1 < s_2 < \cdots < s_k}$ be a $k$-queue.
Then,
\begin{align*}
&  \sum_{\substack{\qq=\tup{q_1,q_2,\ldots,q_{\ell-1}} \text{ is an interlacing}\\\text{MLQ of type $\mm$ with } q_{\ell-1}=S}} \wt(\qq) \\
&  = \left(  \prod_{i=1}^{k}x_{s_i}\right)
    \det\left(h_{\lambda_j-j+i-1}(x_1, x_2, \dotsc, x_{s_j}) \right)_{i, j \in \ive{k}} .
\end{align*}
\end{cor}

\begin{proof}[Proof of Corollary~\ref{cor:determinant_form.bij1c}.]
Consider the injection $P$ from Lemma~\ref{lem:determinant_form.bij1}, and recall the properties (a--d).
Property~(c) shows that this injection $P$ restricts to an injection
\[
\set{\text{interlacing MLQs of type } \mm}  \to \set{  \text{semistandard tableaux of shape } \lambda^{\mm}}.
\]
Property~(d) shows that this restricted injection is also surjective, and thus a bijection.
Hence, we can substitute $P(\qq)$ for $T$ in the sum on the left hand side of Theorem~\ref{thm.tableau.jt} (applied to $\lambda = \lambda^{\mm}$).
\begin{vershort}
We thus obtain
\begin{align*}
\sum_{T \in \SST(\lambda^{\mm}, s)} \wt(T)
  & = \sum_{\substack{\qq=\tup{q_1, q_2, \dotsc, q_{\ell-1}} \text{ is an interlacing}\\\text{MLQ of type } \mm \text{ such that} \\\text{the surface of }P(\qq) \text{ is } s}} \wt\bigl(  P(\qq) \bigr) \\
&  = \sum_{\substack{\qq = \tup{q_1,q_2,\dotsc,q_{\ell-1}} \text{ is an interlacing}\\\text{MLQ of type } \mm \text{ with } q_{\ell-1} = S}} \wt(\qq)
\end{align*}
where the second equality follows from Property~(a) and Property~(b) and that $s = S$ (where we consider $s$ as a set).
\end{vershort}
\begin{verlong}
We thus obtain
\begin{align*}
\sum_{T \in \SST(\lambda^{\mm}, s)} \wt(T)
  & = \sum_{\substack{\qq=\tup{q_1, q_2, \dotsc, q_{\ell-1}} \text{ is an interlacing}\\\text{MLQ of type } \mm \text{ such that} \\\text{the surface of }P(\qq) \text{ is } s}} \wt\bigl(  P(\qq) \bigr) \\
&  = \sum_{\substack{\qq= \tup{q_1, q_2, \dotsc,q_{\ell-1}} \text{ is an interlacing}\\\text{MLQ of type } \mm \text{ such that}\\\text{the list of all elements of } q_{\ell-1} \text{ in} \\\text{increasing order is } s}} \wt(\qq) \\
&  = \sum_{\substack{\qq = \tup{q_1,q_2,\dotsc,q_{\ell-1}} \text{ is an interlacing}\\\text{MLQ of type } \mm \text{ with } q_{\ell-1} = S}} \wt(\qq)
\end{align*}
where the second equality follows from Property~(a) and Property~(b) and the last equality is since the list of all elements of $q_{\ell-1}$ in increasing order is $s$ if and only if $q_{\ell-1}=S$.
\end{verlong}
Therefore, the claim of Corollary~\ref{cor:determinant_form.bij1c} follows from Theorem~\ref{thm.tableau.jt}.
\end{proof}

Next, we shall connect the interlacingness of an MLQ with its action on the word $1^n$:

\begin{lemma}
\label{lem:determinant_form.interl-act}
Let $\ell$ be a positive integer.
Let $B = \set{ b_1 < b_2 < \cdots < b_r }  \subseteq \ive{n}$.
Let $\left( v_1 \geq v_2 \geq \dotsm \geq v_r \right)$ be a weakly decreasing $r$-tuple of integers such that $\set{ v_1, v_2, \dotsc, v_r } = \ive{\ell-1}$.
Define a word $u \in \mcW_n$ by $u_i = v_j$ if $i = b_j$ for some $j$, otherwise $u_i = \ell$.

Let $\mm$ be the type of $u$.
Let $\qq = \tup{q_1, q_2, \dotsc, q_{\ell-1}}$ be an MLQ of type $\mm$.
Then, $u = \qq(1^n)$ if and only if the MLQ $\qq$ is interlacing and satisfies $q_{\ell-1} = B$.
\end{lemma}

\Darij{TODO: Example.}

The proof of Lemma~\ref{lem:determinant_form.interl-act} is tedious and technical; it will be completed in the next subsection (after a few auxiliary lemmas).

\subsection{Proof of Lemma~\ref{lem:determinant_form.interl-act}}

There is nothing deep or surprising to this proof; it is merely a lengthy combinatorial argument that does not lend itself to a neat formalization.
Before we begin the proof, we will pave our way with several lemmas.

First, we need another notion:
If $u \in \mcW_n$ and $t \in \NN$, then we say that $u$ is \defn{weakly decreasing up to level $t$} if and only if every two sites $i < j$ in $\ive{n}$ satisfying $u_j \leq t$ must satisfy $u_i \geq u_j$.
Equivalently, $u$ is weakly decreasing up to level $t$ if and only if $u$ becomes weakly decreasing when all letters larger than $t$ are removed.
For example, the word ${\color{gray}5}4{\color{gray}55}4332{\color{gray}5}221{\color{gray}5}$ is weakly decreasing up to level $4$ (and up to any level $\leq 4$).

\begin{lemma}
\label{lem:determinant_form.interl-A}
Let $u \in \mcW_n$ and $t > 0$.
Let $q$ be a queue.
Assume that the word $q(u)$ has at least one letter equal to $t$, is weakly decreasing up to level $t$, and has exactly $\abs{q}$ letters that are at most $t$.
Then:

\begin{enumerate}
\item[(a)] The word $u$ is weakly decreasing up to level $t-1$.

\item[(b)] For each $h \in \ive{t-1}$, we have
\[
\set{ p \in \ive{n} \mid \bigl( q(u) \bigr)_p = h }
\succeq
\set{ p \in \ive{n} \mid u_p = h }
\gg
\set{ p \in \ive{n} \mid \bigl( q(u) \bigr)_p = h+1 } .
\]
\end{enumerate}
\end{lemma}

\Travis{Todo for myself: figure out why this lemma is more complicated if we forbid $\emptyset$. Can these sets even be empty?}

\begin{example}
\mbox{}
\begin{itemize}
\item Let $n = 9$, $u = {\color{gray}3}221{\color{gray}3}11{\color{gray}33}$, $t = 3$ and $q = \set{1, 2, 3, 5, 6, 7}$.
Then, $q(u) = 322{\color{gray}4}111{\color{gray}44}$ satisfies all assumptions of
Lemma~\ref{lem:determinant_form.interl-A}.
Thus, part (a) of the lemma says that $u$ is weakly decreasing up to level $2$ (which is evident).
% Part (b) of the lemma, applied to $h = 2$, says that
% $\set{ 2, 3 } \succeq \set{ 2, 3 } \gg \set{ 1 }$.
Part (b) of the lemma, applied to $h = 1$, says that
\[
\set{ 5, 6, 7 } \succeq \set{ 4, 6, 7 } \gg \set{ 2, 3 }.
\]

\item The assumption that $q(u)$ has at least one letter equal to $t$ cannot be removed from Lemma~\ref{lem:determinant_form.interl-A}.
Indeed, if $n = 4$, $u = {\color{gray}33}12$, $t = 3$ and $q = \set{1, 3}$, then $q(u) = 2{\color{gray}4}1{\color{gray}4}$ satisfies all assumptions except for this one, but the claim of Lemma~\ref{lem:determinant_form.interl-A}(a) does not hold.

\item The assumption that $q(u)$ is weakly decreasing up to level $t$ cannot be removed from Lemma~\ref{lem:determinant_form.interl-A}.
Indeed, if $n = 4$, $u = 12{\color{gray}33}$, $t = 3$ and $q = \set{1, 2, 3}$, then $q(u) = 123{\color{gray}4}$ satisfies all assumptions except for this one, but the claim of Lemma~\ref{lem:determinant_form.interl-A}(a) does not hold.

\item The assumption that $q(u)$ has exactly $\abs{q}$ letters that are at most $t$ cannot be removed from Lemma~\ref{lem:determinant_form.interl-A}.
Indeed, if $n = 5$, $u = {\color{gray}3}2112$, $t = 3$ and $q = \set{2, 3, 5}$, then $q(u) = 321{\color{gray}4}1$ satisfies all assumptions except for this one, but the claim of Lemma~\ref{lem:determinant_form.interl-A}(a) does not hold.
% I think we can loosen this assumption to ``$q(u)$ has \emph{at most} $\abs{q}$ letters that are at most $t$'', at least as far as part (a) of the lemma is concerned. But not for part (b); the counterexample for that is $n = 4$, $u = 3312$, $t = 2$ and $q = \set{1, 2, 3}$.
\end{itemize}
\end{example}

\begin{proof}[Proof of Lemma~\ref{lem:determinant_form.interl-A}.]
We introduce another piece of notation.
For any two sites $i$ and $j$, let $\inter[i,j]$ denote the closed (cyclic) interval from $i$ to $j$.
This is the set $\set{i, i+1, \ldots, j}$ when $i \leq j$ and the set $\set{i, i+1, \ldots, n, 1, 2, \ldots, j}$ when $i > j$. (Thus, if $j = i-1$, then $\inter[i,j] = \ive{n}$.)

Fix a permutation $\tup{i_1, i_2, \dotsc, i_n}$ of $\tup{1, 2, \dotsc, n}$ such that $u_{i_1}\leq u_{i_2}\leq \cdots \leq u_{i_n}$.
Recall the construction of $q(u)$ (using this permutation).
For each $k \in \ive{n}$, there is exactly one step in this construction at which $i = i_k$; we let $j_k$ denote the site $j$ that is found during this step.
This step is part of Phase~II if $k \leq \abs{q}$, and otherwise is part of Phase~I.
Hence, we have $\bigl( q(u) \bigr)_{j_k}=u_{i_k}$ if $k\leq \abs{q}$, and otherwise $\bigl( q(u) \bigr)_{j_k} = u_{i_k}+1$.
This shows that the letters of $q(u)$ at the sites $j \in q$ are all smaller than the letters of $q(u)$ at the sites $j \notin q$.
Therefore, the former letters are the $\abs{q}$ smallest letters of $q(u)$, and thus must all be at most $t$ (since $q(u)$ has exactly $\abs{q}$ letters at most $t$).
Meanwhile, all the latter letters of $q(u)$ must be strictly greater than $t$ (since $q(u)$ has exactly $\abs{q}$ letters at most $t$, and we have already accounted for them all).
So we have shown that
\begin{subequations}
\label{pf.lem:determinant_form.interl}
\begin{align}
\label{pf.lem:determinant_form.interl-A.1}
\bigl( q(u) \bigr)_j  & \leq t && \text{for each } j \in q;
\\
\label{pf.lem:determinant_form.interl-A.2}
\bigl( q(u) \bigr)_j  & > t && \text{for each } j \notin q.
\end{align}
\end{subequations}
\Travis{This follows trivially from the definition of Phase~II: the $\abs{q}$ smallest elements of $q(u)$ are at $j \in q$, which by assumption are at most $t$. Everything else is strictly larger than $t$ (which is used during Phase~I). It does not need a whole paragraph to explain!}
\Darij{The paragraph also shows other things, which are used further below.}
\Travis{I don't really see it. Can we verlong the above paragraph?}
Thus, all letters set during Phase~II of the algorithm are $\leq t$,
while all letters set during Phase~I of the algorithm are $> t$.

We first argue five auxiliary claims:

\begin{claim}
\label{claim:little_interlacing}
Let $k\in \ive{n} $ be such that $k\leq \abs{q}$.
Let $j_{!} \in q$ be a site that belongs to $\inter[i_k, j_k]$.
%(If $i_k > j_k$, then this means that $j_{!} \geq i_k$ or $j_{!} \leq j_k$; otherwise, it means that $i_k \leq j_{!} \leq j_k$.)
Then, $\bigl( q(u) \bigr)_{j_{!}} \leq \bigl( q(u) \bigr)_{j_k} = u_{i_k}$.
\end{claim}

\begin{subproof}
Consider the unique step of the construction of $q(u)$ at which $i = i_k$.
This step is part of Phase~II, since $k \leq \abs{q}$.
Therefore, this step sees $j_k$ being defined as the first $j$ weakly to the right (cyclically) of $i = i_k$ such that $j \in q$ and $\bigl( q(u) \bigr)_j$ is not set.
Also, $\bigl( q(u) \bigr)_{j_k} = u_{i_k}$ (due to how Phase~II works).
If $j_{!} = j_k$, then Claim~\ref{claim:little_interlacing} follows immediately from this.
Thus, without loss of generality, let us assume that $j_{!} \neq j_k$.
That is, $j_{!}$ is distinct from $j_k$.

Recall again that $j_k$ is the first $j$ weakly to the right (cyclically) of $i = i_k$ such that $j \in q$ and $\bigl( q(u) \bigr)_j$ is not set.
Hence, for every site $j_{?}$ in $q$ that lies in $\inter[i_k, j_k]$ but is distinct from $j_k$, the letter $\bigl( q(u) \bigr)_{j_{?}}$ must already be set.
Applying this to $j_{?} = j_{!}$, we conclude that the letter $a := \bigl( q(u) \bigr)_{j_{!}}$ must already be set (since $j_{!}$ is distinct from $j_k$).
Moreover, $a$ must have been set in Phase~II (because the site $j_{!}$ belongs to $q$, whereas Phase~I only sets letters in sites outside of $q$).
Hence, $a \leq u_{i_k}$ because all letters that have been set in Phase~II before the current step are $\leq u_{i_k}$.
Thus, $\bigl( q(u) \bigr)_{j_{!}} = a \leq u_{i_k}$.
Combining this with $\bigl( q(u) \bigr)_{j_k} = u_{i_k}$, we obtain $\bigl( q(u) \bigr)_{j_{!}} \leq \bigl( q(u) \bigr)_{j_k}=u_{i_k}$.
This proves Claim~\ref{claim:little_interlacing}.
\end{subproof}

\begin{claim}
\label{claim:fixed_k_decreasing_i_from_j}
Let $k\in \ive{n} $ be such that $k\leq \abs{q}$ and $u_{i_k} < t$.
Then, $i_k \leq j_k$.
\end{claim}

\begin{subproof}
Assume the contrary. That is, $i_k>j_k$.
Hence, the interval $\inter[i_k, j_k]$ ``wraps around'' the circle (\textit{i.e.}, it is an interval only in $\ZZ/n\ZZ$, not in $\ive{n} $).

Let $j_{\min}$ be the smallest element of $q$.
\begin{vershort}
Thus, the dichotomy~\eqref{pf.lem:determinant_form.interl} and the fact that $q(u)$ is weakly decreasing up to level $t$ yield
\[
\bigl( q(u) \bigr)_{j_{\min}} = \max \set{\bigl( q(u) \bigr)_j \mid j \in q} = t ,
\]
since $q(u)$ has at least one letter equal to $t$.
\end{vershort}
\begin{verlong}
Then,~\eqref{pf.lem:determinant_form.interl-A.1} and~\eqref{pf.lem:determinant_form.interl-A.2} reveal that $\bigl( q(u) \bigr)_{j_{\min}}$ is the first among the letters of $q(u)$ that are at most $t$, and therefore also the largest of these letters (since $q(u)$ is weakly decreasing up to level $t$).
Yet, this largest letter must be $t$ since the word $q(u)$ has at least one letter equal to $t$.
Hence, we have $\bigl( q(u) \bigr)_{j_{\min}} = t$.
\end{verlong}

If we had $j_{\min} \in \inter[i_k, j_k]$, then Claim~\ref{claim:little_interlacing} (applied to $j_{!} = j_{\min}$) would yield $\bigl( q(u) \bigr)_{j_{\min}} \leq \bigl( q(u) \bigr)_{j_k} = u_{i_k}$.
This would contradict $\bigl( q(u) \bigr)_{j_{\min}} = t > u_{i_k}$.
Hence, we cannot have $j_{\min} \in \inter[i_k, j_k]$.
Since the interval $\inter[i_k, j_k]$ ``wraps around'' the circle, this shows that $j_{\min} > j_k$.
Thus, $j_k\notin q$ (since $j_{\min}$ is the smallest element of $q$).
However, $k \leq \abs{q}$, and thus $\bigl( q(u) \bigr)_{j_k}$ is set in Phase~II; therefore, $j_k\in q$.
This contradicts $j_k\notin q$, and so Claim~\ref{claim:fixed_k_decreasing_i_from_j} is proven.
\end{subproof}

\begin{claim}
\label{claim:smaller_site_jbang}
Let $k\in \ive{n} $ be such that $k \leq \abs{q}$.
Let $j_{!} \in q$ such that $j_{!} \geq i_k$.
Then, $\bigl( q(u) \bigr)_{j_{!}} \leq \bigl( q(u) \bigr)_{j_k} = u_{i_k}$.
\end{claim}

\begin{subproof}
If $j_{!}\leq j_k$, then Claim~\ref{claim:smaller_site_jbang} follows from Claim~\ref{claim:little_interlacing}.
Hence, without loss of generality assume that $j_{!} > j_k$.

Consider the unique step of the construction of $q(u) $ at which  $i=i_k$.
This step is part of Phase~II, since $k\leq \abs{q}$.
Recall that $j_k$ is the value of $j$ found during this step; thus, $j_k\in q$ (since this step is part of Phase~II). Also, $\bigl( q(u) \bigr)_{j_k} = u_{i_k}$ (due to how Phase~II works).
Both $j_k$ and $j_{!}$ belong to $q$; hence, both letters $\bigl( q(u) \bigr)_{j_k}$ and $\bigl( q(u) \bigr)_{j_{!}}$ are $\leq t$ (by~\eqref{pf.lem:determinant_form.interl-A.1}).
Hence, from $j_k < j_{!}$, we obtain $\bigl( q(u) \bigr)_{j_k} \geq \bigl( q(u) \bigr)_{j_{!}}$ (since $q(u)$ is weakly decreasing up to level $t$).
Thus, $\bigl( q(u) \bigr)_{j_{!}} \leq \bigl( q(u) \bigr)_{j_k} = u_{i_k}$, proving Claim~\ref{claim:smaller_site_jbang}.
\end{subproof}

\begin{claim}
\label{claim:pf.lem:determinant_form.interl-A.b.1}
Let $k\in \ive{n}$ be such that $u_{i_k} < t$. Then, $k \leq \abs{q}$ and $\bigl( q(u) \bigr)_{j_k} = u_{i_k}$.
\end{claim}

\begin{subproof}
Assume that $k > \abs{q}$.
Consider the unique step of the construction of $q(u)$ at which $i = i_k$.
This step is part of Phase~I, since $k > \abs{q}$.
Hence, $j_k \notin q$ and $\bigl( q(u) \bigr)_{j_k} = u_{i_k}+1$ (by the way Phase~I operates).
Thus, $u_{i_k}+1 = \bigl( q(u) \bigr)_{j_k} > t$ (by~\eqref{pf.lem:determinant_form.interl-A.2}, since $j_k\notin q$), so that $u_{i_k} > t-1$.
In other words, $u_{i_k} \geq t$.
\begin{vershort}
This contradicts $u_{i_k} < t$, and hence, we have $k \leq \abs{q}$.
\end{vershort}
\begin{verlong}
This contradicts $u_{i_k} < t$.
Thus, our assumption (that $k > \abs{q}$) was false.
Hence, $k \leq \abs{q}$.
\end{verlong}
Therefore, the letter $\bigl( q(u) \bigr)_{j_k}$ must be set in Phase~II of the algorithm that constructs $q(u)$.
So we have $\bigl( q(u) \bigr)_{j_k} = u_{i_k}$ (due to how Phase~II works).
Claim~\ref{claim:pf.lem:determinant_form.interl-A.b.1} is thus proven.
\end{subproof}

\begin{claim}
\label{claim:pf.lem:determinant_form.interl-A.b.for_surj}
Let $k \in \ive{n}$ be such that $\bigl( q(u) \bigr)_{j_k} < t$. Then, $u_{i_k} = \bigl( q(u) \bigr)_{j_k}$.
\end{claim}

\begin{subproof}
If we had $k > \abs{q}$, then the letter $\bigl( q(u) \bigr)_{j_k}$ would be set in Phase~I of the construction;
thus, we would have $j_k \notin q$, so that $\bigl( q(u) \bigr)_{j_k} > t$ by~\eqref{pf.lem:determinant_form.interl-A.2}.
However, this would contradict $\bigl( q(u) \bigr)_{j_k} < t$.
Thus, we cannot have $k > \abs{q}$.
Hence, $k \leq \abs{q}$.
Therefore, the letter $\bigl( q(u) \bigr)_{j_k}$ is set in Phase~II of the construction.
This implies $\bigl( q(u) \bigr)_{j_k} = u_{i_k}$, so that $u_{i_k} = \bigl( q(u) \bigr)_{j_k}$.
\end{subproof}

% \Travis{How easy would it be to pull these claims out into separate lemmas?}
% \Darij{Not very easy. They refer to the $j_k$, which are temporary objects in the construction of $q(u)$.}

We are now ready to prove the two parts of the lemma:

(a) Assume the contrary.
Thus, there exist sites $x$ and $y$ in $\ive{n}$ such that $x < y$ and $u_x < u_y < t$.
Let $k$ and $\ell$ be such that $x = i_k$ and $y = i_{\ell}$; then, $u_{i_k} = u_x < u_y = u_{i_{\ell}}$, and thus $u_{i_k} < u_{i_{\ell}} = u_y < t$.
% But $k < \ell$ (since $u_{i_k} < u_{i_{\ell}}$ and $u_{i_1} \leq u_{i_2} \leq \cdots \leq u_{i_n}$).
Hence, Claim~\ref{claim:pf.lem:determinant_form.interl-A.b.1} yields $k \leq \abs{q}$ and $\bigl( q(u) \bigr)_{j_k} = u_{i_k}$.
Similarly, $\ell \leq \abs{q}$ and
$\bigl( q(u) \bigr)_{j_{\ell}} = u_{i_{\ell}}$.
Therefore, $\bigl( q(u) \bigr)_{j_k} = u_{i_k} < u_{i_{\ell}} = \bigl( q(u) \bigr)_{j_{\ell}}$.
Since the letters $\bigl( q(u) \bigr) _{j_k}$ and $\bigl( q(u) \bigr)_{j_{\ell}}$ of $q(u)$ are also at most $t$ (because $\bigl( q(u) \bigr)_{j_k} = u_{i_k} = u_x < t$ and $\bigl( q(u) \bigr)_{j_{\ell }} = u_{i_{\ell}} = u_y < t$), this entails $j_k > j_{\ell}$ (since $q(u)$ is weakly decreasing up to level $t$).
From Claim~\ref{claim:fixed_k_decreasing_i_from_j}, we have $i_k \leq j_k$ and similarly $i_{\ell} \leq j_{\ell}$.
Thus, $i_k = x < y = i_{\ell} \leq j_{\ell} < j_k$.
Hence, $j_{\ell} \inter \inter[i_k, j_k]$.
Therefore, Claim~\ref{claim:little_interlacing} (applied to $j_{!} = j_{\ell}$) yields $\bigl( q(u) \bigr)_{j_{\ell}} \leq \bigl( q(u) \bigr)_{j_k} = u_{i_k}$.
This contradicts $\bigl( q(u) \bigr)_{j_{\ell}} = u_{i_{\ell}} > u_{i_k}$.
\begin{vershort}
Therefore, Lemma~\ref{lem:determinant_form.interl-A}(a) is proven.
\end{vershort}
\begin{verlong}
This contradiction shows that our assumption was false, and so Lemma~\ref{lem:determinant_form.interl-A}(a) is proven.
\end{verlong}

(b) Let $h \in \ive{t-1}$.
\begin{verlong}
Thus, $h \leq t-1$, so that $h + 1 \leq t$ and $h < t$.

Note that $\tup{ j_1, j_2, \dotsc, j_n}$ is a permutation of $\tup{1, 2, \dotsc, n}$ (since each letter of $q(u)$ is set exactly once during the construction of $q(u)$).
Thus, the $j_1, j_2, \dotsc, j_n$ are distinct.
\end{verlong}
Define
\begin{align*}
A & := \set{ p\in \ive{n} \mid \bigl( q(u) \bigr)_p = h },
\\ B & := \set{ p\in \ive{n} \mid u_p = h },
\\ C & := \set{ p\in \ive{n} \mid \bigl( q(u) \bigr)_p = h+1 }.
\end{align*}
Then, we must prove that $A \succeq B \gg C$.

Let us first prove $A \succeq B$.
Indeed, let $i_k\in B$ for some $k \in \ive{n}$.
From $i_k\in B$, we obtain $u_{i_k} = h$ (by the definition of $B$), so that $u_{i_k} = h < t$.
Hence, Claim~\ref{claim:pf.lem:determinant_form.interl-A.b.1} yields $k\leq \abs{q}$ and $\bigl( q(u) \bigr)_{j_k} = u_{i_k} = h$.
Therefore, $j_k\in A$ (by the definition of $A$).
Also, Claim~\ref{claim:fixed_k_decreasing_i_from_j} yields $i_k\leq j_k$.
Hence, $j_k\geq i_k$.

Forget that we fixed $k$. We thus have shown that if $i_k\in B$ for some $k \in \ive{n} $, then $j_k\in A$ and $j_k\geq i_k$.
Hence, we can define a map
\begin{align*}
\phi \colon B & \to A, \\
i_k & \mapsto j_k
\end{align*}
(since each element of $B$ can be written as $i_k$ for a unique $k\in \ive{n} $), and it satisfies $\phi(b) \geq b$ for each $b \in B$ (since $j_k \geq i_k$).
This map $\phi$ is injective since the $j_1, j_2, \dotsc, j_n$ are distinct (indeed, $\tup{j_1, j_2, \dotsc, j_n}$ is a permutation of $\tup{1, 2, \dotsc, n}$ because each letter of $q(u)$ is set exactly once during the construction of $q(u)$).

Next, we claim that the map $\phi$ is surjective.

[\textit{Proof.} Let $a\in A$.
We must prove that there exists some $k\in \ive{n}$ satisfying $i_k \in B$ and $j_k = a$ (because then, $i_k$ will be a preimage of $a$ under $\phi$).

Indeed, recall that $\left( j_1,j_2,\ldots ,j_n\right) $ is a permutation of $\tup{1, 2, \dotsc, n}$.
Thus, there exists some $k \in \ive{n}$ satisfying $j_k = a$.
Consider this $k$.
All we need to prove now is that $i_k \in B$.

We have $j_k = a$, and thus $\bigl( q(u) \bigr)_{j_k} = \bigl( q(u) \bigr)_a = h$ (since $a \in A$).
Hence, $\bigl( q(u) \bigr)_{j_k} = h < t$ (since $h \in \ive{t-1}$).
Thus, Claim~\ref{claim:pf.lem:determinant_form.interl-A.b.for_surj} yields
$u_{i_k} = \bigl( q(u) \bigr)_{j_k} = h$.
In other words, $i_k \in B$.
This completes the proof that $\phi$ is surjective.]

We have thus shown that $\phi$ is both injective and surjective. Therefore, $\phi$ is bijective.
Hence, we have found a bijection $\phi \colon B \to A$ that
furthermore satisfies $\phi(b) \geq b$ for each $b\in B$.
Therefore, Lemma~\ref{lem:determinant_form.gale1} shows that $A \succeq B$.

It remains to show that $B \gg C$.
To do so, we need to check that $b > c$ for every $b \in B$ and $c \in C$.
So let us fix $b \in B$ and $c \in C$.
We must prove that $b > c$. Assume instead $c \geq b$.

From $b\in B$, we obtain $b \in \ive{n}$ and $u_{b} = h$.
From $c\in C$, we obtain $c\in \ive{n}$ and $\bigl( q(u) \bigr)_{c} = h+1$.
Write $b$ in the form $b=i_k$ for some $k\in \ive{n}$.
Then, $i_k=b\in B$, so that $u_{i_k} = h$ (by the definition of $B$).
Thus, $u_{i_k} = h < t$.
Hence, Claim~\ref{claim:pf.lem:determinant_form.interl-A.b.1} yields $k \leq \abs{q}$ and $\bigl( q(u) \bigr)_{j_k} = u_{i_k}$.
Also, if we had $c\notin q$, then~\eqref{pf.lem:determinant_form.interl-A.2} would yield $\bigl( q(u) \bigr)_{c} > t$, which would contradict $\bigl( q(u) \bigr)_c = h + 1 \leq t$.
Thus, we have $c\in q$.
Also, $c \geq b = i_k$.
Hence, Claim~\ref{claim:smaller_site_jbang} (applied to $j_{!} = c$) shows that $\bigl( q(u) \bigr)_c \leq \bigl( q(u) \bigr)_{j_k} = u_{i_k} = u_{b}$ (since $i_k = b$).
This contradicts $\bigl( q(u) \bigr)_c = h + 1 > h = u_{b}$.
Hence, we have $B\gg C$.
Combining this with $A\succeq B$, we obtain $A \succeq B \gg C$.
This completes the proof of Lemma~\ref{lem:determinant_form.interl-A}(b).
\end{proof}

Our next lemma gives an explicit expression for $q(u)$ when the queue $q$ and the word $u$ have a special form (essentially, when the word $u$ has all its letters belong to $\ive{h}$ for some positive integer $h$ and is weakly decreasing up to level $h-1$, and the queue $q$ is tailored to ``shift the letters of $u$ right''):

\begin{lemma}
\label{lem:determinant_form.interl-B}
Let $u \in \mcW_n$ and let $h>0$ be a positive integer.
Let $r$ and $q$ be two queues.
Let $r^{(1)}, r^{(2)}, \ldots, r^{(h-1)}$ be nonempty disjoint subsets of $r$ satisfying
\begin{subequations}
\begin{align}
\label{eq.lem:determinant_form.interl-B.rj.1}
  r  & = r^{(1)} \cup r^{(2)} \cup \cdots \cup r^{(h-1)}
\qquad \text{and}
\\
\label{eq.lem:determinant_form.interl-B.rj.2}
  r^{(1)} & \gg r^{(2)} \gg \cdots \gg r^{(h-1)} .
\end{align}
\end{subequations}
\travis{You need a term for this. You don't need to be referencing these equations but a definition. Perhaps a ``decreasing partition''.}
Let $q^{(1)}, q^{(2)}, \ldots, q^{(h)}$ be nonempty disjoint subsets of $q$ satisfying
\begin{subequations}
\begin{align}
\label{eq.lem:determinant_form.interl-B.qj.1}
  q  & = q^{(1)} \cup q^{(2)} \cup \cdots \cup q^{(h)}
\qquad \text{and}
\\
\label{eq.lem:determinant_form.interl-B.qj.2}
  q^{(1)} & \gg q^{(2)} \gg \cdots \gg q^{(h)} .
\end{align}
\end{subequations}
Furthermore, assume that $q^{(j)} \succeq r^{(j)} \gg q^{(j+1)}$ for all $j \in \ive{h-1}$.
Finally, assume that each $t \in \ive{n}$ satisfies
\begin{equation}
\label{eq.lem:determinant_form.interl-B.asslast}
u_t =
\begin{cases}
j & \text{if } t \in r^{(j)} \text{ for some } j \in\ive{h-1}\!, \\
h & \text{if } t \notin r .
\end{cases}
\end{equation}
Then, each $t \in \ive{n}$ satisfies
\begin{equation}
\label{eq.lem:determinant_form.interl-B.claim}
\bigl( q(u) \bigr)_t =
\begin{cases}
j & \text{if } t \in q^{(j)} \text{ for some } j \in\ive{h}\!, \\
h+1 & \text{if } t \notin q .
\end{cases}
\end{equation}
\end{lemma}

\begin{example}
Let $n = 11$, $u = 332 232 131 13$, $h = 3$,
$r = \set{3, 4, 6, 7, 9, 10}$, $q = \set{2, 4, 5, 6, 9, 10, 11}$,
$r^{(1)} = \set{7, 9, 10}$, $r^{(2)} = \set{3, 4, 6}$,
$q^{(1)} = \set{9, 10, 11}$, $q^{(2)} = \set{4, 5, 6}$, and
$q^{(3)} = \set{2}$.
Then, the assumptions of Lemma~\ref{lem:determinant_form.interl-B}
are satisfied.
As Lemma~\ref{lem:determinant_form.interl-B} predicts, we then have
$q(u) = 434 222 441 11$.
\end{example}

\begin{proof}[Proof of Lemma~\ref{lem:determinant_form.interl-B}.]
For each $j \in \ive{h-1}$, we have
$q^{(j)} \succeq r^{(j)}$ (by assumption), and thus in particular
\begin{equation}
\label{pf.lem:determinant_form.interl-B.qj=rj}
\abs{q^{(j)}} = \abs{r^{(j)}}
\end{equation}
(by the definition of $\succeq$).
Summing these equations over all $j \in \ive{h-1}$, we obtain
\[
\abs{q^{(1)}} + \abs{q^{(2)}} + \cdots + \abs{q^{(h-1)}}
=
\abs{r^{(1)}} + \abs{r^{(2)}} + \cdots + \abs{r^{(h-1)}}
= \abs{r}
\]
(since~\eqref{eq.lem:determinant_form.interl-B.rj.1}
and~\eqref{eq.lem:determinant_form.interl-B.rj.2}
show that the sets $r^{(1)}, r^{(2)}, \ldots, r^{(h-1)}$ partition
$r$).
But~\eqref{eq.lem:determinant_form.interl-B.qj.1}
and~\eqref{eq.lem:determinant_form.interl-B.qj.2}
show that the sets $q^{(1)}, q^{(2)}, \ldots, q^{(h)}$ partition $q$;
thus,
\begin{vershort}
\[
 \abs{q}
 = \abs{q^{(1)}} + \abs{q^{(2)}} + \cdots + \abs{q^{(h-1)}} + \abs{q^{(h)}}
 = \abs{r} + \abs{q^{(h)}} .
\]
\end{vershort}
\begin{verlong}
\[
 \abs{q}
 = \underbrace{\abs{q^{(1)}} + \abs{q^{(2)}} + \cdots + \abs{q^{(h-1)}}}_{= \abs{r}} + \abs{q^{(h)}}
 = \abs{r} + \abs{q^{(h)}} .
\]
\end{verlong}
Therefore, $\abs{q} - \abs{r} = \abs{q^{(h)}}$
and $\abs{q} \geq \abs{r}$.

From~\eqref{eq.lem:determinant_form.interl-B.asslast},
we see that the word $u$ has type
$\tup{\abs{r^{(1)}}, \abs{r^{(2)}}, \ldots, \abs{r^{(h-1)}}, n - \abs{r}}$.
Hence,~\eqref{eq:queue_type_change} (using $\abs{q} \geq \abs{r}$)
shows that the word $q(u)$ has type
\begin{align*}
&\tup{\abs{r^{(1)}}, \abs{r^{(2)}}, \ldots, \abs{r^{(h-1)}}, \abs{q} - \abs{r} ,
n - \abs{q}} \\
&= \tup{\abs{q^{(1)}}, \abs{q^{(2)}}, \ldots, \abs{q^{(h-1)}}, \abs{q^{(h)}} ,
n - \abs{q}}
\end{align*}
(by~\eqref{pf.lem:determinant_form.interl-B.qj=rj} and due to
$\abs{q} - \abs{r} = \abs{q^{(h)}}$).
Thus, in particular, the $n - \abs{q}$ largest letters of $q(u)$
equal $h+1$.

The construction of $q(u)$ shows that each of the letters $\bigl( q(u) \bigr)_j$ with $j \notin q$ is larger than each of the letters $\bigl( q(u) \bigr)_j$ with $j \in q$.
(This is true for any queue $q$ and word $u$.)
Hence, the letters $\bigl( q(u) \bigr)_j$ with $j \notin q$ are the $n - \abs{q}$ largest letters of $q(u)$.
\travis{It took you a fairly large paragraph to say the same thing in the previous lemma. This is sufficient.}
Thus, these letters equal $h+1$ (since the $n - \abs{q}$ largest letters of $q(u)$ equal $h+1$).
In other words,
\begin{equation}
\label{pf.lem:determinant_form.interl-B.res3}
(q(u))_t = h+1
\qquad \text{ for every } t \in \ive{n} \text{ satisfying } t \notin q .
\end{equation}

The properties~\eqref{eq.lem:determinant_form.interl-B.rj.1}
and~\eqref{eq.lem:determinant_form.interl-B.rj.2} show that
the set $r^{(1)}$ consists of the $\abs{r^{(1)}}$ largest elements of $r$;
the set $r^{(2)}$ consists of the $\abs{r^{(2)}}$ next-largest elements of $r$;
and so on.
\travis{I am pretty sure you have said this same thing in a few places in similar forms.}

Now, we construct a permutation $\tup{i_1, i_2, \ldots, i_n}$ of
$\tup{1, 2, \ldots, n}$ as follows:
First list the elements of $r$ in decreasing order
 (this automatically causes the list to start with the
 elements of $r^{(1)}$, then with the elements
 of $r^{(2)}$, and so on, because of what we just said);
 then list the elements of $\ive{n} \setminus r$ in an arbitrary order.
Thus, this permutation begins with a list of all elements of $r^{(1)}$,
then continues with the elements of $r^{(2)}$, and so on, and finally
ends with the elements of $\ive{n} \setminus r$.
Hence, this permutation has the property that
$u_{i_1} \leq u_{i_2} \leq \cdots \leq u_{i_n}$
(by~\eqref{eq.lem:determinant_form.interl-B.asslast}).
Hence, we can use this permutation in the construction of
$q(u)$.
For each $k \in \ive{n}$, let $j_k$ be the site $j$ that
is found in this construction during the step at which $i = i_k$.
Note that $i$ ranges over $i_1, i_2, \ldots, i_{\abs{q}}$ in
Phase~II of the construction, and ranges over
$i_n, i_{n-1}, \ldots, i_{\abs{q}+1}$ in Phase~I.
Also, the sites $j_1, j_2, \ldots, j_n$ are distinct.

In order to better understand Phase~II, let us give a mental model for it.

Consider a man named $M_k$ for each $k \in r$ (for a total of $\abs{r}$ many men).
Consider a woman named $W_k$ for each $k \in q$ (for a total of $\abs{q}$ many women).

The \defn{age} of a man $M_k$ or woman $W_k$ is defined to be the number $k \in \ive{n}$.

\Travis{This is a horrible model with potentially dangerous politically consequences: \emph{it is definitely not PC}. Also, how much of this is really just a rephrasing the algorithm in a more complicated (or at least new) language? Why not just use what will be the language in Section~\ref{sec:thm_proof} of brackets?}
\Darij{Where exactly is this not PC? And should we care? My suggestion is to move this proof into verlong anyway, while in vershort it gets replaced by some good pictures showing the ``balls'' in the $r^{(j)}$ and $q^{(j)}$ and how everything moves to the right place. But I can't draw that picture, at least not in LaTeX.}

We subdivide the (altogether $\abs{r} + \abs{q}$ many) people into $h$ \defn{age brackets}, numbered $1, 2, \ldots, h$:
Namely, for each $j \in \ive{h}$, the $j$-th age bracket shall contain
 the men $M_k$ with $k \in r^{(j)}$ (where $r^{(h)} := \emptyset$), and
 the women $W_k$ with $k \in q^{(j)}$.

Observe the following facts:
\begin{enumerate}
\item[(A)] Each age bracket has at least one woman (since the $q^{(j)}$ are nonempty); likewise, each but the $h$-th age bracket has at least one man.
\item[(B)] If $j_1 < j_2$, then every man in the $j_1$-th age bracket is older than every man in the $j_2$-th age bracket (by~\eqref{eq.lem:determinant_form.interl-B.rj.2}). The same holds for women.
\item[(C)] If $j \in \ive{h-1}$, then any man in the $j$-th age bracket is (strictly) older than any woman in the $j+1$-st age bracket (since $r^{(j)} \gg q^{(j+1)}$), and therefore is also older than any woman in the $j'$-th age bracket for all $j' > j$ (because of facts (A) and (B)).
\item[(D)] If $j \in \ive{h-1}$, then the $j$-th age bracket has as many men as it has women (by~\eqref{pf.lem:determinant_form.interl-B.qj=rj}), and the women are ``generally older'' (this means that for each $p$, the $p$-th oldest woman in the $j$-th age bracket is at least as old as the $p$-th oldest man in the $j$-th age bracket). (This follows from $q^{(j)} \succeq r^{(j)}$.)
\end{enumerate}

We now consider a ``marriage procedure'' in which we try to marry off all men (monogamously).
The procedure proceeds step-by-step:
The men marry in the order of decreasing age; each man marries the youngest available woman that is \emph{at least as old} as him.
Theoretically, it could happen that this procedure fails, in the sense that some man finds no such woman; we will soon see that this does not happen.

Let us now see how the ``marriage procedure'' actually proceeds.
The men marry in the order of decreasing age: thus, the men in the $1$-st age bracket marry first, then the men in the $2$-nd age bracket marry, and so on, until finally the men in the $h-1$-st age bracket marry (or the procedure fails).
We now claim the following fact:
\begin{enumerate}
\item[(E)] Each man marries ``within his own age bracket'' (\textit{i.e.}, if the man belongs to the $j$-th age bracket for some $j \in \ive{h-1}$, then he marries a woman in the $j$-th age bracket).\footnote{In particular, we are saying that each man does marry; thus, the procedure does not fail.}
\end{enumerate}
[\textit{Proof:} To prove this, we argue by strong induction on the time -- i.e., we consider some man $M_\alpha$ marrying during the procedure, and we assume (as induction hypothesis) that all older men have married within their own age brackets. We then need to show that $M_\alpha$ also marries within his age bracket (and in particular, that he does marry).
Let's say that $M_\alpha$ belongs to the $j$-th age bracket, and is the $p$-th oldest man in this age bracket. Then, by the induction assumption, we know that all men in the $1$-st, $2$-nd, ..., $j-1$-st age brackets are already married, and so are $p-1$ men in the $j$-th age bracket. Hence, by fact (D), we conclude that all women in the $1$-st, $2$-nd, ..., $j-1$-st age brackets are already married, and so are $p-1$ women in the $j$-th age bracket. Thus, man $M_\alpha$ seeks his wife-to-be among the remaining women in the $j$-th age bracket, as well as the higher brackets (\textit{i.e.}, the $j'$-th age brackets for $j' > j$). But since he must marry a woman that is at least as old as him, he finds no suitable candidates within the higher brackets (indeed, Fact (C) shows that all women in these higher brackets are younger than him); thus, he can only find a wife in the $j$-th age bracket. Fact (D) shows that the $p$-th oldest woman in the $j$-th age bracket is at least as old as him; thus, there are at least $p$ women in the $j$-th age bracket that are at least as old as him. Since only $p-1$ women in this bracket are already married, this implies that at least one unmarried woman is at least as old as him. Hence, $M_\alpha$ succeeds and marries a woman in the $j$-th age bracket. This completes the proof of fact (E).]

Fact (E) shows that, in particular, each man marries; hence, the ``marriage procedure'' does not fail.

Now, we claim that the ``marriage procedure'' precisely follows the first $\abs{r}$ steps of Phase~II:
The men that get married are precisely the men $M_k$ with $k \in r$, in order of decreasing age; thus, they are $M_{i_1}, M_{i_2}, \ldots, M_{i_{\abs{r}}}$ (in this order)\footnote{This is because the permutation $\tup{i_1, i_2, \ldots, i_n}$ begins with the elements of $r$ listed in decreasing order.}.
Furthermore, each man $M_{i_k}$ marries woman $W_{j_k}$ (because his search for the youngest available woman that is at least as old as him is precisely the search for the first available site $j$ to the right of $i$ in Phase~II\footnote{Except for the fact that his search doesn't ``wrap around the circle'' (\textit{i.e.}, if he finds no wife older than him, then he doesn't wrap over to the youngest women), whereas the search for $j$ in Phase~II does. But this difference is immaterial, because we know from Fact (E) that man $M_{i_k}$ necessarily finds a wife, so that ``wrapping around the circle'' isn't necessary.}).
% This is not very well explained, but I can't do better.

Fact (E) thus shows that (for each man $M_{i_k}$) man $M_{i_k}$ and woman $W_{j_k}$ belong to the same age bracket.
In other words, for each man $M_{i_k}$, we have
\begin{equation}
\label{pf.lem:determinant_form.interl-B.reso1}
\text{if $i_k \in r^{(j)}$ for some $j \in \ive{h-1}$, then $j_k \in q^{(j)}$}
\end{equation}
(because of how age brackets are defined).

Next, we claim that
\begin{equation}
\label{pf.lem:determinant_form.interl-B.res1}
\bigl( q(u) \bigr)_t = j
\qquad \text{ for every } j \in \ive{h-1} \text{ and } t \in q^{(j)} .
\end{equation}

[\textit{Proof of~\eqref{pf.lem:determinant_form.interl-B.res1}:}
Let $j \in \ive{h-1}$.

Fix $k \in \ive{n}$ satisfying $i_k \in r^{(j)}$.
Then, $i_k \in r$, so that man $M_{i_k}$ exists.
Hence,~\eqref{pf.lem:determinant_form.interl-B.reso1} yields $j_k \in q^{(j)}$.
Consider the step in the construction of $q(u)$ at which $i = i_k$.
This step belongs to Phase~II (because otherwise, it would belong to Phase~I,
which would entail $j_k \notin q$, which would contradict $j_k \in q^{(j)} \subseteq q$).
Hence, the construction of $q(u)$ yields $\bigl( q(u) \bigr)_{j_k} = u_{i_k} = j$
(by~\eqref{eq.lem:determinant_form.interl-B.asslast}, since $i_k \in r^{(j)}$).

Forget that we fixed $k$.
We thus have shown that each $k \in \ive{n}$ satisfying $i_k \in r^{(j)}$
satisfies $j_k \in q^{(j)}$ and $\bigl( q(u) \bigr)_{j_k} = j$.
Hence, we have found at least $\abs{r^{(j)}}$ many sites $t \in q^{(j)}$
satisfying $\bigl( q(u) \bigr)_t = j$ (namely, all the sites $j_k$ for $k \in \ive{n}$
satisfying $i_k \in r^{(j)}$).
(Here, we have used the fact that the sites $j_1, j_2, \ldots, j_n$ are distinct.)
But~\eqref{pf.lem:determinant_form.interl-B.qj=rj} shows that there are
only $\abs{r^{(j)}}$ many sites $t \in q^{(j)}$;
hence, the $\abs{r^{(j)}}$ many sites that we found must cover all the
sites $t \in q^{(j)}$.
Therefore, all the sites $t \in q^{(j)}$ satisfy $\bigl( q(u) \bigr)_t = j$.
This proves~\eqref{pf.lem:determinant_form.interl-B.res1}.]

Finally, we claim that
\begin{equation}
\label{pf.lem:determinant_form.interl-B.res2}
\bigl( q(u) \bigr)_t = h
\qquad \text{ for every } t \in q^{(h)} .
\end{equation}

[\textit{Proof of~\eqref{pf.lem:determinant_form.interl-B.res2}:}
We have seen that the word $q(u)$ has type
\[
\tup{\abs{q^{(1)}}, \abs{q^{(2)}}, \ldots, \abs{q^{(h-1)}}, \abs{q^{(h)}} ,
n - \abs{q}} .
\]
Thus, it has $\abs{q^{(h)}}$ many letters equal to $h$.
In other words, there are $\abs{q^{(h)}}$ many positions $t \in \ive{n}$
satisfying $(q(u))_t = h$.
These positions $t$ cannot satisfy $t \notin q$ (since
otherwise,~\eqref{pf.lem:determinant_form.interl-B.res3}
would yield $(q(u))_t = h+1 \neq h$, contradicting $(q(u))_t = h$);
thus, they have to belong to $q$.
But they cannot belong to any of the $q^{(j)}$ with $j \in \ive{h-1}$
(since otherwise,~\eqref{pf.lem:determinant_form.interl-B.res1}
would yield $\bigl( q(u) \bigr)_t = j \leq h-1 < h$, contradicting $\bigl( q(u) \bigr)_t = h$);
thus, they have to belong to
\[
q \setminus \tup{q^{(1)} \cup q^{(2)} \cup \cdots \cup q^{(h-1)}} = q^{(h)}
\]
(since the sets $q^{(1)}, q^{(2)}, \ldots, q^{(h)}$ partition $q$).
Thus, we know that there are $\abs{q^{(h)}}$ many positions $t \in q^{(h)}$ satisfying $\bigl( q(u) \bigr)_t = h$.
These positions must cover all of $q^{(h)}$ (since there are only $\abs{q^{(h)}}$ many positions $t \in q^{(h)}$).
Hence, every position $t \in q^{(h)}$ must satisfy $\bigl( q(u) \bigr)_t = h$.
This proves~\eqref{pf.lem:determinant_form.interl-B.res2}.]

Combining~\eqref{pf.lem:determinant_form.interl-B.res1}
with~\eqref{pf.lem:determinant_form.interl-B.res2}, we conclude that
\[
\bigl( q(u) \bigr)_t = j
\qquad \text{ for every } j \in \ive{h} \text{ and } t \in q^{(j)} .
\]
Combining this with~\eqref{pf.lem:determinant_form.interl-B.res3},
we obtain~\eqref{eq.lem:determinant_form.interl-B.claim}.
Thus, Lemma~\ref{lem:determinant_form.interl-B} is proven.
\end{proof}

We are now ready to prove Lemma~\ref{lem:determinant_form.interl-act}:

\begin{proof}[Proof of Lemma~\ref{lem:determinant_form.interl-act}.]
Consider the queues $q_i^{(j)}$ defined as above.

Write the type $\mm$ as $\tup{m_1, m_2, m_3, \ldots}$.
Since $\qq$ is an MLQ of type $\mm$, we have $\abs{q_i} = p_i(\mm) = m_1 + m_2 + \cdots + m_i$ for each $i \in \ive{\ell-1}$.

For each $i \in \set{0, 1, \dotsc, \ell-1}$, define
\[
u^{\left[  i\right]} := (q_1, q_2, \dotsc, q_i)(1^n)  = q_i\bigl( \cdots q_2\bigl( q_1(1^n) \bigr) \cdots \bigr)  \in \mcW_n .
\]
Note that $u^{\left[  i\right]  }$ has type $\mm^{[i]} := \tup{m_1, m_2, \dotsc, m_i, n-p_i(\mm), 0, 0, \ldots}$.
(This is proven similarly to Lemma~\ref{rmk:mlq-type}, using $\abs{q_i} = p_i(\mm)$.)
The definition of $u^{\left[  i\right]  }$ yields
\begin{equation}
\label{pf.lem:determinant_form.interl-act.rec}
u^{\left[  i\right]} = q_i\left(  u^{\left[  i-1\right]  }\right) \qquad \text{for each } i \in \ive{\ell-1}.
\end{equation}
The definition of $u^{\left[  \ell-1\right]  }$ yields $u^{\left[\ell-1\right]} = \qq(1^n)$.
Our construction of $u$ shows that $u$ is weakly decreasing up to level $\ell-1$.

$\Longrightarrow:$
Assume that $u = \qq(1^n)$.
We must prove that the MLQ $\qq$ is interlacing and satisfies $q_{\ell-1} = B$.

We have $u = \qq(1^n) = u^{\left[  \ell-1\right]  }$.

\begin{claim}
\label{claim:weakly_decreasing_level_i}
For each $i \in \set{0, 1, \dotsc, \ell-1} $, the word $u^{\left[  i\right]  }$ is weakly decreasing up to level $i$.
\end{claim}

\begin{subproof}
We proceed by descending induction on $i$.
The base case ($i=\ell-1$) follows from the fact that $u^{\left[  \ell-1\right]} = u$ is weakly decreasing up to level $\ell-1$.

For the induction step, we fix some $i \in \ive{\ell-1}$, and we assume that $u^{\left[i\right]}$ is weakly decreasing up to level $i$.
Our goal is then to show that $u^{\left[i-1\right]}$ is weakly decreasing up to level $i-1$.

But~\eqref{pf.lem:determinant_form.interl-act.rec} yields $u^{\left[  i\right]} = q_i( u^{\left[  i-1\right]} )$.
% We know that all letters of $u^{\left[i-1\right]}$ belong to $\ive{i}$ (since $u^{\left[i-1\right]}$ has type $\tup{m_1, m_2, \dotsc, m_{i-1}, n-p_{i-1}(\mm), 0, 0, \ldots}$).
This word $q_i( u^{\left[  i-1\right]} ) = u^{\left[  i\right]}$ has type $\mm^{[i]}$; thus, it has at least one letter equal to $i$ (since $m_i > 0$), and is weakly decreasing up to level $i$ (by the induction hypothesis).
Also, this word has exactly $\abs{q_i}$ letters that are at most $i$ (since its type is $\mm^{[i]}$, and since $\abs{q_i} = p_i(\mm)$).
Hence, Lemma~\ref{lem:determinant_form.interl-A}(a) (applied to $u^{\left[i-1\right]}$ and $q_i$ instead of $u$ and $q$)
yields that $u^{\left[i-1\right]}$ is weakly decreasing up to level $i-1$.
This completes the induction step; Claim~\ref{claim:weakly_decreasing_level_i} is thus proven.
\end{subproof}

\begin{claim}
\label{claim:description_q_i^(j)}
Let $i\in \ive{\ell-1}$. Then,
\[
q_i^{(j)} = \set{ p \in \ive{n} \mid \left( u^{\left[  i\right] } \right)_p = j }
\qquad \text{for each } j \in \ive{i} .
\]
\end{claim}

\begin{subproof}
If $q$ is any queue and $w \in \mcW_n$ is any word, then each of the letters $\bigl( q(w) \bigr)_j$ with $j \notin q$ is larger than each of the letters $\bigl( q(w) \bigr)_j$ with $j \in q$.
(This follows from the construction of $q(w)$.)
Applying this to $q = q_i$ and $w = u^{\left[i-1\right]}$, we conclude that
each of the letters $(u^{\left[  i\right]})_j$ with $j \notin q_i$ is larger than each of the letters $(u^{\left[  i\right]})_j$ with $j \in q_i$
(since~\eqref{pf.lem:determinant_form.interl-act.rec} yields $q_i( u^{\left[  i-1\right]} ) = u^{\left[  i\right]}$).
Thus,
\begin{equation}
\label{pf.claim:description_q_i^(j).1}
\begin{split}
&\text{the $\abs{q_i}$ smallest letters of the word $u^{\left[  i\right]}$} \\
&\text{are exactly the letters $(u^{\left[  i\right]})_j$ with $j \in q_i$} .
\end{split}
\end{equation}

Claim~\ref{claim:weakly_decreasing_level_i} shows that the word $u^{\left[  i\right]  }$ is weakly decreasing up to level $i$.
Hence, the letters $1,2,\dotsc,i$ that appear in $u^{\left[  i\right]  }$ must appear in weakly decreasing order (i.e., first all $i$'s, then all $i-1$'s, etc.).
Moreover, we know how often each letter appears: namely, each $k \in \ive{i}$ appears exactly $m_k$ times (since the word $u^{\left[  i\right]  }$ has type $\mm^{[i]}$).

Recall that the word $u^{\left[  i\right]  }$ has type $\mm^{[i]}$.
Hence, the letters $1,2,\dotsc,i$ that appear in this word are exactly the $p_i(\mm)$ smallest letters of this word.
In other words, they are the $\abs{q_i}$ smallest letters of this word (since $p_i(\mm) = \abs{q_i}$).
In view of~\eqref{pf.claim:description_q_i^(j).1}, this rewrites as follows:
The letters $1,2,\dotsc,i$ that appear in $u^{\left[  i\right]  }$ are exactly the letters $(u^{\left[  i\right]})_j$ with $j \in q_i$.
In other words, these letters appear precisely in the positions $j \in q_i$.
Since these letters must appear in weakly decreasing order, and since we know how often each letter appears, we thus know the exact position of each of these letters:
\begin{itemize}
\item The letters $1$ appear in the largest $m_1$ positions of $q_i$.
\item The letters $2$ appear in the next-largest $m_2$ positions of $q_i$.
\item And so on, until we get to the letters $i$.
\end{itemize}
\begin{verlong}
In other words:
\begin{itemize}
\item The $p \in \ive{n}$ satisfying $( u^{\left[  i\right] } )_p = 1$ are precisely the largest $m_1$ elements of $q_i$.
\item The $p \in \ive{n}$ satisfying $( u^{\left[  i\right] } )_p = 2$ are precisely the next-largest $m_2$ elements of $q_i$.
\item And so on, until we get to the $p \in \ive{n}$ satisfying $(u^{\left[  i\right]})_p = i$.
\end{itemize}
\end{verlong}
In other words:
\begin{itemize}
\item The set $\set{ p \in \ive{n} \mid ( u^{\left[  i\right] } )_p = 1 }$ consists of the largest $m_1$ elements of $q_i$, so that it is $q_i^{(1)}$.
\item The set $\set{ p \in \ive{n} \mid ( u^{\left[  i\right] } )_p = 2 }$ consists of the next-largest $m_2$ elements of $q_i$, so that it is $q_i^{(2)}$.
\item And so on, until we get to the set $\set{ p \in \ive{n} \mid ( u^{\left[  i\right] } )_p = i }$.
\end{itemize}
Thus, for each $j \in \ive{i}$, we have
$\set{ p \in \ive{n} \mid ( u^{\left[  i\right] } )_p = j } = q_i^{(j)}$.
Therefore, we have proven Claim~\ref{claim:description_q_i^(j)}.
% So many words and so little content.
\end{subproof}

\begin{claim}
\label{claim:interlacing_subqueues}
Let $i\in \ive{\ell-1}$ and $j\in \ive{i-1}$.
Then, $q_i^{(j)} \succeq q_{i-1}^{(j)} \gg q_i^{(j+1)}$.
\end{claim}

\begin{subproof}
From~\eqref{pf.lem:determinant_form.interl-act.rec}, we have $u^{\left[  i\right]} = q_i( u^{\left[  i-1\right]  } )$.
This word $q_i( u^{\left[  i-1\right]} ) = u^{\left[  i\right]}$ has type $\mm^{[i]}$.
Thus, it has at least one letter equal to $i$ (since $m_i > 0$)
and is weakly decreasing up to level $i$ (by Claim~\ref{claim:weakly_decreasing_level_i}).
Also, this word has exactly $\abs{q_i}$ letters that are at most $i$
\begin{vershort}
(since $\abs{q_i} = p_i(\mm)$).
\end{vershort}
\begin{verlong}
(since its type is $\mm^{[i]}$, and since $\abs{q_i} = p_i(\mm)$).
\end{verlong}
Hence, Lemma~\ref{lem:determinant_form.interl-A}(b) (applied to $u^{\left[i-1\right]}$, $q_i$ and $j$ instead of $u$, $q$ and $h$)
yields
\[
\set{ p \in \ive{n} \mid \bigl( u^{\left[i\right]} \bigr)_p = j }
\succeq
\set{ p \in \ive{n} \mid \bigl( u^{\left[i-1\right]} \bigr)_p = j }
\gg
\set{ p \in \ive{n} \mid \bigl( u^{\left[i\right]} \bigr)_p = j+1 }
\]
(since $q_i( u^{\left[  i-1\right]} ) = u^{\left[  i\right]}$).
However, the three sets appearing in this relation are $q_i^{(j)}$, $q_{i-1}^{(j)}$, and $q_i^{(j+1)}$ (from left to right), as follows from Claim~\ref{claim:description_q_i^(j)}.
Thus, this relation becomes $q_i^{(j)} \succeq q_{i-1}^{(j)} \gg q_i^{(j+1)}$.
\end{subproof}

\begin{claim}
\label{claim:the_last_queue}
We have $q_{\ell-1} = B$.
\end{claim}

\begin{vershort}
\begin{subproof}
For each $i \in \ive{\ell-1}$, Equation~\eqref{eq.determinant_form.qij.1} and Claim~\ref{claim:description_q_i^(j)} leads to
\[
  q_i = \bigcup_{j=1}^i q_i^{(j)} = \bigcup_{j=1}^i \set{ p \in \ive{n} \mid ( u^{\left[  i\right] } )_p = j }
      = \set{ p \in \ive{n} \mid ( u^{\left[  i\right] } )_p \leq i } .
\]
Applying this to $i = \ell-1$, we obtain
\[
  q_{\ell-1}
  = \set{ p \in \ive{n} \mid ( u^{\left[\ell-1\right] } )_p \leq \ell-1 }
  = \set{ p \in \ive{n} \mid u_p \leq \ell-1 }
  = B
\]
since $u^{\left[  \ell-1\right]  } = u$ and by the construction of $u$.
\end{subproof}
\end{vershort}
\begin{verlong}
\begin{subproof}
For each $i \in \ive{\ell-1}$, the equality~\eqref{eq.determinant_form.qij.1} leads to
\begin{align*}
  q_i & = \bigcup_{j=1}^i q_i^{(j)} = \bigcup_{j=1}^i \set{ p \in \ive{n} \mid ( u^{\left[  i\right] } )_p = j }
            \qquad \left(\text{by \eqref{claim:description_q_i^(j)}}\right) \\
      &= \set{ p \in \ive{n} \mid ( u^{\left[  i\right] } )_p \leq i } .
\end{align*}
Applying this to $i = \ell-1$, we obtain
\begin{align*}
  q_{\ell-1}
  &= \set{ p \in \ive{n} \mid ( u^{\left[\ell-1\right] } )_p \leq \ell-1 } \\
  &= \set{ p \in \ive{n} \mid u_p \leq \ell-1 }
   \qquad \left(\text{since } u^{\left[  \ell-1\right]  } = u \right) \\
  &= B \qquad \left(\text{by the construction of } u \right) .
\end{align*}
\end{subproof}
\end{verlong}

Now, the MLQ $\qq$ is interlacing (by Claim~\ref{claim:interlacing_subqueues}) and satisfies $q_{\ell-1} = B$ (by Claim~\ref{claim:the_last_queue}).
This proves the $\Longrightarrow$ direction of Lemma~\ref{lem:determinant_form.interl-act}.

$\Longleftarrow:$
Assume that the MLQ $\qq$ is interlacing and satisfies $q_{\ell-1} = B$.
We must prove that $u = \qq(1^n)$.

\begin{claim}
\label{claim:describing_u^[i]}
Let $i \in \ive{\ell-1}$. Then, all letters of the
word $u^{\left[  i\right]}$ are given as follows:
\[
\left( u^{\left[  i\right]} \right)_t =
\begin{cases}
j & \text{if } t \in q_i^{(j)} \text{ for some } j \in\ive{i}\!, \\
i+1 & \text{if } t \notin q_i.
\end{cases}
\]
\end{claim}

\begin{subproof}
We proceed by induction on $i$.
For convenience, we extend the claim so that the base case is the trivial case $i = 0$ (remember that $q_0 := \emptyset$ and $u^{\left[  0\right]} = 1^n$).

For the induction step, we fix $h \in \ive{\ell-1}$, and we assume (as induction hypothesis) that Claim~\ref{claim:describing_u^[i]} holds for $i = h - 1$.
We now must prove that Claim~\ref{claim:describing_u^[i]} holds for $i = h$.

The induction hypothesis shows that each $t \in \ive{n}$ satisfies
\begin{equation}
\label{pf.claim:describing_u^[i].IH}
\left( u^{\left[  h-1\right]} \right)_t =
\begin{cases}
j & \text{if } t \in q_{h-1}^{(j)} \text{ for some } j \in\ive{h-1}\!, \\
h & \text{if } t \notin q_{h-1} .
\end{cases}
\end{equation}

Since $\qq$ is interlacing, we have
$q_h^{(j)} \succeq q_{h-1}^{(j)} \gg q_h^{(j+1)}$ for all $j \in \ive{h-1}$.

Altogether, we see that Lemma~\ref{lem:determinant_form.interl-B} (applied to $u^{\left[  h-1\right]  }$, $q_{h-1}$, $q_h$, $q_{h-1}^{(j)}$ and $q_h^{(j)}$ instead of $u$, $r$, $q$, $r^{(j)}$ and $q^{(j)}$) yields that each $t \in \ive{n}$ satisfies
\begin{equation}
\label{pf.claim:describing_u^[i].4}
\biggl( q_h\Bigl(  u^{\left[  h-1\right]  }\Bigr) \biggr)_t =
\begin{cases}
j & \text{if } t \in q_h^{(j)} \text{ for some } j \in\ive{h}\!, \\
h+1 & \text{if } t \notin q_h .
\end{cases}
\end{equation}

From~\eqref{pf.lem:determinant_form.interl-act.rec}, we have
$u^{\left[  h\right]} = q_h( u^{\left[  h-1\right]  } )$.
Thus,~\eqref{pf.claim:describing_u^[i].4} rewrites as
\[
\left( u^{\left[  h\right]} \right)_t =
\begin{cases}
j & \text{if } t \in q_h^{(j)} \text{ for some } j \in\ive{h}\!, \\
h+1 & \text{if } t \notin q_h .
\end{cases}
\]
In other words, Claim~\ref{claim:describing_u^[i]} holds for $i = h$.
This completes the induction step.
Thus, Claim~\ref{claim:describing_u^[i]} is proven.
\end{subproof}

Applying Claim~\ref{claim:describing_u^[i]} to $i=\ell-1$, we conclude that
all letters of the word $u^{\left[  \ell-1\right]}$ are given as follows:
\begin{equation}
\label{pf.lem:determinant_form.interl-act.fwd.5}
\left( u^{\left[  \ell-1\right]} \right)_t =
\begin{cases}
j & \text{if } t \in q_{\ell-1}^{(j)} \text{ for some } j \in\ive{\ell-1}\!, \\
\ell & \text{if } t \notin q_{\ell-1}.
\end{cases}
\end{equation}
On the other hand, the letters of $u$ are given, from the construction, by
\[
u_t =
\begin{cases}
v_j \in \ive{\ell-1} & \text{if } t = b_j \text{ for some } j \in \ive{r}\!, \\
\ell & \text{otherwise.}
\end{cases}
\]
In view of $\set{b_1, b_2, \ldots, b_r} = B = q_{\ell-1}$, this shows that the letters $u_t$ for $t \notin q_{\ell-1}$ are all $\ell$, whereas the letters $u_t$ for $t \in q_{\ell-1}$ are in $\ive{\ell-1}$.
Hence, the letters $u_t$ for $t \in q_{\ell-1}$ are precisely those letters of $u$ that are at most $\ell-1$.
Thus, these letters appear in weakly decreasing order (since $u$ is weakly decreasing up to level $\ell-1$), and we also know how often each of the letters $1, 2, \ldots, \ell-1$ appears among them (namely, each $k \in \ive{\ell-1}$ appears $m_k$ times, since $u$ has type $\mm$).
Hence,
\begin{itemize}
\item the rightmost $m_1$ of these letters are $1$,
\item the next-rightmost $m_2$ of these letters are $2$,
\item and so on, until the letters that are $\ell-1$.
\end{itemize}
In other words,
\begin{itemize}
\item the letter $1$ appears in the rightmost $m_1$ positions in $q_{\ell-1}$;
\item the letter $2$ appears in the next-rightmost $m_2$ positions in $q_{\ell-1}$;
\item and so on, until the letter $\ell-1$.
\end{itemize}
In other words,
\begin{itemize}
\item the letter $1$ appears in the positions in $q_{\ell-1}^{(1)}$ (because these are the rightmost $m_1$ positions in $q_{\ell-1}$);
\item the letter $2$ appears in the positions in $q_{\ell-1}^{(2)}$ (because these are the next-rightmost $m_2$ positions in $q_{\ell-1}$);
\item and so on, until the letter $\ell-1$.
\end{itemize}
If we combine this with the fact that the remaining letters of $u$ are $\ell$ (indeed, the letters $u_t$ for $t \notin q_{\ell-1}$ are all $\ell$),
we thus conclude that all letters of $u$ can be described as follows:
\[
u_t =
\begin{cases}
j & \text{if } t \in q_{\ell-1}^{(j)} \text{ for some } j \in\ive{\ell-1}\!, \\
\ell & \text{if } t \notin q_{\ell-1}.
\end{cases}
\]
Comparing this with~\eqref{pf.lem:determinant_form.interl-act.fwd.5}, we conclude that $( u^{\left[\ell-1\right]} )_t = u_t$ for all $t \in \ive{n}$.
Thus, $u^{\left[\ell-1\right]} = u$.
Hence, $u = u^{\left[\ell-1\right]} = \qq(1^n)$.
This proves the $\Longleftarrow$ direction of Lemma~\ref{lem:determinant_form.interl-act}.
\end{proof}

%%%%%%%%%%
\subsection{Proof of Theorem~\ref{thm:determinant_form}}

We are now ready to prove Theorem~\ref{thm:determinant_form}:

\begin{proof}[Proof of Theorem~\ref{thm:determinant_form}.]
Write the $r$-tuple $\tup{v_1, v_2, \dotsc, v_r}$ in the form
\begin{equation}
\label{pf.thm:determinant_form.v=}
\tup{v_1, v_2, \dotsc, v_r} = (
  \underbrace{\ell-1,\ldots,\ell-1}_{m_{\ell-1}\text{ times}},
  \underbrace{\ell-2,\ldots,\ell-2}_{m_{\ell-2}\text{ times}},
  \dotsc,
  \underbrace{1,\ldots,1}_{m_1\text{ times}}
)
\end{equation}
for some $m_1, m_2, \ldots, m_{\ell-1} \geq 0$
(we can do this, since $\set{v_1, v_2, \dotsc, v_r} = \ive{\ell-1}$ and $v_1 \geq v_2 \geq \cdots \geq v_r$).
\begin{verlong}
Thus, the first $m_{\ell-1}$ of the entries of the $r$-tuple $\tup{v_1 \geq v_2 \geq \cdots \geq v_r}$ equal $\ell-1$; the next $m_{\ell-2}$ of its entries equal $\ell-2$; the next $m_{\ell-3}$ of its entries equal $\ell-3$; and so on.
\end{verlong}
Also set $m_{\ell} = n - r$, and define a type $\mm = \tup{m_1, m_2, \dotsc, m_{\ell}, 0, 0, \ldots}$.
Then, the word $u$ has type $\mm$
\begin{vershort}
by the construction of $u$.
\end{vershort}
\begin{verlong}
(since the entries of $u$ are precisely $v_1, v_2, \dotsc, v_r$ and also $n-r$ entries equal to $\ell$).
\end{verlong}
Note that $m_i > 0$ for all $i \in \ive{\ell-1}$ (since $\set{v_1, v_2, \dotsc, v_r} = \ive{\ell-1}$).
Hence, the word $u$ is packed.
Furthermore, the definition of $\mm$ shows that $r = m_1 + m_2 + \cdots + m_{\ell-1} = p_{\ell-1}(\mm)$.
\begin{verlong}
Each $i \in \ive{\ell}$ satisfies
\[
m_i =
  \begin{cases}
  \abs{ \set{ j \in \ive{r} \mid v_j = i}} & \text{if } i < \ell,\\
  n - r & \text{if } i = \ell
  \end{cases}
\]
(by~\eqref{pf.thm:determinant_form.v=} and the definition of $m_{\ell}$).
\end{verlong}

%This paragraph is pointless;  you are basically just saying ``change $r$ to $k$,'' which a reader is certainly smart enough to do.  -- Travis
%Let $k = p_{\ell-1}(\mm) \in \NN$; hence, $k = r$.
%Thus, $B = \set{b_1 < b_2 < \cdots < b_r}$ can be rewritten as $B = \set{b_1 < b_2 < \cdots < b_k}$.

Define the pseudo-partition $\lambda^{\mm}$ by~\eqref{eq.determinant_form.interlacing.lam}.
% This pseudo-partition $\lambda^{\mm}$ has $p_{\ell-1}(\mm) = r$ entries.
Comparing~\eqref{eq.determinant_form.interlacing.lam} with~\eqref{pf.thm:determinant_form.v=}, we obtain
\[
\lambda^{\mm} = \tup{\ell-v_1, \ell-v_2, \dotsc, \ell-v_r}
= \tup{\gamma_1, \gamma_2, \ldots, \gamma_r}
\]
(since $\ell - v_j = \gamma_j$ for all $j \in \ive{r}$).

The definition of $\swt{u}$ yields
\begin{align*}
\swt{u} & = \sum_{\substack{\qq \text{ is an MLQ of type } \mm; \\ u=\qq(1^n)}}\wt(\qq) \\
%&  = \sum_{\substack{\qq = \tup{q_1, q_2, \dotsc, q_{\ell-1}} \text{ is an MLQ of type } \mm; \\ \qq \text{ is interlacing and satisfies } q_{\ell-1} = B}} \wt(\qq) \qquad \text{(by Lemma~\ref{lem:determinant_form.interl-act})} \\
% The above is just a trivial rewording of the summation set for the equation below -- Travis
&  = \sum_{\substack{\qq = \tup{q_1, q_2, \dotsc, q_{\ell-1}} \text{ is an interlacing} \\\text{MLQ of type } \mm \text{ with } q_{\ell-1}=B}} \wt(\qq) \qquad \text{(by Lemma~\ref{lem:determinant_form.interl-act})} \\
&  = \left(  \prod_{i=1}^r x_{b_i} \right) \det\biggl( h_{\gamma_j-j+i-1}\left(x_1,x_2,\ldots,x_{b_j}\right)  \biggr)_{i, j \in \ive{r}} ,
\end{align*}
where the last equality is from Corollary~\ref{cor:determinant_form.bij1c} (applied to $r$, $\gamma_i$, $B$ and $b_i$ instead of $k$, $\lambda_i$, $S$ and $s_i$).
\begin{verlong}
Hence the claim follows since $\prod_{i=1}^r x_{b_i} = \prod_{b \in B} x_b$.
\end{verlong}
\end{proof}












%=====================================================================
\section{Proof of Theorem~\ref{thm:permutation}}
\label{sec:thm_proof}

In this section, we shall prove Theorem~\ref{thm:permutation} by relying on the
braid relation for dual configurations. We need some definitions first.

An \defn{$(r_1,r_2)$-configuration} shall mean a pair $C = (q_1, q_2)$, where $q_1$ is an $r_1$-queue and $q_2$ is an $r_2$-queue.
As usual, we consider $C$ as a function on words by $C(u) := q_2\bigr(q_1(u)\bigr)$, and we define the weight of $C$ by $\wt(C) := \wt(q_1) \wt(q_2)$.
We construct the \defn{dual}\footnote{This is a different duality than the contragredient duality of Lemma~\ref{le:dual}.} $(r_2,r_1)$-configuration to $C$, which we denote by $C'$, as follows.

We begin by constructing a sequence of parentheses as follows: For each $j = 1, 2, \dotsc, n$ (in that order), we write
\begin{itemize}
\item an opening parenthesis `$($' if $j \in q_1$ and $j \notin q_2$;
\item a closing parenthesis `$)$' if $j \notin q_1$ and $j \in q_2$;
\item a matched pair of parentheses `$()$' if $j \in q_1$ and $j \in q_2$;
\item nothing otherwise.
\end{itemize}
We say that these parentheses are \defn{contributed} by the site $j$.
Next, we match as many parentheses as possible following the \defn{standard parenthesis-matching algorithm}:
every time you find an opening parenthesis to the left of a closing one, with only frozen parentheses between them, you match these two parentheses and declare them frozen.
Here, we understand our sequence of parentheses as being written on a circle -- so the last opening parenthesis can be matched with the first closing parenthesis if all parentheses ``between them'' (\textit{i.e.}, to the right of the former and to the left of the latter) are frozen.

At the end of this algorithm, there will be exactly $\abs{r_1 - r_2}$ parentheses left unmatched; these unmatched parentheses will be opening if $r_1 > r_2$ and closing if $r_1 < r_2$. The unmatched parentheses will not depend on the order in which we perform the matching.
This can be easily seen by considering the parentheses as an infinite shifted-periodic Motzkin path (see Figure~\ref{fig:balanced_motzkin}), where a ``nothing'' corresponds to a flat step.
If $r_1 > r_2$, then the unmatched positions correspond to down steps in the Motzkin path such that the path never returns to the same height.
When $r_1 < r_2$, the unmatched positions correspond to the up steps where the Motzkin path first obtains a certain height.

We define \defn{$\SP(q_1, q_2)$} to be the following data:
\begin{itemize}
\item the sequence of parentheses obtained from $q_1$ and $q_2$;
\item the matching obtained by the algorithm; and
\item the correspondence between sites and \emph{closing} parentheses (\textit{i.e.}, which site contributes which closing parenthesis).
\end{itemize}

Note that each $j \in \ZZ/n\ZZ$ that belongs to both $q_1$ and $q_2$ contributes a pair of parentheses `$()$`, which can be immediately matched (to each other) at the beginning of the algorithm.
Thus, if we disregard these pairs of parentheses, the outcome of the algorithm does not change (apart from these pairs disappearing).
Hence, if we skip the sites $j \in q_1 \cap q_2$ in the definition of our sequence of parentheses, then the outcome of the algorithm (specifically, the set of unmatched parentheses) will be the same.
The sequence of parentheses obtained as above, but skipping these sites $j$, will be called the \defn{reduced parenthesis sequence}.

%If a site $j \in \ZZ / n \ZZ$ contributes a matched parenthesis or two matched parentheses or no parenthesis at all, we say $j$ is \defn{balanced}; otherwise we say $j$ is \defn{unbalanced}.
A site $j \in \ZZ/n\ZZ$ is \defn{unbalanced} if it contributes an unmatched parenthesis; otherwise we say $j$ is \defn{balanced}.
There are exactly $\abs{r_1 - r_2}$ unbalanced sites.

We construct $C' = (q'_1, q'_2)$ as follows.
For balanced $j$, we have $j \in q'_i$ if and only if $j \in q_i$ for $i=1,2$.
For unbalanced $j$, we have $j \in q'_i$ if and only if $j \in q_{3-i}$ for $i = 1,2$.
Note that $C$ and $C'$ have the same balanced sites, since the parentheses that were matched for $C$ remain matched in $C'$ and the remaining parentheses are all of one kind.
Hence, we have $C'' = C$. Also, we have $\wt(C) = \wt(C')$.

\begin{example}
Consider the configuration $C$ given in Figure~\ref{fig:balanced}.
The dual configuration $C'$ is given by sliding all of the circles not boxed from the upper level to the lower level.
In particular, we have $q_1' = q_1 \setminus \{1,5,6,8\}$ and $q_2' = q_2 \cup \{1,5,6,8\}$.
\end{example}

\begin{figure}[t]
\[
\begin{tikzpicture}[scale=0.75]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \draw[fill=blue!30] (1.5*\sc,\l-.5) rectangle(4.5*\sc,\ll+.5);
  \draw[fill=blue!30] (6.5*\sc,\l-.5) rectangle(7.5*\sc,\ll+.5);
  \draw[fill=blue!30] (8.5*\sc,\l-.5) rectangle(20.5*\sc,\ll+.5);
  \foreach \i in {1,2,5,6,8,11,13,14,17,18,19} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {3,4,7,9,10,12,15,16,20} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {2,12,15,16,18,19,20} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,3,4,5,6,7,8,9,10,11,13,14,17} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
\end{tikzpicture}
\]
\caption{We draw a $\bigcirc$ in position $i$ in row $j$ corresponding to $i \in q_j$ and a $\square$ if $i \notin q_j$.
The purple boxes mark the balanced sites.}
\label{fig:balanced}
\end{figure}

\begin{figure}[t]
\[
\begin{tikzpicture}[scale=0.45]
\draw[-,thin,red!50] (0,0) -- (24,0);
\draw[-,thin,red!50] (1,1) -- (24,1);
\draw[-,thin,red!50] (8,2) -- (24,2);
\draw[-,thin,red!50] (9,3) -- (24,3);
\draw[-,thin,red!50] (11,4) -- (24,4);
\draw[-,thin,red!50] (14,5) -- (16,5);
\draw[-,thin,red!50] (18,5) -- (22,5);
\draw[-,thick,dashed] (-1,1) -- (0,0);
\draw[-,dotted] (1,0) -- (1,1);
\draw[-,dotted] (3,0) -- (3,1);
\draw[-,dotted] (4,0) -- (4,1);
\draw[-,dotted] (5,0) -- (5,1);
\draw[-,dotted] (6,0) -- (6,2);
\draw[-,dotted] (7,0) -- (7,2);
\draw[-,dotted] (8,0) -- (8,2);
\draw[-,dotted] (9,0) -- (9,3);
\draw[-,dotted] (10,0) -- (10,4);
\draw[-,dotted] (11,0) -- (11,4);
\draw[-,dotted] (12,0) -- (12,5);
\draw[-,dotted] (13,0) -- (13,4);
\draw[-,dotted] (14,0) -- (14,5);
\draw[-,dotted] (15,0) -- (15,6);
\draw[-,dotted] (16,0) -- (16,5);
\draw[-,dotted] (17,0) -- (17,4);
\draw[-,dotted] (18,0) -- (18,5);
\draw[-,dotted] (20,0) -- (20,5);
\draw[-,dotted] (22,0) -- (22,5);
\draw[-,dotted] (23,0) -- (23,4);
\draw[-,thick] (0,0) -- (1,1) -- (2,2) -- (3,1) -- (4,1) -- (5,1) -- (6,2) -- (7,2) -- (8,2) -- (9,3) -- (10,4) -- (11,4) -- (12,5) -- (13,4) -- (14,5) -- (15,6) -- (16,5) -- (17,4) -- (18,5) -- (19,6) -- (20,5) -- (21,6) -- (22,5) -- (23,4);
\draw[-,thick,dashed] (23,4) -- (24,5);
\fill[blue] (0,0) circle (4pt);
\fill[blue] (5,1) circle (4pt);
\fill[blue] (8,2) circle (4pt);
\fill[blue] (9,3) circle (4pt);
\fill[blue] (23,4) circle (4pt);
\end{tikzpicture}
\]
\caption{The Motzkin path corresponding to the configuration in Figure~\ref{fig:balanced}.
The corresponding unbalanced up-steps are marked by dots.}
\label{fig:balanced_motzkin}
\end{figure}

Recall the notations introduced just before Lemma~\ref{le:dual}.

\begin{remark}
\label{rmk:balanced-dual-let}
Let $C = (q_1, q_2)$ be an $(r_1, r_2)$-configuration.
Thus, the dual configuration of the $(n-r_1, n-r_2)$-configuration $C^* = \tup{q_1^*, q_2^*}$ is obtained from the dual configuration $\tup{q_1', q_2'}$ of $C$ by
\begin{equation}
 (C^*)' = \bigl( (q_1')^*, (q_2')^* \bigr) .
 \label{eq.rmk:balanced-dual-let.dual}
\end{equation}
To see this, we compute the dual configurations of both $C$ and $C^*$ using the reduced parenthesis sequences. The sequence for $C^*$ is obtained from that for $C$ by reflecting both the parentheses (\textit{i.e.}, opening become closing and vice versa) and the sequence itself. Thus, the parenthesis matching algorithm proceeds in the same way.

In addition, applying Lemma~\ref{le:dual} twice, we obtain
\[
C(u) = q_2\bigl( q_1(u) \bigr) = q_2\bigl( (q^*_1(u^*))^* \bigr) = \bigl( q_2^*\bigl( q_1^*(u^*) \bigr) \bigr)^* = \bigl( C^*(u^*) \bigr)^* .
\]
%In particular, for $u \in \set{1,2}^n$, we have $C(u)_i = 5 - C^*(u^*)_{n+1-i}$, where we treat $u$ and $C^*(u^*)$ as a word with $2$ and $4$ classes, respectively.
\end{remark}

Fix $k \geq 1$.
In the following, we simplify our terminology and say that an MLQ
is a $k$-tuple of queues (without any restriction on their sizes).
We want to define an action of $\SymGp{k}$ on MLQs.
%by letting each simple transposition $s_i$ act as the map
For each $i \in \ive{k-1}$, we define a map $\fraks_i \colon \set{\text{MLQs}} \to \set{\text{MLQs}}$ by
\[
\fraks_i(q_1, q_2, \dotsc, q_k) = (q_1, \dotsc, q_{i-1}, q'_i, q'_{i+1}, q_{i+2}, \dotsc, q_k),
\]
where $\tup{q'_i, q'_{i+1}}$ is the dual configuration of $\tup{q_i, q_{i+1}}$.
From the definition of a dual configuration, it is clear that $\fraks_i \fraks_i \qq = \qq$.
It is also clear from the definition that $\fraks_i \fraks_j \qq = \fraks_j \fraks_i \qq$ if $\abs{i - j} > 1$.
Thus, the following proposition shows that $\fraks_i$ defines an action of $\SymGp{k}$ on the set of all MLQs.

\begin{prop} \label{prop:braid}
We have
\[
\fraks_i \fraks_{i+1} \fraks_i \qq
	   = \fraks_{i+1} \fraks_i \fraks_{i+1} \qq
\]
for any MLQ $\qq = \tup{q_1, \dotsc, q_k}$ and any $i \in \set{1, 2, \ldots, k-2}$.
\end{prop}

\begin{proof}
We shall deduce the claim from~\cite[Ch.~5, (5.6.3)]{Loth}.

Let $A$ be the $\tup{k+1}$-element set $\set{\circ, 1, 2, \ldots, k}$.
Let $A^*$ denote the set of all words on the alphabet $A$
(of any finite length).

We construct a $k \times n$-matrix $M_{\qq} \in A^{k \times n}$ from $\qq$ by setting the $\tup{i, j}$-th
entry to $i$ if $j \in q_i$ and $\circ$ otherwise.
We then construct a word $\word(\qq) \in A^*$ by reading $M_{\qq}$ from top-to-bottom, left-to-right (\textit{i.e.}, column by column).
For example, if $n = 5$, $k = 3$, then
\begin{align*}
\qq = \tup{\set{1, 3}, \set{2},
\set{2, 5}}
& \longleftrightarrow
 M_{\qq}
 =
 \begin{array}{ccccc}
  1 & \circ & 1 & \circ & \circ \\
  \circ & 2 & \circ  & \circ & \circ \\
  \circ & 3  & \circ & \circ & 3
 \end{array}
 \\ & \longrightarrow
 \word(\qq) = 1 \circ \circ \circ 2 3 1 \circ \circ \circ \circ \circ \circ \circ 3 .
\end{align*}
Clearly, an MLQ $\qq$ is uniquely determined by $\word(\qq)$ since $n$ is fixed.
In other words, the map $\word \colon \set{\text{MLQs}} \to A^*$
is injective.

Following~\cite[\S5.5]{Loth}, for each $i \in \set{1, 2, \ldots, k-1}$, we give an operator
$\sigma_i \colon A^* \to A^*$.
This operator $\sigma_i$ acts on a word $p \in A^*$ % = \tup{p_1, p_2, \ldots, p_\ell}$
as follows:
\begin{enumerate}
 \item Treat all letters $i$ in $p$ as opening parentheses `$($',
       all letters $i+1$ as closing parentheses `$)$',
       and consider all other letters to be frozen.
       Now, match as many parentheses as possible
       according to the standard parenthesis-matching algorithm,
       but treating the word as a word in the usual sense
       (\textit{i.e.}, not written on a circle, but having a beginning
       and an end).
       The result is independent of the choices in the algorithm,
       and is always a word whose non-frozen
       part (\textit{i.e.}, the word obtained by removing
       all frozen letters) is
       \begin{equation}
       \label{eq:reduced_parens}
       \underbrace{))\cdots)}_{a\text{ parentheses}}
       \underbrace{((\cdots(}_{b\text{ parentheses}}
       \end{equation}
       for some integers $a, b \geq 0$.
 \item Now, replace the non-frozen part~\eqref{eq:reduced_parens} by
       \[
       \underbrace{))\cdots)}_{b\text{ parentheses}}
       \underbrace{((\cdots(}_{a\text{ parentheses}}
       \]
       while keeping all frozen letters in their places.
       The resulting word is $\sigma_i p$.
\end{enumerate}
From~\cite[Eq.~(5.6.3)]{Loth}, these operators
$\sigma_i$ satisfy
\begin{equation}
 \sigma_i \sigma_{i+1} \sigma_i
 = \sigma_{i+1} \sigma_i \sigma_{i+1}
 \label{pf.prop:braid.loth-eq}
\end{equation}
for all $i \in \set{1, 2, \ldots, k-2}$.

Let $\zeta \colon \mcW_n \to \mcW_n$ be the cyclic shift map that sends each word $w_1 w_2 \cdots w_n$ to $w_2 w_3 \cdots w_n w_1$.
We also abuse the notation $\zeta$ for the map that sends each queue $q$ to the queue $\zeta q = \set{ i - 1 \mid i \in q }$ (recall that $0 = n$ as sites).
This map $\zeta$ shall act on MLQs entrywise (since an MLQ is a tuple of queues).
Clearly,
\begin{equation}
 \word(\zeta \qq) = \zeta^k \word(\qq)
 \label{pf.prop:braid.word-zeta}
\end{equation}
for any MLQ $\qq = (q_1, \ldots, q_k)$.

Now, we claim that
\begin{equation}
 \word(\fraks_i \qq) = \sigma_i\bigl( \word(\qq) \bigr)
 \qquad \text{ for each MLQ } \qq \text{ and each } i .
 \label{pf.prop:braid.inter}
\end{equation}
Note that it is sufficient to show that $\word(\fraks_1 \qq) = \sigma_1\bigl( \word(\qq) \bigr)$ for $\qq = (q_1, q_2)$
(because the definition of $\sigma_i$ only relies on the letters $i$ and $i+1$, while all other letters stay in their places and have no effect).

Thus, let $\qq = (q_1, q_2)$.
We want to show $\word(\fraks_1 \qq) = \sigma_1\bigl( \word(\qq) \bigr)$.
If $\abs{q_1} = \abs{q_2}$, then $\fraks_1 \qq = \qq$ by the definition of $\fraks_1$.
Moreover, we have $\sigma_1\bigl( \word(\qq) \bigr) = \word(\qq)$ in this case, since the word $\word(\qq)$ has as many letters $1$ as it has letters $2$, but the map $\sigma_1$ leaves such words unchanged.
Hence, the claim holds when $\abs{q_1} = \abs{q_2}$.
Thus, we assume that $\abs{q_1} \neq \abs{q_2}$.
Therefore, there exists at least one unbalanced site for the configuration $\qq = (q_1, q_2)$.

The operator $\fraks_1$ commutes with the cyclic shift map $\zeta$ on MLQs because the standard parenthesis-matching algorithm used in the definition of dual configurations is clearly invariant under cyclic shift.
The operator $\sigma_1$ commutes with the cyclic shift map $\zeta$ on words in $A^*$ by~\cite[Prop.~5.6.1]{Loth}.
Hence, and because of~\eqref{pf.prop:braid.word-zeta}, we can apply $\zeta$ to $\qq$ any number of times without loss of generality.
Thus, we assume that the site $1$ is unbalanced for the configuration $\qq = (q_1, q_2)$, since at least one unbalanced site $j$ exists and we can cyclically shift until it is $1$.
Thus, in the standard parenthesis-matching algorithm used in the construction of the dual configuration $\fraks_1 \qq$, the site $1$ induces a parenthesis that stays unmatched throughout the algorithm.
Hence, no two parentheses that get matched to each other during this algorithm have this parenthesis lying between them.
Therefore, it does not matter whether we regard the sequence of parentheses as written on a cycle or on a straight line (as the wrapping-around is not used in the matching process).
Hence, the standard parenthesis-matching algorithm used in the construction of the dual configuration $\fraks_1 \qq$ proceeds exactly the same way as the standard parenthesis-matching algorithm used when applying $\sigma_1$ to $\word(\qq)$ (ignoring the letters that are neither $i$ nor $i+1$). That is, the parentheses that get matched in the former are the same as those that get matched in the latter.
% Note that the construction of balanced sites is exactly the sequence of parentheses constructed when applying $\sigma_1$ to $\word(\qq)$ (removing all $\circ$ letters).
Now, recall that $\fraks_1$ merely toggles the unbalanced sites between $q_1$ and $q_2$, whereas $\sigma_1$ switches the number of unmatched `$)$'s with the number of unmatched `$($'s (which, in the case of $\word(\qq)$, boils down to just turning each unmatched `$)$' into a `$($' or vice versa, because one of these numbers is $0$).
Since the sites of the unmatched parentheses are precisely the unbalanced sites, this shows that the two maps agree -- that is, we have $\word(\fraks_1 \qq) = \sigma_1\bigl( \word(\qq) \bigr)$.
This proves~\eqref{pf.prop:braid.inter}.

The equality~\eqref{pf.prop:braid.inter} can be rewritten as the
commutative diagram
\[
\xymatrix{
 \set{\text{MLQs}} \ar[r]^{\fraks_i} \ar[d]_{\word} & \set{\text{MLQs}} \ar[d]^{\word} \\
 A^* \ar[r]_{\sigma_i} & A^*
}
\]
for all $i \in \set{1, 2, \dotsc, k-1}$.
In view of the injectivity of the map $\word \colon \set{\text{MLQs}} \to A^*$,
this diagram allows us to translate~\eqref{pf.prop:braid.loth-eq} into
$\fraks_i \fraks_{i+1} \fraks_i = \fraks_{i+1} \fraks_i \fraks_{i+1}$.
\end{proof}

\begin{remark}
Our letters $1, \ldots, k$ correspond to the letters $a_k, \ldots, a_1$ in~\cite{Loth},
since the definition of $\sigma_i$ in~\cite{Loth} involves $a_i$ rather
than $i+1$ as closing parenthesis and $a_{i+1}$ rather than $i$ as opening one.
Also,~\cite{Loth} does not include the letter $\circ$ in the alphabet,
but this makes no difference to the proof, since all letters $\circ$ are always frozen.
% Note that we have arbitrarily chosen to break our cycle at $n$,
% however by~\cite[Prop.~5.6.1]{Loth}, the result does not depend on this choice.
\end{remark}

\begin{remark}
The operator $\sigma_i$ is essentially a combination of co-plactic operators.
Moreover, it corresponds to the Weyl group action on a tensor product of crystals~\cite{BS17}.
Note that the bracketing rule given above is precisely the usual signature rule (see, \textit{e.g.},~\cite[Sec.~2.4]{BS17} for a description) for computing tensor products.
This arises from considering the MLQ as a binary $m \times n$ matrix and the natural $(\mathfrak{sl}_m \oplus \mathfrak{sl}_n)$-action.
\end{remark}

Next, we define two queues corresponding to a word $w \in \mcW_n$ of type $\mm$.
Namely, for $k \in \set{p_i(\mm) \mid i \geq 0}$, let $[w]_k$ denote the set of the indices $i \in \ive{n}$
corresponding to the $k$ smallest letters $w_i$ of $w$.

Our proof of Theorem~\ref{thm:permutation} will rely on a connection between dual configurations and the action of queues on words.
We begin with a string of lemmas.

\begin{lemma} \label{lem:SL.reconstruct}
Let $w, w' \in \mcW_n$ be two words of the same type $\mm$.
Assume that $[w]_k = [w']_k$ for each $k \in \set{p_i(\mm) \mid i \geq 0}$.
Then, $w = w'$.
\end{lemma}

\begin{proof}
Fix some $i \geq 1$.
The sites containing the letter $i$ in $w$ are the elements of $[w]_{p_i(\mm)} \setminus [w]_{p_{i-1}(\mm)}$
(since $w$ has type $\mm$).
Likewise,
the sites containing the letter $i$ in $w'$ are the elements of $[w']_{p_i(\mm)} \setminus [w']_{p_{i-1}(\mm)}$.
Since our assumption ($[w]_k = [w']_k$) yields $[w]_{p_i(\mm)} \setminus [w]_{p_{i-1}(\mm)}
= [w']_{p_i(\mm)} \setminus [w']_{p_{i-1}(\mm)}$, %\travis{FYI: still fighting us.},
we conclude that these are the same sites.
Since this holds for all letters $i$, we have $w = w'$.
\end{proof}

\begin{lemma} \label{lem:SL.dual.1}
Let $\tup{q_1, q_2}$ be a configuration with $\abs{q_1} \leq \abs{q_2}$.
Let $i \in q_1$.
Let $j$ be the first site weakly to the right of $i$ that belongs to $q_2$.
Then, $\SP(q_1 \setminus \set{i}, q_2 \setminus \set{j})$ is obtained from $\SP(q_1, q_2)$ by removing a pair of matched parentheses.\footnote{The matching of all other parentheses remains the same, and so does the correspondence between sites and closing parentheses (except for the one we removed).}
Moreover, the closing parenthesis of that pair is contributed by $j \in q_2$.
\end{lemma}

\begin{proof}
The assumption $\abs{q_1} \leq \abs{q_2}$ implies that all closing parentheses in $\SP(q_1, q_2)$ are matched.
In particular, the closing parenthesis $\gamma$ contributed by $j \in q_2$ is matched.
Let $\alpha$ be the opening parenthesis contributed by $i \in q_1$.
All parentheses between $\alpha$ and $\gamma$ are opening (by the minimality of $j$).
We know that $\gamma$ is matched to an opening parenthesis $\beta$.
Hence, the parenthesis sequence $\SP(q_1, q_2)$ between $\alpha$ and $\gamma$ (inclusive) is
\[
\begin{array}{cccccc}
( & ( & ( & \cdots & ( & ) \\
\alpha & & & & \beta & \gamma,
\end{array}
\]
where $\alpha$ and $\beta$ may be the same parenthesis.
Therefore $\SP(q_1 \setminus \set{i}, q_2 \setminus \set{j})$ is obtained from $\SP(q_1, q_2)$ by removing $\alpha$ and $\gamma$.
Yet this is tantamount to removing $\beta$ and $\gamma$ from $\SP(q_1, q_2)$, since both times we are simply shortening the string of opening parentheses before $\gamma$ by $1$ (and since we do not store the positions of the opening parentheses).
\end{proof}

\begin{lemma} \label{lem:SL.dual.3}
Let $u \in \mcW_n$ be a word of type $\mm$.
Let $k = p_{\alpha}(\mm)$ for some $\alpha$.
Let $q$ be a queue such that $k \leq \abs{q}$.
Each site $j \in \ive{q(u)}_k$ contributes a matched closing parenthesis to $\SP(\ive{u}_k, q)$.
\end{lemma}

\begin{proof}
Choose a permutation $(i_1, i_2, \dotsc, i_n)$ of $(1, 2, \dotsc, n)$ such that $u_{i_1} \leq u_{i_2} \leq \cdots \leq u_{i_n}$.
Use this permutation to construct $q(u)$ as per the definition.
For each $p \in \ive{n}$, let $j_p$ denote the site that is set while processing $i = i_p$ when constructing $q(u)$.
Thus, $(q(u))_{j_p} = u_{i_p}$ whenever $p \leq \abs{q}$ (since these entries of $q(u)$ are set in Phase~II),
and $(q(u))_{j_p} = u_{i_p} + 1$ otherwise (Phase~I).
Therefore, $\ive{q(u)}_k = \set{j_1, j_2, \ldots, j_k}$ (since $k \leq \abs{q}$).
Thus, we only need to prove that each of the sites $j_1, j_2, \ldots, j_k$ contributes a matched closing parenthesis to $\SP(\ive{u}_k, q)$.
Denote $q_1^{(p)} := q_1 \setminus \{i_1, i_2, \dotsc, i_p\}$ and $q_2^{(p)} := q_2 \setminus \{j_1, j_2, \dotsc, j_p\}$.

\begin{claim}
\label{claim:matching_SP}
Let $p \in \set{0, 1, \ldots, k}$.
Then, $\SP(q_1^{(p)}, q_2^{(p)})$ is obtained from $\SP(q_1 , q_2)$ by removing $p$ pairs of matched parentheses.
The closing parentheses of these $p$ pairs are contributed by $j_1, j_2, \ldots, j_p$.
\end{claim}

\begin{subproof}
We shall prove Claim~\ref{claim:matching_SP} by induction on $p$.
The base case ($p = 0$) is obvious.
For the induction step, we assume that Claim~\ref{claim:matching_SP} holds for $p-1$.
The site $j_p$ is chosen in Phase~II (since $p \leq k \leq \abs{q}$), and therefore $j_p$ is the first site weakly to the right of $i_p$ that belongs to $q_2^{(p-1)}$.
Hence, Lemma~\ref{lem:SL.dual.1}
(applied to $q_1^{(p-1)}$, $q_2^{(p-1)}$, $i_p$ and $j_p$ instead of $q_1$, $q_2$, $i$ and $j$)
implies that $\SP(q_1^{(p)}, q_2^{(p)})$ is obtained from $\SP(q_1^{(p-1)}, q_2^{(p-1)})$ by removing a pair of matched parentheses.
Moreover, the closing parenthesis of that pair is contributed by $j_p \in q_2^{(p-1)}$.
Thus, Claim~\ref{claim:matching_SP} follows from the induction hypothesis.
This completes the induction step.
\end{subproof}

The above claim applied to $p = k$ shows that $\SP(q_1^{(k)}, q_2^{(k)})$ is obtained from $\SP(q_1 , q_2)$ by removing $k$ pairs of matched parentheses, and that the closing parentheses of these $k$ pairs are contributed by $j_1, j_2, \ldots, j_k$.
Hence, each of the sites $j_1, j_2, \ldots, j_k$ contributes a matched closing parenthesis to $\SP(\ive{u}_k, q)$.
\end{proof}

\begin{prop} \label{prop:SL.dual}
Let $u \in \mcW_n$ be a word of type $\mm$.
Let $k = p_{\alpha}(\mm)$ for some $\alpha$.
Let $q$ be a queue.
The dual configuration of $\tup{ [u]_k , q }$ has the form $\tup{q^{\dagger} , [q(u)]_k }$, where $q^{\dagger}$ is some queue.
\end{prop}

\begin{proof}
Let $\tup{q'_1, q'_2}$ be the dual configuration of $\tup{ [u]_k , q }$.
We must then prove that $q'_2 = \ive{q(u)}_k$.
Note that $\abs{q'_2} = \abs{\ive{u}_k} = k = \abs{\ive{q(u)}_k}$.

Suppose $k \leq \abs{q}$.
Then, Lemma~\ref{lem:SL.dual.3} shows that each site $j \in \ive{q(u)}_k$ contributes a matched closing parenthesis to $\SP(\ive{u}_k, q)$.
Therefore, all of these sites are balanced, and hence belong to $q'_2$.
Thus, $q'_2 \supseteq \ive{q(u)}_k$, whence $q'_2 = \ive{q(u)}_k$
(since $\abs{q'_2} = \abs{\ive{q(u)}_k}$).

Now suppose $k > \abs{q}$.
Let $\ell$ be the number of classes in $u$, and consider the contragredient duals $q^*$ and $u^*$ as in Lemma~\ref{le:dual}.
Thus, $n-k < n - \abs{q} = \abs{q^*}$.
Hence, applying the $k \leq \abs{q}$ case (proven above)
to $n-k$, $u^*$ and $q^*$ instead of $k$, $u$ and $q$,
we see that
$\tup{ [u^*]_{n-k} , q^* }' = \tup{ q^\dagger , [q^*(u^*)]_{n-k} }$
for some queue $q^\dagger$.
Now,
\begin{align*}
 %\label{eq:dual_config_equalities}
 \bigl( (q'_1)^*, (q'_2)^* \bigr)
 &= \bigl( ([u]_k)^* , q^* \bigr)'
 = \tup{ [u^*]_{n-k} , q^* }' \\
 & = \tup{ q^{\dagger} , [q^*(u^*)]_{n-k} }
 = \tup{ q^{\dagger} , \bigl[\bigl(q(u) \bigr)^* \bigr]_{n-k} } ,
\end{align*}
where
\begin{itemize}
 \item the first equality follows from~\eqref{eq.rmk:balanced-dual-let.dual};
 \item the second equality is because $([u]_k)^* = [u^*]_{n-k}$; and
 \item the fourth equality follows from Lemma~\ref{le:dual}.
\end{itemize}
Therefore, $(q'_2)^* = \bigl[\bigl( q(u) \bigr)^* \bigr]_{n-k} = ([q(u)]_k)^*$, so that
$q'_2 = [q(u)]_k$.
Hence, Proposition~\ref{prop:SL.dual} is proven in the case when $k > \abs{q}$.
\end{proof}

\begin{proof}[Proof of Theorem~\ref{thm:permutation}.]
Recall that any permutation in $\SymGp{\ell-1}$ is a product of simple transpositions $s_1, s_2, \ldots, s_{\ell-2}$.
Hence, in order to prove Theorem~\ref{thm:permutation}, it suffices to show that $\swt{u}_{\sigma} = \swt{u}_{\sigma s_i}$ for each $\sigma \in \SymGp{\ell-1}$ and $i \in \ive{\ell-2}$.
Then, Theorem~\ref{thm:permutation} follows by induction on length, \textit{i.e.} the minimal number of simple transpositions needed to write $\sigma$.

In order to prove $\swt{u}_{\sigma} = \swt{u}_{\sigma s_i}$, we need to show, for a $\sigma$-twisted MLQ $\qq$ of type $\mm$ satisfying $u = \qq (1^n)$, that $\fraks_i \qq$ is a $\sigma s_i$-twisted MLQ of type $\mm$ satisfying $u = (\fraks_i \qq) (1^n)$ (since this will show that $\fraks_i$ bijects the former MLQs to the latter).
The only nontrivial part is showing $u = (\fraks_i\qq) (1^n)$.
More generally, we will show that $(\fraks_i\qq)(w) = \qq(w)$ for any word $w \in \mcW_n$.
The proof of this claim reduces to showing that for any configuration $C = \tup{q_1, q_2}$ and any word $w \in \mcW_n$ the dual configuration $\fraks_1 C = C' = (q'_1, q'_2)$ of $C$ satisfies $C'(w) = C(w)$.

Each word $w$ can be obtained from a standard word by a sequence of
merges (each of which sends a word $u$ to $\vee^{(k)} u$ for some
$k \in \set{ p_j(\mm) \mid j \geq 1 }$, where $\mm$ is the type of
$u$). Lemma~\ref{lemma:queue_merge_commute} shows that these merges
commute with the action of a queue (and thus of an MLQ).
Hence, it is sufficient to consider standard words $w$.
Thus, assume that $w$ is standard of type $\mm$.
It is straightforward to see
(using Equation~\eqref{eq:queue_type_change} and $\abs{q'_2} = \abs{q_1}$ and $\abs{q'_1} = \abs{q_2}$)
that the words
$C(w) = q_2\bigl( q_1(w) \bigr)$
and
$C'(w) = q'_2\bigl( q_1'(w) \bigr)$
have the same type.
%indeed, the action of a queue $q$ on a word $w$ modifies its
%type in a predictable way (namely, the number $\abs{q}$ is
%inserted into the type of $w$ at the place where it would
%keep the type weakly increasing).
Let $\nn$ be this type.
We shall now show that
$[C'(w)]_k = [C(w)]_k$
for all $k \in \set{ p_i(\nn) \mid i \geq 0}$.
According to Lemma~\ref{lem:SL.reconstruct}, this will yield $C'(w) = C(w)$, and thus our proof will be complete.

Let $k \in \set{ p_i(\nn) \mid i \geq 0}$.
Thus, $k \in \set{0, 1, \ldots, n} = \set{ p_i(\mm) \mid i \geq 0 }$ (since $w$ is standard).
Hence, $[w]_k$ is well-defined.
Note that $q_i(w)$ and $q'_i(w)$ are also standard words.
Using Proposition~\ref{prop:SL.dual} to compute dual
configurations, we can see how the MLQ
$\qq = \tup{[w]_k, q_1, q_2}$ transforms under the action of
$\fraks_1 \fraks_2 \fraks_1$: Namely, we have
\begin{align*}
\tup{[w]_k, q_1, q_2} & \overset{\fraks_1}{\longmapsto} \tup{\ast, [q_1(w)]_k, q_2}
\\ & \overset{\fraks_2}{\longmapsto} \tup{\ast, \ast, \bigl[ q_2\bigl( q_1(w) \bigr) \bigr]_k}
\\ & \overset{\fraks_1}{\longmapsto} \tup{\ast, \ast, \bigl[ q_2\bigl( q_1(w) \bigr) \bigr]_k},
\end{align*}
where $\ast$ denotes some queue.
Likewise, the action of $\fraks_2 \fraks_1 \fraks_2$ is given by
\begin{align*}
\tup{[w]_k, q_1, q_2} & \overset{\fraks_2}{\longmapsto} \tup{[w]_k, q'_1, q'_2}
\\ & \overset{\fraks_1}{\longmapsto} \tup{\ast, [q'_1(w)]_k , q'_2}
\\ & \overset{\fraks_2}{\longmapsto} \tup{\ast, \ast, \bigl[ q'_2\bigl( q'_1(w) \bigr) \bigr]_k}.
\end{align*}
(See Figure~\ref{fig:crossing_diagrams} for the actions depicted using crossing diagrams.)
Yet, the two maps are equal by Proposition~\ref{prop:braid}.
Thus, the resulting MLQs must be identical:
\[
\tup{\ast, \ast, \bigl[ q'_2\bigl(q'_1(w) \bigr) \bigr]_k}
=
\tup{\ast, \ast, \bigl[ q_2\bigl(q_1(w) \bigr) \bigr]_k}.
\]
Hence, we have
\[
\bigl[ q'_2\bigl( q'_1(w) \bigr) \bigr]_k = \bigl[ q_2\bigl( q_1(w) \bigr) \bigr]_k.
\]
In other words, $[C'(w)]_k = [C(w)]_k$.
\end{proof}

\begin{figure}
\begin{gather*}
\begin{tikzpicture}[xscale=3.5]
\node (i1) at (0,0) {$[w]_k$};
\node (i2) at (0,-1) {$q_1$};
\node (i3) at (0,-2) {$q_2$};
\node (s11) at (1,0) {$\ast$};
\node (s12) at (1,-1) {$[q_1(w)]_k$};
\node (s13) at (1,-2) {$q_2$};
\node (s21) at (2,0) {$\ast$};
\node (s22) at (2,-1) {$\ast$};
\node (s23) at (2,-2) {$\bigl[ q_2\bigl( q_1(w) \bigr) \bigr]_k$};
\node (t1) at (3,0) {$\ast$};
\node (t2) at (3,-1) {$\ast$};
\node (t3) at (3,-2) {$\bigl[ q_2\bigl( q_1(w) \bigr) \bigr]_k$};
\path[-] (i2) edge (s11) (s11) edge (s21) (s21) edge (t2);
\path[-] (i3) edge (s13) (s13) edge (s22) (s22) edge (t1);
\path[-,red,thick] (i1) edge (s12) (s12) edge (s23) (s23) edge (t3);
\end{tikzpicture}
\\
\begin{tikzpicture}[xscale=3.5]
\node (i1) at (0,0) {$[w]_k$};
\node (i2) at (0,-1) {$q_1$};
\node (i3) at (0,-2) {$q_2$};
\node (s11) at (1,0) {$[w]_k$};
\node (s12) at (1,-1) {$q'_1$};
\node (s13) at (1,-2) {$q'_2$};
\node (s21) at (2,0) {$\ast$};
\node (s22) at (2,-1) {$[q'_1(w)]_k$};
\node (s23) at (2,-2) {$q'_2$};
\node (t1) at (3,0) {$\ast$};
\node (t2) at (3,-1) {$\ast$};
\node (t3) at (3,-2) {$\bigl[ q'_2\bigl( q'_1(w) \bigr) \bigr]_k$};
\path[-] (i2) edge (s13) (s13) edge (s23) (s23) edge (t2);
\path[-] (i3) edge (s12) (s12) edge (s21) (s21) edge (t1);
\path[-,red,thick] (i1) edge (s11) (s11) edge (s22) (s22) edge (t3);
\end{tikzpicture}
\end{gather*}
\caption{Crossing diagrams representing the action of $\fraks_1 \fraks_2 \fraks_1$ (top) and $\fraks_2 \fraks_1 \fraks_2$ (bottom).}
\label{fig:crossing_diagrams}
\end{figure}

\begin{remark}
Theorem~\ref{thm:permutation} for the special case of $x_1 = \cdots = x_n = 1$ was proven in~\cite{AAMP} using different techniques.
We also sketch an alternative direct approach in the FPSAC extended abstract version of this work~\cite{AGS18}.
\end{remark}






%=====================================================================
\section{Final remarks}
\label{sec:remarks}

We conclude by giving some additional examples, remarks, and comments about our results.
We begin with an example to illustrate the proof of Theorem~\ref{thm:merge} in more detail.

\begin{example}
\label{ex:merge_theorem}
In order to compute $\swt{135452}$, we need to examine MLQs of type $(1,1,1,1, 2, 0, 0, \ldots)$.
We take a particular MLQ $\qq$ and add the $5$-queue $\set{1,2,3,5,6}$ as follows:
\[
\qq = \;
\begin{tikzpicture}[baseline=66,scale=0.75,every node/.style={inner sep=2pt}]
\node at (0, 4){2};\node at (1, 4){2};\node at (2, 4){2};\node[circle, draw=black] at (3, 4){1};\node at (4, 4){2};\node at (5, 4){2};\node at (0, 3){3};\node at (1, 3){3};\node[circle, draw=black] at (2, 3){2};\node at (3, 3){3};\node at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){4};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){5};\node[circle, draw=black] at (5, 1){2};
\end{tikzpicture}
\; \xrightarrow{\hspace{30pt}} \;
\begin{tikzpicture}[baseline=66,scale=0.75,every node/.style={inner sep=2pt}]
\node[circle, draw=black] at (0, 5){1};\node[circle, draw=black] at (1, 5){1};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node[circle, draw=black] at (4, 5){1};\node[circle, draw=black] at (5, 5){1};\node at (0, 4){2};\node at (1, 4){2};\node at (2, 4){3};\node[circle, draw=black] at (3, 4){1};\node at (4, 4){2};\node at (5, 4){2};\node at (0, 3){3};\node at (1, 3){4};\node[circle, draw=black] at (2, 3){2};\node at (3, 3){3};\node at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};
\end{tikzpicture}
\; = \widetilde{\qq}.
\]
Thus, we obtain a $(s_4 s_3 s_2 s_1)$-twisted MLQ $\widetilde{\qq}$ of type $(1, 1, 1, 1, 1, 1, 0, \ldots)$.
Furthermore, note that $135452 = \merge{5} 135462$.
Now, by Theorem~\ref{thm:permutation}, such MLQs $\widetilde{\qq}$ are in bijection with ordinary MLQs contributing to, in this case, $\swt{135462}$.
In more detail, let $R_i(\widetilde{\qq})$ be the MLQ formed by taking the configuration $C = (\widetilde{q}_i, \widetilde{q}_{i+1})$ and replacing it with the dual configuration.
By taking $R_4 R_3 R_2 R_1(\widetilde{\qq})$ to bring the top row to the bottom, we obtain the ordinary MLQ as follows:
\begin{align*}
\; \widetilde{\qq} & \xrightarrow[\hspace{15pt}]{R_1} \;
\begin{tikzpicture}[xscale=0.7,yscale=0.7,every node/.style={inner sep=0.8pt},baseline=55]
\node at (0, 5){2};\node at (1, 5){2};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node[circle, draw=black] at (0, 4){2};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node[circle, draw=black] at (3, 4){1};\node[circle, draw=black] at (4, 4){2};\node[circle, draw=black] at (5, 4){2};\node at (0, 3){3};\node at (1, 3){4};\node[circle, draw=black] at (2, 3){2};\node at (3, 3){3};\node at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};
\end{tikzpicture}
\; \xrightarrow[\hspace{15pt}]{R_2} \;
\begin{tikzpicture}[xscale=0.7,yscale=0.7,every node/.style={inner sep=0.8pt},baseline=55]
\node at (0, 5){2};\node at (1, 5){2};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node at (0, 4){3};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node at (3, 4){3};\node at (4, 4){3};\node[circle, draw=black] at (5, 4){1};\node[circle, draw=black] at (0, 3){3};\node at (1, 3){4};\node[circle, draw=black] at (2, 3){2};\node[circle, draw=black] at (3, 3){3};\node[circle, draw=black] at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};
\end{tikzpicture}
\allowdisplaybreaks
\\[1.3em] &
\; \xrightarrow[\hspace{15pt}]{R_3} \;
\begin{tikzpicture}[xscale=0.7,yscale=0.7,every node/.style={inner sep=0.8pt},baseline=55]
\node at (0, 5){2};\node at (1, 5){2};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node at (0, 4){3};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node at (3, 4){3};\node at (4, 4){3};\node[circle, draw=black] at (5, 4){1};\node[circle, draw=black] at (0, 3){3};\node at (1, 3){4};\node at (2, 3){4};\node at (3, 3){4};\node[circle, draw=black] at (4, 3){2};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node[circle, draw=black] at (2, 2){4};\node[circle, draw=black] at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};\end{tikzpicture}
\; \xrightarrow[\hspace{15pt}]{R_4} \;
\begin{tikzpicture}[xscale=0.7,yscale=0.7,every node/.style={inner sep=0.8pt},baseline=55]
\node at (0, 5){2};\node at (1, 5){2};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node at (0, 4){3};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node at (3, 4){3};\node at (4, 4){3};\node[circle, draw=black] at (5, 4){1};\node[circle, draw=black] at (0, 3){3};\node at (1, 3){4};\node at (2, 3){4};\node at (3, 3){4};\node[circle, draw=black] at (4, 3){2};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){5};\node[circle, draw=black] at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node[circle, draw=black] at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};
\end{tikzpicture}
\; = \widetilde{\qq}',
\end{align*}
which contributes to $\swt{135462}$.
\end{example}

There is the natural cyclic symmetry on our special weights.

\begin{prop}
  Let $C_n \subseteq \SymGp{n}$ denote the cyclic group of order $n$ generated by the $n$-cycle $(1 \; 2 \; \dotsm \; n)$ and $u \in \mcW_n$.
  We have $\swt{u}_{\tau}\sigma = \swt{u \sigma}_{\tau}$ for any $\sigma \in C_n$ and $\tau \in \SymGp{\ell-1}$, where $\SymGp{n}$ acts on $\mcW_n$ from the right by $(u_1 \dotsm u_n) \sigma = u_{\sigma(1)} \dotsm u_{\sigma(n)}$, that is to say permutations act on positions, and similarly on monomials in $\xx$.
\end{prop}

\begin{proof}
  For a queue $q$, define $\sigma q := \{ \sigma(i) \mid i \in q\}$.
  It is clear from the definition of a queue that $q(u \sigma) = \bigl( (\sigma q)(u) \bigr) \sigma$.
  Hence, for any $\tau$-twisted MLQ $\qq$ of type $\mm$, we have
  $\qq (u \sigma) = \bigl( (\sigma \qq)(u) \bigr) \sigma$,
  where the action of $C_n$ on MLQs is obtained by acting on each queue separately.
  Thus, in particular, for any $\tau$-twisted MLQ $\qq$ of type $\mm$, we have
  $\qq (1^n) = \bigl( (\sigma \qq)(1^n) \bigr) \sigma$.
  From here, the claim follows by an obvious bijection
  (given by the action of $\sigma$) between the sums defining
  $\swt{u}_{\tau} \sigma$ and $\swt{u \sigma}_{\tau}$.
\end{proof}

Let $B^{r,s}$, where $r \in [n-1]$ and $s \in \ZZ_{>0}$, be a \defn{Kirillov--Reshetikhin (KR) crystal} in type $A_{n-1}^{(1)}$~\cite{KKMMNN92}.
Recall from~\cite{NY97,Shimozono02} that the combinatorial $R$-matrix is the unique crystal isomorphism
\[
R \colon B^{r_1,s_1} \otimes B^{r_2,s_2} \to B^{r_2,s_2} \otimes B^{r_1,s_1}.
\]
There is a well-known (in slightly different terminology) bijection $\Xi_r$ relating $r$-queues with an element of the KR crystal $B^{r,1}$ in type $A_{n-1}^{(1)}$ by considering $q = \{b_1 < \cdots < b_r\}$  as a single-column Young tableau of height $r$.
In~\cite{KMO15}, this was extended to a bijection $\Xi$ between multiline queues of type $\mm$ with $\ell+1$ classes and $B^{p_1,1} \otimes B^{p_2,1} \otimes \dotsm \otimes B^{p_{\ell},1}$ by
\[
\Xi(\qq) = \Xi_{p_1}(q_1) \otimes \Xi_{p_2}(q_2) \otimes \dotsm \otimes \Xi_{p_{\ell}}(q_{\ell}).
\]
Thus, by comparing the description of the combinatorial $R$-matrix for $B^{r_1,1}$ and $B^{r_2,1}$ from~\cite{NY97}, we obtain that taking the dual configuration is equivalent to applying the combinatorial $R$-matrix under $\Xi$.

\begin{prop}
\label{prop:dual_is_R}
Let $C$ be an $(r_1, r_2)$-configuration. Then
\[
\Xi(C') = R\bigl( \Xi(C) \bigr),
\]
where $C'$ is the dual configuration of $C$.
\end{prop}

Note that Proposition~\ref{prop:dual_is_R} gives another proof of Proposition~\ref{prop:braid} since the combinatorial $R$-matrix is well-known to satisfy the Yang-Baxter equation.

\begin{example}
Suppose $n = 9$.
Consider the $(4,6)$-configuration and dual $(6,4)$-configuration
\[
C = (\set{1,4,5,6}, \set{2,3,4,6,7,8}),
\qquad\quad
C' = (\set{1,3,4,5,6,8}, \set{2,4,6,7}).
\]
We have
\[
\begin{tikzpicture}[xscale=6,yscale=4,>=stealth]
\node (C) at (0,0) { %{$(\set{1,4,5,6}, \set{2,3,4,6,7,8})$};
\begin{tikzpicture}[scale=0.7]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \foreach \i in {1,4,5,6} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2,3,7,8,9} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {2,3,4,6,7,8} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,5,9} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
\end{tikzpicture}
};
\node (Cp) at (0,-1) { %{$(\set{1,3,4,5,6,8}, \set{2,4,6,7})$};
\begin{tikzpicture}[scale=0.7]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \foreach \i in {1,3,4,5,6,8} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2,7,9} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {2,4,6,7} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,3,5,8,9} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
\end{tikzpicture}
};
\node (KR) at (1,0) {$\young(1,4,5,6) \otimes \young(2,3,4,6,7,8)$};
\node (KRp) at (1,-1) {$\young(1,3,4,5,6,8) \otimes \young(2,4,6,7)$};
\draw[<->] (C) -- (Cp) node[midway,anchor=east] {dual};
\draw[<->] (C) -- (KR) node[midway,anchor=south] {$\Xi$};
\draw[<->] (KR) -- (KRp) node[midway,anchor=west] {$R$};
\draw[<->] (Cp) -- (KRp) node[midway,anchor=north] {$\Xi$};
\end{tikzpicture}
\]
\end{example}

Since the combinatorial $R$-matrix satisfies the Yang--Baxter equation, we have an action of the symmetric group $\SymGp{\ell}$ acting on MLQs with $\ell + 1$ queues.
Given the description of the combinatorial $R$-matrix using the Robinson--Schensted--Knuth (RSK) bijection~\cite{Shimozono02}, this $\SymGp{\ell}$-action can be considered as corresponding to the one given by van Leeuwen~\cite[Lemma~2.3]{vanLeeuwen-dc}.\footnote{This could also be considered as an interpretation of the Littlewood--Richardson rule, along with the fact that $s_{\lambda} s_{\mu}$, where $s_{\lambda}$ and $s_{\mu}$ are Schur functions corresponding to rectangles, is multiplicity free~\cite{Stembridge01}, and using Howe duality~\cite[Ch.~9,App.~B]{BS17}.}
Furthermore, the $\SymGp{\ell}$-action on MLQs has been considered by Danilov and Koshevoy~\cite{DanilovKoshevoy} in a different context (see also~\cite[Ch.~4]{Gorodentsev2}).
Unlike the combinatorial $R$-matrix perspective, they do not have the natural interpretation of the weight since $\wt(\qq) = \wt\bigl( \Xi(\qq) \bigr)$, where the crystal weight is the usual tableaux weight.

Next, we describe how to interpret our action from looking at the corner transfer matrix described in~\cite{KMO15}, which can be given diagrammatically by
\[
\begin{tikzpicture}[>=latex,scale=0.5]
\draw[->] (0,1) node[anchor=east] {$\mathbf{b}_{\ell}$} -- (1,1) -- (1,8);
\foreach \x in {1,2} {
  \draw[->] (0,\x+1) node[anchor=east] {$\mathbf{b}_{\ell-\x}$} -- (\x+1,\x+1) -- (\x+1,8);
}
\foreach \x in {1,2,3} {
  \draw[->] (0,8-\x) node[anchor=east] {$\mathbf{b}_{\x}$} -- (8-\x,8-\x) -- (8-\x,8);
}
\node at (4,7.5) {$\cdots$};
\node at (0.5,4) {$\vdots$};
\end{tikzpicture}
\]
where every crossing is a combinatorial $R$-matrix and $\mathbf{b}_i \in B^{p_i,1}$.
Our action effectively does the following on the corner transfer matrix:
\[
\begin{tikzpicture}[>=latex,scale=0.5,baseline=50]
\draw[->] (0,1) node[anchor=east] {$\mathbf{b}_{\ell}$} -- (1,1) -- (1,7);
\draw[->] (0,6) node[anchor=east] {$\mathbf{b}_1$} -- (6,6) -- (6,7);
\draw[->] (-1,3) node[anchor=east] {$\mathbf{b}_i$} -- (0,4) -- (4,4) -- (4,7) -- (3,8);
\draw[->] (-1,4) node[anchor=east] {$\mathbf{b}_{i+1}$} -- (0,3) -- (3,3) -- (3,7) -- (4,8);
\node at (2,6.5) {$\cdots$};
\node at (0.5,2) {$\vdots$};
\node at (5,6.5) {$\cdots$};
\node at (0.5,5) {$\vdots$};
\end{tikzpicture}
\qquad = \qquad
\begin{tikzpicture}[>=latex,scale=0.5,baseline=50]
\draw[->] (0,1) node[anchor=east] {$\mathbf{b}_{\ell}$} -- (1,1) -- (1,7);
\draw[->] (0,6) node[anchor=east] {$\mathbf{b}_1$} -- (6,6) -- (6,7);
\draw[->] (0,4) node[anchor=east] {$\mathbf{b}_i$} -- (4,4) -- (4,7);
\draw[->] (0,3) node[anchor=east] {$\mathbf{b}_{i+1}$} -- (3,3) -- (3,7);
\node at (2,6.5) {$\cdots$};
\node at (0.5,2) {$\vdots$};
\node at (5,6.5) {$\cdots$};
\node at (0.5,5) {$\vdots$};
\end{tikzpicture}
\]
where the equality comes from applying the Yang--Baxter equation and $R^2 = \id$.

It could be interesting to see if our proof has any implications for the work of Danilov and Koshevoy~\cite{DanilovKoshevoy} or van Leeuwen~\cite{vanLeeuwen-dc}.






\appendix

%=====================================================================
\section{Connections with other constructions}
\label{app:queue-relations}

We describe how our definition of $q(u)$ (when $q$ is a queue and $u$ a word) is connected to the construction of~\cite{FM07}, which was coined bully paths in~\cite{AasLin17}, and the tableaux combinatorics of~\cite{AssSea18}.

To clarify the connection, we recall our visualization of a queue $q$ in~\eqref{eq:boxes-and-balls-1} by a row of circles and squares.
We modify this visualization slightly:
Namely, we still represent each $i \in q$ by a circle as in Example~\ref{ex:first_queue}, but we no longer represent the $i \notin q$ by squares.
We refer to the circles as ``boxes''.

\subsection{Connection with Ferrari--Martin and Aas--Linusson MLQs}

We first connect our MLQs with those from~\cite{FM07}.
We will use the language of~\cite{AasLin17}, where we are only considering ``discrete MLQs'' as we consider our ring to have a finite number of sites.

Consider a MLQ $\qq = (q_1, q_2, \dotsc, q_{\ell})$.
A \defn{labeling} of $\qq$ is a sequence of maps $\ff = (f_1, \dotsc, f_{\ell})$, where $f_i \colon q_i \to \ive{i}$.
We represent this by placing an $f_i(j)$, which we call the \defn{label}, inside of the circle corresponding to $j \in q_i$.
The \defn{canonical labeling} $\ff_{\qq}$ of $\qq$ is the labeling $(f_1, \dotsc, f_{\ell})$ defined by
\begin{equation}
f_k(j) = \bigl( q_k( \cdots q_1(1^n) \cdots ) \bigr)_j.
\label{eq.AasLin-lab.formula}
\end{equation}
For example, the labeling of each MLQ in Example~\ref{ex:merge_theorem} is precisely the circled values.
When $\qq$ is an ordinary MLQ, we can also construct this canonical labeling recursively as follows:
\begin{enumerate}
\item Set $q_0 = \emptyset$, and let $f_0 : q_0 \to \ive{0}$ be the trivial map.
\item For each $k = 0, 1, \ldots, \ell-1$:
\begin{itemize}
\item Suppose $f_k \colon q_k \to \ive{k}$ is already defined. Let $\tup{j_1, j_2, \ldots, j_r}$ be a list of all elements of $q_k$ in the order of increasing label in $f_k$; that is, $f_k(j_1) \leq f_k(j_2) \leq \cdots \leq f_k(j_r)$.
      (The relative order between elements with equal label is immaterial.)
\item For $i = i_1, i_2, \ldots, i_r$, do the following:
      Find the first site $j$ weakly to the right (cyclically) of $i$ such that $j \in q_{k+1}$ and $f_{k+1}(j)$ is not set; then set $f_{k+1}(j) = f_k(i)$.
\item For all sites $j \in q_{k+1}$ for which $f_{k+1}(j)$ is not set yet, set $f_{k+1}(j) = k+1$.
\end{itemize}
This defines $f_{k+1} \colon q_{k+1} \to \ive{k+1}$.
\end{enumerate}

\begin{verlong}
In order to see that this recursive construction yields the same labeling $\ff_\qq$ as the equality~\eqref{eq.AasLin-lab.formula}, we can proceed as follows:

If $r$ is a queue and $I$ is a set, then a \defn{labeling} of $r$ by $I$ means a map $f \colon r \to I$.
Of course, we refer to a value $f \tup{i}$ of such a labeling as the \defn{label} of $i$ in $f$.
To represent such a labeling $f$, we label each of the boxes of $r$ with its corresponding value (i.e., we label the box in position $i$ by $f\tup{i}$).
Thus, a labeling of an MLQ $\qq = (q_1, q_2, \dotsc, q_{\ell})$ is a sequence of labelings $f_i \colon q_i \to \ive{i}$ of each of its queues $q_i$; and its visual representation is obtained by stacking the visual representations of the $f_i$ one atop another.

Now, fix a $k \in \NN$ and two queues $r$ and $q$ with $\abs{r} \leq \abs{q}$. Also fix a labeling $f \colon r \to \ive{k}$ of $r$ by $\ive{k}$.
Then, we can define a labeling \defn{$q(f)$} of $q$ by $\ive{k+1}$ as follows:
\begin{enumerate}
\item Let $\tup{i_1, i_2, \ldots, i_{\abs{r}}}$ be a list of all elements of $r$ in the order of increasing label in $f$ (that is, $f(i_1) \leq f(i_2) \leq \cdots \leq f(i_{\abs{r}})$.
 (The relative order between elements with equal label is immaterial.)

\item Initialize a labeling $g$ of $q$ by $\ive{k+1}$. For now, none of its values is set.

\item For $i = i_1, i_2, \ldots, i_{\abs{r}}$, do the following.
    Find the first site $j$ weakly to the right (cyclically) of $i$ such that $j \in q$ and $g\tup{j}$ is not set.
    Then set $g\tup{j} = f\tup{i}$.

\item For all sites $j \in q$ for which $g \tup{j}$ is not set yet, set $g \tup{j} = k+1$.

\item Define $q(f)$ to be the resulting labeling $g$.
\end{enumerate}

The connection between this labeling and the action of queues on words is simple.
Indeed, let $k \in \NN$, let $r$ be a queue, and let $f \colon r \to \ive{k}$ be a labeling.
Then we can can assign to $f$ a word $\omega_k f \in \mcW_n$ as follows:
For each $j \in r$, we set $\tup{\omega_k f}_j = f \tup{j}$.
All other letters of $\omega_k f$ shall be $k+1$.
Now, it is easy to see that if $q$ is a queue satisfying $\abs{r} \leq \abs{q}$, then
\begin{equation}
q \tup{ \omega_k f } = \omega_{k+1} \tup{ q(f) } .
\label{eq.AasLin-lab.two-actions}
\end{equation}
Thus, the action of a queue on a labeling can be computed in terms of its action on a word.
(The converse is not true, since the condition $\abs{r} \leq \abs{q}$ is restrictive.
Thus, our action of queues on words, with its two phases, is more general than their
action on labelings.)

Now, let $\qq = (q_1, q_2, \dotsc, q_{\ell})$ be an ordinary MLQ
(so that $\abs{q_1} \leq \abs{q_2} \leq \cdots \leq \abs{q_{\ell}}$),
and consider the labeling $\ff_\qq = (f_1, \dotsc, f_{\ell})$ constructed by the above recursive procedure
(not by~\eqref{eq.AasLin-lab.formula}).
Then, the recursive procedure clearly yields
\begin{align*}
f_i &= q_i \tup{ f_{i-1} } \qquad \text{for all } i \in \ive{\ell} ,
\end{align*}
where $f_0$ is understood to be the (trivial) labeling of the empty queue $\varnothing$.
In view of~\eqref{eq.AasLin-lab.two-actions}, this entails
\[
\omega_i \tup{ f_i } = q_i \tup{ \omega_{i-1} \tup{ f_{i-1} } } \qquad \text{for all } i \in \ive{\ell} .
\]
Thus, by induction,
\[
\omega_i \tup{ f_i } = q_i( \cdots q_1(1^n) \cdots )
 \qquad \text{for all } i \in \set{0, 1, \dotsc, \ell}
\]
(since $\omega_0 \tup{ f_0 } = 1^n$).
Hence,
\[
f_i(j) = \bigl( q_i( \cdots q_1(1^n) \cdots ) \bigr)_j
 \qquad \text{for all } i \in \set{0, 1, \dotsc, \ell}
        \text{ and } j \in q_i .
\]
But this is precisely the equality~\eqref{eq.AasLin-lab.formula}.
Hence, we have shown that the recursive construction yields the same labeling $\ff_\qq$ as the equality~\eqref{eq.AasLin-lab.formula}.
\end{verlong}

Now consider the labeling procedure in~\cite[\S 2.2]{AasLin17} given by \defn{$k$-bully paths}.
Note that a $k$-bully path from one line to the next precisely corresponds to the path of a letter $k$ under Phase~II of our definition of a queue as a function on words.
For example, the bully paths would correspond to the blue paths in Example~\ref{ex:first_queue}.
In addition, this is exactly the recursive labeling procedure given above.
Thus, we obtain the labeling $\ff_{\qq}$ is equivalently constructed following the labeling procedure of~\cite{AasLin17}.

\Darij{I find the above paragraph vague and unclear, but I have a verlong argument anyway.}

\Darij{TODO: Connect this with parking functions?}

\subsection{Connection with Kohnert diagrams and Assaf--Searles theory}

Next we relate the action of queues on words with the \defn{Kohnert fillings} in~\cite[Def.~2.5]{AssSea18} and the \defn{thread decomposition} in~\cite[Def.~3.5]{AssSea18}.
We remark that the thread decomposition is the same as the Kohnert filling procedure when the shape is an antipartition (\textit{i.e.} a weakly increasing sequence of positive integers).
Roughly speaking, a Kohnert filling (and a thread decomposition) is a standardization of the bully path construction.

In more detail, for a Kohnert diagram $D \in \KM(\alpha)$ for any fixed weak composition $\alpha$ (see~\cite{AssSea18} for notations), we view its columns as queues.
This time, our queues are subsets of $\NN$ (or $\ZZ$) instead of $\ZZ/n\ZZ$; thus, there is no ``wrapping around''.
We consider the reflection of $D$ across the line $x = y$ as an MLQ $\qq_D = (q_1, \dotsc, q_{\ell})$: namely, a cell in row $i$  and column $j$ in the reflected diagram corresponds to a $j \in q_i$.
We then apply the bully path construction to the boxes of this reflected Kohnert diagram.
To obtain the thread decomposition we need to distinguish paths with a fixed label such that these paths are also constructed by the bully path algorithm, where we consider the labels to be decreasing from left to right.
Hence, this can be considered as a standardization of our construction or, equivalently, as fixing specific permutations for how the queues act on words.

Note that the distinction between $\NN$ and $\ZZ/n\ZZ$ never arises since, for $\qq_D$ and all $i$, we have
\[
\abs{\set{ j \in q_i \mid j \geq k }} \leq \abs{\set{  j \in q_{i+1} \mid j \geq k }},
\]
which means we can apply~\cite[Lemma~2.2]{AssSea18} to see that there is no ``wrapping'' around the cylinder.

To obtain a Kohnert filling from a Kohnert diagram of height $K$ (for this, we require $n \gg 1$), we can construct an MLQ
\[
\widetilde{\qq}_D = (\widetilde{q}_1, \widetilde{q}_2, \dotsc, \widetilde{q}_{\widetilde{\ell}}, q_1, q_2, \dotsc, q_{\ell})
\]
from the MLQ $\qq_D = (q_1, q_2, \dotsc, q_{\ell})$ to obtain the correct labelings.
Indeed, a label added in column $i$ comes from a $k \in q$ with $k > K$ for sufficiently many queues $q$ before $q_i$.
We then only consider the labels in the regime $k \in q_i$ for all $1 \leq k \leq K$ and all $1 \leq i \leq \ell$.
We leave the precise details for the interested reader.

\Travis{Is it worthwhile to be more formal about this? It isn't too hard, but it is a lot of annoying bookkeeping.}

\Darij{I find this part quite hard to follow, but so is everything about Kohnert diagrams.}

\begin{comment}
In more detail, let us replace $\ZZ / n \ZZ$ by $\NN$ everywhere in the above definitions.
So a queue is now a finite subset of $\NN$.
In the above definition of the labeling $q(f)$, we must replace the ``$\abs{r} \leq \abs{q}$'' requirement by the stronger requirement that every $k \in \NN$ satisfy
\begin{equation}
\label{eq:queue-relations.kohnert}
\abs{\set{ j \in r \mid j \geq k }} \leq \abs{\set{  j \in q \mid j \geq k }} .
\end{equation}
This stronger requirement can be shown to guarantee that $q(f)$ is well-defined (\textit{i.e.}, the ``find the first site $j$'' step in the construction will never fail to find a $j$).
It is, actually, necessary and sufficient.

TODO: Should we prove this? Not quite trivial.

Given a Kohnert diagram $D \in \KM(a)$ (see~\cite{AssSea18} for notations), we can view its columns as queues, and then we can recursively label them from right to left by starting with the trivial labeling of the empty queue and applying each column-queue to find a labeling for the next column to its left.
(\textit{I.e.}, if $f_{j+1}$ is the labeling of column $j+1$, then the labeling of column $j$ is $q_j (f_{j+1})$, where $q_j$ is the queue that describes column $j$.
To see that this is well-defined, we need merely to observe that~\eqref{eq:queue-relations.kohnert} holds by~\cite[Lemma 2.2]{AssSea18}.)
The resulting labeling is similar to (but different from) the Kohnert labeling in~\cite[Def.~2.5]{AssSea18}. It is also related to the ``thread decomposition'' in~\cite[Def.~3.5]{AssSea18} (indeed, all cells in a single thread will receive identical labels in the labeling).
\end{comment}












%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{verlong}
%=====================================================================
\section{Appendix: Old proof of Theorem~\ref{thm:permutation}}
\label{sec:thm_proof-old6}

This section contains a previous proof of Theorem~\ref{thm:permutation}.
This proof uses similar ideas to the proof given in Section~\ref{sec:thm_proof} above,
but differs in its details (in particular, it defines the dual configuration
in a different way, although the two definitions can be shown to be equivalent).

We need some definitions first.

An \defn{$(r_1,r_2)$-configuration} shall mean a pair $C = (q_1, q_2)$, where $q_1$ is an $r_1$-queue and $q_2$ is an $r_2$-queue.
As usual, we consider $C$ as a function on words by $C(u) := q_2\bigr(q_1(u)\bigr)$, and we define the weight of $C$ by $\wt(C) := \wt(q_1) \wt(q_2)$.
We construct the \defn{dual}\footnote{This is a different duality than the contragredient duality of Lemma~\ref{le:dual}.} $(r_2,r_1)$-configuration to $C$, which we denote by $C'$, as follows.

We first consider the case $r_1 = r_2$, in which case we define $C' = C$.
Thus, assume $r_1 \neq r_2$.

For any two sites $i$ and $j$, let $\inter[i,j]$ denote a closed (cyclic) interval from $i$ to $j$.
This is the set $\set{i, i+1, \ldots, j}$ when $i \leq j$ and the set $\set{i, i+1, \ldots, n, 1, 2, \ldots, j}$ when $i > j$.\footnote{We trivially consider an empty interval to be balanced, and note that if $j = i-1$, then $\inter[i,j] = \ive{n}$.}
Let $c^{\uparrow}[i,j]$ (resp.~$c^{\downarrow}[i,j]$) denote the number of $\ell \in \inter[i,j]$ such that $\ell \in q_1$ (resp.~$\ell \in q_2$).

We say that a closed cyclic interval $\inter[i,j]$ is \defn{balanced} if $c^{\uparrow}[i,j] = c^{\downarrow}[i,j]$ and for each $k \in \inter[i,j]$, we have $c^\uparrow[i,k] \geq c^\downarrow[i,k]$.
Equivalently, $\inter[i,j]$ is balanced if and only if $c^{\downarrow}[i,j] = c^{\uparrow}[i,j]$ and for each $k \in \inter[i,j]$, we have $c^\downarrow[k,j] \geq c^\uparrow[k,j]$.
A set $S$ of sites is \defn{balanced} if it is a disjoint union of balanced intervals.
For $i \in \ive{n}$, we say that $i$ is \defn{balanced} if $i$ belongs to some balanced interval, and \defn{unbalanced} otherwise.

The following facts are straightforward:
\begin{enumerate}
 \item For any balanced interval $\mcI$, we have $\lvert q_1 \cap \mcI \rvert = \lvert q_2 \cap \mcI \rvert$.
 \item The empty interval is balanced.
 \item The set $\ive{n}$ of all sites is not balanced, since $r_1 \neq r_2$.
 \item If $A$ and $B$ are two balanced sets, then the set $A \cap B$
       is balanced.\footnote{To prove this, first check it when $A$ and $B$
       are balanced intervals.}
 \item If $A$ and $B$ are balanced intervals, and if $A \cup B$ is an
       interval, then $A \cup B$ is balanced.\footnote{This is obvious
       when one of $A$ and $B$ contains the other. Otherwise, argue
       that $A \cap B$, $A \setminus B$ and $B \setminus A$ are balanced.}
 \item Thus, the union of all balanced intervals (\textit{i.e.}, the set of all balanced
       $i \in \ive{n}$) is also the disjoint union of all maximal balanced intervals
       (where ``maximal'' means ``maximal under inclusion'').
 \item For $r_1 < r_2$ and $j \in \ive{n}$ unbalanced, we have $j \notin q_1$ and $j \in q_2$.
 \item For $r_1 > r_2$ and $j \in \ive{n}$ unbalanced, we have $j \in q_1$ and $j \notin q_2$.
 \item There are exactly $\abs{r_1 - r_2}$ unbalanced sites $i$.
\end{enumerate}

We construct $C' = (q'_1, q'_2)$ by letting $q'_i \cap \mcI = q_i \cap \mcI$ for $i=1,2$ and each balanced interval $\mcI$ of $C$.
For unbalanced $j$, we have $j \in q'_i$ if and only if $j \in q_{3-i}$ for $i = 1,2$.
Note that $C$ and $C'$ have the same balanced intervals.
It is clear that $C'' = C$ and $\wt(C) = \wt(C')$.

(We could adapt this construction to the case $r_1 = r_2$, but we would need to be more precise about defining intervals, since the set of all sites can be written as $\inter[i, i-1]$ for any value of $i$. If done correctly, this results in every $i \in \ive{n}$ being balanced when $r_1 = r_2$, and thus the construction yields $C' = C$ as we defined.)

\begin{example}
Consider the configuration $C$ given in Figure~\ref{fig:balanced}.
The dual configuration $C'$ is given by sliding all of the circles not boxed from the upper level to the lower level.
In particular, we have $q_1' = q_1 \setminus \{1,5,6,8\}$ and $q_2' = q_2 \cup \{1,5,6,8\}$.
\end{example}

\begin{figure}[t]
\[
\begin{tikzpicture}[scale=0.75]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \draw[fill=blue!30] (1.5*\sc,\l-.5) rectangle(4.5*\sc,\ll+.5);
  \draw[fill=blue!30] (6.5*\sc,\l-.5) rectangle(7.5*\sc,\ll+.5);
  \draw[fill=blue!30] (8.5*\sc,\l-.5) rectangle(20.5*\sc,\ll+.5);
  \foreach \i in {1,2,5,6,8,11,13,14,17,18,19} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {3,4,7,9,10,12,15,16,20} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {2,12,15,16,18,19,20} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,3,4,5,6,7,8,9,10,11,13,14,17} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
\end{tikzpicture}
\]
\caption{We draw a $\bigcirc$ in position $i$ in row $j$ corresponding to $i \in q_j$ and a $\square$ if $i \notin q_j$.
The maximal balanced intervals are boxed.}
\label{fig:balanced-old6}
\end{figure}

Recall the notations introduced just before Lemma~\ref{le:dual}.

\begin{remark}
\label{rmk:balanced-dual-let-old6}
Let $C = (q_1, q_2)$ be an $(r_1, r_2)$-configuration.
Then, the interval $\mcI$ of $C$ is balanced if and only if the interval $\mcI^{\operatorname{refl}} = \set{ n + 1 - i \mid i \in \mcI }$ of the $(n-r_1, n-r_2)$-configuration $C^* = (q_1^*, q_2^*)$ is balanced.
In other words, the balanced intervals of $C$ are exactly the balanced intervals of $C^*$ but reflected through the middle of $\ive{n}$.
Thus, the dual configuration of $C^* = \tup{q_1^*, q_2^*}$ is obtained from the dual configuration $\tup{q_1', q_2'}$ of $C$ by
\begin{equation}
 (C^*)' = \bigl( (q_1')^*, (q_2')^* \bigr) .
 \label{eq.rmk:balanced-dual-let.dual-old6}
\end{equation}
In addition, applying Lemma~\ref{le:dual} twice, we obtain
\[
C(u) = q_2\bigl( q_1(u) \bigr) = q_2\bigl( (q^*_1(u^*))^* \bigr) = \bigl( q_2^*\bigl( q_1^*(u^*) \bigr) \bigr)^* = \bigl( C^*(u^*) \bigr)^* .
\]
In particular, for $u \in \set{1,2}^n$, we have $C(u)_i = 5 - C^*(u^*)_{n+1-i}$, where we treat $u$ and $C^*(u^*)$ as a word with $2$ and $4$ classes, respectively.
\end{remark}

Fix $k \geq 1$.
In the following, we simplify our terminology and say that an MLQ
is a $k$-tuple of queues (without any restriction on their sizes).
We want to define an action of $\SymGp{k}$ on MLQs.
%by letting each simple transposition $s_i$ act as the map
For each $i \in \ive{k-1}$, we define a map $\fraks_i \colon \set{\text{MLQs}} \to \set{\text{MLQs}}$ by
\[
\fraks_i(q_1, q_2, \dotsc, q_k) = (q_1, \dotsc, q_{i-1}, q'_i, q'_{i+1}, q_{i+2}, \dotsc, q_k),
\]
where $\tup{q'_i, q'_{i+1}}$ is the dual configuration of $\tup{q_i, q_{i+1}}$.
From the definition of a dual configuration, it is clear that $\fraks_i \fraks_i \qq = \qq$.
It is also clear from the definition that $\fraks_i \fraks_j \qq = \fraks_j \fraks_i \qq$ if $\abs{i - j} > 1$.
Thus, the following proposition shows that $\fraks_i$ defines an action of $\SymGp{k}$ on the set of all MLQs.

\begin{prop} \label{prop:braid-old6}
We have
\[
\fraks_i \fraks_{i+1} \fraks_i \qq
	   = \fraks_{i+1} \fraks_i \fraks_{i+1} \qq
\]
for any MLQ $\qq = \tup{q_1, \dotsc, q_k}$ and any $i \in \set{1, 2, \ldots, k-2}$.
\end{prop}

\begin{proof}
We shall deduce the claim from~\cite[Ch.~5, (5.6.3)]{Loth}.

Let $A$ be the $\tup{k+1}$-element set $\set{\circ, 1, 2, \ldots, k}$.
Let $A^*$ denote the set of all words on the alphabet $A$
(of any finite length).

We construct a $k \times n$-matrix $M_{\qq} \in A^{k \times n}$ from $\qq$ by setting the $\tup{i, j}$-th
entry to $i$ if $j \in q_i$ and $\circ$ otherwise.
We then construct a word $\word(\qq) \in A^*$ by reading $M_{\qq}$ from top-to-bottom, left-to-right (\textit{i.e.}, column by column).
For example, if $n = 5$, $k = 3$, then
\begin{align*}
\qq = \tup{\set{1, 3}, \set{2},
\set{2, 5}}
& \longleftrightarrow
 M_{\qq}
 =
 \begin{array}{ccccc}
  1 & \circ & 1 & \circ & \circ \\
  \circ & 2 & \circ  & \circ & \circ \\
  \circ & 3  & \circ & \circ & 3
 \end{array}
 \\ & \longrightarrow
 \word(\qq) = 1 \circ \circ \circ 2 3 1 \circ \circ \circ \circ \circ \circ \circ 3 .
\end{align*}
Clearly, an MLQ $\qq$ is uniquely determined by $\word(\qq)$ since $n$ is fixed.
In other words, the map $\word \colon \set{\text{MLQs}} \to A^*$
is injective.

Now, for each $i \in \set{1, 2, \ldots, k-1}$, we recall the operator
$\sigma_i \colon A^* \to A^*$ from~\cite[\S5.5]{Loth}.
This operator $\sigma_i$ acts on a word $p \in A^*$ % = \tup{p_1, p_2, \ldots, p_\ell}$
as follows:
\begin{enumerate}
 \item Treat all letters $i$ in $p$ as opening parentheses `$($',
       all letters $i+1$ as closing parentheses `$)$',
       and consider all other letters to be frozen.
       Now, match as many parentheses as possible
       according to the standard parenthesis-matching
       algorithm (\textit{i.e.}, every time you find an opening
       parenthesis to the left of a closing one, with only
       frozen letters between them, you match these two
       parentheses and declare them frozen).
       Notice that this algorithm is non-deterministic, but
       the outcome is independent of the steps chosen;
       the result is always a word whose non-frozen
       part (\textit{i.e.}, the word obtained by removing
       all frozen letters) is
       $\underbrace{))\cdots)}_{a\text{ parentheses}}
       \underbrace{((\cdots(}_{b\text{ parentheses}}$
       for some integers $a, b \geq 0$.
       We call this the \defn{reduced signature} of $p$.
 \item Now, replace this non-frozen part by
       $\underbrace{))\cdots)}_{b\text{ parentheses}}
       \underbrace{((\cdots(}_{a\text{ parentheses}}$
       while keeping all frozen letters in their places.
       The resulting word is $\sigma_i p$.
\end{enumerate}
From~\cite[Eq.~(5.6.3)]{Loth}, these operators
$\sigma_i$ satisfy
\begin{equation}
 \sigma_i \sigma_{i+1} \sigma_i
 = \sigma_{i+1} \sigma_i \sigma_{i+1}
 \label{pf.prop:braid.loth-eq-old6}
\end{equation}
for all $i \in \set{1, 2, \ldots, k-2}$.

Let $\zeta \colon \mcW_n \to \mcW_n$ be the cyclic shift map that sends each word $w_1 w_2 \cdots w_n$ to $w_2 w_3 \cdots w_n w_1$.
We also abuse the notation $\zeta$ for the map that sends each queue $q$ to the queue $\zeta q = \set{ i - 1 \mid i \in q }$ (recall that $0 = n$ as sites).
This map $\zeta$ shall act on MLQs entrywise (since an MLQ is a tuple of queues).
Clearly,
\begin{equation}
 \word(\zeta \qq) = \zeta^k \word(\qq)
 \label{pf.prop:braid.word-zeta-old6}
\end{equation}
for any MLQ $\qq = (q_1, \ldots, q_k)$.

Now, we claim that
\begin{equation}
 \word(\fraks_i \qq) = \sigma_i\bigl( \word(\qq) \bigr)
 \qquad \text{ for each MLQ } \qq \text{ and each } i .
 \label{pf.prop:braid.inter-old6}
\end{equation}
Note that it is sufficient to show that $\word(\fraks_1 \qq) = \sigma_1\bigl( \word(\qq) \bigr)$ for $\qq = (q_1, q_2)$
(because the definition of $\sigma_i$ only relies on the letters $i$ and $i+1$, while all other letters stay in their places and have no effect).

Thus, let $\qq = (q_1, q_2)$.
We want to show $\word(\fraks_1 \qq) = \sigma_1\bigl( \word(\qq) \bigr)$.
If $\abs{q_1} = \abs{q_2}$, then $\fraks_1 \qq = \qq$ by the definition of $\fraks_1$.
Moreover, we have $\sigma_1\bigl( \word(\qq) \bigr) = \word(\qq)$ in this case, since the word $\word(\qq)$ has as many letters $1$ as it has letters $2$, but the map $\sigma_1$ leaves such words unchanged.
Hence, the claim holds when $\abs{q_1} = \abs{q_2}$.
Thus, we assume that $\abs{q_1} \neq \abs{q_2}$.
Therefore, there exists at least one unbalanced site for the configuration $\qq = (q_1, q_2)$.

The operator $\fraks_1$ commutes with the cyclic shift map $\zeta$ on MLQs because $\zeta$ merely shifts the balanced intervals.
The operator $\sigma_1$ commutes with the cyclic shift map $\zeta$ on words in $A^*$ by~\cite[Prop.~5.6.1]{Loth}.
Hence, and because of~\eqref{pf.prop:braid.word-zeta-old6}, we can apply $\zeta$ to $\qq$ any number of times without loss of generality.
Thus, we assume that the site $1$ is unbalanced for the configuration $\qq = (q_1, q_2)$, since at least one unbalanced site $j$ exists and we can cyclically shift until it is $1$.
Therefore, no balanced interval has the form $\inter[i,j]$ with $i > j$.

We construct a sequence of parentheses as follows: For each $j = 1, 2, \dotsc, n$ (in that order), we write
\begin{itemize}
\item an opening parenthesis `$($' if $j \in q_1$ and $j \notin q_2$,
\item a closing parenthesis `$)$' if $j \notin q_1$ and $j \in q_2$,
\item a matched pair of parentheses `$()$' if $j \in q_1$ and $j \in q_2$,
\item nothing otherwise.
\end{itemize}
Note that this is exactly the sequence of parentheses constructed when applying $\sigma_1$ to $\word(\qq)$ (removing all $\circ$ letters).
Furthermore, every `$($' and `$)$' corresponds to a contribution to $c^{\uparrow}[1,n]$ and $c^{\downarrow}[1,n]$, respectively.
Additionally, every matched pair of parentheses from sites $j \leq j'$ under the standard matching algorithm corresponds to the endpoints of a balanced interval $\inter[j,j']$. (This is easily proven by induction on the time at which the parentheses got matched: At this time, all the parentheses inbetween have already been matched, thus forming balanced intervals, and the newly matched pair merely wraps them in a bigger balanced interval.)
% [Darij: The following is vague.] Since matched parentheses (resp.\ balanced intervals) do not change under $\sigma_1$ (resp.~$\fraks_1$), we can consider $w$ (resp.\ $\qq$) such that there are no matched parentheses (resp.\ balanced intervals that are subintervals of $\inter[1,n]$).
Thus, if the algorithm would leave both a `$)$' and a `$($' unmatched, then the (cyclic) interval between the rightmost unmatched `$)$' and the leftmost unmatched `$($' would also be a balanced interval, which would contradict the fact that no balanced interval has the form $\inter[i,j]$ with $i > j$.
Consequently, the algorithm either leaves only `$)$' parentheses unmatched, or leaves only `$($' parentheses unmatched.
The precise outcome depends on which of $\abs{q_1}$ and $\abs{q_2}$ is larger.
Consequently, the sites of the unmatched parentheses are precisely the unbalanced sites.

Now, recall that $\fraks_1$ merely toggles the unbalanced sites between $q_1$ and $q_2$, whereas $\sigma_1$ switches the number of unmatched `$)$'s with the number of unmatched `$($'s (which, in the case of $\word(\qq)$, boils down to just turning each unmatched `$)$' into a `$($' or vice versa, because one of the numbers is $0$). Since the sites of the unmatched parentheses are precisely the unbalanced sites, this shows that the two maps agree -- that is, we have $\word(\fraks_1 \qq) = \sigma_1\bigl( \word(\qq) \bigr)$. This proves~\eqref{pf.prop:braid.inter-old6}.

The equality~\eqref{pf.prop:braid.inter-old6} can be rewritten as the
commutative diagram
\[
\xymatrix{
 \set{\text{MLQs}} \ar[r]^{\fraks_i} \ar[d]_{\word} & \set{\text{MLQs}} \ar[d]^{\word} \\
 A^* \ar[r]_{\sigma_i} & A^*
}
\]
for all $i \in \set{1, 2, \dotsc, k-1}$.
In view of the injectivity of the map $\word \colon \set{\text{MLQs}} \to A^*$,
this diagram allows us to translate~\eqref{pf.prop:braid.loth-eq-old6} into
$\fraks_i \fraks_{i+1} \fraks_i = \fraks_{i+1} \fraks_i \fraks_{i+1}$.
\end{proof}

\begin{remark}
Our letters $1, \ldots, k$ correspond to the letters
$a_k, \ldots, a_1$ in~\cite{Loth},
since the definition of $\sigma_i$ in~\cite{Loth} involves $a_i$ rather
than $i+1$ as closing parenthesis and $a_{i+1}$ rather than $i$ as opening one.
Also,~\cite{Loth} does not include the letter $\circ$ in the alphabet,
but this makes no difference to the proof, since all letters $\circ$ are always frozen.
% Note that we have arbitrarily chosen to break our cycle at $n$,
% however by~\cite[Prop.~5.6.1]{Loth}, the result does not depend on this choice.
\end{remark}

\begin{remark}
The operator $\sigma_i$ is essentially a combination of co-plactic operators.
Moreover, it corresponds to the Weyl group action on a tensor product of crystals~\cite{BS17}.
Note that the bracketing rule given above is precisely the usual signature rule (see, \textit{e.g.},~\cite[Sec.~2.4]{BS17} for a description) for computing tensor products.
This arises from considering the MLQ as a binary $m \times n$ matrix and the natural $(\mathfrak{sl}_m \oplus \mathfrak{sl}_n)$-action.
\end{remark}

Next, we define two queues corresponding to a word $w \in \mcW_n$ of type $\mm$.
Namely, for $k \in \set{p_i(\mm) \mid i \geq 0}$, let $[w]_k$ denote the set of the indices $i \in \ive{n}$
corresponding to the $k$ smallest letters $w_i$ of $w$.

The crucial tools in our proof of Theorem~\ref{thm:permutation} will be the following two facts.

\begin{lemma} \label{lem:SL.reconstruct-old6}
Let $w, w' \in \mcW_n$ be two words of the same type $\mm$.
Assume that $[w]_k = [w']_k$ for each $k \in \set{p_i(\mm) \mid i \geq 0}$.
Then, $w = w'$.
\end{lemma}

\begin{proof}
Fix some $i \geq 1$.
The sites containing the letter $i$ in $w$ are the elements of $[w]_{p_i(\mm)} \setminus [w]_{p_{i-1}(\mm)}$
(since $w$ has type $\mm$).
Likewise,
the sites containing the letter $i$ in $w'$ are the elements of $[w']_{p_i(\mm)} \setminus [w']_{p_{i-1}(\mm)}$.
Since our assumption ($[w]_k = [w']_k$) yields $[w]_{p_i(\mm)} \setminus [w]_{p_{i-1}(\mm)}
= [w']_{p_i(\mm)} \setminus [w']_{p_{i-1}(\mm)}$, %\travis{FYI: still fighting us.},
we conclude that these are the same sites.
Since this holds for all letters $i$, we have $w = w'$.
\end{proof}

\begin{prop} \label{prop:SL.dual-old6}
Let $u \in \mcW_n$ be a word of type $\mm$.
Let $k = p_{\alpha}(\mm)$ for some $\alpha$.
Let $q$ be a queue.
The dual configuration of $\tup{ [u]_k , q }$ has the form $\tup{q^{\dagger} , [q(u)]_k }$, where $q^{\dagger}$ is some queue.
\end{prop}

\begin{proof} %[Proof of Proposition~\ref{prop:SL.dual-old6}.]
Let $C' = (q'_1, q'_2)$ denote the dual configuration of $C = \tup{ [u]_k , q }$.
The notations $c^{\uparrow}$ and $c^{\downarrow}$ as well as the concept of balanced
intervals shall refer to $C$.

Choose a permutation $\tup{i_1, i_2, \ldots, i_n}$ of $\tup{1, 2, \ldots, n}$
such that $u_{i_1} \leq u_{i_2} \leq \cdots \leq u_{i_n}$.
Use this permutation to construct $q(u)$ (as in the definition of $q(u)$).
For each $p \in \ive{n}$, let $j_p$ be the site $j$ that is found in this construction when $i = i_p$.
%\Darij{We might want a more formal way to refer to this site $j$. ``Landing site''?}
Thus, $j_p \in q$ if $p \leq \abs{q}$, whereas $j_p \notin q$ if $p > \abs{q}$.
Also, $q(u)_{j_1} \leq q(u)_{j_2} \leq \cdots \leq q(u)_{j_n}$, so that
$[q(u)]_k = \set{j_1, j_2, \ldots, j_k}$ for each $k$ for which $[q(u)]_k$ is well-defined.

We want to prove that $(q'_1, q'_2)$ has the form $\tup{q^{\dagger} , [q(u)]_k }$.
In other words, we want to prove that $q'_2 = [q(u)]_k$.
If $k = \abs{q}$, then this is obvious (because in this case, the two queues in the configuration $C$ have the same size, so that its dual configuration $C'$ equals $C$, and thus $q'_2 = q$; but the assumption $k = \abs{q}$ also yields $[q(u)]_k = q$ because of the construction of $q(u)$, and therefore we obtain $q'_2 = q = [q(u)]_k$).

Suppose next that $k < \abs{q}$.
Thus, each site in $[u]_k$ is balanced.
But $[u]_k = \set{i_1, i_2, \ldots, i_k}$ by the definition of the permutation.

If $S$ is a set of sites, then the \defn{connected components} of $S$ are the maximal intervals contained in $S$.

We say that a closed cyclic interval $\inter[i,j]$ is \defn{top-heavy} if for each $\ell \in \inter[i,j]$, we have $c^\uparrow[i,\ell] \geq c^\downarrow[i,\ell]$.
Thus, a balanced cyclic interval is just a top-heavy cyclic interval $\inter[i,j]$ satisfying $c^{\uparrow}[i,j] = c^{\downarrow}[i,j]$.
% A set of sites will be called \defn{top-heavy} if each of its connected components is top-heavy.

For each $p \in \ive{k}$, we define an interval $I_p$ by $I_p = \inter[i_p, j_p]$.

We first observe that $I_p \cap q \subseteq \set{j_1, j_2, \ldots, j_p}$
for each $p \in \ive{k}$.
[\textit{Proof.} Let $p \in \ive{k}$.
Recall that the site $j_p$ is found
(in Phase~II of the algorithm computing $q(u)$) as the first site $j \in q$ weakly to the right of $i_p$ such that $q(u)_j$ is not set yet.
In other words, $j_p$ is the first site $j \in q$ weakly to the right of $i_p$ that is not one of $j_1, j_2, \ldots, j_{p-1}$
(since the sites $j \in q$ such that $q(u)_j$ has already been set are $j_1, j_2, \ldots, j_{p-1}$).
In other words, all sites in $I_p = \inter[i_p, j_p]$ that belong to $q$ must be among $j_1, j_2, \ldots, j_{p-1}, j_p$.
In other words, $I_p \cap q \subseteq \set{j_1, j_2, \ldots, j_p}$, qed.]

Let $U = I_1 \cup I_2 \cup \cdots \cup I_k$.
Then, $U \cap q \subseteq \set{j_1, j_2, \ldots, j_k}$ (since $I_p \cap q \subseteq \set{j_1, j_2, \ldots, j_p}$ for each $p \in \ive{k}$).
Combining this with $\set{j_1, j_2, \ldots, j_k} \subseteq U \cap q$ (since each $j_p$ satisfies $j_p \in I_p \subseteq U$ and $j_p \in \set{j_1, j_2, \ldots, j_{\abs{q}}} = q$),
we obtain $U \cap q = \set{j_1, j_2, \ldots, j_k}$.

If we had $U = \ive{n}$, then this would rewrite as $q = \set{j_1, j_2, \ldots, j_k}$, which would entail $\abs{q} = k$; this would contradict $k < \abs{q}$.
Hence, $U \neq \ive{n}$.

Each connected component of the set $U$ is top-heavy.
[\textit{Proof.} Let $\inter[a,b]$ be a connected component of $U$. Then, we must prove that $\inter[a,b]$ is top-heavy.
Indeed, since $U$ is the union of the connected intervals $I_1, I_2, \ldots, I_k$, its connected component $\inter[a,b]$ must have the form $\inter[a,b] = \bigcup_{p \in R} I_p$ for some nonempty subset $R$ of $\ive{k}$, and be disjoint from all the $I_p$ with $p \notin R$. Consider this $R$.
Thus, $\inter[a,b] \cap \set{i_1, i_2, \ldots, i_k} = \set{i_p \mid p \in R}$ (indeed, $\inter[a,b] = \bigcup_{p \in R} I_p$ shows that all of the $i_p$ with $p \in R$ must lie in $\inter[a,b] \cap \set{i_1, i_2, \ldots, i_k}$; on the other hand, none of the remaining elements of $\set{i_1, i_2, \ldots, i_k}$ can belong to $\inter[a,b]$, since $\inter[a,b]$ is disjoint from all the $I_p$ with $p \notin R$).
Likewise, $\inter[a,b] \cap \set{j_1, j_2, \ldots, j_k} = \set{j_p \mid p \in R}$.
From $[u]_k = \set{i_1, i_2, \ldots, i_k}$, we obtain
\[
\inter[a,b] \cap [u]_k = \inter[a,b] \cap \set{i_1, i_2, \ldots, i_k} = \set{i_p \mid p \in R} .
\]
From $\inter[a,b] \subseteq U$, we obtain
\[
\inter[a,b] \cap q = \inter[a,b] \cap \underbrace{U \cap q}_{= \set{j_1, j_2, \ldots, j_k}}
= \inter[a,b] \cap \set{j_1, j_2, \ldots, j_k} = \set{j_p \mid p \in R} .
\]
Thus, for each $\ell \in \inter[a,b]$, the number $c^\uparrow[a,\ell] = \abs{\inter[a,\ell] \cap [u]_k}$ counts all of the $i_p$ with $p \in R$ that fall into the interval $\inter[a,\ell]$, while the number $c^\downarrow[a,\ell] = \abs{\inter[a,\ell] \cap q}$ counts all of the $j_p$ with $p \in R$ that fall into this interval.
Hence, the former number is at least as large as the latter number (because if $p \in R$ is such that $j_p$ falls into $\inter[a,\ell]$, then $i_p$ must also fall into $\inter[a,\ell]$\footnote{In fact, let $p \in R$ be such that $j_p \in \inter[a,\ell]$. But $\inter[i_p,j_p] = I_p$ is a subinterval of $\inter[a,b]$, due to $\inter[a,b] = \bigcup_{p \in R} I_p$. The interval $\inter[a,\ell]$ is a ``prefix'' of $\inter[a,b]$; thus, every subinterval of $\inter[a,\ell]$ that ends inside $\inter[a,\ell]$ must also begin inside $\inter[a,\ell]$. Applying this to the subinterval $\inter[i_p, j_p]$, we conclude that $i_p \in \inter[a,\ell]$, as we wanted to show. Here, we have tacitly used the fact that $\inter[a,b] \neq \ive{n}$, which follows from $\inter[a,b] \subseteq U \neq \ive{n}$.}).
We have thus proven that for each $\ell \in \inter[i,j]$, we have $c^\uparrow[a,\ell] \geq c^\downarrow[a,\ell]$. In other words, the interval $\inter[a,b]$ is top-heavy, qed.]

Consider again the connected components of $U$. Each of them is top-heavy (as we have just shown), and thus contains at least as many elements of $[u]_k$ as it contains elements of $q$. Hence, the set $U$ altogether contains at least as many elements of $[u]_k$ as it contains elements of $q$, and this inequality becomes an equality only if each connected component of $U$ is balanced.
But this inequality does become an equality, because the set $U$ contains all $k$ elements of $[u]_k$ (since $[u]_k = \set{i_1, i_2, \ldots, i_k} \subseteq U$) and contains exactly $k$ elements of $q$ (since $U \cap q = \set{j_1, j_2, \ldots, j_k}$).
Thus, each connected component of $U$ is balanced. In other words, $U$ is balanced.
Hence, each element of $[q(u)]_k$ is balanced (since $[q(u)]_k = \set{j_1, j_2, \ldots, j_k} = U \cap q \subseteq U$).
Due to how the dual configuration $(q'_1, q'_2)$ was defined, we thus conclude that each element of $[q(u)]_k$ is in $q'_2$. In other words, $[q(u)]_k \subseteq q'_2$.
Combining this with $\abs{q'_2} = \abs{[u]_k} = k = \abs{[q(u)]_k}$, we obtain $q'_2 = [q(u)]_k$.
Thus, Proposition~\ref{prop:SL.dual-old6} is proven in the case when $k < \abs{q}$.

Now suppose $k > \abs{q}$.
% Note that $\ive{n} \setminus [u]_k$ are the indices of the largest $n-k$ letters of $u$ and $n - \abs{q} > n-k$.
Let $\ell$ be the number of classes in $u$, and consider the contragredient duals $q^*$ and $u^*$ as in Lemma~\ref{le:dual}.
Thus, $n-k < n - \abs{q} = \abs{q^*}$.
Hence, applying the $k < \abs{q}$ case (proven above)
to $n-k$, $u^*$ and $q^*$ instead of $k$, $u$ and $q$,
we see that
$\tup{ [u^*]_{n-k} , q^* }' = \tup{ q^\dagger , [q^*(u^*)]_{n-k} }$
for some queue $q^\dagger$.
Now,
\begin{align*}
 \bigl( (q'_1)^*, (q'_2)^* \bigr)
 &= \tup{ ([u]_k)^* , q^* }'
 = \tup{ [u^*]_{n-k} , q^* }' \\
 & = \tup{ q^\dagger , [q^*(u^*)]_{n-k} }
 = \tup{ q^\dagger , [(q(u))^*]_{n-k} } ,
\end{align*}
where
\begin{itemize}
 \item the first equality follows from~\eqref{eq.rmk:balanced-dual-let.dual-old6};
 \item the second equality is because $([u]_k)^* = [u^*]_{n-k}$; and
 \item the fourth equality follows from Lemma~\ref{le:dual}.
\end{itemize}
Therefore, $(q'_2)^* = [(q(u))^*]_{n-k} = ([q(u)]_k)^*$, so that
$q'_2 = [q(u)]_k$.
Hence, Proposition~\ref{prop:SL.dual-old6} is proven in the case when $k > \abs{q}$.
\end{proof}

\begin{proof}[Proof of Theorem~\ref{thm:permutation}.]
Recall that any permutation in $\SymGp{\ell-1}$ is a product of simple transpositions $s_1, s_2, \ldots, s_{\ell-2}$.
Hence, in order to prove Theorem~\ref{thm:permutation}, it suffices to show that $\swt{u}_{\sigma} = \swt{u}_{\sigma s_i}$ for each $\sigma \in \SymGp{\ell-1}$ and $i \in \ive{\ell-2}$.
Then, Theorem~\ref{thm:permutation} follows by induction on length, \textit{i.e.} the minimal number of simple transpositions needed to write $\sigma$.

In order to prove $\swt{u}_{\sigma} = \swt{u}_{\sigma s_i}$, we need to show, for a $\sigma$-twisted MLQ $\qq$ of type $\mm$ satisfying $u = \qq (1^n)$, that $\fraks_i \qq$ is a $\sigma s_i$-twisted MLQ of type $\mm$ satisfying $u = (\fraks_i \qq) (1^n)$ (since this will show that $\fraks_i$ bijects the former MLQs to the latter).
The only nontrivial part is showing $u = (\fraks_i\qq) (1^n)$.
More generally, we will show that $(\fraks_i\qq)(w) = \qq(w)$ for any word $w \in \mcW_n$.
The proof of this claim reduces to showing that for any configuration $C = \tup{q_1, q_2}$ and any word $w \in \mcW_n$ the dual configuration $\fraks_1 C = C' = (q'_1, q'_2)$ of $C$ satisfies $C'(w) = C(w)$.

Each word $w$ can be obtained from a standard word by a sequence of
merges (each of which sends a word $u$ to $\vee^{(k)} u$ for some
$k \in \set{ p_j(\mm) \mid j \geq 1 }$, where $\mm$ is the type of
$u$). Lemma~\ref{lemma:queue_merge_commute} shows that these merges
commute with the action of a queue (and thus of an MLQ).
Hence, it is sufficient to consider standard words $w$.
Thus, assume that $w$ is standard of type $\mm$.
It is straightforward to see
(using Equation~\eqref{eq:queue_type_change} and $\abs{q'_2} = \abs{q_1}$ and $\abs{q'_1} = \abs{q_2}$)
that the words
$C(w) = q_2\bigl( q_1(w) \bigr)$
and
$C'(w) = q'_2\bigl( q_1'(w) \bigr)$
have the same type.
%indeed, the action of a queue $q$ on a word $w$ modifies its
%type in a predictable way (namely, the number $\abs{q}$ is
%inserted into the type of $w$ at the place where it would
%keep the type weakly increasing).
Let $\nn$ be this type.
We shall now show that
$[C'(w)]_k = [C(w)]_k$
for all $k \in \set{ p_i(\nn) \mid i \geq 0}$.
According to Lemma~\ref{lem:SL.reconstruct-old6}, this will yield $C'(w) = C(w)$, and thus our proof will be complete.

Let $k \in \set{ p_i(\nn) \mid i \geq 0}$.
Thus, $k \in \set{0, 1, \ldots, n} = \set{ p_i(\mm) \mid i \geq 0 }$ (since $w$ is standard).
Hence, $[w]_k$ is well-defined.
Note that $q_i(w)$ and $q'_i(w)$ are also standard words.
Using Proposition~\ref{prop:SL.dual-old6} to compute dual
configurations, we can see how the MLQ
$\qq = \tup{[w]_k, q_1, q_2}$ transforms under the action of
$\fraks_1 \fraks_2 \fraks_1$: Namely, we have
\begin{align*}
\tup{[w]_k, q_1, q_2} & \overset{\fraks_1}{\longmapsto} \tup{\ast, [q_1(w)]_k, q_2}
\\ & \overset{\fraks_2}{\longmapsto} \tup{\ast, \ast, \bigl[ q_2\bigl( q_1(w) \bigr) \bigr]_k}
\\ & \overset{\fraks_1}{\longmapsto} \tup{\ast, \ast, \bigl[ q_2\bigl( q_1(w) \bigr) \bigr]_k},
\end{align*}
where $\ast$ denotes some queue.
Likewise, the action of $\fraks_2 \fraks_1 \fraks_2$ is given by
\begin{align*}
\tup{[w]_k, q_1, q_2} & \overset{\fraks_2}{\longmapsto} \tup{[w]_k, q'_1, q'_2}
\\ & \overset{\fraks_1}{\longmapsto} \tup{\ast, [q'_1(w)]_k , q'_2}
\\ & \overset{\fraks_2}{\longmapsto} \tup{\ast, \ast, \bigl[ q'_2\bigl( q'_1(w) \bigr) \bigr]_k}.
\end{align*}
(See Figure~\ref{fig:crossing_diagrams-old6} for the actions depicted using crossing diagrams.)
Yet, the two maps are equal by Proposition~\ref{prop:braid-old6}.
Thus, the resulting MLQs must be identical:
\[
\tup{\ast, \ast, \bigl[ q'_2\bigl(q'_1(w) \bigr) \bigr]_k}
=
\tup{\ast, \ast, \bigl[ q_2\bigl(q_1(w) \bigr) \bigr]_k}.
\]
Hence, we have
\[
\bigl[ q'_2\bigl( q'_1(w) \bigr) \bigr]_k = \bigl[ q_2\bigl( q_1(w) \bigr) \bigr]_k.
\]
In other words, $[C'(w)]_k = [C(w)]_k$.
\end{proof}

\begin{figure}
\begin{gather*}
\begin{tikzpicture}[xscale=3.5]
\node (i1) at (0,0) {$[w]_k$};
\node (i2) at (0,-1) {$q_1$};
\node (i3) at (0,-2) {$q_2$};
\node (s11) at (1,0) {$\ast$};
\node (s12) at (1,-1) {$[q_1(w)]_k$};
\node (s13) at (1,-2) {$q_2$};
\node (s21) at (2,0) {$\ast$};
\node (s22) at (2,-1) {$\ast$};
\node (s23) at (2,-2) {$\bigl[ q_2\bigl( q_1(w) \bigr) \bigr]_k$};
\node (t1) at (3,0) {$\ast$};
\node (t2) at (3,-1) {$\ast$};
\node (t3) at (3,-2) {$\bigl[ q_2\bigl( q_1(w) \bigr) \bigr]_k$};
\path[-] (i2) edge (s11) (s11) edge (s21) (s21) edge (t2);
\path[-] (i3) edge (s13) (s13) edge (s22) (s22) edge (t1);
\path[-,red] (i1) edge (s12) (s12) edge (s23) (s23) edge (t3);
\end{tikzpicture}
\\
\begin{tikzpicture}[xscale=3.5]
\node (i1) at (0,0) {$[w]_k$};
\node (i2) at (0,-1) {$q_1$};
\node (i3) at (0,-2) {$q_2$};
\node (s11) at (1,0) {$[w]_k$};
\node (s12) at (1,-1) {$q'_1$};
\node (s13) at (1,-2) {$q'_2$};
\node (s21) at (2,0) {$\ast$};
\node (s22) at (2,-1) {$[q'_1(w)]_k$};
\node (s23) at (2,-2) {$q'_2$};
\node (t1) at (3,0) {$\ast$};
\node (t2) at (3,-1) {$\ast$};
\node (t3) at (3,-2) {$\bigl[ q'_2\bigl( q'_1(w) \bigr) \bigr]_k$};
\path[-] (i2) edge (s13) (s13) edge (s23) (s23) edge (t2);
\path[-] (i3) edge (s12) (s12) edge (s21) (s21) edge (t1);
\path[-,red] (i1) edge (s11) (s11) edge (s22) (s22) edge (t3);
\end{tikzpicture}
\end{gather*}
\caption{Crossing diagrams representing the action of $\fraks_1 \fraks_2 \fraks_1$ (top) and $\fraks_2 \fraks_1 \fraks_2$ (bottom).}
\label{fig:crossing_diagrams-old6}
\end{figure}

\end{verlong}



\bibliographystyle{alpha}
\bibliography{queue}{}
\end{document}
