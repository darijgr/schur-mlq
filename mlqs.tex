\documentclass[reqno]{amsart}
\usepackage{setspace,tikz,xcolor,mathrsfs,listings,multicol}
\usepackage{amssymb}
\usepackage{rotating}
\usepackage[vcentermath]{youngtab}
\usepackage{enumerate}
\usepackage[all,cmtip]{xy}
\usetikzlibrary{arrows,matrix}
\usepackage{comment}
\usepackage{color}
\usepackage[sc]{mathpazo}
\usepackage[T1]{fontenc}
\usepackage{needspace}
\usepackage{tabls}
%\usepackage{amsmath}
%\usepackage{amsthm}
%\usepackage{subcaption}
%\usepackage{fullpage}
%\usepackage[margin=1.25in]{geometry}
%\onehalfspacing

\usepackage[colorlinks=true, pdfstartview=FitV, linkcolor=blue, citecolor=blue, urlcolor=blue]{hyperref}

% use these commands for typesetting doi and arXiv references in the bibliography
\newcommand{\doi}[1]{\href{http://dx.doi.org/#1}{\texttt{doi:#1}}}
\newcommand{\arxiv}[1]{\href{http://arxiv.org/abs/#1}{\texttt{arXiv:#1}}}

\newcommand{\iso}{\cong}
%\newcommand{\qedbox}{\rule{2mm}{2mm}}
%\renewcommand{\qedsymbol}{\qedbox}
\newcommand{\qbinom}[3]{\genfrac{[}{]}{0pt}{}{#1}{#2}_{#3}}
\newcommand{\absval}[1]{\left\lvert #1 \right\rvert}
\newcommand{\case}[1]{\vspace{12pt}\noindent\underline{#1}:}
\newcommand{\fs}{\mathcal{S}} % flagged Schur function
\newcommand{\mbf}{\mathbf}
\newcommand{\0}{\phantom{c}}
\newcommand{\swt}[1]{\left\langle #1 \right\rangle} % Spectral weight or amplitude
\newcommand{\merge}[1]{\vee_{#1}} % merge

\DeclareMathOperator{\supp}{supp} % Support
\DeclareMathOperator{\inter}{int} % queuing interval
\DeclareMathOperator{\wt}{wt} % weight
\DeclareMathOperator{\pr}{pr} % promotion
\DeclareMathOperator{\id}{id} % identity
\DeclareMathOperator{\ch}{ch} % character
\DeclareMathOperator{\gr}{gr} % grading

\newcommand{\xx}{\mathbf{x}}
\newcommand{\mm}{\mathbf{m}}
\newcommand{\qq}{\mathbf{q}}
\newcommand{\MLQ}{\mathbf{S}}

\newcommand{\mcA}{\mathcal{A}}
\newcommand{\mcF}{\mathcal{F}}
\newcommand{\mcM}{\mathcal{M}}
\newcommand{\mcW}{\mathcal{W}}

\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\CC}{\mathbb{C}}

\newcommand{\bze}{\overline{0}}
\newcommand{\bon}{\overline{1}}
\newcommand{\btw}{\overline{2}}
\newcommand{\bth}{\overline{3}}
\newcommand{\bfo}{\overline{4}}
\newcommand{\bfive}{\overline{5}}
\newcommand{\bsix}{\overline{6}}
\newcommand{\bseven}{\overline{7}}
\newcommand{\beight}{\overline{8}}
\newcommand{\bi}{\overline\imath}
\newcommand{\bk}{\overline{k}}
\newcommand{\brr}{\overline{r}}
\newcommand{\bn}{\overline{n}}
\newcommand{\ellbar}{\overline{\ell}}

\let\sumnonlimits\sum
\let\prodnonlimits\prod
\let\cupnonlimits\bigcup
\let\capnonlimits\bigcap
\renewcommand{\sum}{\sumnonlimits\limits}
\renewcommand{\prod}{\prodnonlimits\limits}
\renewcommand{\bigcup}{\cupnonlimits\limits}
\renewcommand{\bigcap}{\capnonlimits\limits}

\newenvironment{verlong}{}{}
\newenvironment{vershort}{}{}
\newenvironment{noncompile}{}{}
\excludecomment{verlong}
\includecomment{vershort}
\excludecomment{noncompile}
\newcommand{\rev}{\operatorname{rev}}
\newcommand{\conncomp}{\operatorname{conncomp}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\powset}[2][]{\ifthenelse{\equal{#2}{}}{\mathcal{P}\left(#1\right)}{\mathcal{P}_{#1}\left(#2\right)}}
% $\powset[k]{S}$ stands for the set of all $k$-element subsets of
% $S$. The argument $k$ is optional, and if not provided, the result
% is the whole powerset of $S$.
\newcommand{\set}[1]{\left\{ #1 \right\}}
% $\set{...}$ yields $\left\{ ... \right\}$.
\newcommand{\abs}[1]{\left| #1 \right|}
% $\abs{...}$ yields $\left| ... \right|$.
\newcommand{\tup}[1]{\left( #1 \right)}
% $\tup{...}$ yields $\left( ... \right)$.
\newcommand{\ive}[1]{\left[ #1 \right]}
% $\ive{...}$ yields $\left[ ... \right]$.
\newcommand{\verts}[1]{\operatorname{V}\left( #1 \right)}
% $\verts{...}$ yields $\operatorname{V}\left( ... \right)$.
\newcommand{\edges}[1]{\operatorname{E}\left( #1 \right)}
% $\edges{...}$ yields $\operatorname{E}\left( ... \right)$.
\newcommand{\arcs}[1]{\operatorname{A}\left( #1 \right)}
% $\arcs{...}$ yields $\operatorname{A}\left( ... \right)$.
\newcommand{\underbrack}[2]{\underbrace{#1}_{\substack{#2}}}
% $\underbrack{...1}{...2}$ yields
% $\underbrace{...1}_{\substack{...2}}$. This is useful for doing
% local rewriting transformations on mathematical expressions with
% justifications.
\newcommand{\mlnode}[1]{\node[circle, draw=black] at (#1){\phantom{c}};}

% Dark red emphasis
\definecolor{darkred}{rgb}{0.7,0,0} % darkred color
\newcommand{\defn}[1]{{\color{darkred}\emph{#1}}} % emphasis of a definition

%% For typesetting code listings                                                
\usepackage{listings}
\lstdefinelanguage{Sage}[]{Python}
{morekeywords={False,sage,True},sensitive=true}
\lstset{
  frame=single,
  showtabs=False,
  showspaces=False,
  showstringspaces=False,
  commentstyle={\ttfamily\color{dgreencolor}},
  keywordstyle={\ttfamily\color{dbluecolor}\bfseries},
  stringstyle={\ttfamily\color{dgraycolor}\bfseries},
  language=Sage,
  basicstyle={\footnotesize\ttfamily},
  aboveskip=0.75em,
  belowskip=0.75em,
  xleftmargin=.15in,
}
\definecolor{dblackcolor}{rgb}{0.0,0.0,0.0}
\definecolor{dbluecolor}{rgb}{0.01,0.02,0.7}
\definecolor{dgreencolor}{rgb}{0.2,0.4,0.0}
\definecolor{dgraycolor}{rgb}{0.30,0.3,0.30}
\newcommand{\dblue}{\color{dbluecolor}\bf}
\newcommand{\dred}{\color{dredcolor}\bf}
\newcommand{\dblack}{\color{dblackcolor}\bf}

\usepackage{xparse}

\makeatletter
% \specialmergetwolists{<coupler>}{<list1>}{<list2>}{<return macro>}
% \specialmergetwolists*{<coupler>}{<listcmd1>}{<listcmd2>}{<return macro>}
\protected\def\specialmergetwolists{%
  \begingroup
  \@ifstar{\def\cnta{1}\@specialmergetwolists}
    {\def\cnta{0}\@specialmergetwolists}%
}
\def\@specialmergetwolists#1#2#3#4{%
  \def\tempa##1##2{%
    \edef##2{%
      \ifnum\cnta=\@ne\else\expandafter\@firstoftwo\fi
      \unexpanded\expandafter{##1}%
    }%
  }%
  \tempa{#2}\tempb\tempa{#3}\tempa
  \def\cnta{0}\def#4{}%
  \foreach \x in \tempb{%
    \xdef\cnta{\the\numexpr\cnta+1}%
    \gdef\cntb{0}%
    \foreach \y in \tempa{%
      \xdef\cntb{\the\numexpr\cntb+1}%
      \ifnum\cntb=\cnta\relax
        \xdef#4{#4\ifx#4\empty\else,\fi\x#1\y}%
        \breakforeach
      \fi
    }%
  }%
  \endgroup
}
\makeatother

\theoremstyle{plain}
\newtheorem{thm}{Theorem}[section]
\newtheorem{lemma}[thm]{Lemma}
\newtheorem{conj}[thm]{Conjecture}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}
\theoremstyle{definition}
\newtheorem{dfn}[thm]{Definition}
\newtheorem{example}[thm]{Example}
\newtheorem{remark}[thm]{Remark}
\numberwithin{equation}{section}
%\numberwithin{figure}{section}
%\numberwithin{table}{section}
%\setcounter{section}{-1}

% For breaking equations across multiple pages
% \allowdisplaybreaks[1]

\usepackage[colorinlistoftodos]{todonotes}
\newcommand{\erik}[1]{\todo[size=\tiny,color=green!30]{#1 \\ \hfill --- Erik}}
\newcommand{\Erik}[1]{\todo[size=\tiny,inline,color=green!30]{#1
      \\ \hfill --- Erik}}
\newcommand{\darij}[1]{\todo[size=\tiny,color=red!30]{#1 \\ \hfill --- Darij}}
\newcommand{\Darij}[1]{\todo[size=\tiny,inline,color=red!30]{#1
      \\ \hfill --- Darij}}
\newcommand{\travis}[1]{\todo[size=\tiny,color=blue!30]{#1 \\ \hfill --- Travis}}
\newcommand{\Travis}[1]{\todo[size=\tiny,inline,color=blue!30]{#1
      \\ \hfill --- Travis}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
\title[MLQs]{Multiline queues with spectral parameters}

\author[E.~Aas]{Erik Aas}
\address[E. Aas]{Department of Mathematics, Pennsylvania State University, McAllister Building, State College, PA 116802, USA}
\email{eaas@kth.se}

\author[D.~Grinberg]{Darij Grinberg}
\address[D. Grinberg]{School of Mathematics, University of Minnesota, 206 Church St. SE, Minneapolis, MN 55455}
\email{darij.grinberg@gmail.com}
\urladdr{http://www.cip.ifi.lmu.de/~grinberg/}

\author[T.~Scrimshaw]{Travis Scrimshaw}
\address[T. Scrimshaw]{School of Mathematics and Physics, University of Queensland, St. Lucia, QLD 4072, Australia}
\email{tcscrims@gmail.com}
\urladdr{https://sites.google.com/view/tscrim/home}

\keywords{multiline queue, TASEP, R-matrix, symmetric function}
\subjclass[2010]{
60C05,  % Combinatorial probability
05A19,  % Combinatorial identities, bijective combinatorics
16T25,  % Yang--Baxter equations
05E05}  % Symmetric functions

\thanks{TS was partially supported by the Australian Research Council DP170102648 and the National Science Foundation RTG grant DMS-1148634.}

\begin{abstract}
Using the description of multiline queues as functions on words, we introduce the notion of a spectral weight of a word by defining a new weighting on multiline queues.
We show that the spectral weight of a word is invariant under a natural action of the symmetric group, giving a proof of the commutativity conjecture of Arita, Ayyer, Mallick, and Prolhac.
We give a determinant formula for the spectral weight of a word, which gives a proof of a conjecture of the first author and Linusson.
\end{abstract}

\maketitle

%=====================================================================
\section{Introduction}
\label{sec:introduction}

The totally asymmetric exclusion process (TASEP) is a non-equilibrium stochastic process  that has received significant attention in various fields, such as probability theory, combinatorics, physics, biology, and civil engineering over the past few decades.
For some examples, we refer the reader to~\cite{AasLin17,AAMP,BE07,BP14,DEHP93,KMO15,KMO16} and references therein.
In this paper, we consider the TASEP on a ring with $n$ sites and $\ell$ species of particles.
Thus, we will consider the states to be words $u$ in the alphabet $\{1, \dotsc, \ell\}$ of length $n$, where we take the indices to be $\ZZ / n \ZZ$.
We will also consider our process to be discrete in time, where our transition map interchanges a pair $u_i u_{i+1}$ with $u_i > u_{i+1}$ to $u_{i+1} u_i$ and is done at a uniform rate.

The steady state of the TASEP is known in terms of another process using ordinary multiline queues (MLQs) and applying the Ferrari--Martin (FM) algorithm~\cite{FM06}.
In~\cite{KMO15,KMO16}, the FM algorithm was reformulated in terms of the combinatorial $R$-matrix~\cite{NY97,Shimozono02} and using type $A_{n-1}^{(1)}$ Kirillov--Reshetikhin crystals~\cite{KKMMNN92}.
This interpretation gives a connection with five-vertex models, corner transfer matrices~\cite{Baxter89}, 3D integrable lattice models, and the tetrahedron equation~\cite{Zam80}, yielding a matrix product formula for the steady state distribution different than~\cite{CdGW15,EFM09,PEM09}.

We describe MLQs as functions on words of a fixed length $n$ following~\cite{AAMP}, where it was referred to as the generalized FM algorithm.
We introduce a new weighting of MLQs, which is the weight of the MLQ considered as a tensor product of Kirillov--Reshetikhin crystals.
This allows us to define the amplitude or spectral weight of a word $u$ to be the sum over all the weight of all ordinary MLQs $\qq$ such that $u = \qq(1^n)$.
We also introduce the notation of a $\sigma$-twisted MLQ, where $\sigma$ is a permutation.
Our main result is that for a fixed permutation $\sigma$, the sum over the weight of all $\sigma$-twisted MLQs $\qq_{\sigma}$ such that $u = \qq_{\sigma}(1^n)$ is equal the spectral weight of $u$.
That is to say, we introduce an action of the symmetric group on MLQs such that under the FM algorithm corresponds to the natural action by letters on words.
We show this by applying a combinatorial $R$-matrix to an MLQ\footnote{This operation has also previously appeared in other contexts by Danilov and Koshevoy~\cite{DanilovKoshevoy} (see also~\cite[Ch.~4]{Gorodentsev2}).} does not change the MLQ as a function on words.

Our main result gives a proof of the commutativity conjecture of~\cite{AAMP} when we specialize all our weights to $1$.
However, we note that the interlacing property of~\cite{AAMP} does not generalize to our weighting of MLQs.
We also give a determinant expression for the spectral weight by using the Lindstr\"om--Gessel--Viennot Lemma~\cite{GV85,Lindstrom73}.
By combining these results, we obtain a proof of~\cite[Conj.~3.10]{AasLin17}.

%We
%\begin{itemize}
%\item introduce a new weighting of multiline queues
%\item prove the commutativity conjecture of~\cite{AAMP}
%\item prove~\cite[Conj.~3.10]{AasLin17}
%\item the dual configuration corresponds to an operation already used by Danilov and Koshevoy in other contexts~\cite{DanilovKoshevoy} \darij{See also \cite[somewhere in Ch. 4]{Gorodentsev2}? \cite[somewhere]{vanLeeuwen-dc}?}
%\item the dual configuration also is the combinatorial $R$-matrix on a tensor product of single column KR crystals~\cite{NY97,Shimozono02}, where the connection with TASEP models was given in~\cite{KMO15, KMO16}. Note that these are known to satisfy the Yang--Baxter equation, so we have an action of the symmetric group.
%\end{itemize}
%
%\Erik{Mention Gorodentsev's book.}









%=====================================================================
\section{Background}
\label{sec:background}

For a positive integer $N$, let $\ive{N}$ denote the set $\set{1, 2, \ldots, N}$.

%%%%%%%%%%
\subsection{Words and queues}

Fix a positive integer $n$.
Let $\Omega_n$ be the set of words $u = u_1 \dotsm u_n$ over the ordered alphabet $\mcA := \{1 < 2 < 3 < \cdots \}$.
We will consider the indices of words to be taken modulo $n$. 
The \defn{type} $\mm$ of a word $u$ is the vector $(m_1, m_2, \ldots)$ such that $u$ has $m_i$ occurrences of the letter $i$.
We sometimes refer to $u_i = t$ as a \defn{particle at $i$ of class $t$}.
Sometimes it is useful to consider only \defn{packed} words $u$ whose type $\mm$ is such that for some $r$, $m_i \neq 0$ for $1 \leq i \leq r$ and $m_i = 0$ for $i > r$. We denote the set of packed words of type $\mbf{m}$ by $\Omega_{\mbf{m}}$.
We call $r$ the \defn{number of classes} in $u$.
We \defn{merge} two adjacent classes $i,i+1$ in a packed word $u$ to obtain a new packed word as follows: first replace all occurrences of $i+1$ in $u$ by $i$, then replace all occurrences of $j$ in $u$ by $j-1$, for each $j > i$.

We define an \defn{$r$-queue} $q$ to be any subset of $[n]$ of size $r$. When $r$ is clear, we will simply call $q$ a \defn{queue}.
We think of $q$ as a function from $\mcW_n$ to itself as follows.
Let $\mm$ be the type of $u$.
Let $p_i = m_1 + m_2 + \cdots + m_i$.
There exists a unique $t$ such that
$
p_{t-1} \leq r < p_t.
$
The output word $v = q(u)$ will have type $(m_1, \dotsc, m_{t-1}, r-p_{t-1}, p_{t+1}-r, m_{t+2}, m_{t+3}, \ldots)$.
Note that $p_{t+1} - r = m_{t+1} + (p_t - r)$.
We think of this as splitting the class $t$ into two new classes $t$ and $t+1$. The following algorithm computes $v = q(u)$. In the start no letter of $v$ is set.

\begin{description}
\item[Phase I]
  Go through all $i$ such that $u_i > t$ in any order such that larger letters precede smaller ones.
  When considering a site $i$, find the first $j$ weakly to the left (cyclically) of $i$ such that $j \notin q$ and $v_j$ is not set. Then set $v_j = u_i + 1$. We call $\inter[j,i]$ the \defn{queueing interval} of $i$ with respect to $q$ and $u$.

\item[Phase II]
  Go through all $i$ such that $u_i < t$ in any order such that smaller letters precede larger ones.
  When considering a site $i$, find the first $j$ weakly to the right of $i$ such that $j \in q$ and $v_j$ is not set. Then set $v_j = u_i$. Similarly, $\inter[i,j]$ is called the \defn{queueing interval} of $i$ with respect to $q$ and $u$.

\item[Phase III]
  At this point, there are $m_t$ unset values $v_i$. For such $i$, set $v_i = t$ for $i \in q$ and $v_i = t+1$ for $i\notin q$.
\end{description}

\begin{example}
We consider the $4$-queue $q = \{1, 4, 8, 9\}$ and consider the word $u = 346613321$. Thus, the type of $u$ is $\mm = (2, 1, 3, 1, 0, 2, 0, \ldots)$ with $p_2 = 3$ and $p_3 = 6$, and so $t = 3$. To compute $q(w)$:
\[
\begin{tikzpicture}
\node (i1) at (1,1) {$3$};
\node (i2) at (2,1) {$4$};
\node (i3) at (3,1) {$6$};
\node (i4) at (4,1) {$6$};
\node (i5) at (5,1) {$1$};
\node (i6) at (6,1) {$3$};
\node (i7) at (7,1) {$3$};
\node (i8) at (8,1) {$2$};
\node (i9) at (9,1) {$1$};
\node (t1) at (1,-1) {$2$};
\node (t2) at (2,-1) {$7$};
\node (t3) at (3,-1) {$7$};
\node (t4) at (4,-1) {$3$};
\node (t5) at (5,-1) {$4$};
\node (t6) at (6,-1) {$4$};
\node (t7) at (7,-1) {$5$};
\node (t8) at (8,-1) {$1$};
\node (t9) at (9,-1) {$1$};
\node[circle,draw=black] (q1) at (1,0) {};
\node[circle,draw=black] (q2) at (4,0) {};
\node[circle,draw=black] (q3) at (8,0) {};
\node[circle,draw=black] (q4) at (9,0) {};
\draw[->,red] (i4) -- (q2);
\draw[->,red] (q2) -- (2,0) -- (t2);
\draw[->,red] (i3) -- (t3);
\draw[->,red] (i2) -- (2,0.1) -- (q1);
\draw[->,red] (q1) -- (0,0);
\draw[>->,red] (10,0) -- (q4);
\draw[->,red] (q4) -- (q3);
\draw[->,red] (q3) -- (7,0) -- (t7);
\draw[->,blue] (i5) -- (5,0.1) .. controls (7.5,0.1) .. (q3);
\draw[->,blue] (q3) -- (t8);
\draw[->,blue] (i9) -- (q4);
\draw[->,blue] (q4) -- (t9);
\draw[->,blue] (i8) -- (8,0.2) .. controls (9.5,0.2) .. (10,0.1);
\draw[>->,blue] (0,0.1) -- (q1);
\draw[->,blue] (q1) -- (t1);
\end{tikzpicture}
\]
where the arrows in red are Phase I and the blue are Phase II. Hence, we have $q(346613321) = 277344511$, which has type $(2,1,1,2,1,0,2,\ldots)$.

\erik{I think the arrows are a bit confusing at the moment.}
\end{example}

Since Phase I only deals with $j \notin q$, and Phase II only with $j\in q$, these two phases commute.
We illustrate the situation $v = q(u)$ with a $2 \times n$ array where the first row is the word $u$, and second row has a circle labelled $v_j$ for $j \in q$ or a square labelled $v_j$ for $j \notin q$ in position $j$. Sometimes we omit the squares.\erik{fix sentence}
See Figure~ \ref{fi:queue_example} for an example.

\begin{figure}
\label{fi:queue_example}
\[
\begin{tikzpicture}
  \node at  (1,2){1};
  \node at  (2,2){3};
  \node at  (3,2){2};
  \node at  (4,2){3};
  \node at  (5,2){3};
  \node at  (6,2){2};
  \node at  (7,2){2};
  \node at  (8,2){3};
  \node at  (9,2){1};
  \node at (10,2){2};
  \node at (11,2){1};

  \node at                     (1,1){4};
  \node[circle,draw=black] at  (2,1){1};
  \node at                     (3,1){4};
  \node[circle,draw=black] at  (4,1){1};
  \node[circle,draw=black] at  (5,1){2};
  \node at                     (6,1){3};
  \node at                     (7,1){4};
  \node[circle,draw=black] at  (8,1){2};
  \node at                     (9,1){3};
  \node[circle,draw=black] at (10,1){1};
  \node at                    (11,1){4};
\end{tikzpicture}
\]
\caption{A generalized queue showing that $v = Q_S(u)$ where $S = \{2,4,5,8,10\}$, $u = 13233223121$ and $v =41412342314$. It has weight $x_2x_4x_5x_8x_{10}$.}
\end{figure}


Consider a pair $k, k+1 \pmod{n}$ of consecutive columns.
For $s > t$ the \defn{$s$-flow} from $k+1$ to $k$ is the number of $i$ such that $u_i=s$, and whose queueing interval $\inter[j,i]$ contains both $k$ and $k+1$.
Similarly, for $s < t$, the \defn{$s$-flow} from $k$ to $k+1$ is the number of $i$ such that $u_i = s$, and whose queueing interval $\inter[i,j]$ contains both $k$ and $k+1$.

There is an obvious duality in the definition of the labelling process above. We state it as follows.

\begin{lemma}[Duality]
  \label{le:dual}
  Let $q$ be a queue and $u$ be a packed word with $r$ classes. Define a new word $v$ by letting $v_i = r + 1 - u_{n+1-i}$ and a new queue $q'$ by letting $i \in q' \Leftrightarrow n+1-i \notin q$.
 Then $q(u)_i = r + 2 - q'(v)_{n+1-i}$.
\end{lemma}

%\begin{remark} (Excision)
%  Fix a queue $q$ and a word $u$, and let $i,j$ be columns. Suppose that the $s$-flow from $j+1$ to $j$ equals the $s$-flow from $i+1$ to $i$ for each $s > t$, and that the $s$-flow from $i$ to $i+1$ equals the $s$-flow from $j$ to $j+1$ for each $s < t$. Then we have $q_{|\inter[i,j]^c}(u_{|\inter[i,j]^c}) = (q(u))_{|\inter[i,j]^c}$. Here, for a (cyclic) word $u$, we let $u_{|\inter[i,j]^c}$ denote the (cyclic) word gotten from simply removing the closed (cyclic) interval $\inter[i,j]$, and similarly for $q_{|\inter[i,j]^c}$.
%\end{remark}

\begin{lemma}[Monotonicity]
\label{le:mono}
  For any $t \in \ZZ_{\geq 1}$, let $f_t \colon \{1,2, \ldots\} \to \{1,2\}$ be given by $f_t(x) = 1$ for $x \leq t$ and $f_t(x) = 2$ for $x > t$. Let $q$ be a queue, $u$ be any word, and $i,j\in[n]$. Then $q(u)_i \leq q(u)_j$ implies $q(f_t(u))_i \leq q(f_t(u))_j$. Furthermore, if $q(u)_i < q(u)_j$ then $q(f_t(u))_i < q(f_t(u))_j$ for some $t$.
\end{lemma}

Lemma~\ref{le:mono} tells us that $q$, considered as a function on words, is completely determined by its values $q(u)$ on words $u\in\{1,2\}^n$.

%%%%%%%%%%




%=====================================================================
\section{Main result}
\label{sec:result}


%Fix a subset $B = \set{b_1 < b_2 < \cdots < b_n}$ of $\ive{N}$.
%Let $\mcM \tup{B, \mm}$ be the set of all MLQs $\MLQ = (S_0, \dotsc, S_n)$ of type $\mm$
%with $S_n = X$ and bottom row labels
%\[
%(\underbrace{n, \dotsc, n}_{m_n},\, \dotsc,\, \underbrace{2, \dotsc, 2}_{m_2},\, \underbrace{1, \dotsc, 1}_{m_1}).
%\]

For a packed word $u$ of type $\mm = (m_1, \dotsc, m_r)$, we define the \defn{amplitude} 
\[
  [u] = \sum_{(q_1, \dotsc, q_{r-1})} \prod_{i=1} ^{r-1} \prod_{j \in q_i} x_j,
\]
where we sum over all sequences $q_1, \dots, q_{r-1}$ of queues such that
\begin{enumerate}
\item $q_i$ is a $(m_1+\dots+m_i)$-queue, and
\item $u = q_{r-1}(\cdots q_2(q_1(1\dotsm 1)) \cdots)$.
\end{enumerate}
\Travis{This creates a big notational conflict with $[n]$. We should change this.}

Such a sequence $(q_1, \dotsc, q_{r-1}$ is called an (ordinary) \defn{multiline queue} (MLQ) of type $\mm$. For a fixed type $\mbf{m}$, the numbers $[u] \in \Omega_{\mbf{m}}$.

The following result is proved in~\cite{AAMP} in the case $x_1 = \cdots = x_r$.

\begin{thm}
\label{thm:permutation}
  For any permutation $\sigma$ of $[r-1]$, we have 
  \[
  [u] = \sum_{(q_1, \dots, q_{r-1})} \prod_{i=1} ^{r-1} \prod_{j\in q_i} x_j,
  \]
  where we sum over all \defn{$\sigma$-twisted MLQs}: sequences $q_1, \dotsc, q_{r-1}$ of queues such that
  \begin{enumerate}
  \item $q_i$ is a $(m_1 + \cdots + m_{\sigma_i})$-queue, and
  \item $u = q_{r-1}(\cdots q_2(q_1(1\dotsm 1)) \cdots )$.
  \end{enumerate}
\end{thm}


\begin{cor}
\label{co:merge}
  Let $\mm$ be a packed type and $\mm'$ be the result of merging the classes $i$ and $i+1$ in $\mm$. For any word $v$ of type $m$, we have
  \[
  \swt{v} e_{p_i(\mm)}(n) = \sum_u \swt{u},
  \]
  where we sum over all $u$ of type $\mm$ such that merging classes $i$ and $i+1$ in $u$ yields $v$.
\end{cor}

\begin{proof}
  Note that if $u = q_{r-1}(\cdots q_2(q_1(1 \dotsm 1)) \cdots)$ where $q_1$ is a $m_1 + \cdots + m_i$-queue, then $v = q_{r-1}(\cdots q_2(1\dotsm 1)\cdots)$ is the result of merging classes $i$ and $i+1$ in $u$. The result follows from Theorem~\ref{thm:permutation}.
\end{proof}

\begin{example}
  We give an example of the situation in Theorem \ref{thm:permutation} and Corollary~\ref{co:merge}. To compute $[135452]$ we count $(1,1,1,1,2)$-MLQ's, such as the following one.
\[
\begin{tikzpicture}\node at (0, 4){2};\node at (1, 4){2};\node at (2, 4){2};\node[circle, draw=black] at (3, 4){1};\node at (4, 4){2};\node at (5, 4){2};\node at (0, 3){3};\node at (1, 3){3};\node[circle, draw=black] at (2, 3){2};\node at (3, 3){3};\node at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){4};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){5};\node[circle, draw=black] at (5, 1){2};\end{tikzpicture}
\]
To get a word $136452$ or $135462$, following the proof of Corollary~\ref{co:merge} we can add a new row on top, with $5$ boxes. The total weight of these additions is $e_5(x_1, \dots, x_6)$. Here is an example of such an addition.
\[
\begin{tikzpicture}\node[circle, draw=black] at (0, 5){1};\node[circle, draw=black] at (1, 5){1};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node[circle, draw=black] at (4, 5){1};\node[circle, draw=black] at (5, 5){1};\node at (0, 4){2};\node at (1, 4){2};\node at (2, 4){3};\node[circle, draw=black] at (3, 4){1};\node at (4, 4){2};\node at (5, 4){2};\node at (0, 3){3};\node at (1, 3){4};\node[circle, draw=black] at (2, 3){2};\node at (3, 3){3};\node at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};\end{tikzpicture}
\]
By Theorem~\ref{thm:permutation}, such queues are in 1-1 correspondence with ordinary queues counting, in this case, $[135462]$. By applying the bijection in the proof of the theorem $4$ times to bring the top row to the bottom, we get the corresponding ordinary queue, as follows.\\

\noindent Swap rows 1 and 2:
\[
\begin{tikzpicture}\node at (0, 5){2};\node at (1, 5){2};\node[circle,draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node[circle, draw=black] at (0, 4){2};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node[circle, draw=black] at (3, 4){1};\node[circle, draw=black] at (4, 4){2};\node[circle, draw=black] at (5, 4){2};\node at (0, 3){3};\node at (1, 3){4};\node[circle, draw=black] at (2, 3){2};\node at (3, 3){3};\node at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};\end{tikzpicture}
\]
Swap rows 2 and 3:
\[
\begin{tikzpicture}\node at (0, 5){2};\node at (1, 5){2};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node at (0, 4){3};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node at (3, 4){3};\node at (4, 4){3};\node[circle, draw=black] at (5, 4){1};\node[circle, draw=black] at (0, 3){3};\node at (1, 3){4};\node[circle, draw=black] at (2, 3){2};\node[circle, draw=black] at (3, 3){3};\node[circle, draw=black] at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};\end{tikzpicture}
\]
Swap rows 3 and 4:
\[
\begin{tikzpicture}\node at (0, 5){2};\node at (1, 5){2};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node at (0, 4){3};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node at (3, 4){3};\node at (4, 4){3};\node[circle, draw=black] at (5, 4){1};\node[circle, draw=black] at (0, 3){3};\node at (1, 3){4};\node at (2, 3){4};\node at (3, 3){4};\node[circle, draw=black] at (4, 3){2};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node[circle, draw=black] at (2, 2){4};\node[circle, draw=black] at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};\end{tikzpicture}
\]
Swap rows 4 and 5
\[
\begin{tikzpicture}\node at (0, 5){2};\node at (1, 5){2};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node at (0, 4){3};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node at (3, 4){3};\node at (4, 4){3};\node[circle, draw=black] at (5, 4){1};\node[circle, draw=black] at (0, 3){3};\node at (1, 3){4};\node at (2, 3){4};\node at (3, 3){4};\node[circle, draw=black] at (4, 3){2};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){5};\node[circle, draw=black] at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node[circle, draw=black] at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};\end{tikzpicture}
\]
\end{example}


\begin{thm}
\label{thm:determinant_form}
  Let $1 \leq b_1 < \cdots < b_k \leq n$ be integers and $v_1v_2 \dotsm v_k$ be a weakly decreasing (non-cyclic) packed word of length $k$ with $r-1$ classes. Define a word $u$ of length $n$ as follows,
  \[
  u_i = \begin{cases}
  v_k & \text{if $i = b_k$ for some $k$}, \\
  r & \text{ otherwise}.
  \end{cases}
  \]
  Then $[u] = \det(h_{i-j-1+\gamma_j}(x_1, \dotsc, x_{b_j}))_{1\leq i,j\leq n}$, where $\gamma_i$ is the number of distinct letters in $v_1\dotsm v_j$. We define $h_d(\cdots) = 0$ for $d < 0$.
\end{thm}

\begin{proof}
This is an easy application of the Lindstr\"om-Gessel-Viennot Lemma~\cite{Lindstrom73,GV85}.

Define a graph with node set $\{1,\dotsc,k\} \times \{1, \dotsc, n\}$ and edges $(i,j) \to (i,j+1)$ with weight $1$ and $(i,j) \to (i-1,j)$ with weight $x_j$. 

We define $k$ sources $s_i = (k+1-i, 1)$ for $i\in[k]$ and $k$ terminals $t_j = (k-j+\gamma_j,b_j)$ for $j\in[k]$, where $\gamma_j$ is the number of distinct classes in $v_1\dotsm v_j$.

Any non-intersecting path system from the sources to the terminals gives in straightforward way an MLQ with the corresponding weight whose bottom row is labelled $u$, and conversely. See Figure~\ref{fig:MLQ_NLP} for an example.

Note that the weighted sum of paths from $s_i$ to $t_j$ is $h_{i-j-1+\gamma_j}(x_1,\dots,x_{b_j})$. The LGV lemma now gives us the stated formula.
\end{proof}

\begin{figure}
\[
\begin{tikzpicture}
  \node[circle,draw=black] at  (1, 0){3};
  \node[circle,draw=black] at  (2, 0){3};
  \node[circle,draw=black] at  (4, 0){2};
  \node[circle,draw=black] at  (6, 0){2};
  \node[circle,draw=black] at  (7, 0){2};
  \node[circle,draw=black] at  (9, 0){1};
  \node[circle,draw=black] at  (3, 1){2};
  \node[circle,draw=black] at  (4, 1){2};
  \node[circle,draw=black] at  (6, 1){2};
  \node[circle,draw=black] at  (8, 1){1};
  \node[circle,draw=black] at  (7, 2){1};
\end{tikzpicture}
\]
\[
\begin{tikzpicture}
  \draw[densely dotted] (1, 1) -- (9, 1);
  \draw[densely dotted] (1, 2) -- (9, 2);
  \draw[densely dotted] (1, 3) -- (9, 3);
  \draw[densely dotted] (1, 4) -- (9, 4);
  \draw[densely dotted] (1, 5) -- (9, 5);
  \draw[densely dotted] (1, 6) -- (9, 6);

  \draw[densely dotted] (1, 6) -- (1, 1);
  \draw[densely dotted] (2, 6) -- (2, 1);
  \draw[densely dotted] (3, 6) -- (3, 1);
  \draw[densely dotted] (4, 6) -- (4, 1);
  \draw[densely dotted] (5, 6) -- (5, 1);
  \draw[densely dotted] (6, 6) -- (6, 1);
  \draw[densely dotted] (7, 6) -- (7, 1);
  \draw[densely dotted] (8, 6) -- (8, 1);
  \draw[densely dotted] (9, 6) -- (9, 1);

  \draw[draw=red] (1,2)--(2,2);
  \draw[draw=red] (1,3)--(3,3)--(3,2)--(4,2);
  \draw[draw=red] (1,4)--(4,4)--(4,3)--(6,3);
  \draw[draw=red] (1,5)--(6,5)--(6,4)--(7,4);
  \draw[draw=red] (1,6)--(7,6)--(7,5)--(8,5)--(8,4)--(9,4);

  \node at (1,1){\textbullet};
  \node at (1,2){\textbullet};
  \node at (1,3){\textbullet};
  \node at (1,4){\textbullet};
  \node at (1,5){\textbullet};
  \node at (1,6){\textbullet};
  \node at (2,2){\textbullet};
  \node at (4,2){\textbullet};
  \node at (6,3){\textbullet};
  \node at (7,4){\textbullet};
  \node at (9,4){\textbullet};
\end{tikzpicture}
\]
\caption{An example of the correspondence between MLQs and non-intersecting lattice paths with $n = 14$, $r = 3$, and $v = 3211$.}
\label{fig:MLQ_NLP}
\end{figure}

Now, fix a sequence $b_1 < b_2 < \cdots < b_k$, and for a permutation $v$ of $[k]$ let $u(v)$ be the corresponding word as defined in Theorem~\ref{thm:determinant_form}.
Furthermore let $S \subseteq [k-1]$ be such that $i\in S \Rightarrow i+1 \notin S$.
In~\cite{AasLin17}, a formula for the amplitude $\left[ u((\prod_{i\in S} s_i)w_0) \right]$ is conjectured, where $w_0$ is the reverse permutation on $[k]$; $w_0 = k(k-1)\dots 1$.

Let $\varphi(S) = \left[ u(( \prod_{i\in S} s_i ) w_0) \right]$, and $\psi(T) = \sum_{S \subseteq T} \varphi(S)$.
By Theorem~\ref{thm:permutation}, $\psi(T) = \left(\prod_{i\in S} e_{m_1+\dots +m_i}(x_1,\dots,x_n) \right) [w_T]$, where $w_T$ is the result of merging $n+1-i$ and $n-i$ in $w_0$ for each $i\in T$.
By M\"obius inversion we have $\varphi(S) = \sum_{T\subseteq S} (-1)^{|S|-|T|} \psi(T)$.
By Theorem~\ref{thm:determinant_form}, $[w_T] \prod_{i \in T} e_i(x_1,\dots, x_n) \det(\dots)$ \erik{FIX}.
Taken together, this proves \cite[Conj.~3.10]{AasLin17}.








%=====================================================================
\section{The TASEP connection}

We now rephrase Theorem~\ref{thm:permutation} in a language more similar to that of~\cite{AAML}\travis{Is this suppose to be~\cite{AAMP}? Otherwise please add the reference to the bib file.}. Note that there are exactly $2^{n-1}$ different types of packed words of length $n$. These types are naturally indexed by subsets of $[n-1]$ as follows: the type $\mbf{m}_S$ corresponding to $S \subseteq [n-1]$ is the type of the word obtained by identifying $i$ and $i+1$ for each $i\in S$ in the word $12\dots n$ simultaneously.

\begin{example}
  For $n = 4$, we have $\mbf{m}_\emptyset = (1,1,1,1)$, $\mbf{m}_{\{1\}} = (2,1,1)$, $\mbf{m}_{\{2\}} = (1,2,1)$, $\mbf{m}_{\{3\}} = (1,1,2)$, $\mbf{m}_{\{1,2\}} = (3,1)$, $\mbf{m}_{\{1,3\}} = (2,2)$, $\mbf{m}_{\{2,3\}} = (1,3)$, and $\mbf{m}_{\{1,2,3\}} = (4)$.
\end{example}

\erik{hypercube goes here}

When we let all spectral parameters equal, there is a connection between our MLQs and the multi-species \defn{totally asymmetric exclusion process} (TASEP) on the ring, as follows.
For a type $\mbf{m}_S$, where $S \subseteq[n-1]$, we define a Markov chain on $\Omega_{\mbf{m}_S}$ as follows.
For a state $u \in \Omega_{\mm_S}$, we generate a new state by picking a random $i\in [n]$ and either
\begin{itemize}
\item if $u_i < u_{i+1}$, swap the positions $u_i$ and $u_{i+1}$, or
\item do nothing (\textit{i.e.} stay at $u$).
\end{itemize}
Let $M_S$ be the transition matrix of this Markov chain.
For $i \notin S$, we have the merging map $\Phi_i \colon \Omega_{\mbf{m}_S} \to \Omega_{\mbf{m}_{S\cup\{i\}}}$.
It is easy to see that $\Phi_i M_S = M_{S\cup \{i\}} \Phi_i$. 

% Do you plan to use this command elsewhere?    -- Travis
\newcommand{\exE} {
	\begin{tikzpicture} \draw (3,8) node {321}; \draw (0,6) node
{231}; \draw (6,6) node {312}; \draw (0,2) node {213}; \draw (6,2)
node {132}; \draw (3,0) node {123};

	\draw node at (1.5,7.5){$1/3$}; \draw node at
(4.6,7.3){$1/3$}; \draw node at (3.4,6.5){$1/3$};

	\draw node at (-0.5,4.5){$1/3$}; \draw node at
(6.6,4.5){$1/3$};

	\draw node at (1.5,4.5){$1/3$}; \draw node at
(4.6,4.5){$1/3$};

	\draw node at (1.5,1.3){$1/3$}; \draw node at
(4.3,1.3){$1/3$};

	\draw [->, >=stealth, thick] (2.7,7.7) -- (0.3,6.3);
\draw [->, >=stealth, thick] (3.3,7.7) --
(5.7,6.3); \draw [->, >=stealth, thick] (0,5.7) -- (0,2.3);
\draw [<-, >=stealth, thick] (2.7,0.3) --
(0.3,1.7); \draw [<-, >=stealth, thick] (3.3,0.3) -- (5.7,1.7);
\draw [<-, >=stealth, thick] (6,2.3) --
(6,5.7); \draw [->, >=stealth, thick] (3,0.3) -- (3,7.7);
\draw [->, >=stealth, thick] (5.7,2.3) --
(0.3,5.7); \draw [->, >=stealth, thick] (0.3,2.3) -- (5.7,5.7);
\end{tikzpicture} }
\[
\exE
\]


Building on work by Ferrari-Martin~\cite{FM06}, the paper~\cite{AAMP} introduced opposite operators $\Psi_i \colon \Omega_{\mbf{m}_{S\cup\{i\}}} \to \Omega_{\mbf{m}_S}$ given by $\Psi(u) = \sum_q q(u)$, and showed that $\Psi M = M\Psi$. Furthermore they conjectured that $\Psi_S \Psi_T = \Psi_T \Psi_S$.

In the course of proving Theorem~\ref{thm:permutation}, we prove the commutativity conjecture of~\cite{AAMP} for the weighted operators (which obviously generalize those of~\cite{AAMP}) $\Psi(u) = \sum_q \wt(q) q(u)$. This is equivalent to showing that for any $u \in \Omega_{\mbf{m}_S}$, $v \in \Omega_{\mbf{m}_{S\cup\{i,j\}}}$, [TWO THINGS EQUAL] \erik{Fix}

\erik{the proof of interlacing by~\cite{AAMP} is significantly different from our approach}

We have not managed to find a process similar to the TASEP whose transition matrix $M$ would satsify $M\Psi = \Psi M$ for our generalized $\Psi$ operators.
Note however that queues gives us \emph{a} random process with this property: for a word $u \in \Omega_{\mm}$, a move in the chain is given by
\begin{enumerate}
\item picking a random queue $q$
\item going to the state $q(u) \in \Omega_{\mm}$.
\end{enumerate}








%=====================================================================
\section{Proof of Theorem~\ref{thm:permutation}}

%%%%%%%%%%
\subsection{Two line configurations}

Let $q_1$ be an $r$-queue and $q_2$ be an $s$-queue.
We refer to a pair $(q_1, q_2)$ as an \defn{$(r,s)$-configuration}.
Any $(r,s)$-configuration $C$ gives us a map on words by composition: $C(u) = q_2(q_1(u))$.
Furthermore, we let the \defn{weight} of $C$ simply be the product of weights of $q_1$ and $q_2$: $\wt(C)=\prod_{i\in q_1}x_i\prod_{j\in q_2}x_j$.
Note that to prove Theorem~\ref{thm:permutation}, it is enough to show that the amplitude in the statement of Theorem~\ref{thm:permutation} does not change when applying an adjacent transposition to $\sigma$.
This we in turn prove by associating to each $(r,s)$-configuration $C$ a \defn{dual} $(s,r)$-configuration $C'$ in a bijective (in fact, involutive) manner, such that $C$ and $C'$ define the same function on words, and furthermore, the weight of $C$ and the weight of $C'$ equal. We split the proof into four parts, as follows.

By Lemma~\ref{le:mono}, to show that $C(u) = C'(u)$ for all words $u$, it is enough to show that $C(u) = C'(u)$ for \emph{binary} words $u \in \{1,2\}^n$. For the remainder of this section, we refer to binary words simply as words. 

In part A we describe how to split any configuration into \defn{balanced} and \defn{unbalanced} blocks. In part B we define the involution promised above, mapping any configuration $C$ to its dual $C'$. In part C we reduce the problem of showing that $C(u) = C'(u)$ for \emph{all} words $u$ to the showing it for a very restricted set of words $u$. Finally in part D we show that for this restricted set of words $u$, we indeed have $C(u) = C'(u)$.

%%%%%%%%%%
\subsection{Part A: splitting into balanced and unbalanced blocks}

Let $C=(q_1,q_2)$ be a $(r,s)$-configuration. We say that a closed cyclic interval $\inter[i,j]$ is \defn{balanced} if the following conditions holds
\begin{itemize}
  \item for each $k \in \inter[i,j]$, we have $c^\uparrow(i,k) \geq c^\downarrow(i,k)$, where $c^{\uparrow}(i,k)$ is the number of $l \in \inter[i,k]$ such that $l \in q_1$, and $c^\downarrow(i,k)$ is the number of $l\in\inter[i,k]$ such that $l\in q_2$ and
  \item $c^{\uparrow}(i,j) = c^{\downarrow}(i,j)$.
\end{itemize}

We call a maximal (with respect to inclusion) balanced closed cyclic interval in a \defn{balanced block} of $C$. For $i \in [n]$, we say that $i$ is \defn{balanced} if $i$ belongs to some balanced block, and \defn{unbalanced} otherwise. Note that for a balanced block $B$, we have $|q_1 \cap B| = |q_2 \cap B|$.

For $r < s$ and $j$ unbalanced, we have $j \notin q_1$ and $j \in q_2$. Conversely, for $r > s$ and $j$ unbalanced, $j \in q_1$ and $j\notin q_2$. The following notation will be useful later on: for a word $u$ and $j$ balanced with respect to $C$, we let $T(j)$ be the pair $(u_j, s_j)$ where $s_j = \circ$ if $j\in q_1$ and $s_j = \square$ if $j\notin q_1$.

%%%%%%%%%%
\subsection{Part B: defining the dual configuration}

For an $(r,s)$-configuration $C=(q_1,q_2)$, we define its dual $(s,r)$-configuration $C'=(q'_1, q'_2)$ by letting $q'_i \cap B = q_i \cap B$ for $i=1,2$ and each balanced block $B$ in $C$. For unbalanced $j$, we let $j\in q'_i$ if and only if $j\in q_{i'}$ for $i = 1,2$ where $1'=2$, and $2'=1$.

Note that $C$ and $C'$ have the same balanced blocks. Clearly, the dual of $C'$ is again $C$, so our mapping is bijective. Furthermore, $\wt C = \wt C'$. 

\Darij{The construction $C \mapsto C'$ is probably somewhere in the Russian works. \cite[2.6]{DanilovKoshevoy}? \cite[A.2]{DanilovKoshevoy}? \cite[somewhere in Ch. 3]{Gorodentsev2}? \cite[somewhere]{vanLeeuwen-dc}?}

%balanced blocks in C and C' are the same (because #unbalanced columns is same in both)
%%%%%%%%%%
\subsection{Part C: three types of swaps}


For a word $u$ and indices $i,j$, we let $u_{i\leftrightarrow j}$ be the result of swapping positions $i$ and $j$ in $u$.

\begin{lemma}
\label{le:orig}
  Let $q$ be a queue, $u \in \{1,2\}^n$, and $i,j\in [n]$. Suppose that $i \notin q$, $j\in q$, and for $k \in \inter(i,j)$, either $k \in q$ and $u_k=1$ or $k \notin q$ and $u_k = 2$. Then $q(u) = q(u_{i\leftrightarrow j})$.
\end{lemma}

 Throughout, we assume that $C = (q_1, q_2)$ is a $(r,s)$-configuration.

\begin{lemma}[BB]
\label{le:BB}
  Let $C$ and $u$ be as above. Suppose $i,j$ are balanced, $T(i) = (1,\square)$, $T(j) = (2,\bigcirc)$, and that for $k\in\inter(i,j)$, $k$ is balanced and $T(k) \in \{(1,\bigcirc),(2,\square)\}$. Then $C(u) = C(u_{i \leftrightarrow j})$.
\end{lemma}

\begin{proof}
  By Lemma~\ref{le:orig}, $q_1(u) = q_1(u_{i\leftrightarrow j})$ and thus $C(u) = q_2(q_1(u)) = q_2(q_1(u_{i\leftrightarrow j})) = C(u_{i\leftrightarrow j})$.
\end{proof}

\begin{lemma}[BU]
\label{le:BU}
  Let $C$ and $u$ be as above. Suppose $i$ is balanced, $j$ is unbalanced, $T(i) = (1,\square)$, $u_j = 2$, $u_k = 1$ for unbalanced $k$ in $\inter (i,j)$ and for balanced $k$ in $\inter(i,j)$, we have $T(k) \in \{(1,\bigcirc),(2,\square)\}$. Then $C(u) = C(u_{i \leftrightarrow j})$.
 \end{lemma} 
 
\begin{proof}
  We assume here that $r > s$, noting that the dual case $r < s$ follows from Lemma~\ref{le:dual} and Lemma~\ref{le:UB}. Thus $i \in q_1$ for unbalanced $i$. In this case Lemma~\ref{le:orig} applies again, so $q_1(u) = q_1(u_{i\leftrightarrow j})$.
\end{proof}

\begin{lemma}[UB]
\label{le:UB}
  Let $C$ and $u$ be as above. Suppose $i$ is unbalanced, $u_i = 1$, $u_k = 2$ for unbalanced $k$ in $\inter(i,j)$, for balanced $k$ in $\inter(i,j)$ we have $T(k) \in \{(1,\bigcirc),(2,\square)\}$, $j$ is balanced, and $T(j) = (2,\bigcirc)$. Then $C(u) = C(u_{i \leftrightarrow j})$.
\end{lemma}

\begin{proof}
  As in the proof of Lemma~\ref{le:BU}, we assume that $r > s$, noting that the case $r < s$ follows from Lemma~\ref{le:dual} and Lemma~\ref{le:BU}.
  
  Note that for a balanced block $B$ contained in $\inter(i,j)$, the labelling of $C(u)$ for $k \notin B$ is determined entirely by $q_1\cap B^c$, $q_2\cap B^c$ and $u_{|B^c|}$. Thus we can reduce to the case when there is no such balanced block $B$ contained in $\inter(i,j)$.  

  Thus suppose $i, i+1, \dotsc, i+k$ are unbalanced, and $i+k+1, i+k+2, \dotsc, j$ are balanced. We now prove that $C(u) = C(u_{i\leftrightarrow j})$ by induction on $k$. 
  
  \vspace{10pt}
  \noindent \underline{The base case: $k = 0$}

  If $q_1(u)_j = 1$ then $q_1(u) = q_1(u_{i\leftrightarrow j})$ again by Lemma~\ref{le:orig}. We are thus left with the case $q_1(u)_j = 2$. In this case $q_1(u_{i\leftrightarrow j}) = q_1(u)_{i\leftrightarrow j}$, and we can proceed as in the induction step below to conclude that $C(u) = C(u_{i\leftrightarrow})$.

  \vspace{10pt}
  \noindent \underline{The inductive step}

  Suppose $k > 0$. Clearly, $q_1(u)_i = 1$. If $q_1(u)_{i+1} = 1$, it is easy to see that $q_1(u) = q_1(u_{i\leftrightarrow i+1})$ so by our inductive hypothesis, $C(u) = C(u_{i\leftrightarrow j})$ in this case. 

  Now suppose $q_1(u)_{i+1} = 2$. In this case we see that the number of ones in $u$ is at most $r$ (or there wouldn't be any $k$ such that $k \in q_1$ and $q_1(u)_k=2$. This means that $k\notin q_2 \Rightarrow q_2(q_1(u))_k = 4$. We also see that $q_1(u)_l = 2$ for $l$ in all of $\{i+1,\dots, i+k\}$ as well as for $l= j$.

  Since the squares in the lower row of the balanced block of $j$ will all be labeled $4$, we see that in finding the first site to the left of $j$ when considering $q_1(u)_j = 2$ in the computation of $q_2(q_1(u))$ from $q_1(u)$, the search goes beyond $i+k+1$. Together with the previous paragraph, this means that $q_2(q_1(u))_i = 3$.

  Now $q_1(u_{i\leftrightarrow i+1}) = q_1(u)_{i\leftrightarrow i+1}$. Therefore, the only difference between $C(u)$ and $C(u_{i\leftrightarrow j})$ would be in positions $i$ or $i+1$. We have established that $q_1(u)_l = 3$ for $l \in \{i,i+1\}$, and that this is true also for $q_1(u_{i\leftrightarrow i+1})$ is immediate.

\end{proof}


%%%%%%%%%%
\subsection{Part D: finishing the proof}

Note that if one of Lemmas~\ref{le:BB}, \ref{le:BU}, \ref{le:UB} applies to $C,u,i,j$ then it also applies to $C',u,i,j$. Now let $u_0$ be a result of applying Lemma~\ref{le:BB}, \ref{le:BU}, \ref{le:UB} until this can be done no more (such a $u_0$ exists since the number of balanced $k$ with $T(k) \in \{(1,\bigcirc), (2,\square)\}$ increases with each swap).

What do we know about $u_0$? There are three cases.

\begin{itemize}
\item If there is some balanced $i$ such that $T(i) = (1, \square)$ then there is no balanced $i$ such that $T(i) = (2,\bigcirc)$.
\item If there is some balanced $i$ such that $T(i) = (2, \bigcirc)$ then there is no balanced $i$ such that $T(i) = (1,\square)$.
\item If for all balanced $i$, we have $T(i) \in \{(1,\bigcirc),(2,\square)\}$
\end{itemize}

These three cases correspond to $e > r$, $s \geq e$ and $r \geq e > s$ respectively, where $e$ is the total number of ones in $u$. In each of these cases, it is easy to see that all particles in $u$ starting in unbalanced positions in $C$ or $C'$ simply are assigned to the same column two rows down, and that the labellng procedure inside each balanced block is the same in $C$ and $C'$.


\begin{example}
We give an example of the computation inherent in the proof, showing that $C(u) = C'(u)$ for $(r,s)$-configuration $C$ in Figure~\ref{fi:proof_example} and its dual $(s,r)$-configuration $C'$ where $r=5$, $s=3$ and $u = 211112$.
We first find the balanced blocks: the columns 1,2,5 and 6 are balanced while 3 and 4 are unbalanced.
Thus $C$ and $C'$ differ in columns 3 and 4 only. 

Now apply Lemma UB with $i = 4$ and $j = 6$, getting $u_1 = 211112$.  \\
Lemma BU with $i=2, j=4$, getting $u_2 = 221111$.  \\
Lemma UB with $i=4, j=1$, getting $u_0 = 121211$, at which point we cannot apply any of Lemmas UB,BU,BB to $u_0$.

The reader is invited to chech that indeed, $C(u) = C(u_1) = C(u_2) = C(u_0)$ and $C'(u) = C'(u_1) = C'(u_2) = C'(u_0)$.

For the input word $u_0$, we have $C(u_0) = 112314 = C'(u_0)$.

\erik{need more elaborate example, including Lemma BB (and possibly all three cases of Part D}

\end{example}

\begin{figure}
\label{fi:proof_example}

\[
\begin{tikzpicture}
  \node[circle, draw=black] at (0, 3){\0};
  \node[rectangle, draw=black] at (1, 3){\0};
  \node[circle, draw=black] at (2, 3){\0};
  \node[circle, draw=black] at (3, 3){\0};
  \node[circle, draw=black] at (4, 3){\0};
  \node[circle, draw=black] at (5, 3){\0};
  \node[circle, draw=black] at (0, 2){\0};
  \node[circle, draw=black] at (1, 2){\0};
  \node[rectangle, draw=black] at (2, 2){\0};
  \node[rectangle, draw=black] at (3, 2){\0};
  \node[circle, draw=black] at (4, 2){\0};
  \node[rectangle, draw=black] at (5, 2){\0};
\end{tikzpicture}
\]
\vspace{2em}
\[
\begin{tikzpicture}
  \node[circle, draw=black] at (0, 3){\0};
  \node[rectangle, draw=black] at (1, 3){\0};
  \node[rectangle, draw=black] at (2, 3){\0};
  \node[rectangle, draw=black] at (3, 3){\0};
  \node[circle, draw=black] at (4, 3){\0};
  \node[circle, draw=black] at (5, 3){\0};
  \node[circle, draw=black] at (0, 2){\0};
  \node[circle, draw=black] at (1, 2){\0};
  \node[circle, draw=black] at (2, 2){\0};
  \node[circle, draw=black] at (3, 2){\0};
  \node[circle, draw=black] at (4, 2){\0};
  \node[rectangle, draw=black] at (5, 2){\0};
\end{tikzpicture}
\]
\end{figure}




%=====================================================================
\section{Final remarks}

It seems our three lemmas effectively compute $C(u)$ for $u \in \{1,2\}^n$. Can this be done in a more transparent manner (pairs of labelled periodic Dyck paths come to mind)?

Does our proof have any implications for the work of Danilov and Koshevoy?

\vspace{10cm} 

\begin{figure}
\[
\begin{tikzpicture}
  \node at (0, 3){1};
  \node at (1, 3){2};
  \node at (2, 3){2};
  \node at (3, 3){2};
  \node at (4, 3){1};
  \node at (5, 3){2};
  \node at (6, 3){2};
  \node at (7, 3){2};

  \node[circle, draw=black] at (0,2){\0};
  \node[circle, draw=black] at (1,2){\0};
  \node[circle, draw=black] at (2,2){\0};
  \node[circle, draw=black] at (3,2){\0};
  \node[circle, draw=black] at (4,2){\0};
  \node[rectangle, draw=black] at (5,2){\0};
  \node[rectangle, draw=black] at (6,2){\0};
  \node[circle, draw=black] at (7,2){\0};

  \node at (0,5){\textrm{unbalanced}};
  \draw (3.5,1)--(3.5,3);
  \node at (5,5){\textrm{balanced}};
  \node at (0,4){i};
  \node at (7,4){j};
\end{tikzpicture}\]
\caption{A typical situation in Lemma~\ref{le:UB} (when there is no balanced block contained in $\inter(i,j)$). Here $k=3$. In the proof, we consider the case when the circles at $i$ and $i+1$ are labelled $(1,1)$ and when they are labelled $(1,2)$ separately.}
\end{figure}

\begin{figure}
\[
\begin{tikzpicture}{scale=0.9}
  \node at (0,2){3};
  \node at (1,2){2};
  \node at (2,2){1};
  \node at (3,2){3};
  \node at (4,2){2};
  \node at (5,2){2};
  \node at (6,2){1};

  \node[circle,draw=black]    at (0, 1){1};
  \node[rectangle,draw=black] at (1, 1){3};
  \node[circle,draw=black]    at (2, 1){1};
  \node[rectangle,draw=black] at (3, 1){4};
  \node[circle,draw=black]    at (4, 1){2};
  \node[circle,draw=black]    at (5, 1){2};
  \node[rectangle,draw=black] at (6, 1){4};
\end{tikzpicture}
\]
\caption{Here, $n = 7$, $r=4$, $q = \{1,3,5,6\}$ and $u = 3213221$ then $v = q(u) = 1314224$.}
\end{figure}

\begin{figure}
\[
\begin{tikzpicture}
  \node at (0,6){i};
  \node at (5,6){j};
  \node at(-2,5){u:};
  \node at(-2,4){$q_1$:};
  \node at(-1,5){$\dots$};
  \node at(-1,4){$\dots$};
  \node at (6,5){$\dots$};
  \node at (6,4){$\dots$};
  \node at (0,5){1};
  \node at (1,5){2};
  \node at (2,5){1};
  \node at (3,5){1};
  \node at (4,5){2};
  \node at (5,5){2};
  \node[rectangle,draw=black] at (0, 4){3};
  \node[rectangle,draw=black] at (1, 4){3};
  \node[circle,draw=black]    at (2, 4){1};
  \node[circle,draw=black]    at (3, 4){1};
  \node[rectangle,draw=black] at (4, 4){3};
  \node[circle,draw=black]    at (5, 4){1};

  \node at(-2,2){$u_{i\leftrightarrow j}$:};
  \node at(-2,1){$q_1$:};
  \node at(-1,2){$\dots$};
  \node at(-1,1){$\dots$};
  \node at (6,2){$\dots$};
  \node at (6,1){$\dots$};
  \node at (0,2){2};
  \node at (1,2){2};
  \node at (2,2){1};
  \node at (3,2){1};
  \node at (4,2){2};
  \node at (5,2){1};
  \node[rectangle,draw=black] at (0, 1){3};
  \node[rectangle,draw=black] at (1, 1){3};
  \node[circle,draw=black]    at (2, 1){1};
  \node[circle,draw=black]    at (3, 1){1};
  \node[rectangle,draw=black] at (4, 1){3};
  \node[circle,draw=black]    at (5, 1){1};
\end{tikzpicture}
\]
\caption{A BB-swap.}
\end{figure}

\begin{figure}
\[
\begin{tikzpicture}
\draw (-0.5,6)--(-0.5,3);
\draw (5.5,6)--(5.5,3);
  \node at(-2,6){2};
  \node at(-1,6){2};
  \node at (0,6){1};
  \node at (1,6){2};
  \node at (2,6){1};
  \node at (3,6){2};
  \node at (4,6){1};
  \node at (5,6){2};
  \node at (6,6){1};
  \node at (7,6){2};
  \node[circle,draw=black] at (0, 5){1};
  \node[rectangle,draw=black] at (1, 5){3};
  \node[circle,draw=black] at (2, 5){1};
  \node[rectangle, draw=black] at (3, 5){3};
  \node[circle,draw=black] at (4, 5){1};
  \node[rectangle,draw=black] at (5, 5){3};
  \node[rectangle,draw=black] at (0, 4){4};
  \node[circle, draw=black] at (1, 4){1};
  \node[rectangle,draw=black] at (2, 4){4};
  \node[rectangle,draw=black] at (3, 4){4};
  \node[circle,draw=black] at (4, 4){1};
  \node[circle, draw=black] at (5, 4){1};
  \node[circle,draw=black] at (-1, 5){\0};
  \node[circle,draw=black] at (-2, 5){\0};
  \node at (-3,5){\dots};
  \node[circle,draw=black] at (6, 5){\0};
  \node[circle,draw=black] at (7, 5){\0};
  \node at (8,5){\dots};
\end{tikzpicture}
\]
\[
\begin{tikzpicture}
  \node at(-2,6){2};
  \node at(-1,6){2};
  \node at (0,6){1};
  \node at (1,6){2};
  \node at (2,6){1};
  \node at (3,6){2};
  \node at (4,6){1};
  \node at (5,6){2};
  \node at (6,6){1};
  \node at (7,6){2};

\draw (-0.5,6)--(-0.5,3);
\draw (5.5,6)--(5.5,3);
  \node[circle,draw=black] at (0, 5){1};
  \node[rectangle,draw=black] at (1, 5){3};
  \node[circle,draw=black] at (2, 5){1};
  \node[rectangle, draw=black] at (3, 5){3};
  \node[circle,draw=black] at (4, 5){1};
  \node[rectangle,draw=black] at (5, 5){3};

  \node[rectangle,draw=black] at (0, 4){4};
  \node[circle, draw=black] at (1, 4){1};
  \node[rectangle,draw=black] at (2, 4){4};
  \node[rectangle,draw=black] at (3, 4){4};
  \node[circle,draw=black] at (4, 4){1};
  \node[circle, draw=black] at (5, 4){1};
  
  \node[rectangle,draw=black] at (-1, 5){\0};
  \node[rectangle,draw=black] at (-2, 5){\0};
  \node at (-3,5){$\dotsm$};

  \node[rectangle,draw=black] at (6, 5){\0};
  \node[rectangle,draw=black] at (7, 5){\0};
  \node at (8,5){$\dotsm$};
\end{tikzpicture}
\]
\caption{A balanced block $B$ in $C$ (above) and in $C'$ (below), together with an input word $u = \dotsm 2212121212 \dotsm$ such that $T(k) \in \{(1,\bigcirc),(2,\square)\}$ for $k \in B$.}
\end{figure}

%=====================================================================

\begin{example}
Looking at queues, we get
\begin{align*}
[13234] & = x_1 x_2 x_3^2 x_4 (x_1^2 + x_1 x_4 + x_1 x_5 + x_4 x_5 + x_5^2)
\\ [13245] & = x_1 x_2 x_3^2 x_4 (x_1^2 + x_1x_4 + x_1x_5 + x_4^2 + x_4x_5 + x_5^2)
\\ & \hspace{20pt} \times (x_1x_2x_3 + x_1x_2x_5+x_1x_3x_5+x_2x_3x_5)
\\ [14235] & = x_1x_2x_3^2x_4^2 (x_1^3x_2 + x_1^3x_3 + x_1^3x_5 + x_1^2x_2x_3 + x_1^2x_2x_4 + 2x_1^2x_2x_5 + x_1^2x_3x_4
\\ & \hspace{55pt} + 2x_1^2x_3x_5 + x_1^2x_4x_5 + x_1^2x_5^2 + x_1x_2x_3x_5 + x_1x_2x_4x_5 + 2x_1x_2x_5^2
\\ & \hspace{55pt} + x_1x_3x_4x_5 + 2x_1x_3x_5^2 + x_1x_4x_5^2 + x_1x_5^3 + x_2x_3x_5^2 + x_2x_4x_5^2
\\ & \hspace{55pt} + x_2x_5^3 + x_3x_4x_5^2 + x_3x_5^3)
\end{align*}
(We have factored the expressions for readability only.)

The projection formula states that $[13234] e_3(x) = [13245] + [14235]$, as we can check directly in this case.
\end{example}


\begin{comment}
{\bf Example.} 
$(S_1, S_2)$:
\scalebox{0.4}{
\begin{tikzpicture}
  \node[circle, draw=black] at (01, 2){\phantom{c}};
  \node[circle, draw=black] at (02, 2){\phantom{c}};
  \node[circle, draw=black] at (03, 2){\phantom{c}};
  \node[circle, draw=black] at (06, 2){\phantom{c}};
  \node[circle, draw=black] at (07, 2){\phantom{c}};
  \node[circle, draw=black] at (08, 2){\phantom{c}};
  \node[circle, draw=black] at (09, 2){\phantom{c}};
  \node[circle, draw=black] at (11, 2){\phantom{c}};
  \node[circle, draw=black] at (13, 2){\phantom{c}};
  \node[circle, draw=black] at (18, 2){\phantom{c}};
  \node[circle, draw=black] at (19, 2){\phantom{c}};
  \node[circle, draw=black] at (22, 2){\phantom{c}};
  \node[circle, draw=black] at (23, 2){\phantom{c}};
  \node[circle, draw=black] at (24, 2){\phantom{c}};
  \node[circle, draw=black] at (25, 2){\phantom{c}};
  \node[circle, draw=black] at (26, 2){\phantom{c}};

  \node[circle, draw=black] at (02, 1){\phantom{c}};
  \node[circle, draw=black] at (04, 1){\phantom{c}};
  \node[circle, draw=black] at (05, 1){\phantom{c}};
  \node[circle, draw=black] at (06, 1){\phantom{c}};
  \node[circle, draw=black] at (08, 1){\phantom{c}};
  \node[circle, draw=black] at (10, 1){\phantom{c}};
  \node[circle, draw=black] at (11, 1){\phantom{c}};
  \node[circle, draw=black] at (12, 1){\phantom{c}};
  \node[circle, draw=black] at (14, 1){\phantom{c}};
  \node[circle, draw=black] at (16, 1){\phantom{c}};
  \node[circle, draw=black] at (17, 1){\phantom{c}};
  \node[circle, draw=black] at (19, 1){\phantom{c}};
  \node[circle, draw=black] at (20, 1){\phantom{c}};
  \node[circle, draw=black] at (21, 2){u};
  \node[circle, draw=black] at (22, 1){\phantom{c}};
  \node[circle, draw=black] at (24, 1){\phantom{c}};
  \node[circle, draw=black] at (26, 1){\phantom{c}};
\end{tikzpicture}
}
\vspace{2cm}
$(T_1,T_2)$:
\scalebox{0.4}{
\begin{tikzpicture}
  \node[circle, draw=black] at (01, 2){\phantom{c}};
  \node[circle, draw=black] at (02, 2){\phantom{c}};
  \node[circle, draw=black] at (03, 2){\phantom{c}};
  \node[circle, draw=black] at (06, 2){\phantom{c}};
  \node[circle, draw=black] at (07, 2){\phantom{c}};
  \node[circle, draw=black] at (08, 2){\phantom{c}};
  \node[circle, draw=black] at (09, 2){\phantom{c}};
  \node[circle, draw=black] at (11, 2){\phantom{c}};
  \node[circle, draw=black] at (13, 2){\phantom{c}};
  \node[circle, draw=black] at (18, 2){\phantom{c}};
  \node[circle, draw=black] at (19, 2){\phantom{c}};
  \node[circle, draw=black] at (22, 2){\phantom{c}};
  \node[circle, draw=black] at (23, 2){\phantom{c}};
  \node[circle, draw=black] at (24, 2){\phantom{c}};
  \node[circle, draw=black] at (25, 2){\phantom{c}};
  \node[circle, draw=black] at (26, 2){\phantom{c}};

  \node[circle, draw=black] at (02, 1){\phantom{c}};
  \node[circle, draw=black] at (04, 1){\phantom{c}};
  \node[circle, draw=black] at (05, 1){\phantom{c}};
  \node[circle, draw=black] at (06, 1){\phantom{c}};
  \node[circle, draw=black] at (08, 1){\phantom{c}};
  \node[circle, draw=black] at (10, 1){\phantom{c}};
  \node[circle, draw=black] at (11, 1){\phantom{c}};
  \node[circle, draw=black] at (12, 1){\phantom{c}};
  \node[circle, draw=black] at (14, 1){\phantom{c}};
  \node[circle, draw=black] at (16, 1){\phantom{c}};
  \node[circle, draw=black] at (17, 1){\phantom{c}};
  \node[circle, draw=black] at (19, 1){\phantom{c}};
  \node[circle, draw=black] at (20, 1){\phantom{c}};
  \node[circle, draw=black] at (21, 1){u};
  \node[circle, draw=black] at (22, 1){\phantom{c}};
  \node[circle, draw=black] at (24, 1){\phantom{c}};
  \node[circle, draw=black] at (26, 1){\phantom{c}};
\end{tikzpicture}
}
\end{comment}
\begin{comment}
\subsection{Multiline queues}

%\begin{dfn} \label{def.mlqs.mlq}
Fix a nonnegative integer $n$.
A \defn{multiline queue (MLQ)} is an $(n+1)$-tuple $(S_0, S_1, \dotsc, S_n)$ such that $S_0 = \emptyset$ and, for all $1 \leq i \leq n$, we have $S_i \subseteq \ive{N}$ and $\lvert S_{i-1} \rvert < \lvert S_i \rvert$.
We shall represent an MLQ $\tup{S_0, S_1, \ldots, S_n}$ as an
$n \times N$-array, each row of which has some of its boxes
marked. Namely, for each $i \in \set{1, 2, \ldots, n}$ and
each $j \in S_i$, we mark the $j$-th box in row $i$.
(The rows and the columns are indexed as usual for a matrix.)
%\end{dfn}

For example, $\tup{\varnothing, \set{2, 4}, \set{1, 4, 5}}$
is an MLQ for $n = 2$ and $N = 6$; we draw it as follows:
\[
\begin{tikzpicture}[scale=0.7, every node/.style={scale=0.7}]
  \mlnode{2, 2}
  \mlnode{4, 2}
  \mlnode{1, 1}
  \mlnode{4, 1}
  \mlnode{5, 1}
\end{tikzpicture}
\]

\begin{remark}
Our notion of an MLQ corresponds to what is called a ``discrete MLQ'' in~\cite[\S 2.2]{AasLin17}.
We omit the word ``discrete'', as we will not encounter any other kind of MLQs.
\end{remark}

Let $\MLQ = (S_0, \dotsc, S_n)$ be an MLQ.
The \defn{type} of $\MLQ$ is the  $n$-tuple $\mm = \tup{m_1, m_2, \ldots, m_n}$ of
positive
% positive, not just nonnegative, since we required the S_i to strictly grow in size
integers such that $\abs{S_i} = m_1 + m_2 + \cdots + m_i$.
(In particular, $S_0 = \varnothing$.)

In order to define the labeling of an MLQ, we need to setup some notation.

If $p$ is an element of $\ive{N}$,
and if $S$ is a nonempty subset of $\ive{N}$,
then an element $\min_p S$ of $S$ is defined as follows:
If there exists an element of $S$ that is greater
or equal to $p$, then we set $\min_p S$ to be the
smallest such element;
otherwise, we set $\min_p S$ to be the smallest
element of $S$.
(Roughly speaking, $\min_p S$ is the first element
of $S$ you encounter when traversing the elements
$p, p+1, \ldots, n, 1, 2, \ldots, p-1$.)

Let $U$ and $V$ be two subsets of $\ive{N}$ satisfying
$\abs{U} \leq \abs{V}$.
Let $f \colon U \to \ive{n}$ be any map; we shall
refer to it as a ``labeling'', and we shall refer an
image $f \tup{u}$ as the ``label'' of $u$ in $f$.
Let $k$ be a positive integer.
We define the map $f \downarrow_{V, k} : V \to \ive{n}$
as follows (recursively over $\abs{U}$):

\begin{itemize}
 \item If $U = \varnothing$, then $f \downarrow_{V, k}$ sends
       each element of $V$ to $k$.
 \item Otherwise, pick an element $u$ of $U$ having minimum
       label (i.e., having minimum $f \tup{u}$).
       Let $v = \min_u V$.
       Let $g$ be the restriction of $f$ to the subset
       $U \setminus \set{u}$.
       Let $g' = g \downarrow_{V \setminus \set{v}, k}$.
       Then, the labeling $f \downarrow_{V, k}$ is defined by
       setting
       \[
        \tup{f \downarrow_{V, k}} \tup{s}
        =
        \begin{cases}
         f \tup{u}, & \text{ if } s = v; \\
         g \tup{s}, & \text{ if } s \neq v
        \end{cases}
        \qquad \text{ for all } s \in V .
       \]
\end{itemize}

\darij{Remember to fix the spelling of ``labelling''.}

\begin{prop} \label{prop.mlqs.down.indep}
Let $U$ and $V$ be two subsets of $\ive{N}$ satisfying $\abs{U} \leq \abs{V}$.
Let $f \colon U \to \ive{n}$.
Let $k$ be a positive integer.
The definition of $f \downarrow_{V, k}$ given above does not
depend on the choice of $u$.
\end{prop}

\begin{proof}
We can replace this definition by an equivalent one, which
clearly does not depend on any choices:

For any $p \in \ive{N}$, we define a subset
$\operatorname{arc}\ive{p : s}$ of $\ive{N}$ by
\[
\operatorname{arc}\ive{p : s}
=
\begin{cases}
\set{p, p+1, \ldots, s}, & \text{ if } p \leq s; \\
\set{p, p+1, \ldots, N, 1, 2, \ldots, s}, & \text{ if } p > s
\end{cases} .
\]

For any $0 \leq i \leq n$, we let $f^{-1} \tup{\leq i}$ be
the subset
$f^{-1} \tup{\ive{i}} = \set{u \in U \mid f \tup{u} \leq i}$
of $U$.

Let $s \in V$.
If there exists some $i \in \ive{n}$ and some
$p \in \ive{N}$ such that the set
$\operatorname{arc}\ive{p : s}$
contains at least as many elements of $f^{-1} \tup{\leq i}$
as it contains elements of $V$.
(that is, it satisfies
\[
\abs{\operatorname{arc}\ive{p : s} \cap f^{-1} \tup{\leq i}}
\geq \abs{\operatorname{arc}\ive{p : s} \cap V}
\]
),
then we pick the smallest $i$ for which this holds, and we set $\tup{f \downarrow_{V, k}}\tup{s} = i$.
Otherwise, we set $\tup{f \downarrow_{V, k}}\tup{s} = k$.

[The condition
``$\abs{\operatorname{arc}\ive{p : s} \cap f^{-1} \tup{\leq i}}
\geq \abs{\operatorname{arc}\ive{p : s} \cap V}$
for some $p \in \ive{N}$''
can also be restated as follows:
If we define a circular word on $N$ letters whose $q$-th letter
is
\[
\begin{cases}
(, & \text{ if } q \in f^{-1} \tup{\leq i} \setminus V, \\
), & \text{ if } q \in V \setminus f^{-1} \tup{\leq i}, \\
0, & \text{ otherwise},
\end{cases}
\]
and if we match parentheses as usual for a circular word
(this means, in particular, that the last $($ can match the
first $)$),
then the $s$-th letter is either $0$ or a matched parenthesis.
This is strongly reminiscent of the Remmel-Shimozono proof
of the LR rule, and suggests that something coplactic is
going on.]
\Travis{It is not surprising to me that something coplactic is running around in the background because of the $R$-matrix interpretation by Kuniba and co. Coplactic operators are crystal operators and $R$-matrices are crystal isomorphisms. We might be able to get the proof for free by appealing to that perspective.}

......
\end{proof}

\begin{dfn}
The \defn{labeling} of $\MLQ$ is the tuple $(f_0, f_1, \dotsc, f_n)$ given recursively as follows.
Define $f_0 \colon S_0 \to \ive{n}$ in the obvious way (since $S_0 = \varnothing$) and then define $f_i$ by $f_i = f_{i-1} \downarrow_{S_i, i}$.

We define the \defn{bottom row labels} of an MLQ $\MLQ$ with $S_n = (b_1 < b_2 < \cdots < b_n)$ to be $\tup{f_n(b_1), f_n(b_2), \dotsc, f_n(b_n)}$.
\end{dfn}

\begin{dfn} \label{def.mlq.sw}
Let $\MLQ = \tup{S_0, S_1, \ldots, S_n}$ be an MLQ of type $\mm$.
The \defn{spectral weight} $\wt\tup{\MLQ}$
of $\MLQ$ is defined to be the monomial
\[
 \prod_{i=0}^{n-1} \prod_{s \in S_i} x_s
\]
in the indeterminates $x_1, x_2, \ldots, x_N$.
\end{dfn}


%\subsection{Flagged Schur functions}
%
%Let $\lambda$ be a partition of length $m$ and $b = (b_1 \leq b_2 \leq \cdots \leq b_m)$.
%Let
%\[
%h_d(k) = \sum_{i_1 \leq \cdots \leq i_d \leq k} x_{i_1} \cdots x_{i_d}
%\]
%be the complete homogeneous symmetric function of degree $d$ in the variables $x_1, \dotsc, x_k$.
%A \defn{flagged Schur function} is
%\[
%\fs_{\lambda}(b; \xx) = \det\big[ h_{\lambda_i - i + j}(b_i) \bigr]_{i,j=1}^m.
%\]
%We can also express the flagged Schur function combinatorially using $\mcF_{\lambda}(b)$, the semistandard tableaux of shape $\lambda$ such that the max entry in row $i$ is at most $b_i$.
%From~\cite{Wachs85}, we have
%\[
%\fs_{\lambda}(b; \xx) = \sum_{T \in \mcF_{\lambda}(b)} x^T.
%\]
\end{comment}


\bibliographystyle{alpha}
\bibliography{queue}{}
\end{document}
