\documentclass[reqno]{amsart}
\usepackage{setspace,tikz,xcolor,mathrsfs,listings,multicol}
\usepackage{amssymb}
\usepackage{rotating}
\usepackage[vcentermath]{youngtab}
\usepackage{enumerate}
\usepackage[all,cmtip]{xy}
\usetikzlibrary{arrows,matrix}
\usepackage{comment}
\usepackage{color}
\usepackage[sc]{mathpazo}
\usepackage[T1]{fontenc}
\usepackage{needspace}
\usepackage{tabls}
%\usepackage{amsmath}
%\usepackage{amsthm}
%\usepackage{subcaption}
%\usepackage{fullpage}
%\usepackage[margin=1.25in]{geometry}
%\onehalfspacing

\usepackage[colorlinks=true, pdfstartview=FitV, linkcolor=blue, citecolor=blue, urlcolor=blue]{hyperref}

% use these commands for typesetting doi and arXiv references in the bibliography
\newcommand{\doi}[1]{\href{http://dx.doi.org/#1}{\texttt{doi:#1}}}
\newcommand{\arxiv}[1]{\href{http://arxiv.org/abs/#1}{\texttt{arXiv:#1}}}

\newcommand{\iso}{\cong}
%\newcommand{\qedbox}{\rule{2mm}{2mm}}
%\renewcommand{\qedsymbol}{\qedbox}
\newcommand{\qbinom}[3]{\genfrac{[}{]}{0pt}{}{#1}{#2}_{#3}}
\newcommand{\absval}[1]{\left\lvert #1 \right\rvert}
\newcommand{\case}[1]{\vspace{12pt}\noindent\underline{#1}:}
\newcommand{\fs}{\mathcal{S}} % flagged Schur function
\newcommand{\mbf}{\mathbf}
\newcommand{\0}{\phantom{c}}
\newcommand{\swt}[1]{\left\langle #1 \right\rangle} % Spectral weight or amplitude
\newcommand{\merge}[1]{\vee_{#1}} % merge
\newcommand{\SymGp}[1]{\mathfrak{S}_{#1}} % symmetric group

\DeclareMathOperator{\supp}{supp} % Support
\DeclareMathOperator{\inter}{int} % queuing interval
\DeclareMathOperator{\wt}{wt} % weight
\DeclareMathOperator{\pr}{pr} % promotion
\DeclareMathOperator{\id}{id} % identity
\DeclareMathOperator{\ch}{ch} % character
\DeclareMathOperator{\gr}{gr} % grading

\newcommand{\xx}{\mathbf{x}}
\newcommand{\mm}{\mathbf{m}}
\newcommand{\nn}{\mathbf{n}}
\newcommand{\qq}{\mathbf{q}}
\newcommand{\MLQ}{\mathbf{S}}

\newcommand{\mcA}{\mathcal{A}}
\newcommand{\mcF}{\mathcal{F}}
\newcommand{\mcM}{\mathcal{M}}
\newcommand{\mcW}{\mathcal{W}}
\newcommand{\mcI}{\mathcal{I}}

\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\CC}{\mathbb{C}}

\newcommand{\bze}{\overline{0}}
\newcommand{\bon}{\overline{1}}
\newcommand{\btw}{\overline{2}}
\newcommand{\bth}{\overline{3}}
\newcommand{\bfo}{\overline{4}}
\newcommand{\bfive}{\overline{5}}
\newcommand{\bsix}{\overline{6}}
\newcommand{\bseven}{\overline{7}}
\newcommand{\beight}{\overline{8}}
\newcommand{\bi}{\overline\imath}
\newcommand{\bk}{\overline{k}}
\newcommand{\brr}{\overline{r}}
\newcommand{\bn}{\overline{n}}
\newcommand{\ellbar}{\overline{\ell}}

\let\sumnonlimits\sum
\let\prodnonlimits\prod
\let\cupnonlimits\bigcup
\let\capnonlimits\bigcap
\renewcommand{\sum}{\sumnonlimits\limits}
\renewcommand{\prod}{\prodnonlimits\limits}
\renewcommand{\bigcup}{\cupnonlimits\limits}
\renewcommand{\bigcap}{\capnonlimits\limits}

\newenvironment{verlong}{}{}
\newenvironment{vershort}{}{}
\newenvironment{noncompile}{}{}
\excludecomment{verlong}
\includecomment{vershort}
\excludecomment{noncompile}
\newcommand{\rev}{\operatorname{rev}}
\newcommand{\conncomp}{\operatorname{conncomp}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\powset}[2][]{\ifthenelse{\equal{#2}{}}{\mathcal{P}\left(#1\right)}{\mathcal{P}_{#1}\left(#2\right)}}
% $\powset[k]{S}$ stands for the set of all $k$-element subsets of
% $S$. The argument $k$ is optional, and if not provided, the result
% is the whole powerset of $S$.
\newcommand{\set}[1]{\left\{ #1 \right\}}
% $\set{...}$ yields $\left\{ ... \right\}$.
\newcommand{\abs}[1]{\left| #1 \right|}
% $\abs{...}$ yields $\left| ... \right|$.
\newcommand{\tup}[1]{\left( #1 \right)}
% $\tup{...}$ yields $\left( ... \right)$.
\newcommand{\ive}[1]{\left[ #1 \right]}
% $\ive{...}$ yields $\left[ ... \right]$.
\newcommand{\verts}[1]{\operatorname{V}\left( #1 \right)}
% $\verts{...}$ yields $\operatorname{V}\left( ... \right)$.
\newcommand{\edges}[1]{\operatorname{E}\left( #1 \right)}
% $\edges{...}$ yields $\operatorname{E}\left( ... \right)$.
\newcommand{\arcs}[1]{\operatorname{A}\left( #1 \right)}
% $\arcs{...}$ yields $\operatorname{A}\left( ... \right)$.
\newcommand{\underbrack}[2]{\underbrace{#1}_{\substack{#2}}}
% $\underbrack{...1}{...2}$ yields
% $\underbrace{...1}_{\substack{...2}}$. This is useful for doing
% local rewriting transformations on mathematical expressions with
% justifications.
\newcommand{\mlnode}[1]{\node[circle, draw=black] at (#1){\phantom{c}};}

% Dark red emphasis
\definecolor{darkred}{rgb}{0.7,0,0} % darkred color
\newcommand{\defn}[1]{{\color{darkred}\emph{#1}}} % emphasis of a definition

%% For typesetting code listings                                                
\usepackage{listings}
\lstdefinelanguage{Sage}[]{Python}
{morekeywords={False,sage,True},sensitive=true}
\lstset{
  frame=single,
  showtabs=False,
  showspaces=False,
  showstringspaces=False,
  commentstyle={\ttfamily\color{dgreencolor}},
  keywordstyle={\ttfamily\color{dbluecolor}\bfseries},
  stringstyle={\ttfamily\color{dgraycolor}\bfseries},
  language=Sage,
  basicstyle={\footnotesize\ttfamily},
  aboveskip=0.75em,
  belowskip=0.75em,
  xleftmargin=.15in,
}
\definecolor{dblackcolor}{rgb}{0.0,0.0,0.0}
\definecolor{dbluecolor}{rgb}{0.01,0.02,0.7}
\definecolor{dgreencolor}{rgb}{0.2,0.4,0.0}
\definecolor{dgraycolor}{rgb}{0.30,0.3,0.30}
\newcommand{\dblue}{\color{dbluecolor}\bf}
\newcommand{\dred}{\color{dredcolor}\bf}
\newcommand{\dblack}{\color{dblackcolor}\bf}

\usepackage{xparse}

\makeatletter
% \specialmergetwolists{<coupler>}{<list1>}{<list2>}{<return macro>}
% \specialmergetwolists*{<coupler>}{<listcmd1>}{<listcmd2>}{<return macro>}
\protected\def\specialmergetwolists{%
  \begingroup
  \@ifstar{\def\cnta{1}\@specialmergetwolists}
    {\def\cnta{0}\@specialmergetwolists}%
}
\def\@specialmergetwolists#1#2#3#4{%
  \def\tempa##1##2{%
    \edef##2{%
      \ifnum\cnta=\@ne\else\expandafter\@firstoftwo\fi
      \unexpanded\expandafter{##1}%
    }%
  }%
  \tempa{#2}\tempb\tempa{#3}\tempa
  \def\cnta{0}\def#4{}%
  \foreach \x in \tempb{%
    \xdef\cnta{\the\numexpr\cnta+1}%
    \gdef\cntb{0}%
    \foreach \y in \tempa{%
      \xdef\cntb{\the\numexpr\cntb+1}%
      \ifnum\cntb=\cnta\relax
        \xdef#4{#4\ifx#4\empty\else,\fi\x#1\y}%
        \breakforeach
      \fi
    }%
  }%
  \endgroup
}
\makeatother

\theoremstyle{plain}
\newtheorem{thm}{Theorem}[section]
\newtheorem{lemma}[thm]{Lemma}
\newtheorem{conj}[thm]{Conjecture}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{cor}[thm]{Corollary}
\theoremstyle{definition}
\newtheorem{dfn}[thm]{Definition}
\newtheorem{example}[thm]{Example}
\newtheorem{remark}[thm]{Remark}
\numberwithin{equation}{section}
%\numberwithin{figure}{section}
%\numberwithin{table}{section}
%\setcounter{section}{-1}

% For breaking equations across multiple pages
% \allowdisplaybreaks[1]

\usepackage[colorinlistoftodos]{todonotes}
\newcommand{\erik}[1]{\todo[size=\tiny,color=green!30]{#1 \\ \hfill --- Erik}}
\newcommand{\Erik}[1]{\todo[size=\tiny,inline,color=green!30]{#1
      \\ \hfill --- Erik}}
\newcommand{\darij}[1]{\todo[size=\tiny,color=red!30]{#1 \\ \hfill --- Darij}}
\newcommand{\Darij}[1]{\todo[size=\tiny,inline,color=red!30]{#1
      \\ \hfill --- Darij}}
\newcommand{\travis}[1]{\todo[size=\tiny,color=blue!30]{#1 \\ \hfill --- Travis}}
\newcommand{\Travis}[1]{\todo[size=\tiny,inline,color=blue!30]{#1
      \\ \hfill --- Travis}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
\title[MLQs]{Multiline queues with spectral parameters}

\author[E.~Aas]{Erik Aas}
\address[E. Aas]{Department of Mathematics, Pennsylvania State University, McAllister Building, State College, PA 116802, USA}
\email{eaas@kth.se}

\author[D.~Grinberg]{Darij Grinberg}
\address[D. Grinberg]{School of Mathematics, University of Minnesota, 206 Church St. SE, Minneapolis, MN 55455}
\email{darij.grinberg@gmail.com}
\urladdr{http://www.cip.ifi.lmu.de/~grinberg/}

\author[T.~Scrimshaw]{Travis Scrimshaw}
\address[T. Scrimshaw]{School of Mathematics and Physics, University of Queensland, St. Lucia, QLD 4072, Australia}
\email{tcscrims@gmail.com}
\urladdr{https://sites.google.com/view/tscrim/home}

\date{\today}

\keywords{multiline queue, TASEP, R-matrix, symmetric function}
\subjclass[2010]{
60C05,  % Combinatorial probability
05A19,  % Combinatorial identities, bijective combinatorics
16T25,  % Yang--Baxter equations
05E05}  % Symmetric functions

\thanks{TS was partially supported by the Australian Research Council DP170102648 and the National Science Foundation RTG grant DMS-1148634.}

\begin{abstract}
Using the description of multiline queues as functions on words, we introduce the notion of a spectral weight of a word by defining a new weighting on multiline queues.
We show that the spectral weight of a word is invariant under a natural action of the symmetric group, giving a proof of the commutativity conjecture of Arita, Ayyer, Mallick, and Prolhac.
We give a determinant formula for the spectral weight of a word, which gives a proof of a conjecture of the first author and Linusson.
\end{abstract}

\maketitle

%=====================================================================
\section{Introduction}
\label{sec:introduction}

One of the fundamental models of particles moving in a 1-dimensional lattice is the asymmetric simple exclusion process (ASEP) and has received broad attention in many different variations.
The earliest known publication of the ASEP was done to model the dynamics of ribosomes along RNA~\cite{MGP68}.
For statistical mechanics, it is a model for gas particles in a lattice with an induced current, where the exclusion mimics the short-range interactions among the particles.
Despite admitting very simple descriptions of the particle dynamics, the ASEP has very rich macroscopic behaviors, such as
\begin{itemize}
\item boundary-induced phase transitions~\cite{Krug91},
\item spontaneous symmetry breaking with possibly multiple broken symmetry phases~\cite{AHR98,AHR99,CEM01,EFGM95,EPSZ05,GLEMSS95,PK07},
\item describing the formations of shocks~\cite{DJLS93,Ferrari92,FF94,FF94II,Liggett76}, and
\item phase separation and condensation~\cite{EKKM98,JNHWW09,KLMST02,RSS00}.
\end{itemize}
We also refer the reader to~\cite{PEM09,Schutz01,SZ95,TJHJ16} and references therein.

The term exclusion process was coined by Spitzer~\cite{Spitzer70}, where he was focused on an application with Brownian motion with hard-core interactions.
Moreover, it was~\cite{Spitzer70} that initiated the investigation of exclusion processes using probability theory.
However, the applications of the ASEP (and its variations) has since spread to other areas, such as
\begin{itemize}
\item transportation processes in capillary vessels~\cite{Levitt73} or proteins within the cells along actin filaments~\cite{KNL05},
\item anistropic conductors known as solid electrolytes~\cite{CL99},
\item discrete models of traffic flow~\cite{Schad01},
\item partition growth processes~\cite{Lam15},
\item random matrix theory~\cite{Johansson00,TW09}, and
\item moments of Askey--Wilson polynomials~\cite{CW11}.
\end{itemize}

If we prohibit the particles from moving backwards, we obtain the totally asymmetric exclusion process (TASEP), a non-equilibrium stochastic process that has its own vast literature.
For example, we refer the reader to~\cite{AasLin17,AAMP,BE07,BP14,DEHP93,KMO15,KMO16,Liggett99} and references therein.
In this paper, we consider the TASEP on a ring with $n$ sites and $\ell$ species of particles.
Thus, we will consider the states to be words $u$ in the alphabet $\{1, \dotsc, \ell\}$ of length $n$, where we take the indices to be $\ZZ / n \ZZ$.
We will also consider our process to be discrete in time, where our transition map interchanges a pair $u_i u_{i+1}$ with $u_i > u_{i+1}$ to $u_{i+1} u_i$ and is done at a uniform rate.

The steady state of the TASEP on a ring is known in terms of another process using ordinary multiline queues (MLQs) and applying the Ferrari--Martin (FM) algorithm~\cite{FM06,FM07}.
This is a generalization of 2-line queues used by Angel~\cite{Angel06} and the work of Ferrari, Fontes, and Kohayakawa~\cite{FFK94}.
In~\cite{KMO15,KMO16}, the FM algorithm was reformulated in terms of the combinatorial $R$-matrix~\cite{NY97,Shimozono02} and using type $A_{n-1}^{(1)}$ Kirillov--Reshetikhin crystals~\cite{KKMMNN92}.
This interpretation gives a connection with five-vertex models, corner transfer matrices~\cite{Baxter89}, 3D integrable lattice models, and the tetrahedron equation~\cite{Zam80}, yielding a matrix product formula for the steady state distribution different than~\cite{CdGW15,EFM09,PEM09}.

In this paper, we introduce a new weighting of MLQs, which is the weight of the MLQ considered as a tensor product of Kirillov--Reshetikhin crystals.
We also interpret MLQs as functions on words of a fixed length $n$ following~\cite{AAMP}, where it was referred to as the generalized FM algorithm.
This allows us to define the spectral weight or amplitude of a word $u$ to be the sum over all the weight of all ordinary MLQs $\qq$ such that $u = \qq(1^n)$.
Furthermore, we introduce the notion of a $\sigma$-twisted MLQ, where $\sigma$ is a permutation, although this is implicitly considered in~\cite{AAMP}.
Our main result is that for a fixed permutation $\sigma$, the sum of the weights of all $\sigma$-twisted MLQs $\qq_{\sigma}$ such that $u = \qq_{\sigma}(1^n)$ equals the spectral weight of $u$.
To this end, we construct an action of the symmetric group on MLQs that corresponds, under the usual FM algorithm, to the natural action by letters on words.
This action is given by applying a combinatorial $R$-matrix to an MLQ,\footnote{This operation has also previously appeared in Danilov and Koshevoy~\cite{DanilovKoshevoy} (see also~\cite[Ch.~4]{Gorodentsev2}) and van Leeuwen~\cite[Lemma~2.3]{vanLeeuwen-dc}.} and we show that does not change the MLQ as a function on words.

As a consequence of this action and specializing our weight parameters to $1$, we obtain a proof of the commutativity conjecture of~\cite{AAMP}.
However, we note that the interlacing property of~\cite{AAMP} does not generalize to our weighting of MLQs.
Furthermore, we give a determinant expression for the spectral weight of decreasing words by using the Lindstr\"om--Gessel--Viennot Lemma~\cite{GV85,Lindstrom73}.
By combining these results, we obtain a proof of~\cite[Conj.~3.10]{AasLin17}, which in turn proves a number of other conjectures in~\cite{AasLin17}.

We note that our weighting scheme can be extended to multiline process used to determine the steady state distribution of the totally asymmetric zero range process (TARZP) on a ring, where multiple particles can occupy the same site.
This comes from the fact that the TARZP steady state distribution can also be computed using a tensor product of Kirillov--Reshetikhin crystals (under rank-level duality) using combinatorial $R$-matrices with analogous connections to corner transfer matrices and the tetrahedron equation~\cite{KMO16TARZP,KMO16TARZPII}.
Thus, we expect that a similar description of $\sigma$-twisted multiline process can be defined such that the weighting is invariant under the action of the combinatorial $R$-matrix.
However, it seems unlikely that our weighting is related to the steady state distribution for the inhomogeneous TASEP~\cite{AM13,AL14} and TARZP~\cite{KMO16II}.

This paper is organized as follows.
In Section~\ref{sec:background}, we give the necessary background and definitions of MLQs and spectral weight.
In Section~\ref{sec:result}, we give our main results.
In Section~\ref{sec:tasep}, we describe the connection between MLQs and the TASEP.
In Section~\ref{sec:thm_proof}, we give the proof of our main theorem.
In Section~\ref{sec:remarks}, we give some additional remarks about our results.


\subsection{Acknowledgements}

We thank Atsuo Kuniba for explaining the results in his papers~\cite{KMO15,KMO16II,KMO16,KMO16TARZP,KMO16TARZPII} and Olya Mandelshtam for useful discussions on the inhomogeneous TASEP.
This work benefited from computations using \textsc{SageMath}~\cite{sage,combinat}.









%=====================================================================
\section{Background and definitions}
\label{sec:background}

Fix a positive integer $n$.
For a nonnegative integer $k$, let $\ive{k}$ denote the set $\set{1, 2, \ldots, k}$, and so $[0] = \emptyset$.
Let $\SymGp{k}$ denote the symmetric group on $\ive{k}$, and let $s_i \in \SymGp{k}$ be the simple transposition of $i$ and $i+1$.
Let $w_0 \in \SymGp{k}$ be the longest element: the reversed permutation $k (k-1) \dotsm 321$ (written in one line notation).

%%%%%%%%%%
\subsection{Words and queues}

Let $\mcW_n$ be the set of words $u = u_1 \dotsm u_n$ in the ordered alphabet $\mcA := \{1 < 2 < 3 < \cdots \}$.
We consider the indices of letters in a word to be taken modulo $n$ (that is, $u_{k+n} = u_k$ for all $k$).
Let $\xx := \{x_1, x_2, x_3, \ldots\}$ be commuting indeterminates.

The \defn{type} of a word $u$ is the vector $\mm = (m_1, m_2, \ldots)$, where $m_i$ is the number of occurrences of $i$ in $u$.
We sometimes refer to $u_i = t$ as a \defn{particle at $i$ of class $t$}.
Let $\ell = \max\{i \mid m_i \neq 0 \}$, which we say is the number of \defn{classes} in $u$ or $\mm$.
A word $u$ or type $\mm$ with $\ell$ classes is \defn{packed} if $m_i \neq 0$ for all $1 \leq i \leq \ell$.
We \defn{merge} two adjacent classes $i,i+1$ in a word $u$ to obtain a new word by replacing all occurrences of $j$ by $j-1$ in $u$ for each $j = i+1, i+2, \ldots$ in that order.
We denote the merging of $i$ and $i+1$ in $u$ by $\merge{i} u$.
Note that $\merge{i} u$ is packed whenever $u$ is packed.
For $T = \set{t_1 < \cdots < t_k} \subseteq \ive{\ell-1}$, we set $\bigvee_T u := \merge{t_1} \cdots \merge{t_k} u$.
Similarly, the merging of $i,i+1$ of a type $\mm$ is $\merge{i}(\mm) = (m_1, \dotsc, m_{i-1}, m_i + m_{i+1}, m_{i+2}, \ldots)$.

We define an \defn{$r$-queue} $q$ to be any subset of $\ive{n}$ of size $r$. When $r$ is clear, we will simply call $q$ a \defn{queue}.
The \defn{weight} of a queue $q$ is $\wt(q) := \prod_{i \in q} x_i$.
We equate $q$ with a function from $\mcW_n$ to itself defined as follows.
Fix a word $u \in \mcW_n$, and let $\mm = (m_1, m_2, \ldots)$ be the type of $u$.
Define
\begin{equation}
\label{eq:type_partial_sums}
p_i(\mm) := m_1 + m_2 + \cdots + m_i,
\end{equation}
and when $\mm$ is clear, we simply write $p_i$.
(Thus, $p_0 = 0$ and $p_i = n$ for sufficiently large $i$.)
If $r < n$, then there exists a unique $t \in \ive{\ell}$ such that
$
p_{t-1} \leq r < p_t,
$
otherwise we set $t = \ell + 1$.
The output word $v = q(u)$ will have type
\[
(m_1, \dots, m_{t-1}, r-p_{t-1}, p_{t}-r, m_{t+1}, m_{t+2}, \ldots).
\]
Note that $p_{t} - r = m_{t} + (p_{t-1} - r)$.
We think of this as splitting the class $t$ into two new classes $t$ and $t+1$, and so we call $t$ the \defn{splitting class} of $q(u)$.
The following algorithm computes $v = q(u)$.
In the beginning, no letter of $v \in \mcW_n$ is set.
We shall refer to the elements $1, 2, \ldots, n \in \ZZ / n \ZZ$ as \defn{sites}.

\begin{description}
\item[Phase I]
  Go through all $i$ such that exists a $j \notin q$ such that $v_j$ is not set and in such order that if $u_p > u_q$, then $p$ is processed before $q$.\footnote{The order in which equal letters are processed does not matter, as a simple argument shows.}
  When considering a site $i$, find the first $j$ weakly to the left (cyclically) of $i$ such that $j \notin q$ and $v_j$ is not set.
  Then set $v_j = u_i + 1$.

\item[Phase II]
  Go through all $i$ such that there exists a $j \in q$ such that $v_j$ is not set in such order that if $u_p < u_q$, then $p$ is processed before $q$.
  When considering a site $i$, find the first $j$ weakly to the right (cyclically) of $i$ such that $j \in q$ and $v_j$ is not set.
  Then set $v_j = u_i$.
\end{description}

\begin{example}
\label{ex:first_queue}
We consider the $4$-queue $q = \{1, 4, 8, 9\}$, and let $u = 346613321$.
Thus, the type of $u$ is $\mm = (2, 1, 3, 1, 0, 2, 0, \ldots)$ with $p_2 = 3$ and $p_3 = 6$, and so $t = 3$.
To compute $q(u)$, draw the following diagram
(whose upper row shows $u$, whose lower row shows $q(u)$,
and whose middle row represents the set $q$ by balls in the positions of its elements):
\[
\begin{tikzpicture}[>=latex,rounded corners,yscale=1.5,xscale=1.2,baseline=0]
\def\passwidth{3pt};
\node (i1) at (1,1) {$3$};
\node (i2) at (2,1) {$4$};
\node (i3) at (3,1) {$6$};
\node (i4) at (4,1) {$6$};
\node (i5) at (5,1) {$1$};
\node (i6) at (6,1) {$3$};
\node (i7) at (7,1) {$3$};
\node (i8) at (8,1) {$2$};
\node (i9) at (9,1) {$1$};
\node (t1) at (1,-1) {$2$};
\node (t2) at (2,-1) {$7$};
\node (t3) at (3,-1) {$7$};
\node (t4) at (4,-1) {$3$};
\node (t5) at (5,-1) {$4$};
\node (t6) at (6,-1) {$4$};
\node (t7) at (7,-1) {$5$};
\node (t8) at (8,-1) {$1$};
\node (t9) at (9,-1) {$1$};
\node[circle,draw=black] (q1) at (1,0) {};
\node[circle,draw=black] (q2) at (4,0) {};
\node[circle,draw=black] (q3) at (8,0) {};
\node[circle,draw=black] (q4) at (9,0) {};
\draw[->,red] (i4) -- (4,0.5) .. controls (3.8,0.2) and (3.5,0) .. (3.1,0) -- (2,0) -- (t2);
\draw[->,red] (i3) -- (t3);
\draw[->,red] (i2) -- (2,0.1) .. controls (1.8,-0.15) and (1.6,-0.2) .. (1.3,-0.2) -- (0,-0.2);
\draw[>->,red] (10,-0.2) -- (8,-0.2) -- (7,-0.2) -- (t7);
\draw[->,red] (i6) -- (t6);
\draw[->,red] (i7) -- (7,0) -- (5,0) -- (t5);
\draw[white,line width=\passwidth] (5,0.2) -- (7,0.2) .. controls (7.5,0.2) and (7.8,0.1) .. (q3);  % To simulate underpass
\draw[->,blue] (i5) -- (5,0.2) -- (7,0.2) .. controls (7.5,0.2) and (7.8,0.1) .. (q3);
\draw[white,line width=\passwidth] (q3) -- (t8);  % To simulate underpass
\draw[->,blue] (q3) -- (t8);
\draw[->,blue] (i9) -- (q4);
\draw[white,line width=\passwidth] (q4) -- (t9);  % To simulate underpass
\draw[->,blue] (q4) -- (t9);
\draw[white,line width=\passwidth] (1,0.2) -- (3.3,0.2) .. controls (3.7,0.2) and (3.85,0.1) .. (q2);  % To simulate underpass
\draw[->,blue] (i1) -- (1,0.2) -- (3.3,0.2) .. controls (3.7,0.2) and (3.85,0.1) .. (q2);
\draw[->,blue] (q2) -- (t4);
\draw[white,line width=\passwidth] (i8) -- (8,0.35) .. controls (9.5,0.35) .. (10,0.1);  % To simulate underpass
\draw[->,blue] (i8) -- (8,0.35) .. controls (9.5,0.35) .. (10,0.1);
\draw[>->,blue] (0,0.1) -- (q1);
\draw[white,line width=\passwidth] (q1) -- (t1);  % To simulate underpass
\draw[->,blue] (q1) -- (t1);
\end{tikzpicture}
\]
where the paths in red correspond to Phase I and those in blue are from Phase II. Hence, we have $q(346613321) = 277344511$, which has type $(2,1,1,2,1,0,2,\ldots)$.
\end{example}

Since Phase I only deals with $j \notin q$, and Phase II only with $j\in q$, these two phases commute.
We illustrate the situation $v = q(u)$ with a $2 \times n$ array, where the first row is the word $u$
and the second row has a circle labeled $v_j$ for $j \in q$ or a square labeled $v_j$ for $j \notin q$ in position $j$.
Using this convention, we can write Example~\ref{ex:first_queue} as
\[
\begin{tikzpicture}[baseline=10]
  \def\ll{0.65}   % level 2
  \foreach \i in {5,9} { \node at (\i,\ll) {$1$}; }
  \foreach \i in {8} { \node at (\i,\ll) {$2$}; }
  \foreach \i in {1,6,7} { \node at (\i,\ll) {$3$}; }
  \foreach \i in {2} { \node at (\i,\ll) {$4$}; }
  \foreach \i in {3,4} { \node at (\i,\ll) {$6$}; }
  \foreach \i in {1,4,8,9} { \draw (\i,0) circle (0.3); }
  \foreach \i in {2,3,5,6,7} { \draw (\i-.3,0-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {8,9} { \node at (\i,0) {$1$}; }
  \foreach \i in {1} { \node at (\i,0) {$2$}; }
  \foreach \i in {4} { \node at (\i,0) {$3$}; }
  \foreach \i in {5,6} { \node at (\i,0) {$4$}; }
  \foreach \i in {7} { \node at (\i,0) {$5$}; }
  \foreach \i in {2,3} { \node at (\i,0) {$7$}; }
\end{tikzpicture}
\]

\begin{comment}  % s-flow only seems to be used in this paragraph
Consider a pair $k, k+1 \pmod{n}$ of consecutive columns.
For $s > t$ the \defn{$s$-flow} from $k+1$ to $k$ is the number of $i$ such that $u_i=s$, and whose queueing interval $\inter[j,i]$ contains both $k$ and $k+1$.
Similarly, for $s < t$, the \defn{$s$-flow} from $k$ to $k+1$ is the number of $i$ such that $u_i = s$, and whose queueing interval $\inter[i,j]$ contains both $k$ and $k+1$.
\end{comment}

\begin{remark}
For all $i$ processed in Phase~I (resp.\ Phase~II), we have $u_i \geq t$ (resp.~$u_i \leq t$).
\end{remark}

There is an natural duality in the algorithm above.

\begin{lemma}[Duality]
  \label{le:dual}
  Let $q$ be a queue and $u$ be a word with $\ell$ classes.
  Define a new word $v$ by letting $v_i = \ell + 1 - u_{n+1-i}$ and a new queue $q'$ by letting $i \in q'$ if and only if $n+1-i \notin q$.
 Then $q(u)_i = \ell + 2 - q'(v)_{n+1-i}$ for all $i$.
\end{lemma}

\begin{proof}
Let $r = \abs{q}$.
Thus, $q$ is an $r$-queue, so that $q'$ is the $(n-r)$-queue obtained by reflecting $[n] \setminus q$ across the middle of $[n]$.
For a fixed $k$, we call $\ell + 1 - k$ the dual letter of $k$.
Thus, $v$ is obtained by reversing $u$ and taking the dual letters.

Phase~I (resp.~II) in the construction of $q(u)$ corresponds to Phase~II (resp.~I) in the construction of $q'(v)$ when the word is reversed and the letters are replaced by their duals.
Hence the claim follows.
\end{proof}

%\begin{remark} (Excision)
%  Fix a queue $q$ and a word $u$, and let $i,j$ be columns. Suppose that the $s$-flow from $j+1$ to $j$ equals the $s$-flow from $i+1$ to $i$ for each $s > t$, and that the $s$-flow from $i$ to $i+1$ equals the $s$-flow from $j$ to $j+1$ for each $s < t$. Then we have $q_{|\inter[i,j]^c}(u_{|\inter[i,j]^c}) = \bigl( q(u) \bigr)_{|\inter[i,j]^c}$. Here, for a (cyclic) word $u$, we let $u_{|\inter[i,j]^c}$ denote the (cyclic) word gotten from simply removing the closed (cyclic) interval $\inter[i,j]$, and similarly for $q_{|\inter[i,j]^c}$.
%\end{remark}

For the next lemma, we need a further notation:
If $u$ is a word and $f : \set{1,2,\ldots} \to \set{1,2,\ldots}$ is any map,
then $f \tup{u}$ shall mean the word obtained by applying $f$ to each letter of $u$.

\begin{lemma}[Monotonicity]
\label{le:mono}
  For any $k \in \ZZ_{\geq 1}$, let $f_k \colon \{1,2, \ldots\} \to \{1,2\}$ be given by
  \[
    f_k(x) = \begin{cases}
    1 & \text{if } x \leq k, \\
    2 & \text{if } x > k.
    \end{cases}
  \]
  Let $q$ be a queue, $u$ be any word, and $i,j \in \ive{n}$.
  We have $q(u)_i \leq q(u)_j$ if and only if $q\bigl( f_k(u) \bigr)_i \leq q\bigl( f_k(u) \bigr)_j$ for all $k \in \ZZ_{\geq 1}$.
\end{lemma}

\darij{todo: improve the below proof.}

\begin{proof}
%Let $x = q(u)_i$, $y = q(u)_j$, $x_k = q\bigl( f_k(u) \bigr)_i$ and $y_k = q\bigl( f_k(u) \bigr)_j$.
Assume $q(u)_i \leq q(u)_j$.
Let $t$ be the splitting class of $q(u)$.
Note that $q(\merge{h} u) = \merge{h} q(u)$ for all $h < t$ and $q(\merge{h} u) = \merge{h+1} q(u)$ for all $h \geq t$ since equal entries can be processed in any order in the definition of the action of $q$.
Yet we can define $f_k$ as a sequence of merges on $u$, and so we have $q\bigl( f_k(u) \bigr)_i \leq q\bigl( f_k(u) \bigr)_j$ for all $k \in \ZZ_{\geq 1}$.

Next, assume $q\bigl( f_k(u) \bigr)_i \leq q\bigl( f_k(u) \bigr)_j$ for all $k \in \ZZ_{\geq 1}$.
Suppose that $q(u)_i > q(u)_j$, then we can apply merges to $u$ to obtain $f_{k'}$ with $k' = q(u)_i$.
However, the previous argument implies that $q\bigl(f_{k'}(u) \bigr)_i < q\bigl(f_{k'}(u) \bigr)_j$, which is a contradiction.
Hence, the claim follows.
\end{proof}

Lemma~\ref{le:mono} tells us that when $q$ is considered as a function on words, it is completely determined by its values $q(u)$ on words $u \in \{1,2\}^n$.


%%%%%%%%%%
\subsection{Multiline queues}

We now give our main definition of a multiline queue and spectral weight.

\begin{dfn}
For $\sigma \in \SymGp{\ell-1}$, a \defn{$\sigma$-twisted multiline queue (MLQ) of type $\mm = \tup{m_1, m_2, \ldots, m_\ell, 0, 0, \ldots}$}, with $\ell$ classes, is a sequence of queues $\qq = (q_1, \dotsc, q_{\ell-1})$ such that $q_i$ is a $p_{\sigma(i)}(\mm)$-queue and $m_{\ell} = n - p_{\ell-1}(\mm)$ (that is, $p_\ell(\mm) = n$).
When $\sigma$ is the identity permutation, we simply call $\qq$ an \defn{(ordinary) MLQ of type $\mm$}.
Define the \defn{weight} by $\wt(\qq) := \prod_{i=1}^{\ell-1} \wt(q_i)$.
We also consider $\qq$ as a function on words by
\[
\qq(u) := q_{\ell-1}\bigl( \cdots q_2\bigl( q_1(u) \bigr) \cdots \bigr).
\]
\end{dfn}

\begin{remark}
Our notion of an (ordinary) MLQ is equivalent to what is called a ``discrete MLQ'' in~\cite[\S 2.2]{AasLin17}, where we recover the labelling of level $k$ by $q_k( \cdots q_1(1 \dotsm 1) \cdots )$.
We omit the word ``discrete'' as these are the only MLQs in this note.
\end{remark}

\begin{dfn}
For $\sigma \in \SymGp{\ell-1}$ and a packed word $u$ of type $\mm$ with $\ell$ classes, we define the \defn{$\sigma$-spectral weight} or \defn{$\sigma$-amplitude} as
\begin{equation}
\label{eq:amplitude}
  \swt{u}_{\sigma} := \sum_{\qq} \wt(\qq),
\end{equation}
where the sum is over all $\sigma$-twisted MLQs $\qq$ of type $\mm$ satisfying $u = \qq(1 \dotsm 1)$.
(Here, $1 \dotsm 1$ denotes the word in $\mcW_n$ whose all letters are $1$.)
When $\sigma = \id$ is the identity permutation, we simply call this the \defn{spectral weight} or \defn{amplitude} and denote it by $\swt{u} := \swt{u}_{\id}$.
\end{dfn}

\begin{remark}
Note that the type of the word $\qq(1 \dotsm 1)$ is the type of the ($\sigma$-twisted) MLQ $\qq$.
\end{remark}


%%%%%%%%%%
\subsection{Symmetric polynomials}

We also need the \defn{elementary symmetric polynomials} and \defn{complete homogeneous symmetric polynomials}.
Recall that they are defined for each $N \in \left\{0,1,\ldots,n\right\}$ and $k \geq 0$ by
\begin{align*}
e_k(x_1, x_2, \dotsc, x_N) & = \sum_{1 \leq i_1 < \cdots < i_k \leq N} x_{i_1} \dotsm x_{i_k},
\\ h_k(x_1, x_2, \dotsc, x_N) & = \sum_{1 \leq i_1 \leq \cdots \leq i_k \leq N} x_{i_1} \dotsm x_{i_k},
\end{align*}
respectively.
We define $e_k(x_1, \dotsc, x_N) = 0$ and $h_k(x_1, \dotsc, x_N) = 0$ for $k < 0$.
For more details on symmetric polynomials, we refer the reader to~\cite[Ch.~7]{Stanley-EC2}.








%=====================================================================
\section{Main results}
\label{sec:result}


In this section, we state our main results and use them to prove the commutativity conjecture of~\cite{AAMP} and~\cite[Conj.~3.10]{AasLin17}.

\begin{thm}
\label{thm:permutation}
  Let $u$ be a packed word of type $\mm$ with $\ell$ classes.
  For any $\sigma \in \SymGp{\ell-1}$, we have 
  \[
  \swt{u} = \swt{u}_{\sigma}.
  \]
\end{thm}

We will give the proof of Theorem~\ref{thm:permutation} in Section~\ref{sec:thm_proof}.
In order to prove our next result, we need the following lemma.

\begin{lemma}
\label{lemma:queue_merge}
  Let $X$ be a $p_i(\mm)$-queue for some type $\mm$ and some $i \geq 1$.
  Let $\qq$ be an MLQ of type $\merge{i}\mm$.
  For the word
  $
  u = \qq\bigl( X(1 \dotsm 1) \bigr),
  $
  we have
  \[
  v := \qq(1 \dotsm 1) = \merge{i} u.
  \]
\end{lemma}

\begin{proof}
  We will show this by induction on the number of queues in $\qq$.
  If $\qq$ has no queues, then the claim clearly holds.
  
  Next, assume (as the induction hypothesis) that $v = \qq(1 \dotsm 1) = \merge{i} u$, where $\qq = (q_1, \dotsc, q_k)$ is an MLQ of type $\merge{i}\mm$ with $\ell - 1$ classes.
  Let $q^*$ be an $r^*$-queue. %with $r^* > r$.
  Let $t$ (resp.~$t^{\vee}$) be the splitting class of $q^*(u)$ (resp.~$q^*(v)$), and so the type of the extended MLQ $(q^*, q_1, \dotsc, q_k, X)$ is
  \[
  \mm^* := (m_1, \dotsc, m_{t-1}, r^* - p_{t-1}, p_t - r^*, m_{t+1}, \ldots).
  \]
  Note that either $t^{\vee} \leq t$ or $t^{\vee} = t - 1$.
  If $i > t$, then $t^{\vee} = t$ and $q^*\bigl(v) = \merge{i+1} q^*(u)$ from Lemma~\ref{le:mono}, and the claim follows since $X$ is a $p_{i+1}(\mm^*)$-queue.
  If $i < t - 1$, then $t^{\vee} = t - 1$ and $q^*\bigl(v) = \merge{i} q^*(u)$ from Lemma~\ref{le:mono}, and the claim follows since $p_i(\mm) = p_i(\mm^*)$.
  We consider the case $i = t - 1$, where the $i$'s are added during Phase~I of $q^*(u)$ but are instead handled by Phase~III of $q^*(v)$.
  Note that all positions of $q^*$ where $i$ was adding during Phase~I of $q^*(u)$ are remaining positions of $q^*$ in Phase~III of $q^*(v)$, so in both cases they are $i$'s.
  The remaining positions during Phase~III of $q^*(u)$ precisely correspond to all other remaining positions in Phase~III of $q^*(v)$, and hence with Lemma~\ref{le:mono}, we have $q^*(u) = \merge{i} q^*(v)$.
  The case when $i = t$ is similar except instead the $(i+1)$'s are normally handled during Phase~II.
\end{proof}

\begin{example}
Consider $q = \set{1,4,5,9,10}$ and $v = 3455313321$:
\[
\begin{tikzpicture}[baseline=-7]
  \def\ll{0.65}   % level 2
  \foreach \i in {6,10} { \node at (\i,\ll) {$1$}; }
  \foreach \i in {9} { \node at (\i,\ll) {$2$}; }
  \foreach \i in {1,5,7,8} { \node at (\i,\ll) {$3$}; }
  \foreach \i in {2} { \node at (\i,\ll) {$4$}; }
  \foreach \i in {3,4} { \node at (\i,\ll) {$5$}; }
  \foreach \i in {1,4,5,9,10} { \draw (\i,0) circle (0.3); }
  \foreach \i in {2,3,6,7,8} { \draw (\i-.3,0-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {9,10} { \node at (\i,0) {$1$}; }
  \foreach \i in {1} { \node at (\i,0) {$2$}; }
  \foreach \i in {4,5} { \node at (\i,0) {$3$}; }
  \foreach \i in {6,7} { \node at (\i,0) {$4$}; }
  \foreach \i in {8} { \node at (\i,0) {$5$}; }
  \foreach \i in {2,3} { \node at (\i,0) {$6$}; }
\end{tikzpicture}\ .
\]
Let $u = 3566413321$, and note that $v = \merge{3} u$ and
\[
\begin{tikzpicture}[baseline=-7]
  \def\ll{0.65}   % level 2
  \foreach \i in {6,10} { \node at (\i,\ll) {$1$}; }
  \foreach \i in {9} { \node at (\i,\ll) {$2$}; }
  \foreach \i in {1,7,8} { \node at (\i,\ll) {$3$}; }
  \foreach \i in {5} { \node at (\i,\ll) {$4$}; }
  \foreach \i in {2} { \node at (\i,\ll) {$5$}; }
  \foreach \i in {3,4} { \node at (\i,\ll) {$6$}; }
  \foreach \i in {1,4,5,9,10} { \draw (\i,0) circle (0.3); }
  \foreach \i in {2,3,6,7,8} { \draw (\i-.3,0-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {9,10} { \node at (\i,0) {$1$}; }
  \foreach \i in {1} { \node at (\i,0) {$2$}; }
  \foreach \i in {4,5} { \node at (\i,0) {$3$}; }
  \foreach \i in {6} { \node at (\i,0) {$4$}; }
  \foreach \i in {7} { \node[red] at (\i,0) {$5$}; }
  \foreach \i in {8} { \node[dgreencolor] at (\i,0) {$6$}; }
  \foreach \i in {2,3} { \node[dgreencolor] at (\i,0) {$7$}; }
\end{tikzpicture}\ ,
\]
where we have $2663344511 = \merge{4} 2773345611$.
Similarly, let $u' = 4566413421$, and note that $v = \merge{3} u'$ and
\[
\begin{tikzpicture}[baseline=-7]
  \def\ll{0.65}   % level 2
  \foreach \i in {6,10} { \node at (\i,\ll) {$1$}; }
  \foreach \i in {9} { \node at (\i,\ll) {$2$}; }
  \foreach \i in {7} { \node at (\i,\ll) {$3$}; }
  \foreach \i in {1,5,8} { \node at (\i,\ll) {$4$}; }
  \foreach \i in {2} { \node at (\i,\ll) {$5$}; }
  \foreach \i in {3,4} { \node at (\i,\ll) {$6$}; }
  \foreach \i in {1,4,5,9,10} { \draw (\i,0) circle (0.3); }
  \foreach \i in {2,3,6,7,8} { \draw (\i-.3,0-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {9,10} { \node at (\i,0) {$1$}; }
  \foreach \i in {1} { \node at (\i,0) {$2$}; }
  \foreach \i in {4} { \node[blue] at (\i,0) {$3$}; }
  \foreach \i in {5} { \node[dgreencolor] at (\i,0) {$4$}; }
  \foreach \i in {6,7} { \node[dgreencolor] at (\i,0) {$5$}; }
  \foreach \i in {8} { \node[dgreencolor] at (\i,0) {$6$}; }
  \foreach \i in {2,3} { \node[dgreencolor] at (\i,0) {$7$}; }
\end{tikzpicture}\ ,
\]
where we have $2663344511 = \merge{4} 2773455611$.
\end{example}

\begin{thm}
\label{thm:merge}
  Let $\mm$ be a type with $m_i \neq 0$ and $m_{i+1} \neq 0$.
  Let $v$ be a packed word of type $\merge{i}\mm$.
  Then,
\[
  \swt{v} e_{p_i(\mm)}(x_1, \dotsc, x_n) = \sum_u \swt{u},
\]
where we sum over all $u$ of type $\mm$ such that $v = \merge{i} u$.
\end{thm}

\begin{proof}
  First note that
  \begin{equation}
  \swt{v} e_{p_i(\mm)}(x_1, \dotsc, x_n) = \sum_{(\qq,X)} \wt(\qq) \wt(X),
  \label{pf.thm:merge.1}
  \end{equation}
  where we sum over all pairs $(\qq, X)$ such that
  \begin{itemize}
  \item $\qq = (q_1, \dotsc, q_{\ell-1})$ is an MLQ of type $\merge{i}\mm$ such that $v = \qq(1\cdots1)$ and
  \item $X$ is a $p_i(\mm)$-queue.
  \end{itemize}
  Given any such pair $\tup{\qq, X}$, we define an
  $\ell$-tuple $\theta \tup{\qq, X}$ by
  \[
  \theta(\qq, X) = (X, q_1, \dotsc, q_{\ell-1}).
  \]
  This $\theta \tup{\qq, X}$ is a $(s_{i-1} \dotsm s_1)$-twisted MLQ of type $\mm$ and weight
  $\wt \tup{\theta \tup{\qq, X}} = \wt(\qq) \wt(X) $.
  By Lemma~\ref{lemma:queue_merge}, it also satisfies
  \[
  v = \qq(1 \dotsm 1) = \merge{i} \qq\bigl( X(1 \dotsm 1) \bigr) = \merge{i} \tup{\theta \tup{\qq, X}}(1 \dotsm 1).
  \]
  Thus, we have defined a weight preserving bijection $\theta$
  from the set of all pairs $\tup{\qq, X}$ as above
  to the set of all $(s_{i-1} \dotsm s_1)$-twisted MLQs $\widetilde{\qq}$ of type $\mm$ satisfying $v = \merge{i} \widetilde{\qq} \tup{1 \dotsm 1}$.
  This allows us to rewrite the right hand side of \eqref{pf.thm:merge.1} as
  $\sum_{\widetilde{\qq}} \wt \tup{\widetilde{\qq}}$, with the sum ranging over all such MLQs.
  Hence, \eqref{pf.thm:merge.1} rewrites as
  \[
  \swt{v} e_{p_i(\mm)}(x_1, \dotsc, x_n)
  = \sum_{\widetilde{\qq}} \wt \tup{\widetilde{\qq}}
  = \sum_u \swt{u}_{s_{i-1} \dotsm s_1} ,
  \]
  where the last sum is over all words $u$ of type $\mm$ satisfying $v = \merge{i} u$.
  Finally, Theorem~\ref{thm:permutation} shows that $\swt{u}_{s_{i-1} \dotsm s_1} = \swt{u}$ for all such $u$;
  hence, this becomes
  $\swt{v} e_{p_i(\mm)}(x_1, \dotsc, x_n) = \sum_u \swt{u}$.
\end{proof}


\begin{example}
Suppose $n = 5$.
Let $v = 13234$, and we have that $v = \merge{3} u$ if and only if $u \in \set{13245, 14235}$.
By examining all possible MLQs for these words, we obtain
\begin{align*}
\swt{13234} & = x_1 x_2 x_3^2 x_4 (x_1^2 + x_1 x_4 + x_1 x_5 + x_4 x_5 + x_5^2),
\\ \swt{13245} & = x_1 x_2 x_3^2 x_4 (x_1^2 + x_1x_4 + x_1x_5 + x_4^2 + x_4x_5 + x_5^2)
\\ & \hspace{20pt} \times (x_1x_2x_3 + x_1x_2x_5+x_1x_3x_5+x_2x_3x_5),
\\ \swt{14235} & = x_1x_2x_3^2x_4^2 (x_1^3x_2 + x_1^3x_3 + x_1^3x_5 + x_1^2x_2x_3 + x_1^2x_2x_4 + 2x_1^2x_2x_5
\\ & \hspace{60pt} + x_1^2x_3x_4 + 2x_1^2x_3x_5 + x_1^2x_4x_5 + x_1^2x_5^2 + x_1x_2x_3x_5
\\ & \hspace{60pt} + x_1x_2x_4x_5 + 2x_1x_2x_5^2 + x_1x_3x_4x_5 + 2x_1x_3x_5^2 + x_1x_4x_5^2
\\ & \hspace{60pt} + x_1x_5^3 + x_2x_3x_5^2 + x_2x_4x_5^2 + x_2x_5^3 + x_3x_4x_5^2 + x_3x_5^3).
\end{align*}
(We have factored the expressions for readability only.)
We verify Theorem~\ref{thm:merge} in this case by computing $\swt{13234} e_3(x_1, x_2, x_3, x_4, x_5) = \swt{13245} + \swt{14235}$.
\end{example}


\begin{thm}
\label{thm:determinant_form}
  Let $B = \set{b_1 < b_2 < \cdots < b_r} \subseteq \ive{n}$.
  Let $v_1v_2 \dotsm v_r$ be a weakly decreasing (non-cyclic) packed word of length $r$ with $\ell-1$ classes.
  Define a word $u$ of length $n$ by $u_i = v_j$ if $i = b_j$ for some $j$, otherwise $u_i = \ell$.
  Then
  \[
  \swt{u} = \left( \prod_{i\in B} x_i \right) \det\bigl( h_{i-j-1+\gamma_j}(x_1, \dotsc, x_{b_j}) \bigr)_{1\leq i,j\leq r}\,,
  \]
  where $\gamma_j$ is the number of distinct letters in $v_1 \dotsm v_j$.
\end{thm}

\begin{proof}
We apply the \defn{Lindstr\"om--Gessel--Viennot (LGV) Lemma}~\cite{Lindstrom73,GV85} to show the claim.
We refer the reader to \cite[\S2]{GesVie89} for details on the LGV Lemma.\footnote{The version we shall use is \cite[Cor.~2]{GesVie89}.}

Define a directed graph with vertices $\ive{r} \times \ive{n}$ and edges
\[
(r+1-i,j) \to (r+1-i,j+1)
\]
(for $i \in \ive{r}$ and $j \in \ive{n-1}$) with weight $1$ and
\[
(r+1-i,j) \to (r-i,j)
\]
(for $i \in \ive{r-1}$ and $j \in \ive{n}$) with weight $x_j$. 
We choose the $r$ sources $\iota_i = (r+1-i, 1)$ and terminals $\tau_i = (r-i+\gamma_i,b_j)$ for $i \in \ive{r}$.

First, we label an element $k \in q_i \in \qq$ by $q_i\bigl( \cdots q_1(1 \cdots 1) \cdots \bigr)_k$.
We construct a non-intersecting lattice path recursively by taking the rightmost unused elements $(a_1, \dotsc, a_h)$ in $\qq$ labeled by $v_{r-i}$ and constructing a path
\newcommand{\patharrow}{ \xrightarrow{\hspace{10pt}} }
\[
\iota_i \patharrow (\overline{\imath} + 1, a_1) \patharrow (\overline{\imath} + 2, a_1) \patharrow (\overline{\imath} + 2, a_2) \patharrow \cdots \patharrow (\overline{\imath} + \gamma_i - 1, a_{\gamma_i - 1}) = \tau_i,
\]
where $\overline{\imath} = r + 1 - i$.
Conversely, given a non-intersecting lattice path, we construct the MLQ by considering the north-east corners and labelling the paths according to $v$.
See Figure \ref{fig:lattice_path_bijection} for an example.

Note that the weighted sum of paths from $\iota_i$ to $\tau_j$ is $h_{i-j-1+\gamma_j}(x_1, \dotsc, x_{b_j})$.
The LGV Lemma now gives us the stated formula.
\end{proof}

\begin{figure}[t]
\[
\begin{tikzpicture}[xscale=1.3,yscale=0.9]
  \begin{scope}[yshift=7cm]
    \foreach \i in {1,...,9}{
      \foreach \j in {0,1,2}{
        \node at (\i,\j){$\cdot$};
      }
    }
    \node[circle,fill=white,draw=black] at  (1, 0){$3$};
    \node[circle,fill=white,draw=black,text=blue] at  (2, 0){$3$};
    \node[circle,fill=white,draw=black] at  (4, 0){$2$};
    \node[circle,fill=white,draw=black,text=blue] at  (6, 0){$2$};
    \node[circle,fill=white,draw=black,text=darkred] at  (7, 0){$2$};
    \node[circle,fill=white,draw=black] at  (9, 0){$1$};
    \node[circle,fill=white,draw=black] at  (3, 1){$2$};
    \node[circle,fill=white,draw=black,text=blue] at  (4, 1){$2$};
    \node[circle,fill=white,draw=black,text=darkred] at  (6, 1){$2$};
    \node[circle,fill=white,draw=black] at  (8, 1){$1$};
    \node[circle,fill=white,draw=black] at  (7, 2){$1$};
  \end{scope}

  \draw[densely dotted] (1,1) grid (9,6);

  \draw[draw=red] (1,2)--(2,2);
  \draw[draw=red] (1,3)--(3,3)--(3,2)--(4,2);
  \draw[draw=red] (1,4)--(4,4)--(4,3)--(6,3);
  \draw[draw=red] (1,5)--(6,5)--(6,4)--(7,4);
  \draw[draw=red] (1,6)--(7,6)--(7,5)--(8,5)--(8,4)--(9,4);
  
  \node[circle,fill=white,draw=black,inner sep=1pt] at (1,1) {$3$};
  \node[circle,fill=white,draw=black,text=blue,inner sep=1pt] at (2,2) {$3$};
  \node[circle,fill=white,draw=black,inner sep=1pt] at (4,2) {$2$};
  \node[circle,fill=white,draw=black,inner sep=1pt] at (3,3) {$2$};
  \node[circle,fill=white,draw=black,text=blue,inner sep=1pt] at (4,4) {$2$};
  \node[circle,fill=white,draw=black,text=blue,inner sep=1pt] at (6,3) {$2$};
  \node[circle,fill=white,draw=black,text=darkred,inner sep=1pt] at (6,5) {$2$};
  \node[circle,fill=white,draw=black,text=darkred,inner sep=1pt] at (7,4) {$2$};
  \node[circle,fill=white,draw=black,inner sep=1pt] at (7,6) {$1$};
  \node[circle,fill=white,draw=black,inner sep=1pt] at (8,5) {$1$};
  \node[circle,fill=white,draw=black,inner sep=1pt] at (9,4) {$1$};

  \foreach \i in {2,...,6} {
    \node at (1,\i) {\textbullet};
  }
  \foreach \i in {1,...,6} {
    \node[anchor=east,inner sep=7pt] at (1,7-\i) {$\iota_{\i}$};
  }
\end{tikzpicture}
\]
\caption{An example of the bijection with $n = 9$, $r = 6$, $\ell = 4$, $v = 332221$, and $B = \set{1,2,4,6,7,9}$ between MLQs and non-intersecting lattice paths in the proof of Theorem~\ref{thm:determinant_form}.}
\label{fig:lattice_path_bijection}
\end{figure}

Now, fix a sequence $b_1 < b_2 < \cdots < b_r$, and for a permutation $v \in \SymGp{r}$, let $u(v)$ be the corresponding word as defined in Theorem~\ref{thm:determinant_form}.
Furthermore let $S \subseteq \ive{r-1}$ be such that $i\in S$ implies $i+1 \notin S$, and define the permutation $\sigma_S = \left( \prod_{i \in S} s_i \right) w_0$, where $s_i, w_0 \in \SymGp{r}$.
Note that the elements $\{s_i \mid i \in S\}$ all commute, so the product, and hence $\sigma_S$, is well-defined.
In~\cite[Conj.~3.10]{AasLin17}, a formula for the spectral weight $\swt{u \sigma_S}$ at $x_1 = \cdots = x_n = 1$ is conjectured, where $u \sigma_S = u_{\sigma_S(1)} \cdots u_{\sigma_S(r)}$.

Let $T \subseteq \ive{r-1}$, and let $\phi(T) = \sum_{S \subseteq T} \swt{u \sigma_S}$.
By Theorem~\ref{thm:permutation}, we have
\begin{align*}
  \psi(T) & = \left(\prod_{i\in S} e_{p_i(\mm)}(x_1, \dotsc, x_n) \right) \swt{ \bigvee_T w_0}
  \\ & = \left( \prod_{i\in B} x_i \right) \left(\prod_{i\in S} e_{p_i(\mm)}(x_1, \dotsc, x_n) \right) \det\bigl(h_{i-j+1+\gamma_j}(x_1, \dotsc, x_{b_j})\bigr)_{1\leq i,j \leq r},
\end{align*}
where $\gamma_i = i - \lvert \{j\in T \mid j < i \} \rvert$ and the second equality is by Theorem~\ref{thm:determinant_form}.
By M\"obius inversion we have $\swt{u \sigma_S} = \sum_{T\subseteq S} (-1)^{|S|-|T|} \psi(T)$.
Taken together with $x_1 = \cdots = x_n = 1$, this proves~\cite[Conj.~3.10]{AasLin17} (which is a generalization of~\cite[Conj.~3.9]{AasLin17}).
Additionally, this proves~\cite[Conj.~3.6]{AasLin17} (which is a generalization of~\cite[Conj.~3.4]{AasLin17}).










%=====================================================================
\section{The TASEP connection}
\label{sec:tasep}

We now explain how our proof of Theorem~\ref{thm:permutation} gives a proof of the commutativity conjecture of~\cite{AAMP}.

There are $2^{n-1}$ packed types for words of length $n$ as they are compositions of $n$.
We let the subset $S \subseteq [n-1]$ correspond to the type of the word obtained by merging $i$ and $i+1$ in $12 \dotsm n$ for each $i \in S$.
Denote this type by $\mm_S$.
Note that $\set{p_1(\mm_S), \dotsc, p_{\ell-1}(\mm_S)} = [n-1] \setminus S$, where $\mm_S$ has $\ell$ classes, which is the complement of the usual bijection between subsets of $\ive{n-1}$ and compositions of $n$.
Let $\mcW_S$ denote the set of words of type $\mm_S$.
Let $V_S$ be the vector space over $\RR$ with basis $\set{\epsilon_w \mid w \in \mcW_S}$.

\begin{example}
  For $n = 4$, we have
  \[
  \begin{tikzpicture}[xscale=4.5,yscale=2,thick,>=latex]
  \node (E) at (1,0) {$\mbf{m}_{\emptyset} = (1,1,1,1)$};
  \node (1) at (2,1) {$\mbf{m}_{\{1\}} = (2,1,1)$};
  \node (2) at (1,1) {$\mbf{m}_{\{2\}} = (1,2,1)$};
  \node (3) at (0,1) {$\mbf{m}_{\{3\}} = (1,1,2)$};
  \node (12) at (2,2) {$\mbf{m}_{\{1,2\}} = (3,1)$};
  \node (13) at (1,2) {$\mbf{m}_{\{1,3\}} = (2,2)$};
  \node (23) at (0,2) {$\mbf{m}_{\{2,3\}} = (1,3)$};
  \node (123) at (1,3) {$\mbf{m}_{\{1,2,3\}} = (4)$};
  \draw[->,red] (E) -- (1);
  \draw[->,blue] (E) -- (2);
  \draw[->,dgreencolor] (E) -- (3);
  \draw[->,red] (2) -- (12);
  \draw[->,red] (3) -- (13);
  \draw[->,blue] (3) -- (23);
  \draw[->,blue] (1) -- (12);
  \draw[->,dgreencolor] (1) -- (13);
  \draw[->,dgreencolor] (2) -- (23);
  \draw[->,red] (23) -- (123);
  \draw[->,blue] (13) -- (123);
  \draw[->,dgreencolor] (12) -- (123);
  \end{tikzpicture}
  \]
  where we have an arrow $m_S \to m_{S \cup \set{i}}$ for some $i \in [n-1] \setminus S$ (this is the Hasse diagram of the corresponding Boolean lattice).
\end{example}

The \defn{totally asymmetric simple exclusion process} (TASEP) is a Markov chain on $\mcW_S$, where $S \subseteq[n-1]$, as follows.
For a state $u \in \mcW_S$, we move to a new state by picking a random $i \in [n]$ and either
\begin{itemize}
\item if $u_i > u_{i+1}$, swap the positions $u_i$ and $u_{i+1}$, or
\item do nothing (\textit{i.e.} stay at $u$).
\end{itemize}
Let $M_S \colon V_S \to V_S$ be the transition matrix of this Markov chain.
Note that these moves preserve the type of the words, thus we could consider this as a Markov chain on $\mcW_n$, where $M_S$ becomes an irreducible component.
For $i \notin S$, we have the merging map $\Phi_i \colon \mcW_S \to \mcW_{S\cup\{i\}}$ given by $\Phi_i(\epsilon_u) = \epsilon_{\merge{t}u}$, where $t = \min\set{k \mid p_k(\mm_S) \geq i}$.
It is easy to see that $\Phi_i M_S = M_{S\cup \{i\}} \Phi_i$. 

\begin{figure}
\[
\begin{tikzpicture}[>=stealth,thick,scale=0.8]
\node (321) at (3,8) {$321$};
\node (231) at (0,6) {$231$};
\node (312) at (6,6) {$312$};
\node (213) at (0,2) {$213$};
\node (132) at (6,2) {$132$};
\node (123) at (3,0) {$123$};
\draw[->,blue] (123) -- (321); % node[right,pos=0.8] {$1/3$};
\draw[->,dgreencolor] (132) -- (123); % node[above=3pt,pos=0.5] {$1/3$};
\draw[->,red] (132) -- (231); % node[below=4pt,pos=0.8] {$1/3$};
\draw[->,red] (213) -- (123); % node[above=3pt,pos=0.5] {$1/3$};
\draw[->,dgreencolor] (213) -- (312); % node[below=4pt,pos=0.8] {$1/3$};
\draw[->,blue] (231) -- (213); % node[left,pos=0.5] {$1/3$};
\draw[->,blue] (312) -- (132); % node[right,pos=0.5] {$1/3$};
\draw[->,dgreencolor] (321) -- (231); % node[above=3pt,pos=0.5] {$1/3$};
\draw[->,red] (321) -- (312); % node[above=3pt,pos=0.5] {$1/3$};
\end{tikzpicture}
\hspace{35pt}
\begin{tikzpicture}[>=stealth,thick,scale=0.8]
\node (1223) at (0,-2) {$1223$};
\node (3221) at (0,8) {$3221$};
\node (2321) at (2,6) {$2321$};
\node (3212) at (-2,6) {$3212$};
\node (2231) at (3,4) {$2231$};
\node (2312) at (0,4) {$2312$};
\node (3122) at (-3,4) {$3122$};
\node (2213) at (3,2) {$2213$};
\node (2132) at (0,2) {$2132$};
\node (1322) at (-3,2) {$1322$};
\node (1232) at (-2,0) {$1232$};
\node (2123) at (2,0) {$2123$};
\draw[->,blue] (1223) .. controls (2,3) and (1,6) .. (3221);
\draw[->,red] (3221) -- (3212);
\draw[->,dgreencolor] (3221) -- (2321);
\draw[->,dgreencolor] (2321) -- (2231);
\draw[->,red] (2321) -- (2312);
\draw[->,red] (3212) -- (3122);
\draw[->,dgreencolor] (3212) -- (2312);
\draw[->,blue] (3122) -- (1322);
\draw[->,blue] (2312) -- (2132);
\draw[->,blue] (2231) -- (2213);
\draw[->,dgreencolor] (1322) -- (1232);
\draw[->,red] (1322)  .. controls (-1,3) and (-1,6) .. (2321);
\draw[->,dgreencolor] (2132) -- (2123);
\draw[->,red] (2132) -- (1232);
\draw[->,dgreencolor] (2213) .. controls (1,3) and (1,6) .. (3212);
\draw[->,red] (2213) -- (2123);
\draw[->,dgreencolor] (1232) -- (1223);
\draw[->,red] (1232) .. controls (1,0) and (1,3) .. (2231);
\draw[->,red] (2123) -- (1223);
\draw[->,dgreencolor] (2123) .. controls (-1,0) and (-1,3) .. (3122);
\end{tikzpicture}
\]
\caption{The states and transitions for $\mcW_{\emptyset}$ for $n =3$ (left) and $\mcW_{\set{2}}$ for $n = 4$ (right).
All probabilities of the drawn transitions are $1/n$.}
\end{figure}

Building on work by Ferrari and Martin~\cite{FM06,FM07}, the paper~\cite{AAMP} introduced opposite operators $\Psi_i \colon \mcW_S \to \mcW_{S \setminus \{i\}}$ given by $\Psi_i(\epsilon_u) = \sum_{q} \epsilon_{q(u)}$, where the sum is taken over all $i$-queues $q$, and showed that $\Psi_i M_S = M_{S \setminus \{i\}} \Psi_i$.
Furthermore they proposed the \defn{commutativity conjecture}: that $\Psi_i \Psi_j = \Psi_j \Psi_i$.
By looking at the $(u,v)$ entry of both sides of this equation, the commutativity conjecture is asking whether the number of $(i,j)$-configurations $C$ such that $v = C(u)$ equals the number of $(j,i)$-configurations $C'$ such that $v = C'(u)$. 
Thus, our proof of Theorem~\ref{thm:permutation} shows that $\widetilde{\Psi}_i \widetilde{\Psi}_j = \widetilde{\Psi}_j \widetilde{\Psi}_i$ for the weighted operators $\widetilde{\Psi}_i$ given by
\[
\widetilde{\Psi}_i(\epsilon_u) = \sum_q \wt(q) \epsilon_{q(u)},
\]
where we also sum over all $i$-queues $q$.
Note that $\widetilde{\Psi}_i = \Psi_i$ when we specialize $x_1 = \cdots = x_n = 1$, giving the connection between our MLQs and the multi-species TASEP.
We note that the proof of interlacing given in~\cite{AAMP} is significantly different from our approach.

We have not managed to find a process similar to the TASEP whose transition matrix $\widetilde{M}_S$ would satisfy $\widetilde{M}_S \widetilde{\Psi}_i = \widetilde{\Psi}_i \widetilde{M}_{S \setminus \set{i}}$ for our $\widetilde{\Psi}_i$ operators.
Note however that queues give us \emph{a} random process with this property: for a word $u \in \mcW_S$, a move in the chain is given by
\begin{enumerate}
\item picking a random $i$-queue $q$
\item going to the state $\merge{t} q(u) \in \mcW_S$, where $t = \min\set{k \mid p_k(\mm_S) \geq i}$.
\end{enumerate}









%=====================================================================
\section{Proof of Theorem~\ref{thm:permutation}}
\label{sec:thm_proof}

Recall that any permutation in $\SymGp{\ell-1}$ is a product of simple transpositions
$s_1, s_2, \ldots, s_{\ell-2}$.
Hence, in order to prove Theorem~\ref{thm:permutation}, it suffices to show that $\swt{u}_{\sigma} = \swt{u}_{\sigma s_i}$ by induction on length, \textit{i.e.} the minimal number of simple transpositions needed to write $\sigma$.

The proof thus reduces down to defining an action of a simple transposition $s_i$ on a pair of queues.
An \defn{$(r,s)$-configuration} shall mean a pair $C = (q_1, q_2)$, where $q_1$ is an $r$-queue and $q_2$ is an $s$-queue.
As usual, we consider $C$ as a function on words by $C(u) := q_2\bigr(q_1(u)\bigr)$, and we define the weight of $C$ by $\wt(C) := \wt(q_1) \wt(q_2)$.
Hence, our proof is reduced to constructing the \defn{dual} $(r_2,r_1)$-configuration $C'$ to $C$ such that $C'$ satisfies $C(u) = C'(u)$, $\wt(C) = \wt(C')$, and $C'' = C$ (\textit{i.e.} the dual of $C'$ equals $C$).

We first consider the case $r_1 = r_2$, in which we define $C' = C$.
Moreover, it is clear that every $\sigma$-twisted MLQ is a $\sigma s_i$-twisted MLQ and the claim follows.
Thus, for the remainder of this section we assume $r_1 \neq r_2$.

By using Lemma~\ref{le:mono}, we may assume $u \in \{1,2\}^n$.
We split the proof into four parts as follows.
In Part~A we describe how to split any configuration into \defn{balanced} and \defn{unbalanced} blocks.
In Part~B we define the involution promised above, mapping any configuration $C$ to its dual $C'$.
In Part~C we reduce the problem of showing that $C(u) = C'(u)$ for \emph{all} words $u$ to the showing it for a very restricted set of words $u$.
Finally, in Part~D we show that for this restricted set of words $u$, we indeed have $C(u) = C'(u)$.

For the remainder of this section, we fix an $(r_1,r_2)$-configuration $C = (q_1, q_2)$ and binary word $u \in \set{0,1}^n$.
Moreover, we refer to binary words simply as words.

%%%%%%%%%%
\subsection*{Part A: Splitting into balanced and unbalanced intervals}

Let $\inter[i,j]$ denote a closed (cyclic) interval from $i$ to $j$.
This is the set $\set{i, i+1, \ldots, j}$ when $i \leq j$ and the set $\set{i, i+1, \ldots, n, 1, 2, \ldots, j}$ when $i > j$.
Let $\inter(i,j) := \inter[i,j] \setminus \set{i,j}$ denote the open (cyclic) interval.
Let $c^{\uparrow}[i,k]$ (resp.~$c^{\downarrow}[i,k]$) denote the number of $\ell \in \inter[i,k]$ such that $\ell \in q_1$ (resp.~$\ell \in q_2$).
We say that a closed cyclic interval $\inter[i,j]$ is \defn{balanced} if $c^{\uparrow}[i,j] = c^{\downarrow}[i,j]$ and for each $k \in \inter[i,j]$, we have $c^\uparrow[i,k] \geq c^\downarrow[i,k]$.
Note that for a balanced interval $\mcI$, we have $\lvert q_1 \cap \mcI \rvert = \lvert q_2 \cap \mcI \rvert$.
For $i \in \ive{n}$, we say that $i$ is \defn{balanced} if $i$ belongs to some balanced interval, and \defn{unbalanced} otherwise.

For $r_1 < r_2$ and $j$ unbalanced, we have $j \notin q_1$ and $j \in q_2$.
Conversely, for $r_1 > r_2$ and $j$ unbalanced, we have $j \in q_1$ and $j \notin q_2$.
The following notation will be useful later on: for a word $u \in \mcW_n$, an element $j \in \ive{n}$ and an $(r_1, r_2)$-configuration $C = (q_1, q_2)$, we define
\[
T(j) := \begin{cases}
(u_j, \bigcirc) & \text{if } j \in q_1, \\
(u_j, \square) & \text{if } j \notin q_1.
\end{cases}
\]

\begin{figure}[t]
\[
\begin{tikzpicture}[scale=0.75]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \draw[fill=blue!30] (1.5*\sc,\l-.5) rectangle(4.5*\sc,\ll+.5);
  \draw[fill=blue!30] (6.5*\sc,\l-.5) rectangle(7.5*\sc,\ll+.5);
  \draw[fill=blue!30] (8.5*\sc,\l-.5) rectangle(20.5*\sc,\ll+.5);
  \foreach \i in {1,2,5,6,8,11,13,14,17,18,19} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {3,4,7,9,10,12,15,16,20} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {2,12,15,16,18,19,20} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,3,4,5,6,7,8,9,10,11,13,14,17} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
\end{tikzpicture}
\]
\caption{We draw a $\bigcirc$ in position $i$ in row $j$ corresponding to $i \in q_j$ and a $\square$ if $i \notin q_j$.
The maximal balanced intervals are boxed.}
\label{fig:balanced}
\end{figure}


%%%%%%%%%%
\subsection*{Part B: Defining the dual configuration}

We construct $C' = (q'_1, q'_2)$ by letting $q'_i \cap \mcI = q_i \cap \mcI$ for $i=1,2$ and each balanced interval $\mcI$ in $C$.
For unbalanced $j$, we have $j \in q'_i$ if and only if $j \in q_{3-i}$ for $i = 1,2$.
Note that $C$ and $C'$ have the same balanced intervals.
It is clear that $C'' = C$ and $\wt(C) = \wt(C')$.

\begin{example}
Consider the configuration $C$ given in Figure~\ref{fig:balanced}.
The dual configuration $C'$ is given by sliding all of the circles not in a shaded interval from the upper level to the lower level.
In particular, we have $q_1' = q_1 \setminus \{1,5,6,8\}$ and $q_2' = q_2 \cup \{1,5,6,8\}$.
\end{example}


%balanced blocks in C and C' are the same (because #unbalanced columns is same in both)
%%%%%%%%%%
\subsection*{Part C: Reduction to special words}

For a word $u$ and indices $i,j$, we let $u_{i\leftrightarrow j}$ be the result of swapping positions $i$ and $j$ in $u$.

\begin{lemma}
\label{le:orig}
  Let $q$ be an $r$-queue and $u$ be as above.
  Let $i \notin q$ and $j \in q$.
  Suppose that for all $k \in \inter(i,j)$, one of the following hold:
  \begin{itemize}
    \item $k \in q$ and $u_k=1$;
    \item $k \notin q$ and $u_k = 2$.
  \end{itemize}
  Then $q(u) = q(u_{i\leftrightarrow j})$.
\end{lemma}

\begin{proof}
Note that $q(u)_k = u_k + \delta_{2u_k}$, where $\delta_{ab}$ is the Kronecker delta, for all $k \in \inter(i,j)$ by our assumptions, and similarly $q(u_{i \leftrightarrow j})_k = u_k + \delta_{2u_k}$ for all $k \in \inter(i,j)$.
Therefore, if $u_i = 2$ (resp.~$u_j = 1$) and the splitting class of $q$ is $1$ (resp.~$2$), then $q(u)_i = 2 = q(u_{i \leftrightarrow j})_i$ (resp.~$q(u)_j = 1 = q(u_{i \leftrightarrow j})_j$).
Similarly, if $u_i = 1$ (resp.~$u_j = 2$) and the splitting class of $q$ is $2$ (resp.~$1$), then $q(u)_j = 1 = q(u_{i \leftrightarrow j})_j$ (resp.~$q(u)_i = 2 = q(u_{i \leftrightarrow j})_i$).
When $u_i$ and $u_j$ are the splitting class of $q$, the result is immediate by the definition of Phase~III.
Hence, we have $q(u) = q(u_{i \leftrightarrow j})$.
\end{proof}

\begin{lemma}[BB]
\label{le:BB}
  Let $C$ and $u$ be as above.
  Suppose
  \begin{itemize}
    \item $i$ is balanced with $T(i) = (1,\square)$,
    \item $j$ is balanced with $T(j) = (2,\bigcirc)$, and
    \item $T(k) \in \{(1,\bigcirc),(2,\square)\}$ for all balanced $k\in\inter(i,j)$.
  \end{itemize}
  Then $C(u) = C(u_{i \leftrightarrow j})$.
\end{lemma}

\begin{proof}
  By Lemma~\ref{le:orig}, we have $q_1(u) = q_1(u_{i\leftrightarrow j})$, and thus
  \[
  C(u) = q_2\bigl( q_1(u) \bigr) = q_2\bigl( q_1(u_{i\leftrightarrow j}) \bigr) = C(u_{i\leftrightarrow j}).
  \]
\end{proof}

\begin{example}
Suppose $n = 8$.
Let $u = 12121122$, and we consider the $(5,3)$-configuration $C = (\{1,2,5,6,8\}, \{5,7,8\})$.
We apply $C$ to $u$ on the left and to $u_{3 \leftrightarrow 8}$ on the right:
\[
\begin{tikzpicture}[baseline=-3]
  \def\sc{0.75}   % Change this to adjust the x-scaling
  \def\lll{1.7}   % level 3
  \def\ll{1}   % level 2
  \def\l{0}   % level 1
  \node[color=blue] at (3*\sc,\lll) {$1$};
  \node[color=blue] at (8*\sc,\lll) {$2$};
  \foreach \i in {1,5,6} { \node at (\i*\sc,\lll) {$1$}; }
  \foreach \i in {2,4,7} { \node at (\i*\sc,\lll) {$2$}; }
  \foreach \i in {1,2,5,6,8} { \draw (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {3,4,7} { \draw (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,5,6,8} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {2} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {3,4,7} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {5,7,8} { \draw (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,2,3,4,6} { \draw (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {3,4,6} { \node at (\i*\sc,\l) {$4$}; }
  \foreach \i in {2} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {1} { \node at (\i*\sc,\l) {$2$}; }
  \foreach \i in {5,7,8} { \node at (\i*\sc,\l) {$1$}; }
  \draw (2.5*\sc,2) -- (2.5*\sc,2.1) -- (8.5*\sc,2.1) -- (8.5*\sc,2);
  \node at (5.5*\sc,2.5) {balanced};
\end{tikzpicture}
% t = 2 for q_1
% t = 1 for q_2
\hspace{3pt} = \hspace{4pt}
\begin{tikzpicture}[baseline=-3]
  \def\sc{0.75}   % Change this to adjust the x-scaling
  \def\lll{1.7}   % level 3
  \def\ll{1}   % level 2
  \def\l{0}   % level 1
  \node[color=blue] at (8*\sc,\lll) {$1$};
  \node[color=blue] at (3*\sc,\lll) {$2$};
  \foreach \i in {1,5,6} { \node at (\i*\sc,\lll) {$1$}; }
  \foreach \i in {2,4,7} { \node at (\i*\sc,\lll) {$2$}; }
  \foreach \i in {1,2,5,6,8} { \draw (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {3,4,7} { \draw (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,5,6,8} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {3,4,7} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {2} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {5,7,8} { \draw (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,2,3,4,6} { \draw (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {3,4,6} { \node at (\i*\sc,\l) {$4$}; }
  \foreach \i in {2} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {1} { \node at (\i*\sc,\l) {$2$}; }
  \foreach \i in {5,7,8} { \node at (\i*\sc,\l) {$1$}; }
  \draw (2.5*\sc,2) -- (2.5*\sc,2.1) -- (8.5*\sc,2.1) -- (8.5*\sc,2);
  \node at (5.5*\sc,2.5) {balanced};
\end{tikzpicture}
\]
\end{example}

%.......................................

\begin{lemma}[BU]
\label{le:BU}
  Let $C$ and $u$ be as above.
  Suppose
  \begin{itemize}
    \item $i$ is balanced with $T(i) = (1,\square)$,
    \item $j$ is unbalanced with $u_j = 2$,
    \item $u_k = 1$ for unbalanced $k \in \inter (i,j)$, and
    \item $T(k) \in \{(1,\bigcirc),(2,\square)\}$ for balanced $k \in \inter(i,j)$.
  \end{itemize}
  Then we have $C(u) = C(u_{i \leftrightarrow j})$.
 \end{lemma} 
 
\begin{proof}
  We assume here that $r_1 > r_2$, noting that the dual case $r_1 < r_2$ follows from Lemma~\ref{le:dual} and Lemma~\ref{le:UB}.
  Thus, we have $k \in q_1$ for unbalanced $k$, and so $q_1(u) = q_1(u_{i\leftrightarrow j})$ by Lemma~\ref{le:orig}.
\end{proof}

\begin{example}
Suppose $n = 8$.
Let $u = 21111122$, and we consider the $(4,1)$-configuration $C = (\{1,2,5,6\},\{7\})$.
We apply $C$ to $u$ on the left and to $u_{4\leftrightarrow1}$ (note the interval $\inter[4,1]$ wraps around):
\[
\begin{tikzpicture}[baseline=25]
  \def\sc{0.75}   % Change this to adjust the x-scaling
  \def\lll{2.7}   % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \node[color=blue] at (1*\sc,\lll) {$2$};
  \node[color=blue] at (4*\sc,\lll) {$1$};
  \foreach \i in {2,3,5,6} { \node at (\i*\sc,\lll){$1$}; }
  \foreach \i in {7,8} { \node at (\i*\sc,\lll){$2$}; }
  \foreach \i in {1,2,5,6} { \draw (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {3,4,7,8} { \draw (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,2,5,6} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {4,7,8} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {8} { \draw (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,2,3,4,5,6,7} { \draw (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {4,6,7} { \node at (\i*\sc,\l) {$4$}; }
  \foreach \i in {8} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {1,2,5} { \node at (\i*\sc,\l) {$2$}; }
  \draw (2.5*\sc,3) -- (2.5*\sc,3.1) -- (4.5*\sc,3.1) -- (4.5*\sc,3);
  \node at (3.5*\sc,3.5) {balanced};
  \draw (5.5*\sc,3) -- (5.5*\sc,3.1) -- (8.5*\sc,3.1) -- (8.5*\sc,3);
  \node at (7.0*\sc,3.5) {balanced};
\end{tikzpicture}
% t = 1 for q_1
% t = 1 for q_2
\hspace{3pt} = \hspace{4pt}
\begin{tikzpicture}[baseline=25]
  \def\sc{0.75}   % Change this to adjust the x-scaling
  \def\lll{2.7}   % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \node[color=blue] at (4*\sc,\lll) {$2$};
  \node[color=blue] at (1*\sc,\lll) {$1$};
  \foreach \i in {2,3,5,6} { \node at (\i*\sc,\lll){$1$}; }
  \foreach \i in {7,8} { \node at (\i*\sc,\lll){$2$}; }
  \foreach \i in {1,2,5,6} { \draw (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {3,4,7,8} { \draw (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,2,5,6} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {4,7,8} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {8} { \draw (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,2,3,4,5,6,7} { \draw (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {4,6,7} { \node at (\i*\sc,\l) {$4$}; }
  \foreach \i in {8} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {1,2,5} { \node at (\i*\sc,\l) {$2$}; }
  \draw (2.5*\sc,3) -- (2.5*\sc,3.1) -- (4.5*\sc,3.1) -- (4.5*\sc,3);
  \node at (3.5*\sc,3.5) {balanced};
  \draw (5.5*\sc,3) -- (5.5*\sc,3.1) -- (8.5*\sc,3.1) -- (8.5*\sc,3);
  \node at (7.0*\sc,3.5) {balanced};
\end{tikzpicture}
\]
\end{example}

%.......................................

\begin{lemma}[UB]
\label{le:UB}
  Let $C$ and $u$ be as above.
  Suppose
  \begin{itemize}
    \item $i$ is unbalanced with $u_i = 1$,
    \item $j$ is balanced with $T(j) = (2,\bigcirc)$,
    \item $u_k = 2$ for unbalanced $k \in \inter(i,j)$, and
    \item $T(k) \in \{(1,\bigcirc),(2,\square)\}$ for balanced $k \in \inter(i,j)$.
  \end{itemize}
  Then we have $C(u) = C(u_{i \leftrightarrow j})$.
\end{lemma}

\begin{proof}
  As in the proof of Lemma~\ref{le:BU}, we assume that $r_1 > r_2$, noting that the case $r_1 < r_2$ follows from Lemma~\ref{le:dual} and Lemma~\ref{le:BU}.
  
  Let $B$ be a balanced block, and let $B^c := [\ell] \setminus B$ denote the complement of $B$.
  Note that for $B \subseteq \inter(i,j)$, the value of $C(u)_k$ for $k \notin B$ is determined entirely by $q_1\cap B^c$, $q_2\cap B^c$, and $u_{\lvert B^c \rvert}$.
  Thus we can reduce to the case when there is no such balanced block $B$ contained in $\inter(i,j)$.  

  Thus suppose $i, i+1, \dotsc, i+k$ are unbalanced and $i+k+1, i+k+2, \dotsc, j$ are balanced.
  We now prove that $C(u) = C(u_{i \leftrightarrow j})$ by induction on $k$. 
  
  \vspace{10pt}
  \noindent \underline{The base case}:

  Suppose $k = 0$.
  If $q_1(u)_j = 1$, then $q_1(u) = q_1(u_{i \leftrightarrow j})$ by Lemma~\ref{le:orig}.
  We are thus left with the case $q_1(u)_j = 2$.
  In this case, we have  $q_1(u_{i \leftrightarrow j}) = q_1(u)_{i \leftrightarrow j}$, and we can proceed as in the induction step below to conclude that $C(u) = C(u_{i \leftrightarrow j})$.

  \vspace{10pt}
  \noindent \underline{The inductive step}:

  Suppose $k > 0$.
  Clearly, we have $q_1(u)_i = 1$.
  If $q_1(u)_{i+1} = 1$, then it is easy to see that $q_1(u) = q_1(u_{i\leftrightarrow (i+1)})$.
  So by our inductive hypothesis, we have $C(u) = C(u_{i\leftrightarrow j})$ in this case. 

  Now suppose $q_1(u)_{i+1} = 2$.
  In this case, we see that the number of ones in $u$ is at most $r_1$ as otherwise there would not exist a $k \in q_1$ such that $q_1(u)_k = 2$.
  This means that $k \notin q_2$ implies $q_2\bigl( q_1(u) \bigr)_k = 4$.
  We also see that $q_1(u)_h = 2$ for all $h \in \set{i+1, \dotsc, i+k}$ as well as for $h = j$.

  Since the squares in the lower row of the balanced block of $j$ will all be labeled $4$, we see that in finding the first site to the left of $j$ when considering $q_1(u)_j = 2$ in the computation of $q_2\bigl( q_1(u) \bigr)$ from $q_1(u)$, the search goes beyond $i+k+1$.
  Together with the previous paragraph, this means that $q_2\bigl( q_1(u) \bigr)_i = 3$.

  Now, we have $q_1(u_{i\leftrightarrow (i+1)}) = q_1(u)_{i\leftrightarrow (i+1)}$.
  Therefore, the only difference between $C(u)$ and $C(u_{i\leftrightarrow j})$ would be in positions $i$ or $i+1$.
  We have established that $q_1(u)_i = q_1(u)_{i+1} = 3$, and it is immediate that this is also holds for $q_1(u_{i\leftrightarrow (i+1)})$.
\end{proof}

\begin{example}
Suppose $n = 8$.
Let $u = 12221222$, and we consider the $(6,2)$-configuration $C = (\{1,2,3,4,5,8\}, \{7,8\})$.
We apply $C$ to $u$ on the left and to $u_{1 \leftrightarrow 8}$ on the right:
\[
\begin{tikzpicture}[baseline=25]
  \def\sc{0.75}   % Change this to adjust the x-scaling
  \def\lll{2.7}   % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \node[color=blue] at (1*\sc,\lll) {$1$};
  \node[color=blue] at (8*\sc,\lll) {$2$};
  \foreach \i in {5} { \node at (\i*\sc,\lll){$1$}; }
  \foreach \i in {2,3,4,6,7} { \node at (\i*\sc,\lll){$2$}; }
  \foreach \i in {1,2,3,4,5,8} { \draw (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {6,7} { \draw (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \node[color=blue] at (1*\sc,\ll) {$1$};
  \node[color=blue] at (8*\sc,\ll) {$2$};
  \foreach \i in {5} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {2,3,4} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {6,7} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {7,8} { \draw (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,2,3,4,5,6} { \draw (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {5,6} { \node at (\i*\sc,\l) {$4$}; }
  \foreach \i in {7,8} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {1,2,3,4} { \node at (\i*\sc,\l) {$3$}; }
  \draw (4.5*\sc,3) -- (4.5*\sc,3.1) -- (8.5*\sc,3.1) -- (8.5*\sc,3);
  \node at (6.5*\sc,3.5) {balanced};
\end{tikzpicture}
% t = 2 for q_1 = {1,2,3,4,5,8}
% t = 2 for q_2 = {7,8}
\hspace{3pt} = \hspace{4pt}
\begin{tikzpicture}[baseline=25]
  \def\sc{0.75}   % Change this to adjust the x-scaling
  \def\lll{2.7}   % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \node[color=blue] at (8*\sc,\lll) {$1$};
  \node[color=blue] at (1*\sc,\lll) {$2$};
  \foreach \i in {5} { \node at (\i*\sc,\lll){$1$}; }
  \foreach \i in {2,3,4,6,7} { \node at (\i*\sc,\lll){$2$}; }
  \foreach \i in {1,2,3,4,5,8} { \draw (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {6,7} { \draw (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \node[color=blue] at (8*\sc,\ll) {$1$};
  \node[color=blue] at (1*\sc,\ll) {$2$};
  \foreach \i in {5} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {2,3,4} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {6,7} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {7,8} { \draw (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,2,3,4,5,6} { \draw (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {5,6} { \node at (\i*\sc,\l) {$4$}; }
  \foreach \i in {7,8} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {1,2,3,4} { \node at (\i*\sc,\l) {$3$}; }
  \draw (4.5*\sc,3) -- (4.5*\sc,3.1) -- (8.5*\sc,3.1) -- (8.5*\sc,3);
  \node at (6.5*\sc,3.5) {balanced};
\end{tikzpicture}
\]
\end{example}


%%%%%%%%%%
\subsection*{Part D: finishing the proof}

Note that if one of Lemmas~\ref{le:BB}, \ref{le:BU}, and \ref{le:UB} applies to $C,u,i,j$ then it also applies to $C',u,i,j$.
Now, let $u_0$ be a result of applying Lemmas~\ref{le:BB}, \ref{le:BU}, and \ref{le:UB} until this can be done no more.
Such a $u_0$ exists since the number of balanced $k$ with $T(k) \in \{(1,\bigcirc), (2,\square)\}$ increases with each swap.

Note that $u_0$ falls into one of the following three cases.
Recall that $m_1(u)$ denotes the number of occurrences of $1$ in $u$.
\begin{enumerate}
\item There is some balanced $i$ such that $T(i) = (1, \square)$, but there is no balanced $i$ such that $T(i) = (2,\bigcirc)$.
  Equivalently, we have $m_1(u) > r_1$.
\item There is some balanced $i$ such that $T(i) = (2, \bigcirc)$, but there is no balanced $i$ such that $T(i) = (1,\square)$.
  Equivalently, we have $r_2 \geq m_1(u)$.
\item For all balanced $i$, we have $T(i) \in \{(1,\bigcirc),(2,\square)\}$.
  Equivalently, we have $r_1 \geq m_1(u) > r_2$.
\end{enumerate}
In each of these cases, it is easy to see that all particles in $u$ starting in unbalanced positions in $C$ or $C'$ simply are assigned to the same column two rows down, and that the labelling procedure inside each balanced block is the same in $C$ and $C'$.
Therefore, we have $\swt{u}_{\sigma} = \swt{u}_{\sigma s_i}$, and hence, Theorem~\ref{thm:permutation} following by induction on length.
\qed

\begin{example}
\label{ex:proof_process}
Suppose $n = 6$.
Let us consider the $(5,3)$-configuration $C = (\set{1,3,4,5,6}, \set{1,2,5})$ and its dual configuration $C' = (\set{1,5,6}, \set{1,2,3,4,5})$.
Note that $1$, $2$, $5$, and $6$ are balanced and $3$ and $4$ are unbalanced.
We take the word $u = 211112$, which yields (we write $C$ on the left and $C'$ on the right):
\[
\begin{tikzpicture}[scale=0.9]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\lll{3}  % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \draw[fill=blue!30] (0.5*\sc,\l-.5) rectangle(2.5*\sc,\ll+.5);
  \draw[fill=blue!30] (4.5*\sc,\l-.5) rectangle(6.5*\sc,\ll+.5);
  \foreach \i in {1,3,4,5,6} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,2,5} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {3,4,6} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {2,3,4,5} { \node at (\i*\sc,\lll) {$1$}; }
  \foreach \i in {1,6} { \node at (\i*\sc,\lll) {$2$}; }
  \foreach \i in {3,4,5,6} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {1} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {2} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {1,2,5} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\l) {$2$}; }
  \foreach \i in {4} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {6} { \node at (\i*\sc,\l) {$4$}; }
\end{tikzpicture}
\hspace{40pt}
\begin{tikzpicture}[scale=0.9]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\lll{3}  % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \draw[fill=blue!30] (0.5*\sc,\l-.5) rectangle(2.5*\sc,\ll+.5);
  \draw[fill=blue!30] (4.5*\sc,\l-.5) rectangle(6.5*\sc,\ll+.5);
  \foreach \i in {1,5,6} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2,3,4} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,2,3,4,5} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {6} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {2,3,4,5} { \node at (\i*\sc,\lll) {$1$}; }
  \foreach \i in {1,6} { \node at (\i*\sc,\lll) {$2$}; }
  \foreach \i in {1,5,6} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {2} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {3,4} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {1,2,5} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\l) {$2$}; }
  \foreach \i in {4} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {6} { \node at (\i*\sc,\l) {$4$}; }
\end{tikzpicture}
\]
We will do the reductions given in Part~C.
We first apply Lemma UB with $i = 4$ and $j = 6$ and obtain:
\[
\begin{tikzpicture}[scale=0.9]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\lll{3}  % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \draw[fill=blue!30] (0.5*\sc,\l-.5) rectangle(2.5*\sc,\ll+.5);
  \draw[fill=blue!30] (4.5*\sc,\l-.5) rectangle(6.5*\sc,\ll+.5);
  \foreach \i in {1,3,4,5,6} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,2,5} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {3,4,6} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \node[blue] at (4*\sc,\lll) {$2$};
  \node[blue] at (6*\sc,\lll) {$1$};
  \foreach \i in {2,3,5} { \node at (\i*\sc,\lll) {$1$}; }
  \foreach \i in {1} { \node at (\i*\sc,\lll) {$2$}; }
  \foreach \i in {3,4,5,6} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {1} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {2} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {1,2,5} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\l) {$2$}; }
  \foreach \i in {4} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {6} { \node at (\i*\sc,\l) {$4$}; }
\end{tikzpicture}
\hspace{40pt}
\begin{tikzpicture}[scale=0.9]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\lll{3}  % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \draw[fill=blue!30] (0.5*\sc,\l-.5) rectangle(2.5*\sc,\ll+.5);
  \draw[fill=blue!30] (4.5*\sc,\l-.5) rectangle(6.5*\sc,\ll+.5);
  \foreach \i in {1,5,6} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2,3,4} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,2,3,4,5} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {6} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \node[blue] at (4*\sc,\lll) {$2$};
  \node[blue] at (6*\sc,\lll) {$1$};
  \foreach \i in {2,3,5} { \node at (\i*\sc,\lll) {$1$}; }
  \foreach \i in {1} { \node at (\i*\sc,\lll) {$2$}; }
  \foreach \i in {1,5,6} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {2} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {3,4} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {1,2,5} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\l) {$2$}; }
  \foreach \i in {4} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {6} { \node at (\i*\sc,\l) {$4$}; }
\end{tikzpicture}
\]
then Lemma BU with $i=2$ and $j=4$:
\[
\begin{tikzpicture}[scale=0.9]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\lll{3}  % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \draw[fill=blue!30] (0.5*\sc,\l-.5) rectangle(2.5*\sc,\ll+.5);
  \draw[fill=blue!30] (4.5*\sc,\l-.5) rectangle(6.5*\sc,\ll+.5);
  \foreach \i in {1,3,4,5,6} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,2,5} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {3,4,6} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \node[blue] at (2*\sc,\lll) {$2$};
  \node[blue] at (4*\sc,\lll) {$1$};
  \foreach \i in {3,5,6} { \node at (\i*\sc,\lll) {$1$}; }
  \foreach \i in {1} { \node at (\i*\sc,\lll) {$2$}; }
  \foreach \i in {3,4,5,6} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {1} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {2} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {1,2,5} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\l) {$2$}; }
  \foreach \i in {4} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {6} { \node at (\i*\sc,\l) {$4$}; }
\end{tikzpicture}
\hspace{40pt}
\begin{tikzpicture}[scale=0.9]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\lll{3}  % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \draw[fill=blue!30] (0.5*\sc,\l-.5) rectangle(2.5*\sc,\ll+.5);
  \draw[fill=blue!30] (4.5*\sc,\l-.5) rectangle(6.5*\sc,\ll+.5);
  \foreach \i in {1,5,6} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2,3,4} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,2,3,4,5} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {6} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \node[blue] at (2*\sc,\lll) {$2$};
  \node[blue] at (4*\sc,\lll) {$1$};
  \foreach \i in {3,5,6} { \node at (\i*\sc,\lll) {$1$}; }
  \foreach \i in {1} { \node at (\i*\sc,\lll) {$2$}; }
  \node[blue] at (2*\sc,\ll) {$3$};
  \node[blue] at (3*\sc,\ll) {$2$};
  \foreach \i in {1,5,6} { \node at (\i*\sc,\ll) {$1$}; }
  %\foreach \i in {3} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {4} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {1,2,5} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\l) {$2$}; }
  \foreach \i in {4} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {6} { \node at (\i*\sc,\l) {$4$}; }
\end{tikzpicture}
\]
and finally Lemma UB with $i=4$ and $j=1$ yields:
\[
\begin{tikzpicture}[scale=0.9]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\lll{3}  % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \draw[fill=blue!30] (0.5*\sc,\l-.5) rectangle(2.5*\sc,\ll+.5);
  \draw[fill=blue!30] (4.5*\sc,\l-.5) rectangle(6.5*\sc,\ll+.5);
  \foreach \i in {1,3,4,5,6} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,2,5} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {3,4,6} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \node[blue] at (4*\sc,\lll) {$2$};
  \node[blue] at (1*\sc,\lll) {$1$};
  \foreach \i in {3,5,6} { \node at (\i*\sc,\lll) {$1$}; }
  \foreach \i in {2} { \node at (\i*\sc,\lll) {$2$}; }
  \foreach \i in {3,4,5,6} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {1} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {2} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {1,2,5} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\l) {$2$}; }
  \foreach \i in {4} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {6} { \node at (\i*\sc,\l) {$4$}; }
\end{tikzpicture}
\hspace{40pt}
\begin{tikzpicture}[scale=0.9]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\lll{3}  % level 3
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \draw[fill=blue!30] (0.5*\sc,\l-.5) rectangle(2.5*\sc,\ll+.5);
  \draw[fill=blue!30] (4.5*\sc,\l-.5) rectangle(6.5*\sc,\ll+.5);
  \foreach \i in {1,5,6} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2,3,4} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {1,2,3,4,5} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {6} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
  \node[blue] at (4*\sc,\lll) {$2$};
  \node[blue] at (1*\sc,\lll) {$1$};
  \foreach \i in {3,5,6} { \node at (\i*\sc,\lll) {$1$}; }
  \foreach \i in {2} { \node at (\i*\sc,\lll) {$2$}; }
  \foreach \i in {1,5,6} { \node at (\i*\sc,\ll) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\ll) {$2$}; }
  \foreach \i in {2,4} { \node at (\i*\sc,\ll) {$3$}; }
  \foreach \i in {1,2,5} { \node at (\i*\sc,\l) {$1$}; }
  \foreach \i in {3} { \node at (\i*\sc,\l) {$2$}; }
  \foreach \i in {4} { \node at (\i*\sc,\l) {$3$}; }
  \foreach \i in {6} { \node at (\i*\sc,\l) {$4$}; }
\end{tikzpicture}
\]
at which point we cannot apply any of the reductions.
Furthermore, we have
\begin{align*}
C(211112) & = C(211211) = C(221111) = C(121211)
\\ & = C'(121211) = C'(221111) = C'(211211) = C'(211112).
\end{align*}
\end{example}

\begin{remark}
Theorem~\ref{thm:permutation} for the special case of $x_1 = \cdots = x_n = 1$ was proven in~\cite{AAMP} using different techniques.
\end{remark}










%=====================================================================
\section{Final remarks}
\label{sec:remarks}

We conclude by giving some additional examples, remarks, and comments about our results.
We begin with an example to illustrate the proof of Theorem~\ref{thm:merge} in more detail.

\begin{example}
In order to compute $\swt{135452}$, we need to examine MLQs of type $(1,1,1,1, 2, 0, 0, \ldots)$.
We take a particular MLQ $\qq$ and add the $5$-queue $\set{1,2,3,5,6}$ as follows:
\[
\qq = \;
\begin{tikzpicture}[baseline=66,scale=0.75,every node/.style={inner sep=2pt}]
\node at (0, 4){2};\node at (1, 4){2};\node at (2, 4){2};\node[circle, draw=black] at (3, 4){1};\node at (4, 4){2};\node at (5, 4){2};\node at (0, 3){3};\node at (1, 3){3};\node[circle, draw=black] at (2, 3){2};\node at (3, 3){3};\node at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){4};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){5};\node[circle, draw=black] at (5, 1){2};
\end{tikzpicture}
\; \xrightarrow{\hspace{30pt}} \;
\begin{tikzpicture}[baseline=66,scale=0.75,every node/.style={inner sep=2pt}]
\node[circle, draw=black] at (0, 5){1};\node[circle, draw=black] at (1, 5){1};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node[circle, draw=black] at (4, 5){1};\node[circle, draw=black] at (5, 5){1};\node at (0, 4){2};\node at (1, 4){2};\node at (2, 4){3};\node[circle, draw=black] at (3, 4){1};\node at (4, 4){2};\node at (5, 4){2};\node at (0, 3){3};\node at (1, 3){4};\node[circle, draw=black] at (2, 3){2};\node at (3, 3){3};\node at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};
\end{tikzpicture}
\; = \widetilde{\qq}.
\]
Thus, we obtain a $(s_4 s_3 s_2 s_1)$-twisted MLQ $\widetilde{\qq}$ of type $(1, 1, 1, 1, 1, 1, 0, \ldots)$.
Furthermore, note that $135452 = \merge{5} 135462$.
Now, by Theorem~\ref{thm:permutation}, such MLQs $\widetilde{\qq}$ are in bijection with ordinary MLQs contributing to, in this case, $\swt{135462}$.
In more detail, let $R_i(\widetilde{\qq})$ be the MLQ formed by taking the configuration $C = (\widetilde{q}_i, \widetilde{q}_{i+1})$ and replacing it with the dual configuration.
By taking $R_4 R_3 R_2 R_1(\widetilde{\qq})$ to bring the top row to the bottom, we obtain the ordinary MLQ as follows:
\begin{align*}
\; \widetilde{\qq} & \xrightarrow[\hspace{15pt}]{R_1} \;
\begin{tikzpicture}[xscale=0.7,yscale=0.7,every node/.style={inner sep=0.8pt},baseline=55]
\node at (0, 5){2};\node at (1, 5){2};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node[circle, draw=black] at (0, 4){2};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node[circle, draw=black] at (3, 4){1};\node[circle, draw=black] at (4, 4){2};\node[circle, draw=black] at (5, 4){2};\node at (0, 3){3};\node at (1, 3){4};\node[circle, draw=black] at (2, 3){2};\node at (3, 3){3};\node at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};
\end{tikzpicture}
\; \xrightarrow[\hspace{15pt}]{R_2} \;
\begin{tikzpicture}[xscale=0.7,yscale=0.7,every node/.style={inner sep=0.8pt},baseline=55]
\node at (0, 5){2};\node at (1, 5){2};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node at (0, 4){3};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node at (3, 4){3};\node at (4, 4){3};\node[circle, draw=black] at (5, 4){1};\node[circle, draw=black] at (0, 3){3};\node at (1, 3){4};\node[circle, draw=black] at (2, 3){2};\node[circle, draw=black] at (3, 3){3};\node[circle, draw=black] at (4, 3){3};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){4};\node at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};
\end{tikzpicture}
\\[1.3em] &
\; \xrightarrow[\hspace{15pt}]{R_3} \;
\begin{tikzpicture}[xscale=0.7,yscale=0.7,every node/.style={inner sep=0.8pt},baseline=55]
\node at (0, 5){2};\node at (1, 5){2};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node at (0, 4){3};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node at (3, 4){3};\node at (4, 4){3};\node[circle, draw=black] at (5, 4){1};\node[circle, draw=black] at (0, 3){3};\node at (1, 3){4};\node at (2, 3){4};\node at (3, 3){4};\node[circle, draw=black] at (4, 3){2};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node[circle, draw=black] at (2, 2){4};\node[circle, draw=black] at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};\end{tikzpicture}
\; \xrightarrow[\hspace{15pt}]{R_4} \;
\begin{tikzpicture}[xscale=0.7,yscale=0.7,every node/.style={inner sep=0.8pt},baseline=55]
\node at (0, 5){2};\node at (1, 5){2};\node[circle, draw=black] at (2, 5){1};\node at (3, 5){2};\node at (4, 5){2};\node at (5, 5){2};\node at (0, 4){3};\node[circle, draw=black] at (1, 4){2};\node at (2, 4){3};\node at (3, 4){3};\node at (4, 4){3};\node[circle, draw=black] at (5, 4){1};\node[circle, draw=black] at (0, 3){3};\node at (1, 3){4};\node at (2, 3){4};\node at (3, 3){4};\node[circle, draw=black] at (4, 3){2};\node[circle, draw=black] at (5, 3){1};\node[circle, draw=black] at (0, 2){1};\node[circle, draw=black] at (1, 2){3};\node at (2, 2){5};\node[circle, draw=black] at (3, 2){4};\node[circle, draw=black] at (4, 2){2};\node at (5, 2){5};\node[circle, draw=black] at (0, 1){1};\node[circle, draw=black] at (1, 1){3};\node[circle, draw=black] at (2, 1){5};\node[circle, draw=black] at (3, 1){4};\node at (4, 1){6};\node[circle, draw=black] at (5, 1){2};
\end{tikzpicture}
\; = \widetilde{\qq}',
\end{align*}
which contributes to $\swt{135462}$.
\end{example}

There is the natural cyclic symmetry on our special weights.

\begin{prop}
  Let $C_n \subseteq \SymGp{n}$ denote the cyclic group of order $n$ generated by the $n$-cycle $(1 \; 2 \; \dotsm \; n)$ and $u \in \mcW_n$.
  We have $\swt{u}_{\tau}\sigma = \swt{u \sigma}_{\tau}$ for any $\sigma \in C_n$ and $\tau \in \SymGp{\ell-1}$, where $\SymGp{n}$ acts on $\mcW_n$ from the right by $(u_1 \dotsm u_n) \sigma = u_{\sigma(1)} \dotsm u_{\sigma(n)}$, that is to say permutations act on positions, and similarly on monomials in $\xx$.
\end{prop}

\begin{proof}
  For a queue $q$, define $\sigma q := \{ \sigma(i) \mid i \in q\}$.
  It is clear from the definition of a queue that $q(u \sigma) = \bigl( (\sigma q)(u) \bigr) \sigma$.
  Hence, for any $\tau$-twisted MLQ $\qq$ of type $\mm$, we have
  $\qq (u \sigma) = \bigl( (\sigma \qq)(u) \bigr) \sigma$,
  where the action of $C_n$ on MLQs is obtained by acting on each queue separately.
  Thus, in particular, for any $\tau$-twisted MLQ $\qq$ of type $\mm$, we have
  $\qq (1 \cdots 1) = \bigl( (\sigma \qq)(1 \cdots 1) \bigr) \sigma$.
  From here, the claim follows by an obvious bijection
  (given by the action of $\sigma$) between the sums defining
  $\swt{u}_{\tau} \sigma$ and $\swt{u \sigma}_{\tau}$.
\end{proof}

Let $B^{r,s}$, where $r \in [n-1]$ and $s \in \ZZ_{>0}$, be a \defn{Kirillov--Reshetikhin (KR) crystal} in type $A_{n-1}^{(1)}$~\cite{KKMMNN92}.
Recall the combinatorial $R$-matrix acting on $B^{r,s}$ from~\cite{NY97,Shimozono02}, which is the unique crystal isomorphism
\[
R \colon B^{r_1,s_1} \otimes B^{r_2,s_2} \to B^{r_2,s_2} \otimes B^{r_1,s_2}.
\]
There is a well-known (in slightly different terminology) bijection $\Xi_r$ relating $r$-queues with an element of the KR crystal $B^{r,1}$ in type $A_{n-1}^{(1)}$ by considering $q = \{b_1 < \cdots < b_r\}$  as a single-column Young tableau of height $r$.
In~\cite{KMO15}, this was extended to a bijection $\Xi$ between multiline queues of type $\mm$ with $\ell+1$ classes and $B^{p_1,1} \otimes B^{p_2,1} \otimes \dotsm \otimes B^{p_{\ell},1}$ by
\[
\Xi(\qq) = \Xi_{p_1}(q_1) \otimes \Xi_{p_2}(q_2) \otimes \dotsm \otimes \Xi_{p_{\ell}}(q_{\ell}).
\]
Thus, by comparing the description of the combinatorial $R$-matrix for $B^{r_1,1}$ and $B^{r_2,1}$ from~\cite{NY97}, we obtain that taking the dual configuration is equivalent to applying the combinatorial $R$-matrix under $\Xi$.

\begin{prop}
Let $C$ be an $(r_1, r_2)$-configuration. Then
\[
\Xi(C') = R\bigl( \Xi(C) \bigr),
\]
where $C'$ is the dual configuration of $C$.
\end{prop}

\begin{example}
Suppose $n = 9$.
Consider the $(4,6)$-configuration and dual $(6,4)$-configuration
\[
C = (\set{1,4,5,6}, \set{2,3,4,6,7,8}),
\qquad\quad
C' = (\set{1,3,4,5,6,8}, \set{2,4,6,7}).
\]
We have
\[
\begin{tikzpicture}[xscale=6,yscale=4,>=stealth]
\node (C) at (0,0) { %{$(\set{1,4,5,6}, \set{2,3,4,6,7,8})$};
\begin{tikzpicture}[scale=0.7]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \foreach \i in {1,4,5,6} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2,3,7,8,9} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {2,3,4,6,7,8} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,5,9} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
\end{tikzpicture}
};
\node (Cp) at (0,-1) { %{$(\set{1,3,4,5,6,8}, \set{2,4,6,7})$};
\begin{tikzpicture}[scale=0.7]
  \def\sc{0.85}   % Change this to adjust the x-scaling
  \def\ll{2}   % level 2
  \def\l{1}   % level 1
  \foreach \i in {1,3,4,5,6,8} { \draw[fill=white] (\i*\sc,\ll) circle (0.3); }
  \foreach \i in {2,7,9} { \draw[fill=white] (\i*\sc-.3,\ll-.3) rectangle +(0.6,+0.6); }
  \foreach \i in {2,4,6,7} { \draw[fill=white] (\i*\sc,\l) circle (0.3); }
  \foreach \i in {1,3,5,8,9} { \draw[fill=white] (\i*\sc-.3,\l-.3) rectangle +(0.6,+0.6); }
\end{tikzpicture}
};
\node (KR) at (1,0) {$\young(1,4,5,6) \otimes \young(2,3,4,6,7,8)$};
\node (KRp) at (1,-1) {$\young(1,3,4,5,6,8) \otimes \young(2,4,6,7)$};
\draw[<->] (C) -- (Cp) node[midway,anchor=east] {dual};
\draw[<->] (C) -- (KR) node[midway,anchor=south] {$\Xi$};
\draw[<->] (KR) -- (KRp) node[midway,anchor=west] {$R$};
\draw[<->] (Cp) -- (KRp) node[midway,anchor=north] {$\Xi$};
\end{tikzpicture}
\]
\end{example}

Since the combinatorial $R$-matrix satisfies the Yang--Baxter equation, we have an action of the symmetric group $\SymGp{\ell}$ acting on MLQs with $\ell + 1$ queues.
Given the description of the combinatorial $R$-matrix using the Robinson--Schensted--Knuth (RSK) bijection~\cite{Shimozono02}, this $\SymGp{\ell}$-action can be considered as corresponding to the one given by van Leeuwen~\cite[Lemma~2.3]{vanLeeuwen-dc}.\footnote{This could also be considered as an interpretation of the Littlewood--Richardson rule, along with the fact that $s_{\lambda} s_{\mu}$, where $s_{\lambda}$ and $s_{\mu}$ are Schur functions corresponding to rectangles, is multiplicity free~\cite{Stembridge01}, and using Howe duality~\cite[Ch.~9,App.~B]{BS17}.}
Furthermore, the $\SymGp{\ell}$-action on MLQs has been considered by Danilov and Koshevoy~\cite{DanilovKoshevoy} in a different context (see also~\cite[Ch.~4]{Gorodentsev2}).
Unlike the combinatorial $R$-matrix perspective, they do not have the natural interpretation of the weight since $\wt(\qq) = \wt\bigl( \Xi(\qq) \bigr)$, where the crystal weight is the usual tableaux weight.

Next, we describe how to interpret our action from looking at the corner transfer matrix described in~\cite{KMO15}, which can be given diagrammatically by
\[
\begin{tikzpicture}[>=latex,scale=0.5]
\draw[->] (0,1) node[anchor=east] {$\mathbf{b}_{\ell}$} -- (1,1) -- (1,8);
\foreach \x in {1,2} {
  \draw[->] (0,\x+1) node[anchor=east] {$\mathbf{b}_{\ell-\x}$} -- (\x+1,\x+1) -- (\x+1,8);
}
\foreach \x in {1,2,3} {
  \draw[->] (0,8-\x) node[anchor=east] {$\mathbf{b}_{\x}$} -- (8-\x,8-\x) -- (8-\x,8);
}
\node at (4,7.5) {$\cdots$};
\node at (0.5,4) {$\vdots$};
\end{tikzpicture}
\]
where every crossing is a combinatorial $R$-matrix and $\mathbf{b}_i \in B^{p_i,1}$.
Our action effectively does the following on the corner transfer matrix:
\[
\begin{tikzpicture}[>=latex,scale=0.5,baseline=50]
\draw[->] (0,1) node[anchor=east] {$\mathbf{b}_{\ell}$} -- (1,1) -- (1,7);
\draw[->] (0,6) node[anchor=east] {$\mathbf{b}_1$} -- (6,6) -- (6,7);
\draw[->] (-1,3) node[anchor=east] {$\mathbf{b}_i$} -- (0,4) -- (4,4) -- (4,7) -- (3,8);
\draw[->] (-1,4) node[anchor=east] {$\mathbf{b}_{i+1}$} -- (0,3) -- (3,3) -- (3,7) -- (4,8);
\node at (2,6.5) {$\cdots$};
\node at (0.5,2) {$\vdots$};
\node at (5,6.5) {$\cdots$};
\node at (0.5,5) {$\vdots$};
\end{tikzpicture}
\qquad = \qquad
\begin{tikzpicture}[>=latex,scale=0.5,baseline=50]
\draw[->] (0,1) node[anchor=east] {$\mathbf{b}_{\ell}$} -- (1,1) -- (1,7);
\draw[->] (0,6) node[anchor=east] {$\mathbf{b}_1$} -- (6,6) -- (6,7);
\draw[->] (0,4) node[anchor=east] {$\mathbf{b}_i$} -- (4,4) -- (4,7);
\draw[->] (0,3) node[anchor=east] {$\mathbf{b}_{i+1}$} -- (3,3) -- (3,7);
\node at (2,6.5) {$\cdots$};
\node at (0.5,2) {$\vdots$};
\node at (5,6.5) {$\cdots$};
\node at (0.5,5) {$\vdots$};
\end{tikzpicture}
\]
where the equality comes from applying the Yang--Baxter equation and $R^2 = \id$.

We conclude with a few questions.
Note that Lemmas~\ref{le:BB},~\ref{le:BU} and~\ref{le:UB} effectively compute $C(u)$ for $u \in \{1,2\}^n$.
Could this be done in a more transparent manner, such as by using pairs of labeled periodic Dyck paths?
It could be interesting to see if our proof has any implications for the work of Danilov and Koshevoy~\cite{DanilovKoshevoy} or van Leeuwen~\cite{vanLeeuwen-dc}.


\bibliographystyle{alpha}
\bibliography{queue}{}
\end{document}
